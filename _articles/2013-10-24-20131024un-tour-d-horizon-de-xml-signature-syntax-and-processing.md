---
ID: 139
post_title: 'Un tour d&#039;horizon de la spécification XML Signature Syntax and Processing'
author: ylegat
post_date: 2013-10-24 14:00:00
post_excerpt: |
  <h3>Introduction</h3> <p>XML Signature Syntax and Processing (XMLDsig) est une spécification élaboré par le W3C en 2002 afin de standardiser la signature de documents. Cette spécification a été modifié en 2008 et est actuellement en <a href="http://www.w3.org/TR/xmldsig-core/" hreflang="en" title="w3c-xmldsig-core">version 2</a>.</p> <p>L'objet de cet article est de présenter XMLDsig ainsi que de détailler son implémentation par la JSR-105. Quelques notions élémentaires sur le chiffrement asymétrique seront utiles à sa bonne compréhension.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=139
published: true
---
<h3>Introduction</h3> <p>XML Signature Syntax and Processing (XMLDsig) est une spécification élaboré par le W3C en 2002 afin de standardiser la signature de documents. Cette spécification a été modifié en 2008 et est actuellement en <a href="http://www.w3.org/TR/xmldsig-core/" hreflang="en" title="w3c-xmldsig-core">version 2</a>.</p> <p>L'objet de cet article est de présenter XMLDsig ainsi que de détailler son implémentation par la JSR-105. Quelques notions élémentaires sur le chiffrement asymétrique seront utiles à sa bonne compréhension.</p>
<!--more-->
<h3>XML Signature Syntax and Processing</h3> <h4>Un premier aperçu</h4> <p>Les modes d'utilisation de XMLDsig étant variés, nous allons d'abord illustrer son fonctionnement à travers un cas d'utilisation simplifié à l'extrême. Nous verrons ensuite plus en détail chacune des étapes qui mène à la génération d'une signature.</p> <p><img src="/wp-content/uploads/2015/07/xmldsig-core-schema.jpg" alt="xmldsig-core-schema" style="display:block; margin:0 auto;" title="xmldsig-core-schema" /></p> <p>Comme on le voit sur ce schéma, XMLDsig est en mesure de générer une signature portant sur un ou plusieurs de documents de formats divers. Au cours de ce processus différentes transformations peuvent être appliquées sur ces documents, mais la principale d'entre elle est l'application d'une fonction de hachage. Cette transformation est obligatoire dans la mesure où elle participe au mécanisme de validation qui sera appliqué par le destinataire du message pour s'assurer que les URI n'ont pas été modifiées. L'algorithme MD5 figure sur ce schéma, mais d'autres fonctions de hachage peuvent être utilisées.</p> <p>Un document XML est ensuite crée. Il contient les empreintes (hash) des trois documents référencés. Une fonction de hachage est de nouveau appliquée et le résultat est chiffré à l'aide d'une clef privée et intégré au document précédemment crée. C'est ce document qui constitue la signature XML.</p> <p>L'idée centrale à retenir est que ce ne sont pas les documents d'origine qui sont directement chiffrés, mais l'élément XML qui les référence et dont voici un exemple :</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;SignedInfo<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;CanonicalizationMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;SignatureMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Reference</span> <span style="color: #000066;">URI</span>=<span style="color: #ff0000;">&quot;http://path/doc.csv&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/04/xmldsig-more#md5&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>jLPnPblTb48XVTtwhZzOJSRr4mSz3lp8Bnryxj39JC0=<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Reference<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Reference</span> <span style="color: #000066;">URI</span>=<span style="color: #ff0000;">&quot;http://path/doc.xml&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/04/xmldsig-more#md5&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>hKj94odLnTCKkONgKV5h89vrnDDU+lHgVnVFMIknMZI=<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Reference<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Reference</span> <span style="color: #000066;">URI</span>=<span style="color: #ff0000;">&quot;http://path/doc.txt&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/04/xmldsig-more#md5&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Rr4mSz3lpXVTtjLPnPblTb48whZzOJSyxj39JC08Bnr=<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Reference<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/SignedInfo<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>On constate qu'à chaque document correspond un nœud Reference spécifiant les algorithmes de transformation utilisés, en l'occurrence l'algorithme de hachage MD5 (DigestMethod), ainsi que l'empreinte correspondante (DigestValue).</p> <blockquote><p>Note&nbsp;: le W3C a défini une <a href="http://www.w3.org/TR/2013/NOTE-xmlsec-algorithms-20130411/" hreflang="en" title="w3c-alg-urls">liste</a> d'URIs pour identifier de manière standardisée les algorithmes de chiffrement, de hachage et d'encodage les plus courants.</p></blockquote> <p>Les documents sont désignés par l'attribut URI du nœud Reference. Nous verrons plus tard qu'il est également possible de les intégrer dans la signature.</p> <p>Le nœud SignedInfo contient deux autres informations : un algorithme de canonisation (CanonicalizationMethod) et un algorithme de chiffrement (SignatureMethod). La canonisation, ou normalisation, est un processus permettant de présenter de l'information sous une forme standard. Pour un document XML il s'agira d'encoder les données au format UTF-8, de transformer les URIs relatives en URIs absolues etc. L'objectif étant de pouvoir détecter si deux documents sont identiques indépendamment de leur formatage respectif.</p> <p>Le nom de l'algorithme de chiffrement employé est explicite : il nous apprend qu'une empreinte de SignedInfo sera d'abord générée par l'application de la fonction SHA256 et que cette empreinte sera ensuite chiffrée à l'aide de RSA.</p> <blockquote><p>Note: l'algorithme désigné par l'URI http://www.w3.org/2001/04/xmldsig-more#rsa-sha256 a été introduit avec Java 7 et porté sur Java 6.</p></blockquote> <p>Nous l'avons vu plus haut, ces deux algorithmes doivent être appliqués sur le nœud SignedInfo et le résultat doit être intégré au sein du même document. Le XML final correspond donc à celui ci :</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Signature</spa
n> <span style="color: #000066;">xmlns</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;SignedInfo<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;CanonicalizationMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;SignatureMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Reference</span> <span style="color: #000066;">URI</span>=<span style="color: #ff0000;">&quot;http://path/doc.csv&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/04/xmldsig-more#md5&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>jLPnPblTb48XVTtwhZzOJSRr4mSz3lp8Bnryxj39JC0=<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Reference<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Reference</span> <span style="color: #000066;">URI</span>=<span style="color: #ff0000;">&quot;http://path/doc.xml&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/04/xmldsig-more#md5&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>hKj94odLnTCKkONgKV5h89vrnDDU+lHgVnVFMIknMZI=<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Reference<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Reference</span> <span style="color: #000066;">URI</span>=<span style="color: #ff0000;">&quot;http://path/doc.txt&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestMethod</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/04/xmldsig-more#md5&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Rr4mSz3lpXVTtjLPnPblTb48whZzOJSyxj39JC08Bnr=<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/DigestValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Reference<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/SignedInfo<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;SignatureValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>h8TLwi5I7bZTBt5YxoF3MxdnGQlL+YJMJlZul/DoBC909fOv3LlHweSH5jthzZIKwy4M7xx2bKuN rHdsNpjk19mjmNV7YqWLTJvzCav0CBwXld0GhNbqODXQUoG5yHqsDuMj8mOcGQbEfqj6/KQUxyYI J5wgWV69WsnESegvWIU3Hfh6VsUwIPOwxRGPIRDfilmxNVyUGWLiRO0uKRcZZhm6BPbu2iXPb7UP ZslZOeWYQ/MncQdQHbLcaGFjFfO7fGCSeikLnzyFC0cMnzaGpwCgeJkQeR+R96F6qHXczzulnDhp AxNjc/Kas1eXy/g0SN4bB8cpILfhESKjqHijgg==     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/SignatureValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Signature<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Une dernière chose : les valeurs de DigestValue et SignatureValue sont présentées au format base 64.</p> <h4>Les différents modes de signature.</h4> <p>On distingue les signatures détachées (detached signature), enveloppées (envelopped signature) et enveloppantes (enveloping signature). L'exemple que nous avons vu précédemment est du premier type : la signature XML est complètement détachée des documents qu'elle référence.</p> <p>Une signature enveloppée est une signature intégrée à un des documents XML qu'elle référence. La sélection de ce mode passe par l'ajout d'une transformation supplémentaire à l'élément Reference concerné.</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Transform</span> <span style="color: #000066;">Algorithm</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span></pre> <blockquote><p>Note : Dans le cas d’une signature enveloppée, l'URI de l'élément contenant la signature doit être vide.</p></blockquote> <p>Une signature enveloppante est une signature qui contient tout ou partie des données qu'elle référence. Ces données sont présentes dans des nœuds Object au même niveau que SignedInfo et SignatureValue. Object possède un attribut id afin qu'il soit possible de le référencer avec l'attribut URI du nœud Reference.</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;SignedInfo<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     …     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Reference</span> <span style="color: #000066;">URI</span>=<span style="color: #ff0000;">&quot;#myId&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         …     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Reference<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/SignedInfo</span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Object</span> <span style="color: #000066;">Id</span>=<span style="color: #ff0000;">&quot;myId&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>       … <s
pan style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Object<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <h4>Identification du certificat.</h4> <p>Le destinataire doit utiliser le certificat associé à la clef privé qui a permis de générer la signature pour s'assurer de sa validité. Dans le cas où il ne serait pas en mesure de déterminer seul quel certificat doit être employé, il est possible de lui transmettre une indication en ajoutant un nœud KeyInfo dans la signature. Par exemple :</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;KeyInfo<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;KeyName<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>80F6D4F7FB242A85A853C0188A41633D124A8EDF<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/KeyName<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/KeyInfo<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Ici nous avons choisi pour nom l'empreinte SHA1 du certificat à utiliser. XMLDsig ne donne aucune indication quant à la valeur de KeyName et il est donc du ressort de l'expéditeur et du destinataire de s'accorder sur sa signification.</p> <p>Il est également possible de renseigner dans KeyInfo toutes les informations nécessaires pour calculer la clef publiques à utiliser. Le nœud suivant permet ainsi de reconstituer une clef publique RSA :</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;KeyInfo<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;KeyValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>       <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;RSAKeyValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>       <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Modulus<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>kbeoO/Uou6nJ/UALAp1N1eGHLVnFvsEiASALUhzkwHHniF50b0hcRATMdNSMjDgVphBBu0lhv+Kx Q1vL82EgQwkjSKRoSfT997peQ5CjJmzwM8fMvYcO+JgSW/h1cm0YEAcFgb2X1X/Qy0YfkboEfT1p zu1AqlP0YZ/YkjOFPFEyoi0olTxhViZqbXBpO9YuFXN7CZntkrxC+gLpCAl4T0CRmudag4XUBkgt grywq6mEfvTjcEnRvJyj09svdx16V9+XbBKcrFi28ge+P1Xv/GPVUCjyRbLvdUvTTR2fMZYec73x +X7w1VO+3ZfZEz+ZsugHFJqB3rqrZyAPTzII2w==          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Modulus<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Exponent<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>AQAB<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Exponent<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>       <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/RSAKeyValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/KeyValue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/KeyInfo<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Bien entendu, la transmission de cette information rend impossible l'identification de l'expéditeur puisque la preuve de son identité est normalement liée à la clef publique qu'il est censé avoir préalablement communiqué au destinataire dans un contexte sécurisé.</p> <p>Quoiqu’il en soit, la procédure de validation, appelée core validation, est une procédure en deux étapes :</p> <ol> <li>validation des références : l’empreinte de chaque document référencé doit être calculée et comparée à la valeur de l’élément DigestValue correspondant ;</li> <li>validation de la signature : le contenu de SignatureValue doit être déchiffré à l’aide de la clef publique et comparé à l’empreinte de l’élément SignedInfo.</li> </ol> <h3>Présentation de la JSR 105.</h3> <p>Cette <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/security/xmldsig/overview.html" hreflang="en" title="java-xmldsig-overview">spécification</a> définie une API permettant de générer et de valider des signatures XML. Nous allons voir comment l'utiliser pour signer un document à l'aide des trois modes de signature présentés plus haut.</p> <h4>Génération de signatures.</h4> <h5>Génération d'une signature détachée.</h5> <p>Nous commençons par récupérer une instance de XMLSignatureFactory, c'est l'élément central de l'API dans la mesure où il permet de construire les différents éléments de notre signature.</p> <pre class="java code java" style="font-family:inherit">XMLSignatureFactory xmlSignatureFactory <span style="color: #339933;">=</span> XMLSignatureFactory.<span style="color: #006633;">getInstance</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Nous appelons sur cette factory le méthode newSignatureMethod pour indiquer l’algorithme de chiffrement à utiliser ; nous choisissons l'application de l'algorithme SHA256 suivi par un chiffrement RSA. newSignatureMethod possède un deuxième argument permettant de spécifier des paramètres supplémentaires spécifiques à l'algorithme utilisé. Dans notre cas cela n'est pas nécessaire.</p> <pre class="java code java" style="font-family:inherit">SignatureMethod signatureMethod <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newSignatureMethod</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Nous instancions également une méthode de canonisation :</p> <pre class="java code java" style="font-family:inherit">CanonicalizationMethod canonicalizationMethod <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newCanonicalizationMethod</span><span style="color: #009900;">&#40;</span> CanonicalizationMethod.<span style="color: #006633;">EXCLUSIVE</span>, <span style="color: #009900;">&#40;</span>C14NMethodParameterSpec<span style="color: #009900;">&#41;</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Nous construisons maintenant l'élément Reference de notre signature. Pour ce faire nous devons d'abord spécifier l'algorithme de hachage à utiliser (SHA256 dans cet exemple). Comme pour newSignatureMethod, des paramètres supplémentaires spécifiques à l'algorithme utilisé peuvent être transmis.</p> <pre class="java code java" style="font-family:inherit">DigestMethod digestMethod <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newDigestMethod</span><span style="color: #009900;">&#40;</span>DigestMethod.<span style="color: #006633;">SHA256</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Nous pouvons à présent instancier notre objet Reference en transmettant à la factory la fonction de hachage choisie et l'URL du document à signer. Nous aurions égale
ment pu ajouter une liste de transformations à effectuer (canonisation, XSLT...), une valeur d'id et le type d'URI (URL ou URN).</p> <pre class="java code java" style="font-family:inherit"><span style="color: #003399;">Reference</span> reference <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newReference</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;http://www.google-analytics.com/ga.js&quot;</span>, digestMethod, <span style="color: #000066; font-weight: bold;">null</span>, <span style="color: #000066; font-weight: bold;">null</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Nous possédons maintenant tous les éléments nécessaires pour créer l'élément SignedInfo :</p> <pre class="java code java" style="font-family:inherit">SignedInfo signedInfo <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newSignedInfo</span><span style="color: #009900;">&#40;</span>canonicalizationMethod, signatureMethod, Lists.<span style="color: #006633;">newArrayList</span><span style="color: #009900;">&#40;</span>reference<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>N'oublions pas de générer un élément KeyInfo pour indiquer le nom du certificat à utiliser pour valider la signature :</p> <pre class="java code java" style="font-family:inherit">KeyInfoFactory keyInfoFactory <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">getKeyInfoFactory</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> KeyInfo keyInfo <span style="color: #339933;">=</span> keyInfoFactory.<span style="color: #006633;">newKeyInfo</span><span style="color: #009900;">&#40;</span>Lists.<span style="color: #006633;">newArrayList</span><span style="color: #009900;">&#40;</span> keyInfoFactory.<span style="color: #006633;">newKeyName</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;certificat1&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Il ne nous reste que deux étapes à effectuer : récupérer une instance de XMLSignature paramétrée avec signedInfo et keyInfo, puis générer notre signature dans un document XML vierge.</p> <pre class="java code java" style="font-family:inherit">XMLSignature xmlSignature <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newXMLSignature</span><span style="color: #009900;">&#40;</span>signedInfo, keyInfo, <span style="color: #000066; font-weight: bold;">null</span>, <span style="color: #000066; font-weight: bold;">null</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> DocumentBuilderFactory documentBuilderFactory <span style="color: #339933;">=</span> DocumentBuilderFactory.<span style="color: #006633;">newInstance</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> documentBuilderFactory.<span style="color: #006633;">setNamespaceAware</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">true</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #003399;">Document</span> result <span style="color: #339933;">=</span> documentBuilder.<span style="color: #006633;">newDocument</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> xmlSignature.<span style="color: #006633;">sign</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">new</span> DOMSignContext<span style="color: #009900;">&#40;</span>privateKey, result<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <h5>Signature enveloppée.</h5> <p>La génération d'une signature enveloppée est identique à celle d'une signature détachée, à l'exception du fait que le document transmis au constructeur de DOMSignContext est également le document sur lequel porte la signature. Dans ce contexte, l'attribut uri de Reference doit être vide. Par ailleurs, une transformation supplémentaire doit être effectuée sur le document enveloppant&nbsp;:</p> <pre class="java code java" style="font-family:inherit">List<span style="color: #339933;">&lt;</span>Transform<span style="color: #339933;">&gt;</span> transforms <span style="color: #339933;">=</span> Lists.<span style="color: #006633;">newArrayList</span><span style="color: #009900;">&#40;</span>xmlSignatureFactory.<span style="color: #006633;">newTransform</span><span style="color: #009900;">&#40;</span>Transform.<span style="color: #006633;">ENVELOPED</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> xmlSignatureFactory.<span style="color: #006633;">newReference</span><span style="color: #009900;">&#40;</span>uri, digestMethod, transforms, <span style="color: #000066; font-weight: bold;">null</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <h5>Signature enveloppante.</h5> <p>La génération d'une signature enveloppante nécessite d'ajouter un nœud Object contenant le document à signer, ainsi qu'à donner pour valeur à l'attribut uri de Reference l'identifiant de cet Object :</p> <pre class="java code java" style="font-family:inherit">XMLObject object <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newXMLObject</span><span style="color: #009900;">&#40;</span><span style="color: #003399;">Collections</span>.<span style="color: #006633;">singletonList</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">new</span> DOMStructure<span style="color: #009900;">&#40;</span>document.<span style="color: #006633;">getDocumentElement</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>, <span style="color: #0000ff;">&quot;myId&quot;</span>, <span style="color: #000066; font-weight: bold;">null</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> DigestMethod digestMethod <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newDigestMethod</span><span style="color: #009900;">&#40;</span>DigestMethod.<span style="color: #006633;">SHA256</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #003399;">Reference</span> reference <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newReference</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;#myId&quot;</span>, digestMethod, <span style="color: #000066; font-weight: bold;">null</span>, <span style="color: #000066; font-weight: bold;">null</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; xmlSignature  <span style="color: #339933;">=</span> xmlSignatureFactory.<span style="color: #006633;">newXMLSignature</span><span style="color: #009900;">&#40;</span>signedInfo, keyInfo, Lists.<span style="color: #006633;">newArrayList</span><span style="color: #009900;">&#40;
</span>object<span style="color: #009900;">&#41;</span>, <span style="color: #000066; font-weight: bold;">null</span>, <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Les deux autre arguments pouvant être transmis à newXMLObject sont le type MIME et l'encodage de l'objet inséré.</p> <h4>validation de signatures.</h4> <p>Une signature peut être validée de deux manière : soit en donnant explicitement la clef publique à utiliser, comme ci dessous, soit avec une implémentation de KeySelector qui sera chargée de sélectionner le bonne clef, par exemple à l'intérieur d'un keystore par exemple.</p> <pre class="java code java" style="font-family:inherit">NodeList nodes <span style="color: #339933;">=</span> document.<span style="color: #006633;">getElementsByTagName</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Signature&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> Node signatureNode <span style="color: #339933;">=</span> nodes.<span style="color: #006633;">item</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> DOMValidateContext validateContext <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> DOMValidateContext<span style="color: #009900;">&#40;</span>publicKey, signatureNode<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> XMLSignature xmlSignature <span style="color: #339933;">=</span> XMLSignatureFactory.<span style="color: #006633;">getInstance</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">unmarshalXMLSignature</span><span style="color: #009900;">&#40;</span> validateContext<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> xmlSignature.<span style="color: #006633;">validate</span><span style="color: #009900;">&#40;</span>validateContext<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// true ou false</span></pre> <h3>Vers plus de simplicité.</h3> <p>L'API de la JSR105 est relativement complexe. Nous pouvons contourner ce problème en localisant cette complexité à l'intérieur de builders : l'utilisation de builders permet de réaliser des appels de méthode nécessitant moins de paramètres que l'API d'origine et donc plus explicites quand à leur finalité. <img src="/wp-content/uploads/2015/07/xmldsig-core-diag1.jpg" alt="xmldsig-diag1" style="display:block; margin:0 auto;" title="xmldsig-diag1" /></p> <p>Les principaux éléments d'une signature XML sont les nœuds Signature, SignedInfo, Reference et KeyInfo. Nous proposons donc la construction de builders dédiés : XmlSignatureBuilder, SignedInfoBuilder, ReferenceBuilder et KeyInfoBuilder. En organisant notre code de façon à ce que chaque builder de niveau N puisse lui même instancier les builders de niveau inférieur N-1, nous obtenons une logique d'appel qui épouse parfaitement la structure d'une signature XML :</p> <pre class="java code java" style="font-family:inherit"><span style="color: #003399;">Document</span> result <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> XmlSignatureBuilder<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">withKeyInfo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                     <span style="color: #006633;">withKeyName</span><span style="color: #009900;">&#40;</span>certificate, keySelector.<span style="color: #006633;">getKeyNameFunction</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>.                     <span style="color: #006633;">buildAndAttach</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">withSignedInfo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                     <span style="color: #006633;">withExclusiveCanonicalization</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                     <span style="color: #006633;">withRsaSha256Signature</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                     <span style="color: #006633;">withReference</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                         <span style="color: #006633;">withURI</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;#doc1&quot;</span><span style="color: #009900;">&#41;</span>.                         <span style="color: #006633;">withSHA256Digest</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                         <span style="color: #006633;">withExclusiveCanonicalization</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                         <span style="color: #006633;">buildAndAttach</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                     <span style="color: #006633;">withReference</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                         <span style="color: #006633;">withURI</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;#doc2&quot;</span><span style="color: #009900;">&#41;</span>.                         <span style="color: #006633;">withSHA1Digest</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                         <span style="color: #006633;">withExclusiveCanonicalization</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                         <span style="color: #006633;">buildAndAttach</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                     <span style="color: #006633;">buildAndAttach</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">withObject</span><span style="color: #009900;">&#40;</span>document1.<span style="color: #006633;">getDocumentElement</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>, <span style="color: #0000ff;">&quot;doc1&quot;</span><span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">withObject</span><span style="color: #009900;">&#40;</span>document2.<span style="color: #006633;">getDocumentElement</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>, <span style="color: #0000ff;">&quot;doc2&quot;</span><span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">buildAndSign</span><span style="color: #009900;">&#40;</span>privateKey<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Ce code permet de générer une signature enveloppante sur deux documents. La méthode withKeyName attend en paramètre le certificat contenant la clef publique qui devra être utilisée pour valider la signature ainsi qu'une instance de Function de la librairie  Guava (en attendant la généralisation de Java 8). Le rôle de cette fonction est de convertir un certificat en une String représentant son nom.</p> <p>La raison pour laquelle nous passons par une fonction pour réaliser cette opération est que nous avons réalisé une implémentation de KeySelector qui en fait déjà usage : HashKeySelector. Ce KeySelector pourra être utilisé a
u moment de la validation pour sélectionner à l'intérieur d'un keystore la clef publique dont l'empreinte correspond à la valeur de l'élément KeyName :</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000066; font-weight: bold;">boolean</span> validate <span style="color: #339933;">=</span> XmlSignatureValidationFactory.                 <span style="color: #006633;">fromKeySelector</span><span style="color: #009900;">&#40;</span>keySelector<span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">validate</span><span style="color: #009900;">&#40;</span>document<span style="color: #009900;">&#41;</span> <span style="color: #339933;">;</span></pre> <p>XmlSignatureValidationFactory est une factory qui retourne une instance de XmlSignatureValidation. Il en existe deux implémentations : PublicKeyXmlSignatureValidation qui effectue une validation à partir d'une clef publique donnée et KeySelectorXmlSignatureValidation qui effectue une validation en utilisant l'implémentation de KeySelector que nous venons de présenter.</p> <p><img src="/wp-content/uploads/2015/07/xmldsig-core-diag2.jpg" alt="xmldsig-diag2" style="display:block; margin:0 auto;" title="xmldsig-diag2" /></p> <p>Cette surcouche ne couvre sans doute pas tous les cas de figure prévus par XMLDsig. Elle remplacera néanmoins avantageusement une utilisation directe de la JSR-105 pour les cas d'utilisation les plus simples. Les sources sont disponibles sur le <a href="https://github.com/Zenika/Blogs/tree/master/20131015_XML-Signature-Syntax-and-Processing/XMLDsig/src" title="sources">repo GitHub de Zenika</a>.</p>