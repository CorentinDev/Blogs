---
ID: 176
post_title: Intégrer RPM avec Maven et Jenkins 1/2
author: dboukelmoune
post_date: 2012-07-25 09:30:00
post_excerpt: "<p>Le mouvement <em>DevOps</em> fait de plus en plus parler de lui, et parmi les concepts qu'on y trouve, figure le packaging natif. Après quelques mois passés sur un projet livré en RPM, je vous propose de partager mon retour d'expérience sur le sujet. Pour faire simple, je suis convaincu par le packaging natif, surtout dans un cadre <em>entreprise</em>. Mais plutôt que de vous présenter ce qui a été fait en mission, je vous propose un cocktail Maven-RPM servi par Jenkins. Dans ce premier article, je découvre avec vous le <em>rpm-maven-plugin</em> que je n'avais encore jamais utilisé.</p>"
layout: post
permalink: http://blog.zenika-offres.com/?p=176
published: true
---
<p>Le mouvement <em>DevOps</em> fait de plus en plus parler de lui, et parmi les concepts qu'on y trouve, figure le packaging natif. Après quelques mois passés sur un projet livré en RPM, je vous propose de partager mon retour d'expérience sur le sujet. Pour faire simple, je suis convaincu par le packaging natif, surtout dans un cadre <em>entreprise</em>. Mais plutôt que de vous présenter ce qui a été fait en mission, je vous propose un cocktail Maven-RPM servi par Jenkins. Dans ce premier article, je découvre avec vous le <em>rpm-maven-plugin</em> que je n'avais encore jamais utilisé.</p>
<!--more-->
<h3>A la découverte de RPM</h3> <p>Cet article suppose une connaissance préalable de Maven, Jenkins sert surtout à illustrer la partie intégration continue. Avant de mettre les mains dans le code, je vous propose un tour d'horizon de RPM.</p> <p>Pour commencer, RPM signifie RPM Package Manager (très geek le nom récursif =) et fait partie de la <acronym title="Linux Standard Base">LSB</acronym> en tant que gestionnaire de paquets officiel. Les puristes préfèreront le packaging <em>Deb</em>, mais pour des environnements cibles <acronym title="Red Hat Enterprise Linux">RHEL</acronym>, le choix est vite fait. Le packaging natif apporte plus qu'une simple archive (zip, tar.gz, jar, war...) c'est un mélange de fichiers, de métadonnées et de scripts, une archive autonome et autosuffisante (aux dépendances près). Dans le cas de RPM, on dispose de plusieurs outils en ligne de commande (principalement la commande <em>rpm</em>) pour exploiter ces paquets. Outre les classiques installations et désinstallations, il est possible d'extraire beaucoup d'informations à partir d'un paquet.</p> <p>Côté exploitation donc, on utilisera rarement la commande <em>rpm</em> directement, on lui préfèrera généralement des surcouches. La plus connue est probablement <acronym title="Yellowdog Updater Modified">YUM</acronym> qui propose en ligne de commandes un jeu d'instructions plus humain et de plus haut niveau (eg. <em>yum install &lt;nom&gt;</em> à la place de <em>rpm -i &lt;fichier&gt;</em>) et permet surtout de récupérer automatiquement les dépendances. Il n'est pas forcément nécessaire de passer par de la ligne de commande, il existe des surcouches web , et certains outils comme <a href="http://wiki.opscode.com/display/chef/Resources#Resources-Package" hreflang="en">Chef</a> sont capables de travailler avec des RPM. A noter qu'il est recommandé de signer ses RPM, en particulier pour un usage sur environnement cible.</p> <h4>Socle d'installation</h4> <p>Un fichier RPM, ce n'est pas juste des fichiers, des métadonnées et des scripts comme dit précédemment. C'est aussi des <em>workflows</em> d'exécution prédéfinis, signe d'une certaine maturité de l'outil. L'installation d'un paquet par exemple, passera par une série prédéfinie d'étapes qui correspondent chacunes à l'exécution d'une <em>scriptlet</em>. On peut y faire à peu près ce qu'on veut, comme créer un utilisateur dédié à l'application, enregistrer un service au démarrage du système.</p> <h5>Worflow simplifié d'installation&nbsp;:</h5> <ul> <li>exécution de la <em>scriptlet</em> <code>%pre</code></li> <li>copie des fichiers</li> <li>exécution de la <em>scriptlet</em> <code>%post</code></li> </ul> <h5>Worflow simplifié de désinstallation&nbsp;:</h5> <ul> <li>exécution de la <em>scriptlet</em> <code>%preun</code></li> <li>suppression des fichiers</li> <li>exécution de la <em>scriptlet</em> <code>%postun</code></li> </ul> <p>Les <em>scriptlets</em> ne sont executées que si elles existent dans le RPM, et pour en savoir plus sur la construction de RPM, nous allons nous intéresser à la commande <em>rpmbuild</em>.</p> <p><a name="construire-des-rpm"></a></p> <h3>Construire des RPM</h3> <p>La construction de RPM n'est pas un exercice difficile en soit, il nécessite cependant quelques connaissances systèmes. La difficulté principale, se situera dans les paquets à créer, au cas par cas, en fonction de ce qu'on cherche à réaliser. Par exemple, comment réaliser une mise à jour (eg. <em>yum upgrade</em> ou <em>rpm -U</em>) d'une application en cours d'exécution&nbsp;? C'est à mon sens un des points clés du DevOps&nbsp;: certaines questions de packaging pourront être adressées par les développeurs, d'autres en revanche nécessiteront une collaboration avec d'autres acteurs (administrateurs systèmes, DBA etc).</p> <p>La commande <em>rpmbuild</em> donc, s'appuie sur des fichiers <em>spec</em> qui décrivent au moins un paquet. Le fichier <em>spec</em> est l'équivalent de notre <em>pom.xml</em>, et va contenir les éléments suivants&nbsp;:</p> <ul> <li>Une (des) fiche(s) d'identité</li> <li>Les relations de dépendances (dans les deux sens)</li> <li>Des scripts</li> <li>Un changelog</li> </ul> <p>On distinguera plusieurs types de scripts, ceux exécutés au build-time, et ceux embarqués dans le RPM, les <em>scriptlets</em>.</p> <p>Le cycle de vie de construction passe par les <em>sections</em> suivantes, l'équivalent des <em>phases</em> de Maven&nbsp;:</p> <ul> <li><code>%prep</code> -&gt; à peu près <em>process-sources</em></li> <li><code>%build</code> -&gt; <em>compile</em></li> <li><code>%check</code> -&gt; <em>test</em></li> <li><code>%install</code> -&gt; à peu près <em>prepare-package</em><sup>[<a href="#pnote-362-1" id="rev-pnote-362-1">1</a>]</sup></li> <li><code>%files</code> -&gt; particulier, on peut l'assimiler de loin à <em>verify</em></li> <li><code>%clean</code> -&gt; n'est pas un cycle à part entière comme pour Maven</li> </ul> <p>Je ne vais pas détailler l'ensemble aujourd'hui, parce qu'il y a beaucoup à dire, et qu'aujourd'hui nous allons utiliser le <em>rpm-maven-plugin</em> qui nous masque l'invocation de <em>rpmbuild</em> et la création de la <em>spec</em> RPM.</p> <p>On notera cependant qu'il existe une étape de construction dans <em>rpmbuild</em> qui s'utilise traditionnellement avec les outils <em>make</em>, <em>automake</em> et <em>autoconf</em>. J'ai donc identifié deux intégrations possibles entre Maven et RPM&nbsp;:</p> <ul> <li>naturelle du point de vue RPM&nbsp;: invocation de <code>mvn</code> dans la section <code>%build</code></li> <li>naturelle du point de vue Maven&nbsp;: extension du packaging à l'aide d'un plugin dédié</li> </ul> <p>Chaque approche essaye de résoudre le conflit sur le <em>point d'entrée</em> du build, que les deux outils révendiquent de par leurs conceptions respectives. On notera cependant que la construction du <em>fichier</em> RPM sera toujours postérieure au build Maven.</p> <p><a name="sirkuttaa"></a></p> <h3>Sirkuttaa</h3> <p>Afin d'illustrer la construction de RPM, il est nécessaire d'avoir plus qu'un simple livrable Java à construire. J'ai donc décidé de créer un client twitter en ligne de commande. Pour offrir une expérience utilisateur convenable, la ligne de commande ne doit pas commencer par <code>java -jar</code> ou nécessiter de faire passer toute la configuration à grand renfort de <code>-Dsystem.properties</code>. En terme de configuration, il doit être possible de choisir le nombre de tweets maximum à récupérer et de définir un <em>timeout</em> global.</p> <p>Le paquet contiendra donc&nbsp;:</p> <ul> <li>un script dans <code>/usr/bin</code></li> <li>des jar dans <code>/usr/lib</code></li> <li>de la configuration dans <code>/etc</code></li> </ul> <p>C'est ainsi qu'est né Sirkuttaa, fruit d'un intense brainstorming avec Google Traduction. Après être parti à la découverte des <acronym title="Application Programming Interface">API</acronym> Twitter (oui sirkuttaa est mon hello world Twitter :), en l'espace de quelques classes j'obtenais mon client en ligne de commande. Il ne restait donc plus qu'à attaquer (enfin !) la création du RPM. C'est donc armé d'un moteur de recherche, que je suis allé voir ce que Maven a à m'offrir.</p> <h4>Plugins Maven</h4> <p>N'ayant jamais construit de RPM à l'aide de Maven, un petit travail de recherche était nécessaire. J'ai rapidement trouvé le <a href="http://maven-plugins.sourceforge.net/maven-rpm-plugin/index.html" hreflang="en">maven-rpm-plugin</a> <sup>[<a href="#pnote-362-2" id="rev-pnote-362-2">2</a>]</sup> et le <a href="http://mojo.codehaus.org/rpm-maven-plugin/" hreflang="en">rpm-maven-plugin</a>. Aucun de ces plugins n'est activement maintenu, la mise à jour la plus récente remonte à 2010, une version alpha!</p> <p>Après quelques tests, je découvre que ces plugins sont en fait des wrappers à la commande <em>rpmbuild</em>, qui fonctionnent un peu comme le <em>maven-assembly-plugin</em>. La documentation est aussi assez claire là-dessus: l'utilisation de ces plugins suppose une connai
ssance préalable dans la construction de RPM. Cela-dit, cette connaissance est à relativiser. Pour des paquets simples, je pense que ce n'est pas critique. Par contre c'est indispensable lorsqu'on commence à utiliser des mécanismes plus avancés comme les <em>scriptlets</em>. Le <em>rpm-maven-plugin</em> semble cependant se démarquer&nbsp;: dernière mise à jour plus récente, et c'est celui évoqué dans toutes les présentations que j'ai vues sur le sujet. J'ai en toute logique choisi de l'utiliser.</p> <p>A l'utilisation, le plugin s'avère un peu bancal. Le vocabulaire adopté n'est pas toujours celui de RPM (par exemple <em>license</em> devient <em>copyright</em>). Ensuite, pas sa conception, le plugin mélange maladroitement les sections <code>%install</code> et <code>%files</code>.</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.codehaus.mojo<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>rpm-maven-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>2.0.1<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>sirkuttaa<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;group<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Zenika/Blog<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/group<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;packager<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Zenika<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/packager<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;needarch<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>noarch<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/needarch<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;copyright<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>GPLv2+<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/copyright<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;defaultFilemode<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>644<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/defaultFilemode<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;defaultUsername<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>root<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/defaultUsername<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;defaultGroupname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>root<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/defaultGroupname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;defaultDirmode<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>755<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/defaultDirmode<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;requires<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;require<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>java<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/require<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/requires<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;mappings<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/usr/lib/sirkuttaa<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dependency</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;sources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;source<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 						<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;location<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>${project.build.directory}/${project.build.finalName}.jar<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/location<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/source<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/sources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="colo
r: #000000; font-weight: bold;">&lt;mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/usr/bin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;directoryIncluded<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>false<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/directoryIncluded<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;filemode<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>755<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/filemode<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;sources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;source<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 						<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;location<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>src/main/scripts<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/location<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/source<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/sources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/etc<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;directoryIncluded<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>false<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/directoryIncluded<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>noreplace<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;sources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;source<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 						<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;location<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>src/main/config<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/location<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/source<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/sources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/mappings<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Et surtout, le plugin invoque explicitement la commande <em>rpmbuild</em>, ce qui faire perdre sa portabilité au build. Selon moi, je dois pouvoir arriver sur un projet Maven et exécuter <code>mvn install</code>, si ce n'est pas le fonctionnement par défaut (la convention), c'est que le build est à revoir (idéalement j'invoque juste <code>mvn</code> et une phase par défaut a été prévue). Le développeur doit pouvoir reproduire le build, et sous Windows ce n'est possible qu'avec Cygwin et son paquet <a href="http://cygwin.com/cgi-bin2/package-cat.cgi?file=rpm-build%2Frpm-build-4.1-2&amp;grep=rpmbuild" hreflang="en" title="Cygwin Package Listing">rpm-build</a>. Heureusement, Maven propose via ses mécanismes de profils de ne générer le RPM que si la commande <em>rpmbuild</em> est disponible, et en plus ce n'est pas verbeux&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #808080; font-style: italic;">&lt;!-- un &quot;simple&quot; if file /usr/bin/rpmbuild exists then attach rpm --&gt;</span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;profiles<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;profile<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;id<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>rpmbuild<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/id<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;activation<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;file<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;exists<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/usr/bin/rpmbuild<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/exists<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/file<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/activation<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;build<span style="color: #000000; font-weight: bold;">&gt;</span></s
pan></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugins<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.codehaus.mojo<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>rpm-maven-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;executions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 						<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;execution<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 							<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;phase<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>package<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/phase<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 							<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;goals<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 								<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;goal<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>attached-rpm<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/goal<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 							<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/goals<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 						<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/execution<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 					<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/executions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugins<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/build<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/profile<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/profiles<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Au final, j'ai tout de même eu l'impression de me battre avec l'outil et de devoir faire sans arrêt des compromis, un peu comme avec <a href="/index.php?post/2012/03/28/Presentation-de-MyBatis" hreflang="fr" title="Oui je préfère MyBatis :p">JPA</a>. Mais j'obtiens tout de même un RPM, dont l'installation se déroule correctement, et je suis capable d'utiliser Sirkuttaa. Je peux même exécuter quelques commandes pour par exemple connaître la liste des des fichiers, voire la liste des fichiers de configuration&nbsp;:</p> <pre> $ rpm -ql sirkuttaa /etc/sirkuttaa /etc/sysconfig/sirkuttaa /usr/bin/sirkuttaa /usr/lib/sirkuttaa /usr/lib/sirkuttaa/commons-io-2.3.jar /usr/lib/sirkuttaa/jackson-core-asl-1.9.7.jar /usr/lib/sirkuttaa/jackson-mapper-asl-1.9.7.jar /usr/lib/sirkuttaa/sirkuttaa-1.jar $ rpm -qc sirkuttaa /etc/sirkuttaa /etc/sysconfig/sirkuttaa </pre> <h3>Continuous Delivery</h3> <p>La construction du RPM en elle même ne présente au final pas tant d'intérêt que ça, si ce n'est que l'équipe de développement est impliquée très tôt dans la construction des livrables pour les environnements cibles. Si on ajoute une petite dose d'intégration continue à notre cocktail Maven-RPM, on obtient à tout moment un livrable vérifié, stable, prêt à être installé. On peut aller plus loin en signant automatiquement tout RPM construit, voire en le déployant automatiquement&nbsp;: rappelez-vous, un paquet natif est autonome<sup>[<a href="#pnote-362-3" id="rev-pnote-362-3">3</a>]</sup>.</p> <p>La seule chose à prévoir du côté de Jenkins, c'est évidemment d'installer <em>rpmpbuild</em>. Le <em>rpm-maven-plugin</em> attache automatiquement le RPM généré au Reactor de Maven, il sera donc automatiquement archivé par Jenkins. Il sera également déployé (au sens Maven cette fois) automatiquement. On obtient donc clé en main de quoi faire de la livraison continue, sans avoir à fournir d'autre effort que créer un <em>job</em> de type Maven.</p> <p><img src="/wp-content/uploads/2015/07/jenkins-build-artifacts.png" alt="Récupération des artéfacts du build" style="display:block; margin:0 auto;" /></p> <h3>Conclusion</h3> <p>Arrivé ici, vous devriez normalement vous dire qu'au final vous n'avez pas appris grand chose sur RPM, c'est normal. Pour ma part j'ai découvert <strong>avec vous</strong> le <em>rpm-maven-plugin</em> et je dois avouer que je suis plutôt surpris. J'avais un à-priori très négatif sur ce plugin, et je pense aujourd'hui que c'est probablement la solution la plus efficace pour construire des RPM avec un projet Maven. On obtient à moindre coût une infrastructure de livraison continue, sans effort important de configuration! Ça ne dispense par contre pas de connaître <em>rpmbuild</em> et la construction classique de RPM, ce que je vous propose de découvrir dans un prochain article, avec à nouveau Sirkuttaa en guise d'exemple.</p> <p>En attendant, vous pouvez toujours jouer avec Sirkuttaa&nbsp;:</p> <pre> $ mvn clean package $ sudo rpm -i target/rpm/sirkuttaa/RPMS/noarch/sirkuttaa-1-1.noarch.rpm $ sirkuttaa ZenikaIT &gt; Retour sur le #MongoDB Day Paris: http://t.co/M7uwPdgg, merci @10gen pour cet évènement! &gt; Bilan, photos et interviews vidéos des équipes de la #zNight, tout est ici : http://t.co/3XifivM9 #hackathon #GoogleTV #Android &gt; RT @alecharp: Prochain @HckrgartenParis chez @ZenikaIT. Une nouvelle édition pleine de bonne humeur et de commiter! http://t.co/sSw2ZRHu &gt; La 1ère #zNight est finie, bravo à tous pour vos super idées #Android #GoogleTV, un grand, grand merci à #Google et #Sony pour leur soutien &gt; Plus que quelques minutes à la #zNight avant les démos des applis réalisées! #Android #GoogleTV &gt; RT @rolios: Hey @googletvdev we have about 20 developers spending their night coding on #googleTV in France! Hope to get nice apps! #zni ... &gt; RT @queinnec: #GoogleTV by #Sony http://t.co/lb1yHLUq &gt; #Sony #GoogleTV at Zenika, admiring the remote featuring 2 sides, keyboard + classic remote… very nice looking! #Android #hackathon &gt; Zenika organise une conférence sur l'architecture de #Varnish jeudi; il reste quelques places, inscrivez-vous vite sur http://t.co/oHhUl5WU &gt; Y'a plein de boissons énergisantes :) RT @n0tnull: Ce soir hackathon sur une Google TV, ça va être funky vu le peu de sommeil... *_* </pre> <p>Les sources de l'article sont récupérables sur <a href="https://github.com/Zenika/Blogs/tree/master/20120725_RPM-Maven-Jenkins-1">github</a>.</p> <div class="footnotes"><h4>Notes</h4> <p>[
<a href="#rev-pnote-362-1" id="pnote-362-1">1</a>] En adoptant cette correspondance entre section <em>rpmbuild</em> et phase Maven on peut faire une croix sur les tests d'intégration</p> <p>[<a href="#rev-pnote-362-2" id="pnote-362-2">2</a>] Il existe un second <a href="https://github.com/ghaskins/maven-rpm-plugin" hreflang="en">maven-rpm-plugin</a> que je n'ai pas testé</p> <p>[<a href="#rev-pnote-362-3" id="pnote-362-3">3</a>] Attention aux régressions dans la <em>spec</em> RPM, il faut de toute façon tester son RPM (installation, mise à jour ...)</p></div> 