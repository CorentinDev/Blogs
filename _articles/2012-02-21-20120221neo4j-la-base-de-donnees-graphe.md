---
ID: 109
post_title: Neo4j la base de données graphe
author: arouaze
post_date: 2012-02-21 11:16:00
post_excerpt: '<p>Les bases de données relationnelles ont pu résoudre la plupart des problématiques de stockage pour les données de nos applications. Mais de temps en temps Il se peut que cela devienne très compliqué de représenter de façon relationnelle certains types de données. Par exemple un graphe dynamique d’objet du même type. Je vous invite donc, à découvrir une autre face du monde des bases de données.</p>'
layout: post
permalink: http://blog.zenika-offres.com/?p=109
published: true
---
<p>Les bases de données relationnelles ont pu résoudre la plupart des problématiques de stockage pour les données de nos applications. Mais de temps en temps Il se peut que cela devienne très compliqué de représenter de façon relationnelle certains types de données. Par exemple un graphe dynamique d’objet du même type. Je vous invite donc, à découvrir une autre face du monde des bases de données.</p>
<!--more-->
<h3>Présentation de Neo4j</h3> <p>Imaginez une application de réseau social comme Facebook, Viadeo ou Linkedin dans laquelle l’utilisateur peut se lier avec des amis. Cet utilisateur veut savoir quels amis il a en commun avec d’autres amis. Grâce à un graphe, il pourrait facilement voir ces relations. En voici un exemple basique :</p> <p><img src="/wp-content/uploads/2015/07/.Graph_example_3_m.jpg" alt="Graph example 1" style="display:block; margin:0 auto;" title="Graph example 1" /></p> <p>L’implémentation du schéma ci-dessus dans une base de données relationnelle n’est pas facile. Il existe plusieurs façons de le faire, comme le Pattern Querie pour faire des résolutions, mais cela reste compliqué à utiliser. Pour résoudre ces problèmes plusieurs bases de données de type graphe existent, dont la célèbre base Neo4j ainsi que HyperGraphDB et InfoGrid.</p> <p>Dans un graphe nous allons pouvoir stocker deux types d’informations : des nœuds et des liens. En anglais des nodes et des edges. Chaque nœud peut posséder plusieurs liens qui pointent sur d’autres nœuds. C’est grâce à cela que les relations peuvent se faire entre les nœuds. Elles vont ainsi nous permettent de les organiser. De plus chaque nœud peut avoir plusieurs propriétés ou attributs pour stoker sous forme de clé/valeur nos données.</p> <p><strong>En bref</strong> : Un graph stocke des données dans des nœuds qui ont des propriétés.</p> <p>Les relations organisent les nœuds entre eux. Nous allons pouvoir trier nos données sous forme de liste, d’arbre ou d’une façon plus libre en fonction de nos besoins. Elles peuvent avoir plusieurs directions, soit sortante, soit entrante ou les deux à la fois. De même que les nœuds, elle peuvent elle aussi avoir des propriétés pour nous faciliter l’organisation.</p> <p><strong>En bref</strong> : Les nœuds sont organisés par des relations qui ont-elles même des propriétés.</p> <p>Il existe deux façons de récupérer des données dans un graphe. Soit par une traversée, soit avec des index. Pour la première méthode il faut « traverser » graphe de nœuds en nœuds en fonction d’un algorithme. On peut définir plusieurs options lors de la traversée : récupérer le nœud en fonction d’une valeur de ses propriétés, si le nœud possède au moins une relation sortante, etc. Si on prend l’exemple ci-dessus, on pourrait créer une traversée pour répondre à cette question : Quels amis de Martin ont au moins deux amis en commun avec lui. Voici le sous graph qui nous serait retourné :</p> <p><img src="/wp-content/uploads/2015/07/.Graph_example_4_m.jpg" alt="Graph exemple 2" style="display:block; margin:0 auto;" title="Graph exemple 2" /></p> <p>Pour résoudre cette problématique il suffit de tester s’il y a au moins deux relations sortantes pour chaque nœud.</p> <p><strong>En bref</strong> : Une traversée navigue dans le graphe à partir d’un nœud et identifie les chemins ou sous chemins avec les nœuds ordonnés en fonction d’options.</p> <p>La deuxième manière de récupérer un nœud ou une relation de façon plus spécifique est d’utiliser les index. Grâce à cela nous allons pouvoir récupérer un nœud directement en fonction d’une valeur de ses propriétés. Si on reprend l’exemple plus haut, la base de données pourra nous retourner un nœud en fonction son attribut « nom ».</p> <p><strong>En bref</strong> : Un index est mappé par les propriétés des nœuds et des relations.</p> <p>Et Neo4j dans tout ça ?</p> <p>La base de données permet de gérer tous ces types d’objet, nœuds, relations et index. Et grâce à des algorithmes, des outils internes et des modules externes comme Apache Lucuene, Cypher, ou Gremlin la récupération de nos données est plus facile.</p> <h3>Mise en pratique</h3> <p>Nous allons mettre en pratique l’exemple de la présentation en utilisant la version embarquée de Neo4j. Créez un projet Maven avec votre IDE préféré et rajoutez cette dépendance dans le pom :</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.neo4j<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>neo4j<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>1.6<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Dans Neo4j chaque relation doit être typée. Nous allons donc créer une énumération qui représentera tous les types de notre graphe :</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">enum</span> RelTypes <span style="color: #7F0055; font-weight: bold;">implements</span> RelationshipType <span style="color: #000000;">&#123;</span>     FRIEND <span style="color: #000000;">&#125;</span></pre> <p>Ensuite créez une classe avec la classique méthode main. Pour créer et démarrer la base de données Neo4j en mode embarqué, il suffit de déclarer un objet de type GraphDatabaseService et de l’instancier avec la classe EmbeddedGraphDatabase en passant comme paramètre au constructeur le chemin de la base :</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Main <span style="color: #000000;">&#123;</span> <span style="color: #7F0055; font-weight: bold;">private</span> GraphDatabaseService graphDB;     <span style="color: #7F0055; font-weight: bold;">public</span> Main<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         graphDB = <span style="color: #7F0055; font-weight: bold;">new</span> EmbeddedGraphDatabase<span style="color: #000000;">&#40;</span>DB_PATH<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span>     <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> shutDownDB<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         graphDB.<span style="color: #000000;">shutDown</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span>     <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">void</span> main<span style="color: #000000;">&#40;</span><span style="color: #000000;">String</span><span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> args<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         Main main = <span style="color: #7F0055; font-weight: bold;">new</span> Main<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#4
1;</span>;         main.<span style="color: #000000;">shutDown</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>La méthode shutdown de notre base de données permet de l’éteindre correctement. La création des nœuds est très facile. Il suffit de déclarer pour chaque nœud un nouvel objet de type Node créé à partir de notre objet graphe :</p> <pre class="java code java" style="font-family:inherit">Node martin = graphDB.<span style="color: #000000;">createNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</pre> <p>Pour lui affecter une propriété, comme le nom par exemple, il faut appeler la méthode setProperty qui prend en paramètres une clé et une valeur.</p> <pre class="java code java" style="font-family:inherit">martin.<span style="color: #000000;">setProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, <span style="color: #888888;">&quot;Martin&quot;</span><span style="color: #000000;">&#41;</span>;</pre> <p>Pour indexer le nœud « Martin » afin de le récupérer facilement, voici la démarche à faire :</p> <pre class="java code java" style="font-family:inherit">IndexManager indexManager = graphDB.<span style="color: #000000;">index</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; Index<span style="color: #000000;">&lt;</span>Node<span style="color: #000000;">&gt;</span> users = indexManager.<span style="color: #000000;">forNodes</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;users&quot;</span><span style="color: #000000;">&#41;</span>; users.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>martin, <span style="color: #888888;">&quot;name&quot;</span>, martin.<span style="color: #000000;">getProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</pre> <p>Pour créer une relation entre deux nœud une méthode createRelationship est disponible dans chaque objet de type Node. Elle prend en paramètre le nœud à lier et un type. Voici un exemple qui lie comme ami Martin avec Romain :</p> <pre class="java code java" style="font-family:inherit">Node romain = graphDB.<span style="color: #000000;">createNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> ; martin.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>romain, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;</pre> <p>Puisque nous allons créer plusieurs nœuds et relations, nous devons les encapsuler dans une transaction. Car si une erreur se produit pendant une insertion il faut invalider les présentes. Voici toutes les insertions de l’exemple :</p> <pre class="java code java" style="font-family:inherit">Transaction tx = graphDB.<span style="color: #000000;">beginTx</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span>     <span style="color: #808080; font-style: italic;">// Creation des Noeuds</span>     Node martin = graphDB.<span style="color: #000000;">createNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     martin.<span style="color: #000000;">setProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, <span style="color: #888888;">&quot;Martin&quot;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #808080; font-style: italic;">// Indexation de martin</span>     users.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>martin, <span style="color: #888888;">&quot;name&quot;</span>, martin.<span style="color: #000000;">getProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;     Node romain = graphDB.<span style="color: #000000;">createNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     romain.<span style="color: #000000;">setProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, <span style="color: #888888;">&quot;Romain&quot;</span><span style="color: #000000;">&#41;</span>;     Node matthieu = graphDB.<span style="color: #000000;">createNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     matthieu.<span style="color: #000000;">setProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, <span style="color: #888888;">&quot;Matthieu&quot;</span><span style="color: #000000;">&#41;</span>;     Node lois = graphDB.<span style="color: #000000;">createNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     lois.<span style="color: #000000;">setProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, <span style="color: #888888;">&quot;Lois&quot;</span><span style="color: #000000;">&#41;</span>;     Node sebastien = graphDB.<span style="color: #000000;">createNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     sebastien.<span style="color: #000000;">setProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, <span style="color: #888888;">&quot;Sebastien&quot;</span><span style="color: #000000;">&#41;</span>;     Node brice = graphDB.<span style="color: #000000;">createNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     brice.<span style="color: #000000;">setProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, <span style="color: #888888;">&quot;Brice&quot;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #808080; font-style: italic;">// Creation des Relations</span>     martin.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>romain, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     martin.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>matthieu, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     martin.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>lois, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     martin.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>sebastien, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     martin.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>lois, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     romain.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>lois, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     romain.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>sebastien, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     matthieu.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>romain,
 RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     matthieu.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>sebastien, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     lois.<span style="color: #000000;">createRelationshipTo</span><span style="color: #000000;">&#40;</span>brice, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;     tx.<span style="color: #000000;">success</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #000000;">&#40;</span><span style="color: #000000;">Exception</span> e<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     tx.<span style="color: #000000;">failure</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">finally</span> <span style="color: #000000;">&#123;</span>     tx.<span style="color: #000000;">finish</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; <span style="color: #000000;">&#125;</span></pre> <p>Nous allons maintenant créer la traversée qui permettra de connaitre les amis de Martin qui ont au moins deux amis en commun avec lui. Mais avant il faut récupérer le nœud grâce à l’index :</p> <pre class="java code java" style="font-family:inherit">Node martin = users.<span style="color: #000000;">get</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, <span style="color: #888888;">&quot;Martin&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getSingle</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</pre> <p>Ensuite la traversée partira de Martin et pour chaque nœud traversé nous allons récupérer ceux qui ont au moins deux relations sortantes de type Friend. Pour effectuer cette opération il faut créer un objet de type Traverser récupéré par le nœud de départ qui est Martin :</p> <pre class="java code java" style="font-family:inherit">Node martin = users.<span style="color: #000000;">get</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, <span style="color: #888888;">&quot;Martin&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getSingle</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; Traverser traverser = martin.<span style="color: #000000;">traverse</span><span style="color: #000000;">&#40;</span>Traverser.<span style="color: #000000;">Order</span>.<span style="color: #000000;">BREADTH_FIRST</span>, StopEvaluator.<span style="color: #000000;">END_OF_GRAPH</span>, <span style="color: #7F0055; font-weight: bold;">new</span> ReturnableEvaluator<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     @Override         <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">boolean</span> isReturnableNode<span style="color: #000000;">&#40;</span>TraversalPosition traversalPosition<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>             Iterable<span style="color: #000000;">&lt;</span>Relationship<span style="color: #000000;">&gt;</span> it = traversalPosition.<span style="color: #000000;">currentNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getRelationships</span><span style="color: #000000;">&#40;</span>Direction.<span style="color: #000000;">OUTGOING</span>, RelTypes.<span style="color: #000000;">FRIEND</span><span style="color: #000000;">&#41;</span>;             <span style="color: #7F0055; font-weight: bold;">int</span> i = 0;             <span style="color: #7F0055;font-weight: bold;">for</span> <span style="color: #000000;">&#40;</span>Relationship relationship : it<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>                 i++;             <span style="color: #000000;">&#125;</span>             <span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #000000;">!</span>traversalPosition.<span style="color: #000000;">isStartNode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&amp;&amp;</span> i <span style="color: #000000;">&gt;</span>= <span style="color: #cc66cc;">2</span>;         <span style="color: #000000;">&#125;</span>     <span style="color: #000000;">&#125;</span>, RelTypes.<span style="color: #000000;">FRIEND</span>, Direction.<span style="color: #000000;">OUTGOING</span><span style="color: #000000;">&#41;</span>; <span style="color: #7F0055;font-weight: bold;">for</span> <span style="color: #000000;">&#40;</span>Node node : traverser<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     <span style="color: #000000;">System</span>.<span style="color: #000000;">out</span>.<span style="color: #000000;">println</span><span style="color: #000000;">&#40;</span>node.<span style="color: #000000;">getProperty</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>; <span style="color: #000000;">&#125;</span></pre> <p>Les paramètres de la méthode traverse sont :</p> <ul> <li>Traverser.Order : Ce paramètre peut prendre deux valeurs : soit Order. BREADTH_FIRST qui force en premier la traversée de chaque relation du nœud courant ou Order.DEPTH_FIRST qui force d’abords la traversée des nœuds enfant du nœud courant.</li> <li>StopEvaluator : Ce paramètre définit la portée de la traversée dans le graphe. Ici dans l’exemple nous traversons tout le graphe.</li> <li>ReturnableEvaluator : Ce paramètre prend un objet de type ReturnableEvaluator qui contient une méthode qui définit si le nœud traversé doit être récupéré. Dans l’exemple les nœuds validés doivent avoir au moins deux relations sortantes et on exclut le nœud de départ.</li> <li>RelationshipType : Ce paramètre définit le type de relation à parcourir.</li> <li>Direction : Ce paramètre définit la direction des relations à parcourir.</li> </ul> <p>Le résultat de la traversée est :</p> <pre> Romain Matthieu </pre> <p>Vous pouvez remarquer qu’il est très simple de faire des requêtes dans ce graph grâce à Neo4j. Les requêtes plus complexes peuvent être effectuées avec le module Cypher qui propose plus d’options.</p> <h3>Conclusion</h3> <p>La base de données Neo4j se démarque de ses concurrents grâce à sa simplicité d’utilisation, ses modules et sa communauté. Pour l’instant peu utilisée en entreprise, les bases graphe permettent de résoudre des problématiques plutôt spécifiques. Mais couplée avec une base de données relationnelle la représentation des données dans les applications est bien plus simplifiée.</p> <p>De plus, le framework Java le plus connu, Spring, intègre récemment dans sa déclinaison Spring Data, le support de la base de données Neo4j. Il permet de mapper de façon avancé nos entités en graphe de données et supporte la version server de Neo4j via l’API Rest. Je vous en reparlerai dans un prochain article.</p> <h3>Annexe</h3> <p>Voici le code source complet de l'exemple&nbsp;: <a href="/wp-content/uploads/2015/07/Neo4jExample.zip">source</a>.</p>