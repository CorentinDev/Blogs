---
ID: 195
post_title: 'Failover with RabbitMQ, the sender&#039;s story'
author: Arnaud Cogolu√®gnes
post_date: 2012-03-30 09:20:00
post_excerpt: |
  <p>When a client connects to a <a href="http://www.rabbitmq.com/" hreflang="en">RabbitMQ</a> instance, it must be able to handle the failure of this instance. The cause of the failure can be an abrupt crash or a network glitch. These things happen, especially in cloud environments, where anything can die, anytime. Applications can't rely blindly on the middleware; the software must be able to recover from these kinds of failure, and not crash miserably. Let's see how a message sender can be made more robust and reliable with the <a href="http://www.rabbitmq.com/api-guide.html" hreflang="en">RabbitMQ Java binding</a> first, and then with the <a href="http://www.springsource.org/spring-amqp" hreflang="en">Spring AMQP</a>  project.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=195
published: true
---
<p>When a client connects to a <a href="http://www.rabbitmq.com/" hreflang="en">RabbitMQ</a> instance, it must be able to handle the failure of this instance. The cause of the failure can be an abrupt crash or a network glitch. These things happen, especially in cloud environments, where anything can die, anytime. Applications can't rely blindly on the middleware; the software must be able to recover from these kinds of failure, and not crash miserably. Let's see how a message sender can be made more robust and reliable with the <a href="http://www.rabbitmq.com/api-guide.html" hreflang="en">RabbitMQ Java binding</a> first, and then with the <a href="http://www.springsource.org/spring-amqp" hreflang="en">Spring AMQP</a>  project.</p>
<!--more-->
<h3>Context</h3> <p>Here is the context:</p> <ul> <li>The sender measures temperature every second and sends a message.</li> <li>A consumer is consuming from a <code>temperature</code> queue and displays the temperature on the console (we won't show the consumer code in this post). Don't forget to create the <code>temperature</code> queue if you're running the sample.</li> <li>There are 3 nodes in the cluster, they all run locally, on different ports. You wouldn't do that in production, but this is handy to test failure of a cluster node. Note the sample works even if you're not running a cluster.</li> <li>When it detects a failure, the client tries to reconnect to another node. It picks the node randomly.</li> </ul> <h3>Sending messages with RabbitMQ Java binding</h3> <p>RabbitMQ comes with bindings (= drivers) for different languages. The <a href="http://www.rabbitmq.com/api-guide.html" hreflang="en">Java binding</a> works great and is directly usable in applications, even if it can be considered a little bit "low-level". Let's see how to implement our bulletproof sender with the Java binding.</p> <h4>The main sending loop</h4> <p>The main loop does the following:</p> <ul> <li>It asks for a first channel instance on a specific port (it's then easier to choose the node that will crash first)</li> <li>It starts looping and sending temperature to the default exchange, with <code>temperature</code> as the routing key. The messages are then automatically routed to the <code>temperature</code> queue (if it exists).</li> <li>If the sending fails, the sender asks for a new channel.</li> </ul> <p>Note the <code>channel</code> methods can't fail: they loop until they get a channel. We'll see their code later.</p> <p>Here is the main loop:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">void</span> main<span style="color: #000000;">&#40;</span><span style="color: #000000;">String</span> <span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> args<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>   Channel channel = channel<span style="color: #000000;">&#40;</span>FIRST_CONNECTION_PORT<span style="color: #000000;">&#41;</span>;   <span style="color: #7F0055;font-weight: bold;">while</span> <span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">true</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     letsWait<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;  <span style="color: #808080; font-style: italic;">// sends a measure every second</span>     <span style="color: #000000;">String</span> temperature = measureTemperature<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span>       channel.<span style="color: #000000;">basicPublish</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;&quot;</span>, <span style="color: #888888;">&quot;temperature&quot;</span>, <span style="color: #7F0055; font-weight: bold;">null</span>,temperature.<span style="color: #000000;">getBytes</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #000000;">&#40;</span><span style="color: #000000;">Exception</span> e<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>        <span style="color: #000000;">System</span>.<span style="color: #000000;">err</span>.<span style="color: #000000;">println</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;Message sending failed, trying to reconnect&quot;</span><span style="color: #000000;">&#41;</span>;        channel = channel<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span>   <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <h4>Channel creation</h4> <p>This is where things get interesting. The channel creation hides the failure and retry logic to the main loop. The <code>channel</code> method loops until it gets a connection on the passed in port parameter. Note it delegates the connection creation to another method (more on this later).</p> <p>Here is the code of the channel creation:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">static</span> Channel channel<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">int</span> portSuggestion<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>   Channel channel = <span style="color: #7F0055; font-weight: bold;">null</span>;   <span style="color: #7F0055;font-weight: bold;">while</span> <span style="color: #000000;">&#40;</span>channel == <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span>       <span style="color: #000000;">Thread</span>.<span style="color: #000000;">sleep</span><span style="color: #000000;">&#40;</span><span style="color: #cc66cc;">500</span><span style="color: #000000;">&#41;</span>;       channel = connection<span style="color: #000000;">&#40;</span>portSuggestion<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">createChannel</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;       <span style="color: #7F0055; font-weight: bold;">return</span> channel;     <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #000000;">&#40;</span><span style="color: #000000;">Exception</span> e<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>       <span style="color: #000000;">System</span>.<span style="color: #000000;">err</span>.<span style="color: #000000;">println</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;Connection to broker failed, trying again&quot;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span>   <span style="color: #000000;">&#125;</span>   <span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #7F0055; font-weight: bold;">null</span>; <span style="color: #000000;">&#125;</span> &nbsp; <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> Channel channel<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>   <span style="color: #808080; font-style: italic;">// not suggestion for the port</span>   <span style="color: #7F0055; font-weight: bold;">return</span> channel<span style="color: #000000;">&#40;</span>-<span style="color: #cc66cc;">1</span><span style="color: #000000;">&#41;</span>; <span style="color: #000000;">&#125;</span></pre> <h4>Connection creation</h4> <p>At last, the creation of the connection. In this method, the client doesn't try endlessly to reconnect to the same node, it picks a node randomly. This is useful if the cause of the failure is a crash rather than a transient network glitch.</p> <p>Here is the code that creates the connection:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-
weight: bold;">static</span> <span style="color: #000000;">Connection</span> connection<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">int</span> portSuggestion<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">IOException</span> <span style="color: #000000;">&#123;</span>   ConnectionFactory factory = <span style="color: #7F0055; font-weight: bold;">new</span> ConnectionFactory<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;   factory.<span style="color: #000000;">setUsername</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;guest&quot;</span><span style="color: #000000;">&#41;</span>;   factory.<span style="color: #000000;">setPassword</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;guest&quot;</span><span style="color: #000000;">&#41;</span>;   factory.<span style="color: #000000;">setVirtualHost</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;/&quot;</span><span style="color: #000000;">&#41;</span>;   factory.<span style="color: #000000;">setHost</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;localhost&quot;</span><span style="color: #000000;">&#41;</span>; &nbsp;   <span style="color: #7F0055; font-weight: bold;">int</span> serverPort = portSuggestion == -<span style="color: #cc66cc;">1</span> <span style="color: #000000;">?</span> pickPortRandomly<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> : portSuggestion;   <span style="color: #000000;">System</span>.<span style="color: #000000;">out</span>.<span style="color: #000000;">println</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;Connecting on port &quot;</span>+serverPort<span style="color: #000000;">&#41;</span>; &nbsp;   factory.<span style="color: #000000;">setPort</span><span style="color: #000000;">&#40;</span>serverPort<span style="color: #000000;">&#41;</span>;   <span style="color: #000000;">Connection</span> connection = factory.<span style="color: #000000;">newConnection</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;   <span style="color: #7F0055; font-weight: bold;">return</span> connection; <span style="color: #000000;">&#125;</span> &nbsp; <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">int</span> pickPortRandomly<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>   <span style="color: #7F0055; font-weight: bold;">return</span> SERVER_PORTS<span style="color: #000000;">&#91;</span>RANDOM.<span style="color: #000000;">nextInt</span><span style="color: #000000;">&#40;</span>SERVER_PORTS.<span style="color: #000000;">length</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#93;</span>; <span style="color: #000000;">&#125;</span></pre> <h4>Testing</h4> <p>You can run the sender and the consumer classes. To simulate a failure, you can stop the Erlang application.</p> <p>If you're running a standalone RabbitMQ instance (not a cluster):</p> <pre> rabbitmqctl stop_app </pre> <p>If you're running a cluster, to stop the <code>server1</code> node:</p> <pre> rabbitmqctl -n server1 stop_app </pre> <p>To restart the node, use the same command, but with <code>start_app</code> instead of <code>stop_app</code>.</p> <p>When simulating a crash, you should see the sender trying to reconnect (and the consumer as well, if you stopped its node).</p> <h4>So what?</h4> <p>Well, we built a robust and reliable message sender. The thing is this code is a little bit cumbersome, especially if we need to rewrite it everytime we want to send messages. Fortunately, higher-level libraries like Spring AMQP can help.</p> <h3>Sending messages with Spring AMQP</h3> <p><a href="http://www.springsource.org/spring-amqp" hreflang="en">Spring AMQP</a>  is part of the <a href="http://www.springsource.org/projects" hreflang="en">Spring portfolio</a> and provides an abstraction over the RabbitMQ Java binding. People familiar with Spring and/or its JMS support will feel at ease Spring AMQP. Note Spring AMQP also provides support for <a href="http://www.springsource.org/spring-integration" hreflang="en">Spring Integration</a>.</p> <h4>Configuration</h4> <p>The main class in Spring AMQP is the <code>RabbitTemplate</code>, here is how to configure it in a Spring application context:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;rabbit:connection-factory</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;connectionFactory&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span> &nbsp; <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.amqp.rabbit.core.RabbitTemplate&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;connectionFactory&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;connectionFactory&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <h4>Using the <code>RabbitTemplate</code></h4> <p>Here is our sender program, using now the <code>RabbitTemplate</code> (note the <code>RabbitTemplate</code> class implements the <code>RabbitOperations</code> interface):</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">void</span> main<span style="color: #000000;">&#40;</span><span style="color: #000000;">String</span><span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> args<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>   ApplicationContext ctx = <span style="color: #7F0055; font-weight: bold;">new</span> ClassPathXmlApplicationContext<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;/spring-amqp-sender.xml&quot;</span><span style="color: #000000;">&#41;</span>;   RabbitOperations tpl = ctx.<span style="color: #000000;">getBean</span><span style="color: #000000;">&#40;</span>RabbitOperations.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span>; &nbsp;   <span style="color: #7F0055;font-weight: bold;">while</span> <span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">true</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     letsWait<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">String</span> temperature = measureTemperature<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span>       tpl.<span style="color: #000000;">convertAndSend</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;temperature&quot;</span>,temperature<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #000000
;">&#40;</span>AmqpException e<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>       <span style="color: #000000;">System</span>.<span style="color: #000000;">err</span>.<span style="color: #000000;">println</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;Error while sending message, keeping looping...&quot;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span>   <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Is that all? Where is the error-handling code? Well, this is the <code>catch</code> block! In case of error, the <code>RabbitTemplate</code> throws a <code>AmqpException</code>. It doesn't hide that something went wrong, but it handles the reconnection transparently if we use the template again.</p> <p>There's a drawback: we can't specify several nodes to try to reconnect to. If the node is really dead, the template will try to reconnect endlessly. This can be easily avoided by using a load balancer in front of the cluster. <a href="http://haproxy.1wt.eu/" hreflang="en">HAProxy</a> is a solution that works well with RabbitMQ. The Spring configuration would point to the load balancer and the load balancer would round-robin the nodes when a connection dies.</p> <h3>What about failover for the consumer?</h3> <p>Failover for a consumer can be tricky, especially for asynchronous consumption. This is another story and would need another blog post (you can check the samples for a solution based on the Java binding). The good news is RabbitMQ provides the necessary callbacks to notify async consumers when something goes wrong and Spring AMQP also supports failover for async consumers.</p> <h3>Conclusion</h3> <p>Handling failover is complex and is a must-have for any so-called robust application. We have everything we need with RabbitMQ Java binding, but the error-handling code can be tricky and doesn't bring much value to the end-user. The Java binding is great to get started, but higher-level like Spring AMQP are more than welcome when it comes to write day-to-day application code. <a href="http://www.springsource.org/spring-amqp" hreflang="en">Spring AMQP</a> comes with many other features than failover like declarative configuration, POJO-based async consumption, etc. Don't hesitate to take a look at it!</p>