---
ID: 114
post_title: Présentation de MyBatis
author: dboukelmoune
post_date: 2012-03-28 09:03:00
post_excerpt: '<p>A l’occasion de la sortie de MyBatis 3.1.0 je vous propose de découvrir cet <acronym title="Object-Relational Mapper">ORM</acronym> pas comme les autres. Avec un niveau d’abstraction à mi-chemin entre <acronym title="Java DataBase Connectivity">JDBC</acronym> et <acronym title="Java Persistence API">JPA</acronym>, le successeur d’iBatis est activement développé&nbsp;: plusieurs mises à jour mineures se sont succédées avant l’arrivée de la version 3.1.0.</p>'
layout: post
permalink: http://blog.zenika-offres.com/?p=114
published: true
---
<p>A l’occasion de la sortie de MyBatis 3.1.0 je vous propose de découvrir cet <acronym title="Object-Relational Mapper">ORM</acronym> pas comme les autres. Avec un niveau d’abstraction à mi-chemin entre <acronym title="Java DataBase Connectivity">JDBC</acronym> et <acronym title="Java Persistence API">JPA</acronym>, le successeur d’iBatis est activement développé&nbsp;: plusieurs mises à jour mineures se sont succédées avant l’arrivée de la version 3.1.0.</p>
<!--more-->
<h3>L'ORM pas comme les autres</h3> <p>MyBatis est un framework de persistance de base de données relationnelles, c'est un ORM au même titre que les différentes implémentations JPA&nbsp;: il transforme des données issues d'une base de données relationnelles en objets Java. La différence majeure entre JPA et MyBatis, c'est que le premier opère un mapping des objets sur des <em>tables</em> (les entités), alors que le second ne travaille qu'avec des requêtes. JPA crée un couplage entre la base de données et le modèle objet par le biais d'annotations (ou en XML) là où MyBatis offre beaucoup de souplesse pour le mapping. Il est même possible de mapper les résultats sur des classes qu'on ne peut pas modifier (classes issues de bibliothèques tierces ou développées par une autre équipe par exemple).</p> <p>Principales fonctionnalités:</p> <ul> <li>Création de requêtes <em>SQL</em> dynamiques</li> <li>Mapping avancé des résultats</li> <li>Personnalisation du mapping</li> <li>Gestion des transactions</li> <li>Mise en cache des résultats</li> <li>Pool de connexion</li> <li>Configuration par environnement</li> <li>Intégration à Spring et Guice</li> </ul> <p>En terme d'outillage on trouve MyBatis Generator qui permet de démarrer son projet en générant des classes et des mappers de type <acronym title="Create Read Update Delete">CRUD</acronym>. Un plugin Eclipse permet de faciliter l'affichage du SQL dynamique. Il existe également une version .NET de MyBatis.</p> <h3>Un cas d'utilisation simple</h3> <p>Afin d'illustrer l'utilisation de MyBatis, je vous propose de prendre un modèle de données simple en entrée, et un modèle de données différent en sortie. Le modèle en entrée est représenté par des tables dans une base de données relationnelle, et le modèle en sortie est représenté par des POJO. Entre les deux&nbsp;: un <acronym title="Data Access Object">DAO</acronym> qu'il faut implémenter pour passer de notre base de données à nos objets Java. Ajoutons comme hypothèse que les classes et l'interface ne peuvent pas être modifiées.</p> <p><img src="/wp-content/uploads/2015/07/modele.png" alt="Base de données" title="Base de données" /></p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Session <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">Long</span> idFormation = <span style="color: #7F0055; font-weight: bold;">null</span>;     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">String</span> nomCours = <span style="color: #7F0055; font-weight: bold;">null</span>;     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">String</span> nomFormateur = <span style="color: #7F0055; font-weight: bold;">null</span>;     <span style="color: #7F0055; font-weight: bold;">private</span> Set<span style="color: #000000;">&lt;</span>Participant<span style="color: #000000;">&gt;</span> participants = <span style="color: #7F0055; font-weight: bold;">new</span> HashSet<span style="color: #000000;">&lt;&gt;</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; &nbsp;     ... <span style="color: #000000;">&#125;</span></pre> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Participant <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">Long</span> id = <span style="color: #7F0055; font-weight: bold;">null</span>;     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">String</span> nom = <span style="color: #7F0055; font-weight: bold;">null</span>; &nbsp;     ... <span style="color: #000000;">&#125;</span></pre> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">interface</span> SessionDao <span style="color: #000000;">&#123;</span> &nbsp;     <span style="color: #808080; font-style: italic;">/**      * Récupère la liste des sessions de formation auxquelles des      * stagiaires se sont inscrits.      */</span>     <span style="color: #7F0055; font-weight: bold;">public</span> List<span style="color: #000000;">&lt;</span>Session<span style="color: #000000;">&gt;</span> findAll<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; <span style="color: #000000;">&#125;</span></pre> <p>Et on va se prêter à l'exercice avec du JDBC brut, JdbcTemplate, MyBatis et Hibernate. Il s'agit d'implémentations <em>naïves</em>, qui se contentent d'être correctes fonctionnellement. Les aspects tels que les best practices ou le tuning de performance ne seront donc pas abordés. Les différentes solutions sont implémentées sous la forme de tests junit et permet de s'assurer que le résultat obtenu est correct. Le code source complet est disponible à la fin de l'article.</p> <p>Le résultat attendu est une liste de deux sessions, comptant trois participants chacune. D’un point de vue technique, le DAO renvoie une liste de sessions avec une relation 1-n vers des participants.</p> <h4>JDBC</h4> <p>Il s'agit là d'une API vieille de plus de 10 ans. JDBC est incontournable pour accéder à une base de données relationnelle, c'est d'ailleurs sur cette API que reposent les trois autres solutions de ce comparatif. L'ennui c'est que certaines fonctionnalités peuvent être supportées par certains drivers mais pas d'autres. Si on ajoute le fait qu'il s'agit d'une API très bas niveau, le JDBC brut n'est pas la solution à privilégier pour développer nos applications.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> JdbcSessionDao <span style="color: #7F0055; font-weight: bold;">implements</span> SessionDao <span style="color: #000000;">&#123;</span> &nbsp;     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">String</span> FIND_ALL =             <span style="color: #888888;">&quot;select fo.id as id_formation, co.nom as nom_cours, fe.nom as nom_formateur, st.id as id_stagiaire, st.nom as nom_stagiaire &quot;</span> +             <span style="color: #888888;">&quot;from formation fo, cours co, formateur fe, stagiaire st &quot;</span> +             <span style="color: #888888;">&quot;where co.id = fo.id_cours and fe.id = fo.id_formateur and fo.id = st.id_formation &quot;</span> +             <span style="color: #888888;">&quot;order by id_formation&quot;</span>; &nbsp;     @Override     <span style="color: #7F0055; font-weight: bold;">public</span> List<span style="color: #000000;">&lt;</span>Session<span style="color: #000000;">&gt;</span> findAll<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span> &nbsp;         <span style="color: #000000;">Connection</span> connection = <span style="color: #7F0055; font-weight: bold;">null</span>;         <span style="color: #000000;">Statement</span> statement = <span style="color: #7F0055; font-weight: bold;">null</span>;         <span style="color: #000000;">ResultSet</span> resultSet = <span style="color: #7F0055; font-weight: bold;">null</span>; &nbsp;         <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span>             connection = <span style="color: #000000;">DriverManager</span>.<span style="color: #000000;">getConnection</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;jdbc:
h2:mem:dataSource;DB_CLOSE_DELAY=-1&quot;</span>, <span style="color: #888888;">&quot;sa&quot;</span>, <span style="color: #888888;">&quot;&quot;</span><span style="color: #000000;">&#41;</span>;             statement = connection.<span style="color: #000000;">createStatement</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;             resultSet = statement.<span style="color: #000000;">executeQuery</span><span style="color: #000000;">&#40;</span>FIND_ALL<span style="color: #000000;">&#41;</span>; &nbsp;             Session session = <span style="color: #7F0055; font-weight: bold;">null</span>;             List<span style="color: #000000;">&lt;</span>Session<span style="color: #000000;">&gt;</span> sessions = <span style="color: #7F0055; font-weight: bold;">new</span> ArrayList<span style="color: #000000;">&lt;&gt;</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; &nbsp;             <span style="color: #7F0055;font-weight: bold;">while</span> <span style="color: #000000;">&#40;</span> resultSet.<span style="color: #000000;">next</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>                 <span style="color: #000000;">Long</span> idFormation = resultSet.<span style="color: #000000;">getLong</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;id_formation&quot;</span><span style="color: #000000;">&#41;</span>; &nbsp;                 <span style="color: #808080; font-style: italic;">// pour mapper la session il faut vérifier le changement d'id</span>                 <span style="color: #7F0055;font-weight: bold;">if</span> <span style="color: #000000;">&#40;</span> isNewSession<span style="color: #000000;">&#40;</span>session, idFormation<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>                     session = <span style="color: #7F0055; font-weight: bold;">new</span> Session<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;                     session.<span style="color: #000000;">setIdFormation</span><span style="color: #000000;">&#40;</span>idFormation<span style="color: #000000;">&#41;</span>;                     session.<span style="color: #000000;">setNomCours</span><span style="color: #000000;">&#40;</span> resultSet.<span style="color: #000000;">getString</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;nom_cours&quot;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;                     session.<span style="color: #000000;">setNomFormateur</span><span style="color: #000000;">&#40;</span> resultSet.<span style="color: #000000;">getString</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;nom_formateur&quot;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;                     sessions.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>session<span style="color: #000000;">&#41;</span>;                 <span style="color: #000000;">&#125;</span> &nbsp;                 <span style="color: #808080; font-style: italic;">// dans le cas des participants pas besoin de vérifier (d'après la requête)</span>                 Participant participant = <span style="color: #7F0055; font-weight: bold;">new</span> Participant<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;                 participant.<span style="color: #000000;">setId</span><span style="color: #000000;">&#40;</span> resultSet.<span style="color: #000000;">getLong</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;id_stagiaire&quot;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;                 participant.<span style="color: #000000;">setNom</span><span style="color: #000000;">&#40;</span> resultSet.<span style="color: #000000;">getString</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;nom_stagiaire&quot;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;                 session.<span style="color: #000000;">getParticipants</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>participant<span style="color: #000000;">&#41;</span>;             <span style="color: #000000;">&#125;</span> &nbsp;             <span style="color: #7F0055; font-weight: bold;">return</span> sessions;         <span style="color: #000000;">&#125;</span>         <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #000000;">&#40;</span><span style="color: #000000;">SQLException</span> e<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>             <span style="color: #7F0055; font-weight: bold;">throw</span> <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #000000;">IllegalStateException</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;Echec de récupération des formations&quot;</span>, e<span style="color: #000000;">&#41;</span>;         <span style="color: #000000;">&#125;</span>         <span style="color: #7F0055; font-weight: bold;">finally</span> <span style="color: #000000;">&#123;</span>             JdbcUtils.<span style="color: #000000;">closeResultSet</span><span style="color: #000000;">&#40;</span>resultSet<span style="color: #000000;">&#41;</span>;             JdbcUtils.<span style="color: #000000;">closeStatement</span><span style="color: #000000;">&#40;</span>statement<span style="color: #000000;">&#41;</span>;             JdbcUtils.<span style="color: #000000;">closeConnection</span><span style="color: #000000;">&#40;</span>connection<span style="color: #000000;">&#41;</span>;         <span style="color: #000000;">&#125;</span>     <span style="color: #000000;">&#125;</span> &nbsp;     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">boolean</span> isNewSession<span style="color: #000000;">&#40;</span>Session session, <span style="color: #000000;">Long</span> idFormation<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         <span style="color: #7F0055; font-weight: bold;">return</span> session == <span style="color: #7F0055; font-weight: bold;">null</span> || <span style="color: #000000;">!</span>session.<span style="color: #000000;">getIdFormation</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">equals</span><span style="color: #000000;">&#40;</span>idFormation<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> JdbcSessionDaoTest <span style="color: #7F0055; font-weight: bold;">extends</span> AbstractSessionDaoTest <span style="color: #000000;">&#123;</span>     @Test     <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> shouldFindFormationsWithPlainJdbc<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>         checkSessions<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">new</span> JdbcSessionDao<span style="color: #000000;">&#40;</span><span style="color: #000000;">
&#41;</span>.<span style="color: #000000;">findAll</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>La première chose qui saute aux yeux, c'est que le code fonctionnel du DAO est noyé dans le code technique. Sur les 55 lignes de code de cet extrait, seules 21 lignes ont un réel intérêt fonctionnel. La requête est dans une chaîne de caractère Java, c'est un peu gênant quand on veut la copier/coller dans un sqldeveloper par exemple. JDBC n’offre rien de ce côté là, et ce n’est pas son rôle. C’est donc au développeur de gérer une éventuelle externalisation des requêtes. Enfin, les API à manipuler ne sont pas les plus simples (ResultSet contient des dizaines de méthodes). Il n'y a donc rien de particulier à dire sur l'implémentation JDBC, si ce n'est que l'API est assez lourde à utiliser, et que l’utilisation du DriverManager n’est pas recommandée. On peut même identifier que certaines parties du code se répèteront d'un DAO à l'autre. C'est à cette problématique que répond le pattern template.</p> <h4>JdbcTemplate</h4> <p>JdbcTemplate est une classe du framework Spring qui propose de simplifier l'utilisation de JDBC en s'occupant des tâches répétitives. JdbcTemplate s'utilise en conjonction avec d'autres API (dans cet exemple l'interface RowCallbackHandler) et a vocation à s'intégrer d'une manière générale dans spring. Cet exemple a donc été implémenté dans un conteneur Spring et profite des mécanismes d'injection de dépendances.</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;com.zenika.blog.mybatis.impl.jdbctemplate.JdbcTemplateSessionDao&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></pre> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> JdbcTemplateSessionDao <span style="color: #7F0055; font-weight: bold;">implements</span> SessionDao <span style="color: #000000;">&#123;</span> &nbsp;     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">String</span> FIND_ALL =             <span style="color: #888888;">&quot;select fo.id as id_formation, co.nom as nom_cours, fe.nom as nom_formateur, st.id as id_stagiaire, st.nom as nom_stagiaire &quot;</span> +             <span style="color: #888888;">&quot;from formation fo, cours co, formateur fe, stagiaire st &quot;</span> +             <span style="color: #888888;">&quot;where co.id = fo.id_cours and fe.id = fo.id_formateur and fo.id = st.id_formation &quot;</span> +             <span style="color: #888888;">&quot;order by id_formation&quot;</span>; &nbsp;     <span style="color: #7F0055; font-weight: bold;">private</span> JdbcTemplate jdbcTemplate; &nbsp;     @Override     <span style="color: #7F0055; font-weight: bold;">public</span> List<span style="color: #000000;">&lt;</span>Session<span style="color: #000000;">&gt;</span> findAll<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         SessionRowCallbackHandler handler = <span style="color: #7F0055; font-weight: bold;">new</span> SessionRowCallbackHandler<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;         jdbcTemplate.<span style="color: #000000;">query</span><span style="color: #000000;">&#40;</span>FIND_ALL, handler<span style="color: #000000;">&#41;</span>;         <span style="color: #7F0055; font-weight: bold;">return</span> handler.<span style="color: #000000;">getSessions</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> &nbsp;     @Autowired     <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> setDataSource<span style="color: #000000;">&#40;</span>DataSource dataSource<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         <span style="color: #7F0055; font-weight: bold;">this</span>.<span style="color: #000000;">jdbcTemplate</span> = <span style="color: #7F0055; font-weight: bold;">new</span> JdbcTemplate<span style="color: #000000;">&#40;</span>dataSource<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">class</span> SessionRowCallbackHandler <span style="color: #7F0055; font-weight: bold;">implements</span> RowCallbackHandler <span style="color: #000000;">&#123;</span> &nbsp;     <span style="color: #7F0055; font-weight: bold;">private</span> Session session = <span style="color: #7F0055; font-weight: bold;">null</span>;     <span style="color: #7F0055; font-weight: bold;">private</span> List<span style="color: #000000;">&lt;</span>Session<span style="color: #000000;">&gt;</span> sessions = <span style="color: #7F0055; font-weight: bold;">new</span> ArrayList<span style="color: #000000;">&lt;&gt;</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; &nbsp;     <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> processRow<span style="color: #000000;">&#40;</span><span style="color: #000000;">ResultSet</span> resultSet<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">SQLException</span> <span style="color: #000000;">&#123;</span>         <span style="color: #000000;">Long</span> idFormation = resultSet.<span style="color: #000000;">getLong</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;id_formation&quot;</span><span style="color: #000000;">&#41;</span>; &nbsp;         <span style="color: #808080; font-style: italic;">// pour mapper la session il faut vérifier le changement d'id</span>         <span style="color: #7F0055;font-weight: bold;">if</span> <span style="color: #000000;">&#40;</span> isNewSession<span style="color: #000000;">&#40;</span>idFormation<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>             session = <span style="color: #7F0055; font-weight: bold;">new</span> Session<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;             session.<span style="color: #000000;">setIdFormation</span><span style="color: #000000;">&#40;</span>idFormation<span style="color: #000000;">&#41;</span>;             session.<span style="color: #000000;">setNomCours</span><span style="color: #000000;">&#40;</span> resultSet.<span style="color: #000000;">getString</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;nom_cours&quot;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;             session.<span style="color: #000000;">setNomFormateur</span><span style="color: #000000;">&#40;</span> resultSet.<span style="color: #000000;">getString</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;nom_formateur&quot;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;             sessions.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>session<span style="color: #000000;">&#41;</span>;         <span style="color: #000000;">&#125;</span> &nbsp;         <span
style="color: #808080; font-style: italic;">// dans le cas des participants pas besoin de vérifier (d'après la requête)</span>         Participant participant = <span style="color: #7F0055; font-weight: bold;">new</span> Participant<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;         participant.<span style="color: #000000;">setId</span><span style="color: #000000;">&#40;</span> resultSet.<span style="color: #000000;">getLong</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;id_stagiaire&quot;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;         participant.<span style="color: #000000;">setNom</span><span style="color: #000000;">&#40;</span> resultSet.<span style="color: #000000;">getString</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;nom_stagiaire&quot;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;         session.<span style="color: #000000;">getParticipants</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>participant<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> &nbsp;     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">boolean</span> isNewSession<span style="color: #000000;">&#40;</span><span style="color: #000000;">Long</span> idFormation<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         <span style="color: #7F0055; font-weight: bold;">return</span> session == <span style="color: #7F0055; font-weight: bold;">null</span> || <span style="color: #000000;">!</span>session.<span style="color: #000000;">getIdFormation</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">equals</span><span style="color: #000000;">&#40;</span>idFormation<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> &nbsp;     List<span style="color: #000000;">&lt;</span>Session<span style="color: #000000;">&gt;</span> getSessions<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         <span style="color: #7F0055; font-weight: bold;">return</span> sessions;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> JdbcTemplateSessionDaoTest <span style="color: #7F0055; font-weight: bold;">extends</span> AbstractSessionDaoTest <span style="color: #000000;">&#123;</span>     @Autowired     SessionDao formationDao; &nbsp;     @Test     <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> shouldFindFormationsWithJdbcTemplate<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>         checkSessions<span style="color: #000000;">&#40;</span> formationDao.<span style="color: #000000;">findAll</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Premier constat, l'implémentation est découpée en deux classes, et le tout nécessite un peu de configuration. JdbcTemplate encourage une bonne séparation des responsabilités séparant le mapping du reste du traitement (que ce soit dans une classe à part ou dans une classe anonyme). En appliquant le pattern du template, les API de bas niveau ont presque disparu, seul le ResultSet subsiste, de façon quasi-anodine&nbsp;: on n'itère pas manuellement dessus. On ne retrouve donc dans la classe SessionRowCallbackHandler <strong>que</strong> les 21 lignes à valeur ajoutée de l’implémentation JDBC brute. La requête se trouve toujours dans une constante Java, pas d'amélioration de ce côté là. Un autre changement est visible au niveau du test, celui-ci se fait directement injecter le DAO. Le cycle de vie du DAO est donc géré par Spring tel qu'on lui a déclaré, là où l'implémentation JDBC brute devait instancier elle-même son DAO.</p> <p>Comme dit précédemment, MyBatis se situe à un niveau d'abstraction entre JdbcTemplate et Hibernate. C'est donc maintenant que je vous propose de voir l'implémentation MyBatis.</p> <h4>MyBatis</h4> <p>Parmi les différents types d'ORM, on trouve les appellations <em>micro</em> et <em>full</em>. <strong>MyBatis est un micro ORM, qui se contente de faire le lien entre les mondes relationnel et objet</strong>, à la différence des implémentations JPA comme Hibernate qui sont des full ORM. En utilisant JPA, on crée tout un modèle objet à l'image des tables de la base de données (ou vice-versa). MyBatis repose sur la notion de <em>mapper</em>. Le mapper a pour tâche de transformer un résultat de requête en objet. C'est en substance la fonctionnalité principale du framework.</p> <p>La mise en œuvre de MyBatis nécessite un peu de configuration.</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?xml</span> <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;1.0&quot;</span> <span style="color: #000066;">encoding</span>=<span style="color: #ff0000;">&quot;UTF-8&quot;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span></span> <span style="color: #00bbdd;">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;environments</span> <span style="color: #000066;">default</span>=<span style="color: #ff0000;">&quot;test&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;environment</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;test&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;transactionManager</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;JDBC&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dataSource</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;POOLED&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>                 <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;driver&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;org.h2.Driver&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>                 <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;url&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;jdbc:h2:mem:data
Source;DB_CLOSE_DELAY=-1&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>                 <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;username&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;sa&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dataSource<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/environment<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/environments<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp;     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;mappers<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;mapper</span> <span style="color: #000066;">resource</span>=<span style="color: #ff0000;">&quot;formation-mapper.xml&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/mappers<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>On peut ensuite implémenter notre DAO.</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?xml</span> <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;1.0&quot;</span> <span style="color: #000066;">encoding</span>=<span style="color: #ff0000;">&quot;UTF-8&quot;</span><span style="color: #000000; font-weight: bold;">?&gt;</span></span> <span style="color: #00bbdd;">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span> &nbsp; <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;mapper</span> <span style="color: #000066;">namespace</span>=<span style="color: #ff0000;">&quot;com.zenika.blog.mybatis.SessionDao&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span> &nbsp;     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;resultMap</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;SessionResultMap&quot;</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;com.zenika.blog.mybatis.Session&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;id</span>     <span style="color: #000066;">property</span>=<span style="color: #ff0000;">&quot;idFormation&quot;</span> <span style="color: #000066;">column</span>=<span style="color: #ff0000;">&quot;id_formation&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;result</span> <span style="color: #000066;">property</span>=<span style="color: #ff0000;">&quot;nomCours&quot;</span> <span style="color: #000066;">column</span>=<span style="color: #ff0000;">&quot;nom_cours&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;result</span> <span style="color: #000066;">property</span>=<span style="color: #ff0000;">&quot;nomFormateur&quot;</span> <span style="color: #000066;">column</span>=<span style="color: #ff0000;">&quot;nom_formateur&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;collection</span> <span style="color: #000066;">property</span>=<span style="color: #ff0000;">&quot;participants&quot;</span> <span style="color: #000066;">resultMap</span>=<span style="color: #ff0000;">&quot;ParticipantResultMap&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/resultMap<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp;     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;resultMap</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;ParticipantResultMap&quot;</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;com.zenika.blog.mybatis.Participant&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;id</span>     <span style="color: #000066;">property</span>=<span style="color: #ff0000;">&quot;id&quot;</span> <span style="color: #000066;">column</span>=<span style="color: #ff0000;">&quot;id_stagiaire&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;result</span> <span style="color: #000066;">property</span>=<span style="color: #ff0000;">&quot;nom&quot;</span> <span style="color: #000066;">column</span>=<span style="color: #ff0000;">&quot;nom_stagiaire&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/resultMap<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp;     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;select</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;findAll&quot;</span> <span style="color: #000066;">resultMap</span>=<span style="color: #ff0000;">&quot;SessionResultMap&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         select             fo.id as id_formation,             co.nom as nom_cours,             fe.nom as nom_formateur,             st.id as id_stagiaire,             st.nom as nom_stagiaire         from formation fo, cours co, formateur fe, stagiaire st         where co.id = fo.id_cours         and fe.id = fo.id_formateur         and fo.id = st.id_formation     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/select<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/mapper<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> MyBatisSessionDaoTest <span style="color: #7F0055; font-weight: bold;">extends</span> AbstractSessionDaoTest <span style="color: #000000;">&#123;</span>     @Test     <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> shouldFindFormationsWithMyBatis<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>         <span style="color: #000000;">InputStream</span> stream = <span style="color: #7F0055; font-weight: b
old;">null</span>;         <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span>             stream = Resources.<span style="color: #000000;">getResourceAsStream</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;mybatis.xml&quot;</span><span style="color: #000000;">&#41;</span>;             SqlSessionFactory sessionFactory = <span style="color: #7F0055; font-weight: bold;">new</span> SqlSessionFactoryBuilder<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">build</span><span style="color: #000000;">&#40;</span>stream<span style="color: #000000;">&#41;</span>;             SqlSession session = sessionFactory.<span style="color: #000000;">openSession</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;             checkSessions<span style="color: #000000;">&#40;</span> session.<span style="color: #000000;">getMapper</span><span style="color: #000000;">&#40;</span>SessionDao.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">findAll</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;         <span style="color: #000000;">&#125;</span>         <span style="color: #7F0055; font-weight: bold;">finally</span> <span style="color: #000000;">&#123;</span>             IOUtils.<span style="color: #000000;">closeSilently</span><span style="color: #000000;">&#40;</span>stream<span style="color: #000000;">&#41;</span>;         <span style="color: #000000;">&#125;</span>     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Si vous êtes attentifs, vous avez remarqué que la classe implémentant SessionDao n'est pas présente. Si vous êtes très attentifs (ou que vous connaissez déjà iBatis/MyBatis) vous aurez compris que c'est MyBatis qui génère l'implémentation de l'interface. La contrepartie, c'est un fichier XML expliquant comment faire le mapping. L'XML est assez verbeux par nature, mais les mappers MyBatis restent tout à fait lisibles. La requête SQL peut être directement copiée sans avoir besoin de retirer des guillemets ou autres points-virgules! Attention par contre aux conflits entre XML et SQL sur des caractères comme &lt; et &gt;. On notera aussi que nous n’avons pas besoin de spécifier de clause ‘’order by’’ dans la requête, car c’est la balise &lt;id&gt; qui déterminera le passage à un nouvel objet. La configuration nous montre aussi qu'il existe une notion d'environnement dans MyBatis, et qu'il est capable de gérer un pool de connexion. C'est une des nombreuses fonctionnalités du framework en plus du simple mapping. Seul le test gagne en complexité, on a besoin de créer une SqlSessionFactory (une seule fois) et d'ouvrir une session afin de récupérer le Dao. Dans un conteneur comme spring, la question ne se pose pas&nbsp;: on peut directement se faire injecter les mappers où c'est nécessaire. Il ne reste donc plus qu'à voir l'implémentation avec Hibernate.</p> <h4>Hibernate</h4> <p>Je ne suis pas certain qu'il soit nécessaire de présenter Hibernate. C'est un full ORM qui nécessite donc de déclarer des entités correspondant aux tables de la base de données. Mon cas d'utilisation a volontairement été choisi pour afficher une des limitation des full ORM. Cela suppose donc de passer par des objets intermédiaires pour instancier les objets en sortie du DAO. Il est bien entendu possible en JPQL d'instancier directement une classe n'étant pas une entité, mais cela n'enlève pas la nécessité d'avoir des entités.</p> <pre class="java code java" style="font-family:inherit">@<span style="color: #000000;">Entity</span> @Table<span style="color: #000000;">&#40;</span>name=<span style="color: #888888;">&quot;formation&quot;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> Formation <span style="color: #000000;">&#123;</span> &nbsp;     @Id     @Column<span style="color: #000000;">&#40;</span>name=<span style="color: #888888;">&quot;id&quot;</span><span style="color: #000000;">&#41;</span>     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">Long</span> id; &nbsp;     @ManyToOne     @JoinColumn<span style="color: #000000;">&#40;</span>name=<span style="color: #888888;">&quot;id_cours&quot;</span><span style="color: #000000;">&#41;</span>     <span style="color: #7F0055; font-weight: bold;">private</span> Cours cours; &nbsp;     @ManyToOne     @JoinColumn<span style="color: #000000;">&#40;</span>name=<span style="color: #888888;">&quot;id_formateur&quot;</span><span style="color: #000000;">&#41;</span>     <span style="color: #7F0055; font-weight: bold;">private</span> Formateur formateur; &nbsp;     @Column<span style="color: #000000;">&#40;</span>name=<span style="color: #888888;">&quot;date_debut&quot;</span><span style="color: #000000;">&#41;</span>     <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">Date</span> dateDebut; &nbsp;     @OneToMany     @JoinColumn<span style="color: #000000;">&#40;</span>name=<span style="color: #888888;">&quot;id_formation&quot;</span><span style="color: #000000;">&#41;</span>     <span style="color: #7F0055; font-weight: bold;">private</span> Set<span style="color: #000000;">&lt;</span>Stagiaire<span style="color: #000000;">&gt;</span> stagiaires; &nbsp;     ... <span style="color: #000000;">&#125;</span></pre> <p>Dans cet exemple nous avons besoin de créer quatre entités ne serait-ce que pour assurer le mapping. Il est faut aussi ajouter les champs que nous n'utilisons pas. On peut s'en passer pour de la lecture, mais une insertion ne fonctionnera pas si une colonne <em>NOT NULL</em> n'est pas mappée. Nous avons donc nos quatre entités, voyons maintenant l'implémentation.</p> <p>On utilise Hibernate en tant qu'implémentation de JPA, il faut donc créer un fichier <em>persistence.xml</em>.</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;persistence</span></span> <span style="color: #009900;">    <span style="color: #000066;">xmlns</span>=<span style="color: #ff0000;">&quot;http://java.sun.com/xml/ns/persistence&quot;</span></span> <span style="color: #009900;">    <span style="color: #000066;">xmlns:xsi</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span> <span style="color: #009900;">    <span style="color: #000066;">xsi:schemaLocation</span>=<span style="color: #ff0000;">&quot;</span> <span style="color: #009900;">        http://java.sun.com/xml/ns/persistence</span> <span style="color: #009900;">        http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span></span> <span style="color: #009900;">    <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;2.0&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;persistence-unit</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;test&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;provider<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.hibernate.ejb.HibernatePersistence<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/provider<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>com.zenika.blog.mybatis.impl.jpa
.Cours<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>com.zenika.blog.mybatis.impl.jpa.Formateur<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>com.zenika.blog.mybatis.impl.jpa.Formation<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>com.zenika.blog.mybatis.impl.jpa.Stagiaire<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;properties<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;hibernate.connection.url&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;jdbc:h2:mem:dataSource;DB_CLOSE_DELAY=-1&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;hibernate.dialect&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;org.hibernate.dialect.H2Dialect&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;hibernate.connection.driver_class&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;org.h2.Driver&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;hibernate.connection.username&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;sa&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/properties<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/persistence-unit<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/persistence<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>On peut ensuite implémenter le DAO.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> HibernateSessionDao <span style="color: #7F0055; font-weight: bold;">implements</span> SessionDao <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055; font-weight: bold;">private</span> EntityManager entityManager; &nbsp;     <span style="color: #7F0055; font-weight: bold;">public</span> HibernateSessionDao<span style="color: #000000;">&#40;</span>EntityManager entityManager<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         <span style="color: #7F0055; font-weight: bold;">this</span>.<span style="color: #000000;">entityManager</span> = entityManager;     <span style="color: #000000;">&#125;</span> &nbsp;     @Override     <span style="color: #7F0055; font-weight: bold;">public</span> List<span style="color: #000000;">&lt;</span>Session<span style="color: #000000;">&gt;</span> findAll<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         @SuppressWarnings<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;unchecked&quot;</span><span style="color: #000000;">&#41;</span>         List<span style="color: #000000;">&lt;</span>Formation<span style="color: #000000;">&gt;</span> formations = entityManager.<span style="color: #000000;">createQuery</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;from Formation&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getResultList</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;         List<span style="color: #000000;">&lt;</span>Session<span style="color: #000000;">&gt;</span> sessions = <span style="color: #7F0055; font-weight: bold;">new</span> ArrayList<span style="color: #000000;">&lt;&gt;</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; &nbsp;         <span style="color: #7F0055;font-weight: bold;">for</span> <span style="color: #000000;">&#40;</span>Formation formation : formations<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>             Session session = <span style="color: #7F0055; font-weight: bold;">new</span> Session<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;             session.<span style="color: #000000;">setIdFormation</span><span style="color: #000000;">&#40;</span> formation.<span style="color: #000000;">getId</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;             session.<span style="color: #000000;">setNomCours</span><span style="color: #000000;">&#40;</span> formation.<span style="color: #000000;">getCours</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getNom</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;             session.<span style="color: #000000;">setNomFormateur</span><span style="color: #000000;">&#40;</span> formation.<span style="color: #000000;">getFormateur</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getNom</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;             <span style="color: #7F0055;font-weight: bold;">for</span> <span style="color: #000000;">&#40;</span>Stagiaire stagiaire : formation.<span style="color: #000000;">getStagiaires</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>                 Participant participant = <span style="color: #7F0055; font-weight: bold;">new</span> Participant<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;                 participant.<span style="color: #000000;">setId</span><span style="color: #000000;">&#40;</span> stag
iaire.<span style="color: #000000;">getId</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;                 participant.<span style="color: #000000;">setNom</span><span style="color: #000000;">&#40;</span> stagiaire.<span style="color: #000000;">getNom</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;                 session.<span style="color: #000000;">getParticipants</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>participant<span style="color: #000000;">&#41;</span>;             <span style="color: #000000;">&#125;</span>             sessions.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>session<span style="color: #000000;">&#41;</span>;         <span style="color: #000000;">&#125;</span> &nbsp;         <span style="color: #7F0055; font-weight: bold;">return</span> sessions;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> HibernateSessionDaoTest <span style="color: #7F0055; font-weight: bold;">extends</span> AbstractSessionDaoTest <span style="color: #000000;">&#123;</span>     @Test     <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> shouldFindFormationsWithHibernate<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>         EntityManager entityManager = Persistence.<span style="color: #000000;">createEntityManagerFactory</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;test&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">createEntityManager</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;         checkSessions<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">new</span> HibernateSessionDao<span style="color: #000000;">&#40;</span>entityManager<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">findAll</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Sans surprise, le code n'est pas compliqué. Il s'agit d'une simple transformation d'objets <em>Formation</em> en objets <em>Session</em>. Comme pour le test MyBatis, il est nécessaire de créer un EntityManager, mais JPA reposant sur des conventions, le code est beaucoup moins verbeux. Il ne serait bien entendu pas nécessaire d'écrire ce code dans un conteneur Spring, EJB ou autre... Il ne faut par contre pas perdre de vue qu'il a été nécessaire de créer quatre classes afin de pouvoir implémenter le DAO ce qui fait de cette solution la plus verbeuse. D'une manière générale, ce genre de solution pousse souvent au compromis, au détriment d'une solution plus naturelle.</p> <p>Attention aussi à ne pas reproduire cet exemple dans vos projets. Afin de simplifier au maximum cet exemple, Hibernate se retrouve à faire 1+3n requêtes à cause des relations. Il faut donc préciser qu’on veut charger les relations en ‘’eager loading’’ soit par annotations, ou dans la requête JPQL. Il n’est pas non plus obligatoire de passer par les entités. On peut passer par l’opérateur ‘’new’’ en JPQL pour passer directement les valeurs par le constructeur. Par contre un des postulats de départ était que les classes ‘’Session’’ et ‘’Participant’’ ne sont pas sous notre contrôle. On ne peut donc pas ajouter de constructeur. De son côté MyBatis, peut travailler aussi bien avec des setters qu’avec des constructeurs, et on peut même combiner les deux. Hibernate propose également un système de ‘’ResultTransformer’’ qui répond au besoin de mapper les résultats en direct sans passer par les entités. Cette solution est cependant spécifique à Hibernate et ne s’applique donc pas à JPA.</p> <h3>Pour conclure</h3> <p>MyBatis est un ORM très souple. En prenant le parti de se concentrer sur le mapping de résultats, MyBatis nous laisse maîtres du modèle de données sous-jacent. Il tolère de fait un changement dans la structure de la base de données, si tant est que les nouvelles requêtes renvoient les mêmes résultats. Les DBA peuvent directement modifier les requêtes avec les développeurs et n'ont pas besoin d'apprendre un langage supplémentaire (et je n'ai jamais vu de DBA optimiser une requête JPQL/Criteria!).</p> <p>MyBatis offre également une meilleure abstraction&nbsp;:</p> <ul> <li>puisqu'on ne manipule pas de JDBC dans la grande majorité des cas</li> <li>que le mapping est homogène, que nos classes soient mappées ou non sur nos tables</li> <li>qu’il offre une maîtrise du SQL exécuté</li> <li>et qu’il écarte les pièges courants liés à une mauvaise utilisation d’un full ORM</li> </ul> <p>Zenika propose désormais une <a href="http://www.zenika.com/formation_mybatis.html">formation MyBatis</a> si vous êtes intéressé par ce framework de persistance riche et souple. A l'issue des deux jours vous connaîtrez tout le nécessaire pour bien utiliser MyBatis. La courbe d’apprentissage de ce framework est bien plus douce que celles de JDBC ou JPA, et vous garantira d’être opérationnel très rapidement.</p> <p>Les sources de l'article sont téléchargeables <a href="/wp-content/uploads/2015/07/sources.zip">ici</a>.</p>