---
ID: 82
post_title: >
  REST avec Spring 3.0 et Solr (3ème
  partie)
author: Arnaud Cogoluègnes
post_date: 2010-01-11 11:00:00
post_excerpt: "<p>Voici la dernière partie de notre série d'articles sur le support REST de Spring 3.0 afin d'encapsuler des appels à un serveur Solr. Nous avons dans les précédentes parties configuré un serveur Solr et implémenté un contrôleur REST avec Spring 3.0 pour attaquer Solr avec l'API SolrJ. Cette dernière partie couvre comment utiliser le <code>RestTemplate</code> de Spring 3.0 pour consulter le contrôleur REST mais propose aussi quelques améliorations <em>RESTful</em> pour ce dernier.</p>"
layout: post
permalink: http://blog.zenika-offres.com/?p=82
published: true
---
<p>Voici la dernière partie de notre série d'articles sur le support REST de Spring 3.0 afin d'encapsuler des appels à un serveur Solr. Nous avons dans les précédentes parties configuré un serveur Solr et implémenté un contrôleur REST avec Spring 3.0 pour attaquer Solr avec l'API SolrJ. Cette dernière partie couvre comment utiliser le <code>RestTemplate</code> de Spring 3.0 pour consulter le contrôleur REST mais propose aussi quelques améliorations <em>RESTful</em> pour ce dernier.</p>
<!--more-->
<h2>Utilisation basique du <code>RestTemplate</code></h2> <p>Le <code>RestTemplate</code> correspond à la partie cliente du support REST de Spring&nbsp;: il permet d'accéder à des Web Services REST (implémentés avec Spring ou non). REST est basé sur HTTP, donc pourquoi ne pas utiliser les nombreuses bibliothèques HTTP déjà existantes en Java (dans le JDK, Commons HTTP, etc.)&nbsp;? Car comme d'autres API d'accès aux données (JDBC, JMS...), ces API sont bas niveau et nécessitent du code technique fastidieux, qui nuit à la productivité et à la robustesse. Le <code>RestTemplate</code> se propose donc de gérer une bonne partie de la "plomberie" (gestion des connexions HTTP, conversion des réponses en objets Java), tout en restant très paramétrable pour chaque aspect (possibilité d'utiliser le support HTTP du JDK ou Commons HTTP en interne, branchement sur différents frameworks de binding pour gérer des formats XML, JSON). Bref, le <code>RestTemplate</code> suit la philosophie des templates d'accès aux données de Spring, afin de pouvoir se concentrer sur le code fonctionnel.</p> <p>Voyons immédiatement comment utiliser le <code>RestTemplate</code> pour effectuer la requête avec le mot clé 'solr' (requête effectuée dans <a href="/index.php?post/2010/01/04/REST-avec-Spring-3.0-et-Solr-%282%C3%A8me-partie%29">la deuxième partie</a> avec un navigateur Web)&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">RestTemplate restTemplate = <span style="color: #7F0055; font-weight: bold;">new</span> RestTemplate<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">String</span> res = restTemplate.<span style="color: #000000;">getForObject</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #888888;">&quot;http://localhost:8080/springsolr/catalogue/search/{query}&quot;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">String</span>.<span style="color: #7F0055; font-weight: bold;">class</span>, <span style="color: #888888;">&quot;solr&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span>;</div></li></ol></pre> <p>La variable <code>res</code> contient alors le code suivant (indenté pour une meilleure lisibilité)&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;catalogue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;products<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;product<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;id<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>SOLR1000<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/id<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Solr, the Enterprise Search Server<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;manufacturer<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Apache Software Foundation<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/manufacturer<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/product<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/products<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/catalogue<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>Voici les éléments à retenir de cette première utilisation du <code>RestTemplate</code>&nbsp;:</p> <ul> <li>il dispose de méthodes pour les différentes opérations HTTP (dans notre cas, GET, mais il y a aussi POST, PUT, DELETE, etc)</li> <li>comme les contrôleurs REST Spring MVC, il accepte les "URI templates" (ex.&nbsp;: http://localhost:8080/springsolr/catalogue/search/{query}), qui contiennent des paramètres avec la syntaxe <code>{param}</code>.</li> <li>les paramètres des URI templates peuvent être passés via des varargs mais aussi avec une <code>Map</code> (pas de problème d'ordre alors)</li> <li>on peut préciser le type de retour souhaité, le <code>RestTemplate</code> effectuant alors la conversion de la réponse (nous verrons comment paramétrer les conversions par la suite)</li> </ul> <p>Nous avons fait une première opération GET, voyons maintenant comment effectuer un POST, ce qui correspond à de l'indexation du coté de notre contrôleur REST&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">restTemplate.<span style="color: #000000;">postForLocation</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #888888;">&qu
ot;http://localhost:8080/springsolr/catalogue/index/{id}/{name}/{manu}&quot;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055; font-weight: bold;">null</span>, <span style="color: #808080; font-style: italic;">// pas d'objet dans le corps de la requête, tout est dans l'URL</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #888888;">&quot;sdmia&quot;</span>,<span style="color: #888888;">&quot;Spring Dynamic Modules in action&quot;</span>,<span style="color: #888888;">&quot;Cogoluegnes-Piper-Templier&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">// requête pour vérifier que l'indexation a bien eu lieu</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">String</span> res = restTemplate.<span style="color: #000000;">getForObject</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #888888;">&quot;http://localhost:8080/springsolr/catalogue/search/{query}&quot;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">   <span style="color: #000000;">String</span>.<span style="color: #7F0055; font-weight: bold;">class</span>, <span style="color: #888888;">&quot;spring dynamic modules&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertTrue</span><span style="color: #000000;">&#40;</span>res.<span style="color: #000000;">contains</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;Spring Dynamic Modules in action&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li></ol></pre> <p>Le contrôleur REST retourne du XML, ce qui donne lui donne une bonne interopérabilité mais, coté client, il n'est pas pratique de récupérer directement ce XML sous la forme d'une chaîne de caractère. L'idéal serait de pouvoir récupérer un objet métier Java, le <code>RestTemplate</code> se chargeant de la conversion. Nous allons voir comment faire cela immédiatement.</p> <h2>Conversion avec le <code>HttpMessageConverter</code></h2> <p>Le <code>RestTemplate</code> maintient une liste de <code>HttpMessageConverter</code>s qui lui permet d'effectuer des conversions entre Java et HTTP. Les conversions vont dans les deux sens&nbsp;: objet Java vers requête HTTP et aussi réponse HTTP vers objet Java (ce qui nous intéresse dans l'immédiat). Par défaut, le <code>RestTemplate</code> dispose de <code>HttpMessageConverter</code> effectuant des conversions simples (<code>String</code>, tableau de <code>byte</code>) mais aussi plus complexes (données de formulaire sous forme de <code>MultiValueMap</code>, <code>Source</code> XML). Nous allons voir comment écrire un <code>HttpMessageConverter</code> effectuant des conversions vers nos deux objets métier (<code>Catalogue</code> et <code>Product</code>), puis comment enregistrer ce convertisseur programmatiquement et déclarativement.</p> <h3>Ecrire un <code>HttpMessageConverter</code></h3> <p>L'implémentation de <code>HttpMessageConverter</code> utilise XStream pour la conversion XML/Java, cela dans les deux sens. Il s'agit finalement du même mécanisme de sérialisation que coté serveur.</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">package</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">springsolr</span>.<span style="color: #000000;">web</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.io.IOException;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.util.Collections;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.util.List;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.http.HttpInputMessage;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.http.HttpOutputMessage;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.http.MediaType;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.http.converter.HttpMessageConverter;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.http.converter.HttpMessageNotReadableException;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.http.converter.HttpMessageNotWritableException;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import com.thoughtworks.xstream.XStream;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">i
mport com.zenika.springsolr.domain.Catalogue;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import com.zenika.springsolr.domain.Product;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> CatalogueHttpMessageConverter <span style="color: #7F0055; font-weight: bold;">implements</span> HttpMessageConverter<span style="color: #000000;">&lt;</span>Catalogue<span style="color: #000000;">&gt;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">private</span> XStream xstream = <span style="color: #7F0055; font-weight: bold;">new</span> XStream<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> CatalogueHttpMessageConverter<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>		</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		xstream.<span style="color: #000000;">alias</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;catalogue&quot;</span>, Catalogue.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		xstream.<span style="color: #000000;">alias</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;product&quot;</span>, Product.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">boolean</span> canRead<span style="color: #000000;">&#40;</span>Class<span style="color: #000000;">&lt;?</span> <span style="color: #7F0055; font-weight: bold;">extends</span> Catalogue<span style="color: #000000;">&gt;</span> clazz, MediaType mediaType<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">return</span> Catalogue.<span style="color: #7F0055; font-weight: bold;">class</span>.<span style="color: #000000;">equals</span><span style="color: #000000;">&#40;</span>clazz<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">boolean</span> canWrite<span style="color: #000000;">&#40;</span>Class<span style="color: #000000;">&lt;?</span> <span style="color: #7F0055; font-weight: bold;">extends</span> Catalogue<span style="color: #000000;">&gt;</span> clazz,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			MediaType mediaType<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">return</span> Catalogue.<span style="color: #7F0055; font-weight: bold;">class</span>.<span style="color: #000000;">equals</span><span style="color: #000000;">&#40;</span>clazz<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> Catalogue read<span style="color: #000000;">&#40;</span>Class<span style="color: #000000;">&lt;</span>Catalogue<span style="color: #000000;">&gt;</span> clazz, HttpInputMessage inputMessage<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">IOException</span>, HttpMessageNotReadableException <span style="color: #000000;">&#123;</span>		</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #000000;">&#40;</span>Catalogue<span style="color: #000000;">&#41;</span> xstream.<span style="color: #000000;">fromXML</span><span style="color: #000000;">&#40;</span>inputMessage.<span style="color: #000000;">getBody</span><span styl
e="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> write<span style="color: #000000;">&#40;</span>Catalogue t, MediaType contentType,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			HttpOutputMessage outputMessage<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">IOException</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			HttpMessageNotWritableException <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		xstream.<span style="color: #000000;">toXML</span><span style="color: #000000;">&#40;</span>t, outputMessage.<span style="color: #000000;">getBody</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> List<span style="color: #000000;">&lt;</span>MediaType<span style="color: #000000;">&gt;</span> getSupportedMediaTypes<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #000000;">Collections</span>.<span style="color: #000000;">singletonList</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> MediaType<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;application&quot;</span>,<span style="color: #888888;">&quot;xml&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <h3>Enregistrement programmatique du convertisseur</h3> <p>On peut configurer le <code>RestTemplate</code> et ses <code>HttpMessageConverter</code>s de façon 100% programmatique&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">RestTemplate restTemplate = <span style="color: #7F0055; font-weight: bold;">new</span> RestTemplate<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">List<span style="color: #000000;">&lt;</span>HttpMessageConverter<span style="color: #000000;">&lt;?&gt;&gt;</span> converters = <span style="color: #7F0055; font-weight: bold;">new</span> ArrayList<span style="color: #000000;">&lt;</span>HttpMessageConverter<span style="color: #000000;">&lt;?&gt;&gt;</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">converters.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> CatalogueHttpMessageConverter<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">restTemplate.<span style="color: #000000;">setMessageConverters</span><span style="color: #000000;">&#40;</span>converters<span style="color: #000000;">&#41;</span>;</div></li></ol></pre> <h3>Enregistrement déclaratif du convertisseur</h3> <p>On peut aussi compter sur Spring pour configurer le <code>RestTemplate</code> et ses <code>HttpMessageConverter</code>s afin de pouvoir l'injecter ensuite&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;restTemplate&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.web.client.RestTemplate&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;messageConverters&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;list<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;"
>&lt;bean</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;com.zenika.springsolr.web.CatalogueHttpMessageConverter&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/list<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>	</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>Attention&nbsp;! Notre liste de <code>HttpMessageConverter</code>s remplace celle par défaut&nbsp;: toutes les conversions correspondantes ne fonctionnent alors plus (<code>String</code>, <code>byte<a href=""></a></code>, etc).</p> <h3>Utilisation du convertisseur</h3> <p>Le convertisseur est ensuite automatiquement utilisé par le <code>RestTemplate</code>, qui délègue les conversions à ses convertisseurs selon leurs capacités (méthodes <code>canRead</code> et <code>canWrite</code>)&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">Catalogue catalogue = restTemplate.<span style="color: #000000;">getForObject</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #888888;">&quot;http://localhost:8080/springsolr/catalogue/search/{query}&quot;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  Catalogue.<span style="color: #7F0055; font-weight: bold;">class</span>, <span style="color: #888888;">&quot;solr&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span>;</div></li></ol></pre> <p>L'écriture du <code>CatalogueHttpMessageConverter</code> a permis de se familiariser avec l'API <code>HttpMessageConverter</code> et de découvrir quelques mécaniques du <code>RestTemplate</code>. Mais ne serait-il pas plus simple d'utiliser des convertisseurs existants&nbsp;? Spring propose plusieurs implémentations ré-utilisables (pour gérer du XML avec différents frameworks de binding, du JSON avec Jackson), voyons comment utiliser celle se basant sur Spring OXM.</p> <h2>Utilisation de Spring OXM pour la conversion</h2> <p>Plutôt que d'écrire un <code>HttpMessageConverter</code> sur mesure comme nous avons fait, il est possible d'obtenir le même résultat en effectuant seulement de la configuration, grâce au <code>MarshallingHttpMessageConverter</code>, qui se base sur Spring OXM. La configuration se fait en deux étapes&nbsp;:</p> <ul> <li>déclarer un <code>Marshaller</code> (nous allons utiliser le même que celui générant la vue coté serveur)</li> <li>injecter un <code>MarshallingHttpMessageConverter</code> dans le <code>RestTemplate</code></li> </ul> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;marshaller&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.oxm.xstream.XStreamMarshaller&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;aliases&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;map<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;entry</span> <span style="color: #000066;">key</span>=<span style="color: #ff0000;">&quot;catalogue&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;com.zenika.springsolr.domain.Catalogue&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;entry</span> <span style="color: #000066;">key</span>=<span style="color: #ff0000;">&quot;product&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;com.zenika.springsolr.domain.Product&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/map<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;restTemplate&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.web.client.RestTemplate&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li>
<li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;messageConverters&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;list<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.http.converter.xml.MarshallingHttpMessageConverter&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;marshaller&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;marshaller&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;unmarshaller&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;marshaller&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/list<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>	</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>Il est ensuite possible de faire le même appel qu'avec le <code>CatalogueHttpMessageConverter</code>, mais cela sans développer de classe spécifique&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">Catalogue catalogue = restTemplate.<span style="color: #000000;">getForObject</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #888888;">&quot;http://localhost:8080/springsolr/catalogue/search/{query}&quot;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  Catalogue.<span style="color: #7F0055; font-weight: bold;">class</span>, <span style="color: #888888;">&quot;solr&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span>;</div></li></ol></pre> <p>Le <code>HttpMessageConverter</code> est donc un point d'extension intéressant, introduit dans Spring 3.0, mais il ne se limite au <code>RestTemplate</code>, puisqu'on peut aussi l'utiliser dans Spring MVC.</p> <h2>Utilisation de Spring OXM coté serveur</h2> <p>Le <code>HttpMessageConverter</code> a été très utile pour les conversions coté client avec le <code>RestTemplate</code>, mais sa définition est très générique&nbsp;:</p> <blockquote><p>Strategy interface that specifies a converter that can convert from and to HTTP requests and responses.</p></blockquote> <p>Cela est donc directement applicable à des contrôleurs Web, puisque ceux-ci doivent potentiellement aussi convertir des requêtes HTTP en objets Java et des objets Java en réponse HTTP.</p> <h3>Déclaration d'un <code>HttpMessageConverter</code> dans Spring MVC</h3> <p>Spring MVC utilise des <code>HandlerAdapter</code>s à qui il délègue les appels sur les contrôleurs Web applicatifs. Depuis Spring 2.5, Spring MVC privilégie une approche 100% annotation et donc un <code>AnnotationMethodHandlerAdapter</code> est automatiquement positionné dans le contexte Spring d'une <code>DispatcherServlet</code>. C'est pour cela que l'on peut directement utiliser des contrôleurs annotés avec <code>RequestMapping</code>, sans configuration spécifique. Il est possible de positionner des <code>HttpMessageConverter</code>s sur un <code>AnnotationMethodHandlerAdapter</code>, donc nous allons en déclarer un qui remplacera celui par défaut.</p> <p>Voilà pour la théorie, en pratique, il suffit d'ajouter le code suivant dans le contexte Spring de la <code>DispatcherServlet</code>&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;messageConverters&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;list<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; fo
nt-weight: bold;">&lt;bean</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.http.converter.xml.MarshallingHttpMessageConverter&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;marshaller&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;marshaller&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;unmarshaller&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;marshaller&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;supportedMediaTypes&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;list<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;value<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>application/xml<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/value<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;value<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>text/*<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/value<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>						</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/list<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/list<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>Voyons maintenant comment tirer parti du <code>MarshallingHttpMessageConverter</code> dans le contrôleur REST.</p> <h3>Conversion des paramètres de la requête</h3> <p>Rappelez-vous comment notre requête POST permet d'indexer un nouveau produit à partir de l'URL&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@RequestMapping<span style="color: #000000;">&#40;</span>value = <span style="color: #888888;">&quot;/index/{id}/{name}/{manu}&quot;</span>, method = RequestMethod.<span style="color: #000000;">POST</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> index<span style="color: #000000;">&#40;</span>@PathVariable <span style="color: #000000;">String</span> id, @PathVariable <span style="color: #000000;">String</span> name,@PathVariable <span style="color: #000000;">String</span> manu,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        HttpServletResponse response<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  ...</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Il est possible de récupérer directement un objet <code>Product</code> à partir du corps de la requête, en utilisant l'annotation <code>RequestBody</code>. Nous pouvons ajouter une méthode <code>index</code> qui répond aux requêtes PUT&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@RequestMapping<span style="color: #000000;">&#40;</span>value=<span style="color: #888888;">&quot;/index/&quot;</span>,method=RequestMethod.<span style="color: #000000;">PUT</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; f
ont-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> index<span style="color: #000000;">&#40;</span>@RequestBody Product product, HttpServletResponse response<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  SolrInputDocument doc = <span style="color: #7F0055; font-weight: bold;">new</span> SolrInputDocument<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  doc.<span style="color: #000000;">addField</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;id&quot;</span>, product.<span style="color: #000000;">getId</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  doc.<span style="color: #000000;">addField</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;name&quot;</span>, product.<span style="color: #000000;">getName</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  doc.<span style="color: #000000;">addField</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;manu&quot;</span>, product.<span style="color: #000000;">getManufacturer</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  solrServer.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>doc<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  solrServer.<span style="color: #000000;">commit</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  response.<span style="color: #000000;">setStatus</span><span style="color: #000000;">&#40;</span>HttpServletResponse.<span style="color: #000000;">SC_OK</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Coté client, nous pouvons effectuer une requête de la manière suivante (en supposant que le <code>RestTemplate</code> utilise bien un convertisseur adapté, comme nous l'avons configuré précédemment)&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">Product product = <span style="color: #7F0055; font-weight: bold;">new</span> Product<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;sia3&quot;</span>,<span style="color: #888888;">&quot;Spring in action 3rd edition&quot;</span>,<span style="color: #888888;">&quot;Walls&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">restTemplate.<span style="color: #000000;">put</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;http://localhost:8080/springsolr/catalogue/index/&quot;</span>, product<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">// requête pour vérifier que l'indexation a bien eu lieu</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">Catalogue catalogue = restTemplate.<span style="color: #000000;">getForObject</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #888888;">&quot;http://localhost:8080/springsolr/catalogue/search/{query}&quot;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  Catalogue.<span style="color: #7F0055; font-weight: bold;">class</span>, <span style="color: #888888;">&quot;walls&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertTrue</span><span style="color: #000000;">&#40;</span>catalogue.<span style="color: #000000;">getProducts</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">size</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&gt;</span> 0<span style="color: #000000;">&#41;</span>;</div></li></ol></pre> <p>On remarque immédiatement que le code est beaucoup plus épuré, car il manipule directement des objets métiers, et cela aussi bien coté client que serveur.</p> <p>Appliquons cela maintenant à une réponse HTTP du contrôleur REST.</p> <h3>Conversion de la réponse</h3> <p>L'implémentation actuelle de la méthode <code>search</code> utilise le mécanisme de génération de vue de Spring MVC&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@RequestMapping<span style="color: #000000;">&#40;</span>value=<span style="color: #888888;">&quot;/search/{query}&quot;</span>,method=RequestMethod.<span style="color: #000000;">GET</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> ModelAndView search<span style="color: #000000;">&#40;</span>@PathVariable <span style="color: #000000;">String</span> query<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div
 style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  Catalogue catalogue = <span style="color: #7F0055; font-weight: bold;">new</span> Catalogue<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  ...</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #7F0055; font-weight: bold;">new</span> ModelAndView<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;default&quot;</span>,<span style="color: #888888;">&quot;catalogue&quot;</span>,catalogue<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Il est possible de court-circuiter le système de génération de vue de Spring MVC, car il n'est pas vraiment utile dans notre cas (sérialisation XML). Nous pouvons donc demander au <code>AnnotationMethodHandlerAdapter</code> de générer la vue (il délèguera à ses <code>HttpMessageConverter</code>s). Il suffit pour cela de retourner directement l'objet métier (et plus un <code>ModelAndView</code>) et d'annoter la méthode avec <code>ResponseBody</code>&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@ResponseBody</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@RequestMapping<span style="color: #000000;">&#40;</span>value = <span style="color: #888888;">&quot;/search/{query}&quot;</span>, method = RequestMethod.<span style="color: #000000;">GET</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> Catalogue search<span style="color: #000000;">&#40;</span>@PathVariable <span style="color: #000000;">String</span> query<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  SolrQuery solrQuery = <span style="color: #7F0055; font-weight: bold;">new</span> SolrQuery<span style="color: #000000;">&#40;</span>query<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  SolrResponse response = solrServer.<span style="color: #000000;">query</span><span style="color: #000000;">&#40;</span>solrQuery<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  SolrDocumentList docs = <span style="color: #000000;">&#40;</span>SolrDocumentList<span style="color: #000000;">&#41;</span> response.<span style="color: #000000;">getResponse</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">get</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;response&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  Catalogue catalogue = <span style="color: #7F0055; font-weight: bold;">new</span> Catalogue<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055;font-weight: bold;">for</span> <span style="color: #000000;">&#40;</span>SolrDocument doc : docs<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    catalogue.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>map<span style="color: #000000;">&#40;</span>doc<span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055; font-weight: bold;">return</span> catalogue;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>L'utilisation de <code>ResponseBody</code> et du <code>MarshallingHttpMessageConverter</code> permet d'obtenir exactement le même résultat XML, mais le contrôleur REST n'a maintenant plus de références à l'API Spring (à part les annotations).</p> <p>Cette dernière amélioration conclut cette série d'articles. Nous avons vu l'utilisation du support REST de Spring, cotés serveur et client, avec un exemple d'application concret&nbsp;: proposer une abstraction sous forme de services Web REST à un serveur d'indexation. Le support de Spring est très souple puisqu'il propose de nombreux points d'extension et permet de s'affranchir de la plupart des problématiques techniques (connexions HTTP, sérialisation dans différents formats).</p>