---
ID: 133
post_title: >
  Using Tomcat JDBC connection pool in a
  standalone environment
author: Arnaud Cogolu√®gnes
post_date: 2013-02-13 10:30:00
post_excerpt: "<p>A multi-user application working against a database cannot be efficient if it doesn't use connection pooling. Middleware can offer this service, but not all applications rely on such middleware. These applications must then come up with their own way to pool connections. The Apache Tomcat project doesn't only come with the most popular web container but also with a performant connection pool library, Tomcat JDBC. This post covers how to configure Tomcat JDBC in a typical Maven + Spring application.</p>"
layout: post
permalink: http://blog.zenika-offres.com/?p=133
published: true
---
<p>A multi-user application working against a database cannot be efficient if it doesn't use connection pooling. Middleware can offer this service, but not all applications rely on such middleware. These applications must then come up with their own way to pool connections. The Apache Tomcat project doesn't only come with the most popular web container but also with a performant connection pool library, Tomcat JDBC. This post covers how to configure Tomcat JDBC in a typical Maven + Spring application.</p>
<!--more-->
<h2>Why using a standalone connection pool?</h2> <p>Here are some good reasons to use a standalone connection pool:</p> <ul> <li>the application is running in a container, but you don't want to use the container connection pool (not efficient or proprietary configuration mechanism like a web console or some complex XML files, etc). The application then creates the connection when it starts. The connection parameters (driver, url, user, password) and pool configuration can be externalized in a simple properties, text file.</li> <li>the application needs some connection pools at runtime. This isn't a common requirement, but some systems like Business Intelligence applications need to connect to different databases and the connections are configured at runtime, by advanced users.</li> <li>the application isn't running in a container and needs to connect to a database. Container-less deployment is getting more and more popular, and, as an example, the <a href="http://dropwizard.codahale.com/">Dropwizard</a> micro-services  framework uses Tomcat JDBC to manage its connection pool.</li> </ul> <p>If your application falls in any of this use cases, it's a good candidate to use Tomcat JDBC. Tomcat JDBC was introduced in Tomcat 7, as a replacement to Commons DBCP (see some reasons <a href="http://people.apache.org/~fhanik/jdbc-pool/jdbc-pool.html">here</a>).</p> <p>A <a href="http://www.tomcatexpert.com/blog/2012/01/24/using-tomcat-7-jdbc-connection-pool-production">couple</a> of <a href="http://www.tomcatexpert.com/blog/2010/04/01/configuring-jdbc-pool-high-concurrency">posts</a> from the Tomcat Expert blog explains thoroughly the features of Tomcat JDBC and <a href="http://www.tomcatexpert.com/blog/2010/03/22/understanding-jdbc-pool-performance-improvements">another post</a> even provides a comparison between Tomcat JDBC, Commons DBCP, and C3P0. To make it short, Tomcat JDBC is simpler and faster than the other implementations, without sacrifying the features.</p> <p>What the Tomcat Export posts miss is the use of the pool in a standalone environment. So this articles focuses on the use of Tomcat JDBC in a typical standalone environment (Maven, Spring), rather than on the features or the performances.</p> <h2>Adding the Maven dependencies</h2> <p>Tomcat JDBC is available on the public Maven repositories. This means you can easily grab the dependencies with your favorite build/dependency management tool (Maven, Gradle, Ivy). Here is the dependency code for Maven:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.apache.tomcat<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>tomcat-jdbc<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>7.0.35<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>If you deploy on Tomcat 7 or provide Tomcat JDBC as an infrastructure library, you can set the scope to 'provided':</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.apache.tomcat<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>tomcat-jdbc<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>7.0.35<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;scope<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>provided<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/scope<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>This way, Tomcat JDBC won't be included in the final archive.</p> <h2>Declaring a pool</h2> <p>Tomcat JDBC is straightforward to use: one needs to create an instance of <code>org.apache.tomcat.jdbc.pool.DataSource</code> and use the appropriate setters to configure the pool:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.tomcat.jdbc.pool.DataSource</span><span style="color: #339933;">;</span> &nbsp; <span style="color: #009900;">&#40;</span>...<span style="color: #009900;">&#41;</span> &nbsp; DataSource ds <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> DataSource<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> ds.<span style="color: #006633;">setDriverClassName</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.h2.Driver&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> ds.<span style="color: #006633;">setUrl</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;jdbc:h2:java-config&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> ds.<span style="color: #006633;">setUsername</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;sa&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> ds.<span style="color: #006633;">setPassword</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> ds.<span style="color: #006633;">setInitialSize</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">5</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> ds.<span style="color: #006633;">setMaxActive</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">10</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> ds.<span style="color: #006633;">setMaxIdle</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">5</span><span style=
"color: #009900;">&#41;</span><span style="color: #339933;">;</span> ds.<span style="color: #006633;">setMinIdle</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Note <code>org.apache.tomcat.jdbc.pool.DataSource</code> implements the <code>javax.sql.DataSource</code>, so an instance of the pool can be used anywhere you need a standard <code>DataSource</code>.</p> <h2>Using Tomcat JDBC with Spring (Java configuration)</h2> <p>Spring is a common choice in Java enterprise applications. The framework brings portability to applications, so it makes sense to use a standalone connection pool in a Spring application. Here is an example of using Tomcat JDBC with Spring Java-based configuration:</p> <pre class="java code java" style="font-family:inherit">@Configuration <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> DataAccessConfiguration <span style="color: #009900;">&#123;</span> &nbsp;     @Bean<span style="color: #009900;">&#40;</span>destroyMethod <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;close&quot;</span><span style="color: #009900;">&#41;</span>     <span style="color: #000000; font-weight: bold;">public</span> javax.<span style="color: #006633;">sql</span>.<span style="color: #006633;">DataSource</span> datasource<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         org.<span style="color: #006633;">apache</span>.<span style="color: #006633;">tomcat</span>.<span style="color: #006633;">jdbc</span>.<span style="color: #006633;">pool</span>.<span style="color: #006633;">DataSource</span> ds <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> org.<span style="color: #006633;">apache</span>.<span style="color: #006633;">tomcat</span>.<span style="color: #006633;">jdbc</span>.<span style="color: #006633;">pool</span>.<span style="color: #006633;">DataSource</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         ds.<span style="color: #006633;">setDriverClassName</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;org.h2.Driver&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         ds.<span style="color: #006633;">setUrl</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;jdbc:h2:java-config&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         ds.<span style="color: #006633;">setUsername</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;sa&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         ds.<span style="color: #006633;">setPassword</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         ds.<span style="color: #006633;">setInitialSize</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">5</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         ds.<span style="color: #006633;">setMaxActive</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">10</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         ds.<span style="color: #006633;">setMaxIdle</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">5</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         ds.<span style="color: #006633;">setMinIdle</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #000000; font-weight: bold;">return</span> ds<span style="color: #339933;">;</span>     <span style="color: #009900;">&#125;</span> &nbsp;     @Bean <span style="color: #000000; font-weight: bold;">public</span> JdbcOperations tpl<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> JdbcTemplate<span style="color: #009900;">&#40;</span>datasource<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>     <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #009900;">&#125;</span></pre> <p>Note the use of the <code>destroyMethod</code> attribute: Spring will call the <code>close</code> method when its container shuts down, to make the pool give the connections back to the database. Note also the declaration of <code>JdbcTemplate</code>: it needs a <code>javax.sql.DataSource</code> to be created and thus accepts Tomcat JDBC <code>DataSource</code> implementation.</p> <h2>Using Tomcat JDBC with Spring (XML configuration)</h2> <p>The XML configuration is still popular in Spring applications, especially for infrastructure components like a connection pool:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;dataSource&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.apache.tomcat.jdbc.pool.DataSource&quot;</span> <span style="color: #000066;">destroy-method</span>=<span style="color: #ff0000;">&quot;close&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;driverClassName&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;org.h2.Driver&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;url&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;jdbc:h2:mem:xml-config&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;username&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;sa&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;password&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;initialSize&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;5&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;maxActive&quot;</span> <span styl
e="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;10&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;maxIdle&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;5&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;minIdle&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;2&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp;  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;constructor-arg</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;dataSource&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Note the use of the <code>destroy-method</code> attribute, to ensure the pool is closed when the Spring container shuts down.</p> <p>NB: the configuration parameters doesn't have to be hard-coded! Spring provides several ways to externalize such parameters (property placeholders, ${...} like syntax, and the <code>Environment</code> abstraction with <code>PropertySource</code>). Take a look at the Spring documentation for more information.</p> <h2>Handy features: connection initialization SQL and validation</h2> <p>Tomcat JDBC provides many features. You will probably need 2 of them if you go a little bit further than the basic usage of the connection pool.</p> <p>The first feature is the execution of some SQL instruction when <em>a new connection is created</em>. The SQL code instruction is thus executed only once for each connection. This comes in handy when connections need to be "tagged" by the application to make monitoring easier. For PostgreSQL, this can be done this way:</p> <pre class="java code java" style="font-family:inherit">ds.<span style="color: #006633;">setInitSQL</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;SET application_name = 'my-app'&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>By doing this, the connections created by our pool instance will show up with the <code>my-app</code> value for the <code>application_name</code> column when executing <code>select * from pg_stat_activity</code>. Very useful for monitoring!</p> <p>The other feature is connection validation. Some databases close open connections quite aggressively if they detect they're not used or a connection can be lost because of a network glitch. The pool can then execute a validation query every time the application borrows a connection. If the validation query fails, the pool assumes it's dead and creates a new one. This is all transparent for the application, which doesn't have to worry about dead or invalid connections.</p> <p>The validation query has a setter in Tomcat JDBC:</p> <pre class="java code java" style="font-family:inherit">ds.<span style="color: #006633;">setValidationQuery</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;select 1&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <h2>Conclusion</h2> <p>Tomcat JDBC is a robust, lighweight, and performant connection pool library. It's a viable alternative to the older yet popular Commons DBCP project and it can be easily embedded in any application. Don't wait to give it a try!</p> <p><a href="https://github.com/acogoluegnes/blog-tomcat-jdbc">Source code</a></p>