---
ID: 426
post_title: 'HTML5 : l&#039;API Geolocation'
author: shadjiat
post_date: 2011-02-10 16:40:00
post_excerpt: "<p>Aujourd'hui nous allons traiter l'une des nouvelles fonctionnalités d'HTML5: la géolocalisation. Cette api, comme son nom l'indique, permet de localiser l'utilisateur de l'application. Dans cet article, nous allons d'abord étudier la fonction de localisation et son fonctionnement, ensuite nous construirons un exemple d'application simple, et enfin nous étendrons notre exemple en intégrant l'API Google Maps.</p>"
layout: post
permalink: http://blog.zenika-offres.com/?p=426
published: true
slide_template:
  - ""
---
<p>Aujourd'hui nous allons traiter l'une des nouvelles fonctionnalités d'HTML5: la géolocalisation. Cette api, comme son nom l'indique, permet de localiser l'utilisateur de l'application. Dans cet article, nous allons d'abord étudier la fonction de localisation et son fonctionnement, ensuite nous construirons un exemple d'application simple, et enfin nous étendrons notre exemple en intégrant l'API Google Maps.</p>
<!--more-->
<h3>Comment ca marche&nbsp;?</h3> <p>La géolocalisation avec Html5 s'effectue en récupérant des données fournies au navigateur par le dispositif utilisant l'application (par exemple, un téléphone mobile, un PC). Il existe différentes méthodes de localisation suivant le dispositif utilisé&nbsp;:</p> <ul> <li>Adresse IP</li> <li>Coordonnées GPS</li> <li>Réseau WIFI</li> <li>Réseau mobile</li> <li>Données entrée par l'utilisateur</li> </ul> <p>Comment l'utiliser? Il suffit d'appeler une fonction javascript&nbsp;:</p> <pre class="javascript code javascript" style="font-family:inherit">navigator.<span style="color: #660066;">geolocation</span>.<span style="color: #660066;">getCurrentPosition</span> <span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">in</span> PositionCallback successCallback<span style="color: #339933;">,</span> 					<span style="color: #000066; font-weight: bold;">in</span> optional PositionErrorCallback errorCallback<span style="color: #339933;">,</span> 					<span style="color: #000066; font-weight: bold;">in</span> optional PositionOptions<span style="color: #009900;">&#41;</span>;</pre> <p>Cette fonction accepte 3 paramètres dont 2 optionnels. Le paramètre obligatoire est la fonction <code>successCallback</code>, appelée en cas de succès de la géolocalisation, et qui récupère l'objet <code>Position</code> retourné. Cet objet contient les coordonnées de la position&nbsp;: <code>latitude</code>, <code>longitude</code> et <code>accuracy</code> (précision en mètres), accessibles via l'attribut <code>coords</code>. Ensuite, on peut spécifier un paramètre <code>errorCallback</code> qui permet de définir une fonction pour gérer les cas d'erreurs. Enfin on peut ajouter des options à notre géolocalisation (<code>timeout</code>, <code>maximumAge</code>, <code>enableHighAccuracy</code>).</p> <p>Et... c'est tout&nbsp;! Simple non? En intégrant ces fonctions à une page HTML on obtient le résultat suivant&nbsp;:</p> <h3>Démonstration</h3> <!DOCTYPE html> <html> <head> <meta charset="ISO-8859-1"> <script> function Geolocation() { 	if (navigator.geolocation) { 		navigator.geolocation.getCurrentPosition(handlePosition); 	} else { 		document.getElementById("status").innerHTML = "HTML5 Geolocation is not supported in your browser."; 	} } function handlePosition(position) { 	var lat = position.coords.latitude; 	var long = position.coords.longitude; 	var acc = position.coords.accuracy; 	document.getElementById("pos").innerHTML = "Votre position : "; 	document.getElementById("lat").innerHTML = "latitude : " + lat; 	document.getElementById("long").innerHTML = "longitude : " + long; 	document.getElementById("acc").innerHTML = "accuracy : " + acc + " m"; } </script> </head> <body> <div> <button type="button" id="start" onclick="Geolocation()">Find Me!</button> </div> <p id="status"></p> <h4 id="pos"></h3> <p id="lat"></p> <p id="long"></p> <p id="acc"></p> </body> </html> <p>En cliquant sur le bouton, le navigateur (s'il supporte l'API) va vous demander l'autorisation pour activer le partage de localisation. En acceptant, vous verrez apparaître vos coordonnées.</p> <h3>Support des navigateurs</h3> <ul> <li>chrome: versions 5+ ou via plugin Gears</li> <li>firefox: versions 3.5+</li> <li>IE: 9+ ou via plugin Gears</li> <li>Opéra: version 10.6+</li> <li>Safari: 5+</li> </ul> <h3>Utilisation de Google Maps</h3> <p>A présent que nous avons récupéré nos coordonnées, l'idéal serait de pouvoir se localiser sur une carte. Pour cela, on peut utiliser Google Maps Javascript Api. Cette API fournit des fonctions javascript accessibles en ajoutant cette ligne à notre page:</p> <pre class="html code html" style="font-family:inherit"><span style="color: #009900;">&lt;<span style="color: #000000; font-weight: bold;">script</span> <span style="color: #000066;">src</span><span style="color: #66cc66;">=</span><span style="color: #ff0000;">&quot;http://maps.google.com/maps/api/js?sensor=true&quot;</span>&gt;&lt;<span style="color: #66cc66;">/</span><span style="color: #000000; font-weight: bold;">script</span>&gt;</span></pre> <p>Ensuite, nous allons utiliser les coordonnées de la position récupérée et créer un objet <code>LatLng</code>&nbsp;:</p> <pre class="html code html" style="font-family:inherit">var myPosition = new google.maps.LatLng(latitude, longitude);</pre> <p>Pour créer une carte, il suffit de créer un objet de type <code>Map</code> en lui indiquant l'élément HTML qui va la contenir, ainsi qu'une liste d'options.</p> <pre class="html code html" style="font-family:inherit">var map = new google.maps.Map(document.getElementById(&quot;mapCanvas&quot;), 		myOptions);</pre> <p>Cette liste d'options comprend la taille du zoom, le centre la carte qui est l'objet <code>LatLng</code> initialisé plus haut, ainsi que le type de carte.</p> <pre class="html code html" style="font-family:inherit">var myOptions = { 	zoom : 15, 	center : myPosition, 	mapTypeId : google.maps.MapTypeId.ROADMAP };</pre> <p>Enfin, il reste à rajouter un repère sur notre position:</p> <pre class="html code html" style="font-family:inherit">var marker = new google.maps.Marker({ 		position : myPosition, 		map : map, 		title : &quot;Here you are!&quot; 	});</pre> <p>L'API Google Maps permet également de calculer et de tracer un chemin vers une destination donnée. Et voici le résultat obtenu en combinant toutes ces fonctions&nbsp;:</p> <!DOCTYPE html> <html> <head> <meta charset="utf-8" /> <style> #mapCanvas { 	width: 500px; 	height: 300px; 	box-shadow: 5px 5px 10px #000; 	-moz-box-shadow: 5px 5px 10px #000; 	-webkit-box-shadow: 5px 5px 10px #000; } </style> <script src="http://maps.google.com/maps/api/js?sensor=true"></script> <script> 	var latitude;  	var longitude;         var accuracy; 	var myOptions; 	var map; 	var maPosition; 	var directionDisplay; 	function updateStatus(message) { 		document.getElementById("statut").innerHTML = message; 	} 	//fonction errorCallBack appelée en cas d'erreurs rendues par la requete getCurrentPosition 	function handleError(error) { 		switch (error.code) { 		case 0: 			updateStatus("There was an error while retrieving your location: " 					+ error.message); 			break; 		case 1: 			updateStatus("The user prevented this page from retrieving a location."); 			break; 		case 2: 			updateStatus("The browser was unable to determine your location: " 					+ error.message); 			break; 		case 3: 			updateStatus("The browser timed out before retrieving the location."); 			break; 		} 	} 	//initialise la carte googleMaps 	function initialize() { 		var myLatlng = new google.maps.LatLng(0, 0); 		myOptions = { 			zoom : 1, 			center : myLatlng, 			mapTypeId : google.maps.MapTypeId.ROADMAP 		}; 		map = new google.maps.Map(document.getElementById("mapCanvas"), 				myOptions); 	} 	//fonction successCallBack appelé par la requete getCurrentPosition 	function findPosition(position) { 		latitude = position.coords.latitude; 		longitude = position.coords.longitude; 		accuracy = position.coords.accuracy;         findOnGoogleMaps(); 	} 	//repère la position de l'utilisateur sur la carte 	function findOnGoogleMaps() { 		maPosition = new google.maps.LatLng(latitude, longitude); 		map.setZoom(15); 		map.setCenter(maPosition); 		var marker = new google.maps.Marker({ 			position : maPosition, 			map : map, 			title : "Me!" 		}); 		document.getElementById('chemin').style.visibility='visible'; 	} 	//trace le chemin pour aller à Zénika à partir de la position courante 	function findDirection() { 		var directionsService = new google.maps.DirectionsService(); 		var start = maPosition; 		var end = "51, rue Le Peletier, Paris" 		var request = { 			origin : start, 			destination : end, 			travelMode : google.maps.DirectionsTravelMode.DRIVING 		}; 		directionsService.route(request, function(response, status) { 			if (status == google.maps.DirectionsStatus.OK) { 				directionsDisplay.setDirections(response); 			} 		}); 		directionsDisplay = new google.maps.DirectionsRenderer(); 		directionsDisplay.setMap(map); 	} 	//trouve la position courante de l'utilisateur 	function startGeolocation() { 		if (n
avigator.geolocation) { 			navigator.geolocation.getCurrentPosition(findPosition, handleError); 		} else { 			updateStatus("HTML5 Geolocation is not supported in your browser."); 		} 	} </script> </head> <body onload="initialize()"> <div> 	<button type="button" id="find" onclick="startGeolocation()">Find Me!</button> 	<button type="button" id="chemin" onclick="findDirection()" style="visibility: hidden" >Go to Zenika</button> </div> <br />
<div id="mapCanvas"></div> </body> </html> <p><br /></p> <p>Ainsi, en cliquant sur le bouton "Find me!", le navigateur va récupérer les coordonnées courantes et afficher la position sur la carte. Ensuite, le bouton "Go to Zenika" permet de tracer un itinéraire entre la position courante et le bureau de Zenika à Paris.</p> <h3>Conclusion</h3> <p>Nous venons donc de voir comment utiliser l'API Geolocation d'Html5 pour trouver la position de l'utilisateur et, avec l'API Google Maps, l'afficher sur une carte. L'exemple que nous avons vu est relativement simple, il faut savoir que l'API comprend une autre fonctionnalité qui permet de suivre la position de l'utilisateur et la mettre à jour à intervalle régulier. Ainsi dans le cas d'un utilisateur mobile, nous pourrions imaginer une application qui calcule sa position courante ainsi que la distance parcourue au fur et à mesure.</p> <p>Dans le prochain billet consacré à Html5, je m'intéresserai aux applications en mode Hors-ligne.</p>