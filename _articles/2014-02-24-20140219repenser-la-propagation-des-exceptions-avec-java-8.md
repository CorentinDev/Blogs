---
ID: 145
post_title: >
  Repenser la propagation des exceptions
  avec Java 8
author: ylegat
post_date: 2014-02-24 10:45:00
post_excerpt: "<p>La sortie de Java 8 est prévu pour le 18 mars prochain ; les plus curieux d'entre nous ont déjà pris un peu de temps pour se familiariser avec quelques unes de ses nouveautés et en particulier avec les lambda et l'API <code>java.util.stream</code>.</p> <p>L'objet de cet article est d'étudier en quoi l'utilisation de cette API va nous amener à repenser la manière dont nous manipulons les exceptions Java.</p>"
layout: post
permalink: http://blog.zenika-offres.com/?p=145
published: true
---
<p>La sortie de Java 8 est prévu pour le 18 mars prochain ; les plus curieux d'entre nous ont déjà pris un peu de temps pour se familiariser avec quelques unes de ses nouveautés et en particulier avec les lambda et l'API <code>java.util.stream</code>.</p> <p>L'objet de cet article est d'étudier en quoi l'utilisation de cette API va nous amener à repenser la manière dont nous manipulons les exceptions Java.</p>
<!--more-->
<h2>Des lambda&nbsp;! Des lambda partout&nbsp;! Des lambda sans exceptions&nbsp;!</h2> <p>Considérons le contexte suivant&nbsp;:</p> <ul> <li>une méthode, <code>doSomething</code>, prenant en entrée un <code>Integer</code> et retournant un résultat du même type</li> <li>une liste d'entiers que nous souhaitons transformer à l'aide de l'API <code>Stream</code> en utilisant la méthode décrite plus haut</li> </ul> <p>Pour cela rien de plus simple :</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Integer</span> doSomething<span style="color: #009900;">&#40;</span><span style="color: #003399;">Integer</span> value<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     <span style="color: #666666; font-style: italic;">// do something ...</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> test<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     List<span style="color: #339933;">&lt;</span>Integer<span style="color: #339933;">&gt;</span> myList <span style="color: #339933;">=</span> <span style="color: #003399;">Arrays</span>.<span style="color: #006633;">asList</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1</span>, <span style="color: #cc66cc;">2</span>, <span style="color: #cc66cc;">3</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>     List<span style="color: #339933;">&lt;</span>Integer<span style="color: #339933;">&gt;</span> result <span style="color: #339933;">=</span> myList.<span style="color: #006633;">stream</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.             <span style="color: #006633;">map</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">this</span><span style="color: #339933;">::</span>doSomething<span style="color: #009900;">&#41;</span>.             <span style="color: #006633;">collect</span><span style="color: #009900;">&#40;</span>Collectors.<span style="color: #006633;">toList</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Supposons maintenant que la signature de la méthode <code>doSomething</code> déclare retourner une exception checked.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Integer</span> doSomething<span style="color: #009900;">&#40;</span><span style="color: #003399;">Integer</span> value<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span> <span style="color: #009900;">&#123;</span>     <span style="color: #666666; font-style: italic;">// do something </span> <span style="color: #009900;">&#125;</span></pre> <p>Le compilateur nous averti à présent d'une erreur : <code>doSomething</code> retourne une exception qui n'est pas contenue dans la lambda transmise à la méthode <code>Stream.map</code>. Et effectivement, <code>map</code> prend en paramètre une instance de <code>Function</code> laquelle définie la méthode <code>apply</code> de la manière suivante&nbsp;:</p> <pre class="java code java" style="font-family:inherit">R apply<span style="color: #009900;">&#40;</span>T t<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p><code>Function</code> n'a donc pas été conçue pour remonter des exceptions checked. Il y a sans doute une bonne raison à cela : le projet lambda a donné lieu à de nombreux débats portant sur la place des exceptions en Java. Le sujet a même fait l'objet d'un article écrit par Brian Goertz : <a href="https://blogs.oracle.com/briangoetz/entry/exception_transparency_in_java" hreflang="en" title="exception transparency in java">Exception Transparency in Java</a>.</p> <p>Pour résumé son propos : le traitement des exceptions checked est une des faiblesse du langage parce qu'il impose aux concepteurs d'API à choisir entre deux extrêmes : prévoir la possibilité de retourner des exceptions et imposer ainsi aux utilisateurs d'encadrer leurs appels dans des blocs <code>try / catch</code> parfois inutiles, comme c'est le cas avec <code>Callable</code>, ou suivre la voie inverse comme l'illustrent <code>Runnable</code> et maintenant <code>Function</code>.</p> <p>Les <a href="http://mail.openjdk.java.net/pipermail/lambda-dev/2010-June/001484.html" hreflang="en">échanges</a> entre les membres du projet lambda montrent qu'ils ont essayé pendant un temps de trouver une solution alternative, mais en vain. Leur décision s'est donc finalement portée sur une implémentation « à la Runnable »  mais je ne suis pas parvenu à trouver de documents exposant les raisons qui les ont poussé à faire ce choix.</p> <p>Quoiqu'il en soit, et dans ces conditions, comment transmettre l'information indiquant qu'une exception a été levée durant l'exécution d'un stream ? Trois solutions au moins s'offrent à nous.</p> <h2>Une première approche naïve.</h2> <p>En l'état, le plus simple serait de catcher notre exception lors de l'appel à <code>doSomething</code>&nbsp;:</p> <pre class="java code java" style="font-family:inherit">List<span style="color: #339933;">&lt;</span>Integer<span style="color: #339933;">&gt;</span> result <span style="color: #339933;">=</span> myList.<span style="color: #006633;">stream</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.         <span style="color: #006633;">map</span><span style="color: #009900;">&#40;</span>value <span style="color: #339933;">-&gt;</span> <span style="color: #009900;">&#123;</span>             <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>                 <span style="color: #000000; font-weight: bold;">return</span> doSomething<span style="color: #009900;">&#40;</span>value<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>             <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">IOException</span> e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                 e.<span style="color: #006633;">printStackTrace</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>                 <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #339933;">-</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span>             <span style="color: #009900;">&#125;</span>         <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.         <span style="color: #006633;">collect</span><span style="color: #009900;">&#40;</span>Collectors.<span style="color: #006633;">toList</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <p>Pour juger de l'intérêt de cette approche, ainsi que de celles qui suivront, je propose de prendre en compte quatre critères :</p> <ol> <li>propagation&nbsp;: l'exception d'origine peut-elle être remontée le long de la pile d'appel ?</li> <li>disjonction&nbsp;: la valeur d'échec peut-elle interférer avec l'ensemble des résultats valides ?</li> <li>visibilité&nbsp;: la présence éventuelle d'une exception est-elle clairement visible par le développeur ?</li> <li>indépendance&nbsp;: un échec provoqué p
ar le traitement d'un élément d'une collection peut-il entraîner l'échec du traitement de l'ensemble des éléments de cette collection ?</li> </ol> <p>Avec cette solution le contenu même de l'exception est perdu au cours du traitement et la valeur d'échec peut interférer avec un résultat valide (-1, dans cet exemple, pourrait tout à fait être une valeur correcte). En revanche le compilateur averti clairement le développeur de la présence éventuelle d'une exception à l'intérieur de <code>map</code> et cette éventualité n'empêchera pas le traitement de tous les éléments de <code>myList</code>.</p> <h2>Un classique : la cape d'invisibilité appliquée aux exceptions.</h2> <p>Il est possible de rendre une exception « invisible » en l'enveloppant à l'intérieur d'une exception de type runtime.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Integer</span> doSomething<span style="color: #009900;">&#40;</span><span style="color: #003399;">Integer</span> value<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// do something</span>     <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">catch</span><span style="color: #009900;">&#40;</span><span style="color: #003399;">IOException</span> e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #000000; font-weight: bold;">throw</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">RuntimeException</span><span style="color: #009900;">&#40;</span>e<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>     <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Cette manipulation est d'ailleurs tellement courante que Guava propose une classe utilitaire, <code>Throwables</code>, facilitant cette opération. Nous pouvons maintenant traiter l'exception à un niveau plus élevé que précédemment :</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> test<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     ArrayList<span style="color: #339933;">&lt;</span>Integer<span style="color: #339933;">&gt;</span> myList <span style="color: #339933;">=</span> <span style="color: #003399;">Arrays</span>.<span style="color: #006633;">asList</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1</span>, <span style="color: #cc66cc;">2</span>, <span style="color: #cc66cc;">3</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>         List<span style="color: #339933;">&lt;</span>Integer<span style="color: #339933;">&gt;</span> result <span style="color: #339933;">=</span> myList.<span style="color: #006633;">stream</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">map</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">this</span><span style="color: #339933;">::</span>doSomething<span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">collect</span><span style="color: #009900;">&#40;</span>Collectors.<span style="color: #006633;">toList</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">catch</span><span style="color: #009900;">&#40;</span><span style="color: #003399;">RuntimeException</span> e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// handle exception </span>     <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Cette solution fonctionne mais elle nous limite en cela qu'une exception remontée lors de la manipulation d'un élément de notre stream empêchera le traitement des éléments restants. Or nous pourrions considérer que ces traitements sont tous indépendants les uns des autres et que ce comportement n'est donc pas approprié.</p> <p>Un collègue, Hugo Wood, a proposé une solution pour résoudre ce problème. Elle est disponible sur <a href="https://github.com/hgwood/java8-streams-and-exceptions/">GitHub</a> et consiste à encapsuler le traitement des élément du stream dans des <code>Supplier</code> puis à collecter le tout à l'aide d'un <code>Collector</code> particulier.</p> <p>Cette solution reste toutefois dangereuse : en rendant silencieuses nos exceptions nous pouvons être certain qu'il arrivera régulièrement aux membres de notre équipe d'oublier de les traiter. Et quand bien même, il nous faudrait aussi séparer le bon grain de l'ivraie, à savoir d'une part les exceptions runtime qui doivent redescendre tout en bas de la pile d'appel pour signaler les erreurs graves (salut à toi, <code>NullPointerException</code>) et de l'autre les exceptions checked que nous devrions contenir.</p> <p>Autant de symptômes indiquant selon moi que quelque chose ne va pas avec cette approche. Ceci dit il n'y a pas que du négatif : les exceptions peuvent être propagées le long de la pile d'appel, il n'y a pas d'interférence entre un échec et l'ensemble des résultat valides et, grâce à l'implémentation de Hugo, les différents éléments d'un stream peuvent être traités indépendamment les uns des autres.</p> <h2>Un nouveau type d'exception.</h2> <p>On dira ce que l'on veut de Scala mais sa gestion des exceptions checked a le mérite d'être agréable à utiliser. Scala propose en effet deux classes, <code>Success</code> et <code>Failure</code>, héritant toutes deux de la classe abstraite <code>Try</code>. Un <code>Try</code> représente une tentative pour réaliser une opération et obtenir un résultat (en cela sa sémantique n'est pas différente de celle du mot clef java <code>try</code>). Si cette tentative est un succès il s'agit d'une instance de <code>Success</code>. Dans le cas contraire, il s'agit d'une instance de <code>Failure</code>.</p> <p>Pour la petite histoire : <code>Try</code> est en réalité une contribution de Twitter et c'est seulement après plusieurs années d'utilisation en interne que ce pattern a été intégré à l'API Scala.</p> <p>L'avantage principal de cette solution est qu'elle nous permet de ne plus être confronté au dilemme que nous avons évoqué plus haut : nous pouvons à présent laisser aux développeurs la décision de transmettre ou non des exceptions checked simplement en rendant générique les types de retour des méthodes de nos interfaces. Dans ce contexte, la présence d'une exception n'est en aucun cas dissimulée : tout comme <code>Optional</code> a été conçue pour alerter le développeur sur la présence éventuelle d'une référence null (la fameuse erreur à un milliard de dollars), <code>Try</code> nous alerte sur la possible présence d'une exception.</p> <p>L'autre avantage est que la réception d'une exception ne rompt plus brutalement le flux d'exécution de notre programme. Son traitement s'intègre plus naturellement dans notre code et nous réduisons ainsi l'empreinte du code purement technique.</p> <p>À ma connaissance, le seul type présent dans Java 8 qui se rapproche un peu du concept de <code>Try</code> est <code>Optional</code>, mais il s'agit d'une classe final dont il
n'existe qu'une seule instance <code>empty</code> (c'est pour s'en assurer que le constructeur de <code>Optional</code> a été rendu privé). Impossible donc de conserver les exceptions levées avec ce moyen.</p> <p>Nous allons devoir implémenter nous même cette structure si nous souhaitons l'utiliser... une implémentation de <code>Try</code> pourrait ressembler à ceci&nbsp;:</p> <p><img src="/wp-content/uploads/2015/07/try-uml.png" alt="try-uml" style="display:block; margin:0 auto;" title="try-uml" /></p> <p>Rien de très inattendu : nous avons là une classe abstraite <code>Try</code> et deux implémentations <code>Success</code> et <code>Failure</code>.</p> <p><code>ThrowingFunction</code> est une interface représentant une fonction qui, contrairement à l'interface standard <code>Function</code>, peut retourner une exception. <code>Try.of</code> a pour rôle de convertir une instance de <code>ThrowingFunction&lt;I, O&gt;</code> en une instance de <code>Function&lt;I, Try&lt;O&gt;&gt;</code>. C'est en quelque sorte le pont qui réconcilie <code>java.util.stream</code> avec les exceptions.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #339933;">&lt;</span>I, O<span style="color: #339933;">&gt;</span> Function<span style="color: #339933;">&lt;</span>I, Try<span style="color: #339933;">&lt;</span>O<span style="color: #339933;">&gt;&gt;</span> of<span style="color: #009900;">&#40;</span>ThrowingFunction<span style="color: #339933;">&lt;</span>I, O<span style="color: #339933;">&gt;</span> function<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     <span style="color: #000000; font-weight: bold;">return</span> a <span style="color: #339933;">-&gt;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>             O result <span style="color: #339933;">=</span> function.<span style="color: #006633;">apply</span><span style="color: #009900;">&#40;</span>a<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>             <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> Success<span style="color: #339933;">&lt;&gt;</span><span style="color: #009900;">&#40;</span>result<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">RuntimeException</span> e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             <span style="color: #000000; font-weight: bold;">throw</span> e<span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// we don't want to wrap runtime exceptions</span>         <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Exception</span> e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> Failure<span style="color: #339933;">&lt;&gt;</span><span style="color: #009900;">&#40;</span>e<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span>     <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Voici un exemple d'utilisation : la transformation d'une liste d'entiers à l'aide de <code>doSomething</code> et le partitionnement des résultats en fonction du succès de cette opération. Le partitionnement est effectué à l'aide de la méthode <code>Try.groupingBySuccess</code> laquelle est simplement une méthode utilitaire retournant le Collector approprié.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Integer</span> doSomething<span style="color: #009900;">&#40;</span><span style="color: #003399;">Integer</span> value<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// do something</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> test<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     List<span style="color: #339933;">&lt;</span>Integer<span style="color: #339933;">&gt;</span> myList <span style="color: #339933;">=</span> <span style="color: #003399;">Arrays</span>.<span style="color: #006633;">asList</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">1</span>, <span style="color: #cc66cc;">2</span>, <span style="color: #cc66cc;">3</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;     Map<span style="color: #339933;">&lt;</span>Type, List<span style="color: #339933;">&lt;</span>Try<span style="color: #339933;">&lt;</span>Double<span style="color: #339933;">&gt;&gt;&gt;</span> result <span style="color: #339933;">=</span> myList.<span style="color: #006633;">stream</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">map</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">Try</span>.<span style="color: #006633;">of</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">this</span><span style="color: #339933;">::</span>doSomething<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">map</span><span style="color: #009900;">&#40;</span>trry <span style="color: #339933;">-&gt;</span> trry.<span style="color: #006633;">map</span><span style="color: #009900;">&#40;</span>i <span style="color: #339933;">-&gt;</span> <span style="color: #003399;">Math</span>.<span style="color: #006633;">PI</span> <span style="color: #339933;">*</span> i<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>.                 <span style="color: #006633;">collect</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">Try</span>.<span style="color: #006633;">groupingBySuccess</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>result.<span style="color: #006633;">containsKey</span><span style="color: #009900;">&#40;</span>Type.<span style="color: #006633;">FAILURE</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// do something with failure</span>     <span style="color: #009900;">&#125;</span>     <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>result.<span style="color: #006633;">containsKey</span><span style="color: #009900;">&#40;</span>Type.<span style="color: #006633;">SUCCESS</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</
span>         <span style="color: #666666; font-style: italic;">// do something with success</span>     <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Ici, peu importe que les éléments calculés soient de type <code>Success</code> ou <code>Failure</code>, notre stream continuera d'être exécuté jusqu'à ce que tous les éléments de <code>myList</code> aient été indépendamment traités. Cette solution est donc conforme aux quatre critères que nous avons listé. Voici d'ailleurs un récapitulatif des trois solutions que nous venons de voir :</p> <table> <tr> <td></td> <td style="padding:5px"><strong>propagation</strong></td> <td style="padding:5px"><strong>disjonction</strong></td> <td style="padding:5px"><strong>visibilité</strong></td> <td style="padding:5px"><strong>indépendance</strong></td> </tr> <td style="padding:5px"><strong>solution naïve</strong></td> <td style="text-align:center;color:red">non</td> <td style="text-align:center;color:red">non</td> <td style="text-align:center;color:green">oui</td> <td style="text-align:center;color:green">oui</td> </tr> <td style="padding:5px"><strong>exceptions runtime</strong></td> <td style="text-align:center;color:green">oui</td> <td style="text-align:center;color:green">oui</td> <td style="text-align:center;color:red">non</td> <td style="text-align:center;color:green">oui</td> </tr> <td style="padding:5px"><strong>success / failure</strong></td> <td style="text-align:center;color:green">oui</td> <td style="text-align:center;color:green">oui</td> <td style="text-align:center;color:green">oui</td> <td style="text-align:center;color:green">oui</td> </tr> </table> <p>Il existe pourtant des situations qui requiert de pouvoir cesser le processus de traitement dès qu'un échec a été détecté. Bien sûr, il aurait été idéal de pouvoir transmettre à notre stream un prédicat lui indiquant quand il doit interrompre son traitement, mais pour cela la seule méthode proposée par l'API est la méthode <code>limit(int n)</code> qui limite le nombre de résultats retournés.</p> <p>Pour contourner ce problème je me suis inspiré de la solution implémentée par Hugo et je l'ai adapté en ajoutant une méthode statique <code>Try.lazyOf</code> afin de convertir une instance de <code>ThrowingFunction&lt;I, O&gt;</code> en une instance de <code>Function&lt;I, Supplier&lt;Try&lt;O&gt;&gt;&gt;</code>. Par la suite les suppliers sont collectés dans une implémentation dédiée de Collector, <code>TryCollector</code>, et résolus tant que les résultats sont de type Success.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> test<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     Try<span style="color: #339933;">&lt;</span>List<span style="color: #339933;">&lt;</span>Integer<span style="color: #339933;">&gt;&gt;</span> result <span style="color: #339933;">=</span> myList.<span style="color: #006633;">stream</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.             <span style="color: #006633;">map</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">Try</span>.<span style="color: #006633;">lazyOf</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">this</span><span style="color: #339933;">::</span>doSomething<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>.             <span style="color: #006633;">collect</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">Try</span>.<span style="color: #006633;">collect</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>result.<span style="color: #006633;">isSuccess</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// process success</span>     <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// process failure</span>     <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <h3>Conclusion</h3> <p>Bien sûr, l'idéal serait de pouvoir intégrer toutes ces fonctionnalités directement dans l'API <code>java.util.stream</code>. La bonne nouvelle c'est que c'est possible : grâce aux méthodes virtuelles d'extension nous avons désormais la possibilité d'ajouter des méthodes ayant un comportement par défaut dans n'importe quelle interface tout en conservant une compatibilité ascendante. Il n'est donc pas impossible qu'un jour ou l'autre Oracle décide d'intégrer un dispositif similaire à son API. En attendant, le code source de cette implémentation de <code>Try</code> est disponible <a href="https://github.com/Zenika/Try" title="code source">ici</a>.</p>