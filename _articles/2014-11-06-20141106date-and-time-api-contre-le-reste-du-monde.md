---
ID: 148
post_title: >
  Date and Time API contre le reste du
  monde
author: Gérald Quintana
post_date: 2014-11-06 16:15:00
post_excerpt: "<p>Java 8 apporte une nouvelle API pour manipuler les dates et heures en Java, la Date and Time API, aussi connue comme JSR 310. L'objectif de cet article n'est pas de présenter cette API, mais de montrer ce que l'on doit faire aujourd'hui, pour l'intégrer avec les librairies habituelles comme Spring ou Hibernate, et se débarrasser des <code>java.util.Date</code> et autres <code>java.util.GregorianCalendar</code></p>"
layout: post
permalink: http://blog.zenika-offres.com/?p=148
published: true
slide_template:
  - default
---
Java 8 apporte une nouvelle API pour manipuler les dates et heures en Java, la Date and Time API, aussi connue comme JSR 310. L'objectif de cet article n'est pas de présenter cette API, mais de montrer ce que l'on doit faire aujourd'hui, pour l'intégrer avec les librairies habituelles comme Spring ou Hibernate, et se débarrasser des <code>java.util.Date</code> et autres <code>java.util.GregorianCalendar</code>

<!--more-->

Si vous utilisez encore Java 7, cet article est probablement transposable sur <a href="http://www.joda.org/joda-time/">Joda Time</a> (qui a inspiré la JSR 310) ou sur le <a href="http://www.threeten.org/threetenbp/">"backport" ThreeTen</a>.

Pour commencer, on va persister en base une entité Utilisateur avec un attribut <code>dateNaissance</code> de type <code>java.time.LocalDate</code>. Au niveau, JDBC, cela signifie qu'il faudra être capable de convertir ce type depuis et vers une <code>java.sql.Date</code>
<h3>Persistance avec Hibernate</h3>
Avec Hibernate, pour faire en sorte que le type <code>java.time.LocalTime</code> soit reconnu, il faut implémenter et utiliser un UserType. Par chance, une telle implémentation existe déjà dans une librairie nommée <a href="http://jadira.sourceforge.net/usertype.extended/">Jadira UserType Extended</a>
<pre class="xml code xml" style="font-family: inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.jadira.usertype<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>usertype.extended<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>3.2.0.GA<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
Avec cette librairie, on annotera juste la date de naissance au niveau de l'entité pour indique les UserType:
<pre class="java code java" style="font-family: inherit;">@<span style="color: #003399;">Entity</span>     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Utilisateur <span style="color: #000000; font-weight: bold;">implements</span> <span style="color: #003399;">Serializable</span> <span style="color: #009900;">{</span>         ...         @Type<span style="color: #009900;">(</span>type<span style="color: #339933;">=</span><span style="color: #0000ff;">"org.jadira.usertype.dateandtime.threeten.PersistentLocalDate"</span><span style="color: #009900;">)</span>         <span style="color: #000000; font-weight: bold;">private</span> LocalDate dateNaissance<span style="color: #339933;">;</span></pre>
<h3>Persistance avec JDBC</h3>
Si l'on dispose d'un driver compatible <a href="http://openjdk.java.net/jeps/170">JDBC 4.2</a> (la version de JDBC incluse à Java 8), on doit pouvoir en théorie écrire:
<pre class="java code java" style="font-family: inherit;"><span style="color: #666666; font-style: italic;">// Dans les ResultSet</span>     LocalDate localDate <span style="color: #339933;">=</span> resultSet.<span style="color: #006633;">getObject</span><span style="color: #009900;">(</span><span style="color: #0000ff;">"date_naissance"</span>, LocalDate.<span style="color: #000000; font-weight: bold;">class</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>       <span style="color: #666666; font-style: italic;">// Pour les PreparedStatement</span>     preparedStatement, setObject<span style="color: #009900;">(</span><span style="color: #cc66cc;">3</span>, localDate, <span style="color: #003399;">Types</span>.<span style="color: #006633;">DATE</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre>
En pratique peu de bases de données fournissent un driver compatible JDBC 4.2.
<ul>
	<li><strong>Oracle 10.1 (i.e. 12c):</strong> JDBC 4.1</li>
	<li><strong>PostgreSQL 9.3:</strong> JDBC 4.1</li>
	<li><strong>MySQL Connector/J 5.1:</strong> JDBC 4.0</li>
	<li><strong>H2 1.4:</strong> JDBC 4.0</li>
	<li><strong>HSQL 2.3:</strong> JDBC 4.0</li>
	<li><strong>Apache Derby 10.11:</strong> JDBC 4.2</li>
</ul>
Même la base JavaDB, incluse à Java 8 et issue de Apache Derby, qui <a href="https://issues.apache.org/jira/browse/DERBY-6000">implémente pourtant JDBC 4.2</a> ne semble pas s'intégrer avec la JSR 310. Au final, il faudra donc écrire quelques méthodes utilitaires pour convertir, extraire et injecter les dates en passant par le type <code>java.sql.Date</code>:
<pre class="java code java" style="font-family: inherit;"><span style="color: #666666; font-style: italic;">// Pour les ResultSet</span>     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> LocalDate toLocalDate<span style="color: #009900;">(</span>java.<span style="color: #006633;">sql</span>.<span style="color: #003399;">Date</span> sqlDate<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>         <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">(</span>sqlDate <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>             <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #339933;">;</span>         <span style="color: #009900;">}</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #009900;">{</span>             <span style="color: #000000; font-weight: bold;">return</span> Instant.<span style="color: #006633;">ofEpochMilli</span><span style="color: #009900;">(</span>utilDate.<span style="color: #006633;">getTime</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>.<span style="color: #006633;">atZone</span><span style="color: #009900;">(</span>ZoneId.<span style="color: #006633;">systemDefault</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>.<span style="color: #006633;">toLocalDate</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>         <span style="color: #009900;">}</span>     <span style="color: #009900;">}</span>     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> LocalDate getLocalDate<span style="color: #009900;">(</span><span style="color: #003399;">ResultSet</span> resultSet, <span style="color: #003399;">String</span> columnLabel<span style="color: #009900;">)</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">SQLException</span> <span style="color: #009900;">{</span>         <span style="color: #000000; font-weight: bold;">return</span> toLocalDate<span style="color: #009900;">(</span>resultSet.<span style="color: #006633;">getDate</span><span style="color: #009900;">(</span>columnLabel<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>     <span style="color: #009900;">}</span>       <span style="color: #666666; font-style: italic;">// Pour les
 PreparedStatement</span>     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> java.<span style="color: #006633;">sql</span>.<span style="color: #003399;">Date</span> toSqlDate<span style="color: #009900;">(</span>LocalDate localDate<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>         <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> java.<span style="color: #006633;">sql</span>.<span style="color: #003399;">Date</span><span style="color: #009900;">(</span>localDate.<span style="color: #006633;">atStartOfDay</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>.<span style="color: #006633;">atZone</span><span style="color: #009900;">(</span>ZoneId.<span style="color: #006633;">systemDefault</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span>.<span style="color: #006633;">toInstant</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>.<span style="color: #006633;">toEpochMilli</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>     <span style="color: #009900;">}</span>     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000066; font-weight: bold;">void</span> setLocalDate<span style="color: #009900;">(</span><span style="color: #003399;">PreparedStatement</span> preparedStatement, <span style="color: #000066; font-weight: bold;">int</span> parameterIndex, LocalDate localDate<span style="color: #009900;">)</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">SQLException</span> <span style="color: #009900;">{</span>         <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">(</span>localDate <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>             preparedStatement.<span style="color: #006633;">setNull</span><span style="color: #009900;">(</span>parameterIndex, <span style="color: #003399;">Types</span>.<span style="color: #006633;">DATE</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>         <span style="color: #009900;">}</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #009900;">{</span>             preparedStatement.<span style="color: #006633;">setDate</span><span style="color: #009900;">(</span>parameterIndex, toSqlDate<span style="color: #009900;">(</span>localDate<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>         <span style="color: #009900;">}</span>     <span style="color: #009900;">}</span></pre>
<h3>Persistance avec Spring JDBC</h3>
Grâce aux méthodes utilitaires précédentes, le code Spring JDBC coule de source. Les lambdas permettent même de raccourcir l'écriture des <code>RowMapper</code>s.
<pre class="java code java" style="font-family: inherit;">utilisateurs <span style="color: #339933;">=</span> jdbcTemplate.<span style="color: #006633;">query</span><span style="color: #009900;">(</span>                 <span style="color: #666666; font-style: italic;">// SQL</span>                 <span style="color: #0000ff;">"select * from utilisateur "</span>                         <span style="color: #339933;">+</span> <span style="color: #0000ff;">"where date_naissance between ? and ?"</span>,                 <span style="color: #666666; font-style: italic;">// Paramètres</span>                 <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">Object</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span><span style="color: #009900;">{</span>toSqlDate<span style="color: #009900;">(</span>dateMin<span style="color: #009900;">)</span>, toSqlDate<span style="color: #009900;">(</span>dateMax<span style="color: #009900;">)</span><span style="color: #009900;">}</span>,                 <span style="color: #666666; font-style: italic;">// RowMapper</span>                 <span style="color: #009900;">(</span>resultSet, rowNum<span style="color: #009900;">)</span> <span style="color: #339933;">-&gt;</span> <span style="color: #009900;">{</span>                     Utilisateur utilisateur <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Utilisateur<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>                     <span style="color: #666666; font-style: italic;">// ...</span>                     utilisateur.<span style="color: #006633;">setDateNaissance</span><span style="color: #009900;">(</span>getLocalDate<span style="color: #009900;">(</span>resultSet, <span style="color: #0000ff;">"date_naissance"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>                     <span style="color: #000000; font-weight: bold;">return</span> utilisateur<span style="color: #339933;">;</span>                 <span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre>
En utilisant le <code>BeanPropertyRowMapper</code> pour peupler automatiquement les attributs, on peut automatiser la conversion. On commence par enregistrer un <code>Converter</code> dans le <code>ConversionService</code> de Spring, on ne peut pas utiliser une lambda ici, sinon Spring n'arrive pas à déterminer les types sources/cibles par réflexion. On lie ensuite le <code>ConversionService</code> au <code>BeanPropertyRowMapper</code> via le <code>BeanWrapper</code>:
<pre class="java code java" style="font-family: inherit;">@Bean     <span style="color: #000000; font-weight: bold;">public</span> ConversionService conversionService<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>         DefaultConversionService conversionService <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> DefaultConversionService<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>         conversionService.<span style="color: #006633;">addConverter</span><span style="color: #009900;">(</span><span style="color: #000000; font-weight: bold;">new</span> Converter<span style="color: #339933;">&lt;</span>Date, LocalDate<span style="color: #339933;">&gt;</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>             <span style="color: #000000; font-weight: bold;">public</span> LocalDate convert<span style="color: #009900;">(</span><span style="color: #003399;">Date</span> date<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>                 <span style="color: #000000; font-weight: bold;">return</span> toLocalDate<span style="color: #009900;">(</span>date<span style="color: #009900;">)</span><span style="color: #339933;">;</span>             <span style="color: #009900;">}</span>         <span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>         <span style="color: #000000; font-weight: bold;">return</span> conversionService<span style="color: #339933;">;</span>     }           RowMapper<span style="color: #339933;">&lt;</span>Utilisateur<span style="color: #339933;">&gt;</span> rowMapper <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> BeanPropertyRowMapper<span style="color: #009900;">(</span>Utilisateur.<span style="color: #000000; font-weight: bold;">class</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>             <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000066; font-weight: bold;">void</span> initBeanWrapper<span style="color: #009900;">(</span>BeanWrapper bw<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>                 bw.<span style="color: #006633;">setConversionService</span><span style="color: #009900;">(</span>conversionService<span style="color: #009900;">)</span><span style="color: #339933;">;</span>             <span style="color: #009900;">}</span>         <span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre>
Nous savons à présent lire/écrire des <code>LocalDate</code> avec Hibernate et Spring JDBC. Voyons à présent comment les utiliser lors des échanges REST/JSON et SOAP/XML.
<h3>Sérialisation JSON</h3>
Pour traiter le cas du JSON, avec Jackson c'est immédiat, il y a un module dédié:
<pre class="xml code xml" style="font-family: inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>com.fasterxml.jackson.datatype<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>jackson-datatype-jsr310<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>             <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>${jackson.version}<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
Il suffit de l'enregistrer dans l'<code>ObjectMapper</code>. On peut personnaliser le format de la sérialisation en activant/désactivant l'option <code>WRITE_DATES_AS_TIMESTAMPS</code>:
<pre class="java code java" style="font-family: inherit;">ObjectMapper objectMapper <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> ObjectMapper<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>     objectMapper.<span style="color: #006633;">registerModule</span><span style="color: #009900;">(</span><span style="color: #000000; font-weight: bold;">new</span> JSR310Module<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>     objectMapper.<span style="color: #006633;">disable</span><span style="color: #009900;">(</span>SerializationFeature.<span style="color: #006633;">WRITE_DATES_AS_TIMESTAMPS</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre>
Pour peu qu'il détecte ce qu'il faut sur le classpath, Spring Boot s'occupe de tout (voir <code>JacksonAutoConfiguration</code>).

En ce qui concerne le passage de dates dans les URL HTTP, Spring MVC 4.1 supporte nativement les types JSR 310, il faut juste mettre une annotation <code>@DateTimeFormat</code> pour stipuler le format:
<pre class="java code java" style="font-family: inherit;">@RequestMapping<span style="color: #009900;">(</span>value<span style="color: #339933;">=</span><span style="color: #0000ff;">"/utilisateur"</span>, method <span style="color: #339933;">=</span> RequestMethod.<span style="color: #006633;">GET</span>, produces <span style="color: #339933;">=</span> MediaType.<span style="color: #006633;">APPLICATION_JSON_VALUE</span><span style="color: #009900;">)</span>     <span style="color: #000000; font-weight: bold;">public</span> List<span style="color: #339933;">&lt;</span>Utilisateur<span style="color: #339933;">&gt;</span> findAllWithDateNaissance<span style="color: #009900;">(</span>             @RequestParam<span style="color: #009900;">(</span><span style="color: #0000ff;">"dateMin"</span><span style="color: #009900;">)</span> @DateTimeFormat<span style="color: #009900;">(</span>iso<span style="color: #339933;">=</span>DateTimeFormat.<span style="color: #006633;">ISO</span>.<span style="color: #006633;">DATE</span><span style="color: #009900;">)</span> LocalDate dateMin,             @RequestParam<span style="color: #009900;">(</span><span style="color: #0000ff;">"dateMax"</span><span style="color: #009900;">)</span> @DateTimeFormat<span style="color: #009900;">(</span>iso<span style="color: #339933;">=</span>DateTimeFormat.<span style="color: #006633;">ISO</span>.<span style="color: #006633;">DATE</span><span style="color: #009900;">)</span> LocalDate dateMax<span style="color: #009900;">)</span> <span style="color: #009900;">{</span></pre>
<h3>Sérialisation XML</h3>
Passons à présent aux échanges XML avec JAXB, on écrit un <code>XmlAdapter</code> capable de convertir la <code>LocalDate</code> en <code>XMLGregorianCalendar</code>:
<pre class="java code java" style="font-family: inherit;"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> LocalDateXmlAdapter <span style="color: #000000; font-weight: bold;">extends</span> XmlAdapter<span style="color: #339933;">&lt;</span>XMLGregorianCalendar, LocalDate<span style="color: #339933;">&gt;</span> <span style="color: #009900;">{</span>     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> DatatypeFactory datatypeFactory<span style="color: #339933;">;</span>     <span style="color: #000000; font-weight: bold;">public</span> LocalDateXmlAdapter<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #000000; font-weight: bold;">throws</span> DatatypeConfigurationException<span style="color: #009900;">{</span>         <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">datatypeFactory</span> <span style="color: #339933;">=</span> DatatypeFactory.<span style="color: #006633;">newInstance</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>     <span style="color: #009900;">}</span>     <span style="color: #000000; font-weight: bold;">public</span> LocalDate unmarshal<span style="color: #009900;">(</span>XMLGregorianCalendar xmlDate<span style="color: #009900;">)</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">Exception</span> <span style="color: #009900;">{</span>         <span style="color: #000000; font-weight: bold;">return</span> LocalDate.<span style="color: #006633;">of</span><span style="color: #009900;">(</span>xmlDate.<span style="color: #006633;">getYe
ar</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>, xmlDate.<span style="color: #006633;">getMonth</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>, xmlDate.<span style="color: #006633;">getDay</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>     <span style="color: #009900;">}</span>     <span style="color: #000000; font-weight: bold;">public</span> XMLGregorianCalendar marshal<span style="color: #009900;">(</span>LocalDate localDate<span style="color: #009900;">)</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">Exception</span> <span style="color: #009900;">{</span>         <span style="color: #000000; font-weight: bold;">return</span> datatypeFactory.<span style="color: #006633;">newXMLGregorianCalendarDate</span><span style="color: #009900;">(</span>localDate.<span style="color: #006633;">getYear</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>, localDate.<span style="color: #006633;">getMonth</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>.<span style="color: #006633;">getValue</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>, localDate.<span style="color: #006633;">getDayOfMonth</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>,  DatatypeConstants.<span style="color: #006633;">FIELD_UNDEFINED</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>     <span style="color: #009900;">}</span> <span style="color: #009900;">}</span></pre>
Puis on applique cet adaptateur sur les attributs de type <code>LocalDate</code> avec l'annotation <code>@XmlJavaTypeAdapter</code>:
<pre class="java code java" style="font-family: inherit;">@XmlJavaTypeAdapter<span style="color: #009900;">(</span>LocalDateXmlAdapter.<span style="color: #000000; font-weight: bold;">class</span><span style="color: #009900;">)</span>     @XmlSchemaType<span style="color: #009900;">(</span>name <span style="color: #339933;">=</span> <span style="color: #0000ff;">"date"</span><span style="color: #009900;">)</span>     <span style="color: #000000; font-weight: bold;">protected</span> LocalDate dateNaissance<span style="color: #339933;">;</span></pre>
Afin d'automatiser la génération des classes Java depuis les XSD avec XJC, on mettra dans le fichier de binding:
<pre class="xml code xml" style="font-family: inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;jaxb:globalBindings<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>           <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;xjc:javaType</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">"java.time.LocalDate"</span> <span style="color: #000066;">xmlType</span>=<span style="color: #ff0000;">"xs:date"</span> </span> <span style="color: #009900;">            <span style="color: #000066;">adapter</span>=<span style="color: #ff0000;">"com.zenika.test.jsr310.xml.LocalDateXmlAdapter"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>       <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/jaxb:globalBindings<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
<h3>Validation</h3>
On souhaite à présent valider le champ <code>dateNaissance</code> avec Hibernate Validator:
<pre class="java code java" style="font-family: inherit;">@Past     <span style="color: #000000; font-weight: bold;">private</span> LocalDate dateNaissance<span style="color: #339933;">;</span></pre>
Pour que celà fonctionne, il y a deux solutions. Soit on a le gout du risque et on prend la version 5.2.0.Alpha1 d'Hibernate Validator (voir <a href="https://hibernate.atlassian.net/browse/HV-874">HV-874</a> et le <a href="http://in.relation.to/Bloggers/HibernateValidator520Alpha1WithJava8SupportAndA51MaintenanceRelease">blog in.relation.to</a>). Soit, on se retrouve contraint d'écrire un validateur personnalisé:
<pre class="java code java" style="font-family: inherit;">@Target<span style="color: #009900;">(</span><span style="color: #009900;">{</span> ElementType.<span style="color: #006633;">FIELD</span> <span style="color: #009900;">}</span><span style="color: #009900;">)</span> @Retention<span style="color: #009900;">(</span>RetentionPolicy.<span style="color: #006633;">RUNTIME</span><span style="color: #009900;">)</span> @Constraint<span style="color: #009900;">(</span>validatedBy <span style="color: #339933;">=</span> PastValidator.<span style="color: #000000; font-weight: bold;">class</span><span style="color: #009900;">)</span> @Documented <span style="color: #000000; font-weight: bold;">public</span> @<span style="color: #000000; font-weight: bold;">interface</span> Past <span style="color: #009900;">{</span>     <span style="color: #003399;">String</span> message<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #000000; font-weight: bold;">default</span> <span style="color: #0000ff;">"com.zenika.test.jsr310.entity.Past.message"</span><span style="color: #339933;">;</span>     Class<span style="color: #339933;">&lt;?&gt;</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span> groups<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #000000; font-weight: bold;">default</span> <span style="color: #009900;">{</span><span style="color: #009900;">}</span><span style="color: #339933;">;</span>     Class<span style="color: #339933;">&lt;?</span> <span style="color: #000000; font-weight: bold;">extends</span> Payload<span style="color: #339933;">&gt;</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span> payload<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #000000; font-weight: bold;">default</span> <span style="color: #009900;">{</span><span style="color: #009900;">}</span><span style="color: #339933;">;</span> <span style="color: #009900;">}</span>   <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> PastValidator <span style="color: #000000; font-weight: bold;">implements</span> ConstraintValidator<span style="color: #339933;">&lt;</span>Past, LocalDate<span style="color: #339933;">&gt;</span> <span style="color: #009900;">{</span>     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> initialize<span style="color: #009900;">(</span>Past past<span style="color: #009900;">)</span> <span style="color: #009900;">{</span><span style="color: #009900;">}</span>       <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">boolean</span> isValid<span style="color: #009900;">(</span>LocalDate localDate, ConstraintValidatorContext context<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>         <span style="color: #000000; font-weight: bold;">return</span> localDate <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span> <span style="color: #339933;">||</span> localDate.<span style="color: #006633;">isBefore</span><span style="color: #009900;">(</span>LocalDate.<span style="color: #006633;">now</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span> <span style="color: #009900;">}</span></pre>
<h3>Conclusion</h3>
L'effort à fournir pour éradiquer les <code>java.util.Date</code> n'est pas négligeable, vivement que les librairies classiques intègrent ces types nativement. On soulignera toutefois l'effort fourni par les équipes Spring et Jackson.