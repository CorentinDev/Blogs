---
ID: 191
post_title: 'A Full Javascript Architecture, Part One &#8211; NodeJS'
author: nletaifa
post_date: 2011-05-16 11:00:00
post_excerpt: '<p>This post is the first of a three-part series showing how to build a complete javascript architecture using :</p> <ul> <li><strong>NodeJS</strong> : For the server side. We will use Socket.IO to manage long-terms real-time connection.</li> </ul> <ul> <li><strong>Google Chrome Extension</strong> : For the client side. WebSocket, Notification and Local Storage will be used.</li> </ul> <ul> <li><strong>MongoDB</strong> : To store the datas.</li> </ul> <p>To illustrate our architecture we are going to create a Node application that will track tweets about the <a href="http://www.whatsnextparis.com">“What’s Next”</a> event and broadcast them in real time to the clients. The client will be a Google Chrome browser extension and will use two features of the HTML5 specification to display the tweets broadcasted by the server. In the last post I will introduce the MongoDB database, we will use it to store tweets and provide some statistics when the event ends.</p>'
layout: post
permalink: http://blog.zenika-offres.com/?p=191
published: true
---
<p>This post is the first of a three-part series showing how to build a complete javascript architecture using :</p> <ul> <li><strong>NodeJS</strong> : For the server side. We will use Socket.IO to manage long-terms real-time connection.</li> </ul> <ul> <li><strong>Google Chrome Extension</strong> : For the client side. WebSocket, Notification and Local Storage will be used.</li> </ul> <ul> <li><strong>MongoDB</strong> : To store the datas.</li> </ul> <p>To illustrate our architecture we are going to create a Node application that will track tweets about the <a href="http://www.whatsnextparis.com">“What’s Next”</a> event and broadcast them in real time to the clients. The client will be a Google Chrome browser extension and will use two features of the HTML5 specification to display the tweets broadcasted by the server. In the last post I will introduce the MongoDB database, we will use it to store tweets and provide some statistics when the event ends.</p>
<!--more-->
<p><img src="/wp-content/uploads/2015/07/jsarch.png" alt="Architecture Javascript" style="display:block; margin:0 auto;" title="Architecture Javascript" /></p> <p>This first part is dedicated to the creation of a Node application. We will see step by step how to install Node on a Linux environment and setup a HTTP server with WebSocket support.</p> <h2>Introduction to Node</h2> <br/> <p><img src="/wp-content/uploads/2015/07/NodeJS.png" alt="Node&#039;s Logo" style="display:block; margin:0 auto;" title="Node&#039;s Logo" /></p> <h3>What is Node ?</h3> <p><img src="/wp-content/uploads/2015/07/nodejsarch.png" alt="Node&#039;s Architecture" style="float:right; margin: 0 0 1em 1em;" title="Node&#039;s Architecture" /></p> <p>Node is an open source toolkit for developing server side applications based on the V8 JavaScript engine. Like Node, V8 is written in C++ and is mostly known for being used in Google Chrome.</p> <p>Node is part of the <strong>S</strong>erver <strong>S</strong>ide <strong>J</strong>ava<strong>S</strong>cript environnement and extend JavaScript API to offer usual server side functionalities. Node base API can be extended by using the <a href="http://www.commonjs.org/">CommonJS</a> module system.</p> <p>Node has be created by Ryan Dahl in February 2009 and has since become very popular. It’s spirit is similar to <a href="http://twistedmatrix.com/">Twisted</a> for Python and <a href="http://rubyeventmachine.com">EventMachine</a> for Ruby.</p> <p>The project is run by <a href="http://www.joyent.com">Joyent</a> (the company employing Ryan Dalh) who lunched a cloud hosting service for node applications (<a href="https://no.de">no.de</a>).</p> <h3>Node’s Goal ?</h3> <p>It’s goal is to offer an easy and safe way to build high performance and scalable network applications in JavaScript.</p> <p>Those goals are achieved thanks it's architecture:</p> <ul> <li><strong>Single Threaded</strong> :</li> </ul> <p>Node use a single thread to run instead of other server like Apache HTTP who spawn a thread per request, this approach result in avoiding CPU context switching and massive execution stacks in memory. This is also the method used by <a href="http://wiki.nginx.org">nginx</a> and other servers developed to counter the <a href="http://www.kegel.com/c10k.html">C10K</a> problem.</p> <ul> <li><strong>Event Loop</strong> :</li> </ul> <p>Written in C++ using the Marc Lehman’s <a href="http://software.schmorp.de/pkg/libeio.html">libev</a> library, the event loop use epoll or kqueue for scalable event notification mechanism.</p> <ul> <li><strong>Non blocking I/O</strong> :</li> </ul> <p>Node avoid CPU time loss usually made by waiting for an input or an output response (database, file system, web service, ...) thanks to the full-featured asynchronous I/O provided by Marc Lehmann’s <a href="http://software.schmorp.de/pkg/libev.html">libeio</a> library.</p> <p>These characteristics allow Node to handle a large amount of traffic by handling as quickly as possible a request to free the thread for the next one.</p> <p>Node has a built-in support for most important protocols like TCP, DNS, and HTTP (the one that we will focus on). The design goal of a Node application is that <strong>any function performing an I/O must use a callback</strong>. That’s why there is no blocking methods provided in Node’s API.</p> <p>The HTTP implementation offered by Node is very complete and natively support chunked request and response (very useful since we are going to use the twitter streaming api) and hanging request for comet applications. The Node’s footprint for each http stream is only 36 bytes (<a href="http://s3.amazonaws.com/four.livejournal/20091117/jsconf.pdf">source</a>).</p> <h3>JavaScript</h3> <p>Being an <strong>Event Driven Language</strong>, Javascript is the most suited to develop on the Node’s “Event Loop” architecture. Node’s applications really use javascript's strengths like anonymous functions and closures.</p> <h3>Community</h3> <p>Despite its young age, the community is really growing fast and the <a href="https://github.com/joyent/node">GitHub</a> repository is the <a href="https://github.com/popular/watched">3rd most followed one</a>.</p> <h2>Installing Node</h2> <br/> <p>The first step for us to take is the installation of Node.  I choose to run Node on a Linux Debian 6 system but  Windows users can try <a href="http://node-js.prcn.co.cc/">this</a>.</p> <h3>Prerequisites</h3> <p>We need some packages before installing Node itself, same prerequisites apply for Ubuntu.</p> <pre class="bash code bash" style="font-family:inherit">$ <span style="color: #c20cb9; font-weight: bold;">aptitude</span> <span style="color: #c20cb9; font-weight: bold;">install</span> git-core $ <span style="color: #c20cb9; font-weight: bold;">aptitude</span> <span style="color: #c20cb9; font-weight: bold;">install</span> build-essential $ <span style="color: #c20cb9; font-weight: bold;">aptitude</span> <span style="color: #c20cb9; font-weight: bold;">install</span> libssl-dev</pre> <h3>Node</h3> <p>Now we just have to clone the git repository and install (make might take a while) :</p> <pre class="bash code bash" style="font-family:inherit">$ git clone https:<span style="color: #000000; font-weight: bold;">//</span>github.com<span style="color: #000000; font-weight: bold;">/</span>joyent<span style="color: #000000; font-weight: bold;">/</span>node.git $ <span style="color: #7a0874; font-weight: bold;">cd</span> node $ .<span style="color: #000000; font-weight: bold;">/</span>configure <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #000000; font-weight: bold;">&amp;&amp;</span> <span style="color: #c20cb9; font-weight: bold;">make</span> <span style="color: #c20cb9; font-weight: bold;">install</span></pre> <p>When the installation is complete, try it with :</p> <pre class="bash code bash" style="font-family:inherit">$ node <span style="color: #660033;">-v</span> v0.5.0-pre</pre> <p>That should print out your node version.</p> <h3>Installing Node Package Manager :</h3> <p>Isaac Schlueter (another employee of Joyent) has created a really great Node package manager called <a href="http://npmjs.org/">NPM</a>. We need it because our Node application will use the Socket.IO module.</p> <pre class="bash code bash" style="font-family:inherit">$ <span style="color: #c20cb9; font-weight: bold;">aptitude</span> <span style="color: #c20cb9; font-weight: bold;">install</span> curl $ curl http:<span style="color: #000000; font-weight: bold;">//</span>npmjs.org<span style="color: #000000; font-weight: bold;">/</span>install.sh | <span style="color: #c20cb9; font-weight: bold;">sh</span></pre> <p>Once installed you simply call this command line to install the Socket.IO package.</p> <pre class="bash code bash" style="font-family:inherit">$ npm <span style="color: #c20cb9; font-weight: bold;">install</span> socket.io</pre> <p><strong>About Socket.IO</strong></p> <p>Socket.IO is a powerful Node module that bring the ability to <strong>simply</strong> manage long term connections with the clients. The module is used on the server side and on the client one. The client side will automatically and seamlessly use the best communication type (based on browser capabilities) to connect to a Node server.</p> <p>Our architecture use a Google Chrome client, since this browser has WebSocket protocol capability, that's the connection type Socket.IO will choose.</p> <p>But what happen if we decided to create a Mozilla Firefox extension where WebSocket support is disable ? Well, by using Socket.IO, long polling connection will automatically be used and there is no need to change anything in our code on both client and server sides.</p> <h2>Ready to code</h2> <br/> <p>All the source of this post can be found on it's dedicated <a href="https://github.com/Zenika/WsN-Node">github repository</a>.</p> <h3>Hello World</h3> <p>To introduce the concept behind Node's application development, we will start by the classic Hello World example.</p> <p><br />First let's create the folder tha
t will be our workspace:</p> <pre class="bash code bash" style="font-family:inherit">$ <span style="color: #c20cb9; font-weight: bold;">mkdir</span> nodespace $ <span style="color: #7a0874; font-weight: bold;">cd</span> nodespace</pre> <p>Then copy the following content in a file named <strong>server.js</strong></p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #006600; font-style: italic;">// Loading required modules</span> <span style="color: #003366; font-weight: bold;">var</span> http <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'http'</span><span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #003366; font-weight: bold;">var</span> SERVER_PORT <span style="color: #339933;">=</span> <span style="color: #CC0000;">8124</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Creating HTTP Server</span> <span style="color: #003366; font-weight: bold;">var</span> server <span style="color: #339933;">=</span> http.<span style="color: #660066;">createServer</span><span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>request<span style="color: #339933;">,</span> response<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>     <span style="color: #006600; font-style: italic;">// Called each time a request is made.</span>     response.<span style="color: #660066;">writeHead</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">200</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span><span style="color: #3366CC;">'Content-Type'</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">'text/plain'</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>;     response.<span style="color: #660066;">end</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'Hello World<span style="color: #000099; font-weight: bold;">n</span>'</span><span style="color: #009900;">&#41;</span>; <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Starting the server</span> server.<span style="color: #660066;">listen</span><span style="color: #009900;">&#40;</span>SERVER_PORT<span style="color: #009900;">&#41;</span>; &nbsp; console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'Server running on port : '</span> <span style="color: #339933;">+</span> SERVER_PORT<span style="color: #009900;">&#41;</span>;</pre> <p>This is quiet simple, we just create a http server by requiring the HTTP module and calling the createServer method. The callback method  will be executed each time a request comes in.</p> <p>To start the server call :</p> <pre class="bash code bash" style="font-family:inherit">$ node server.js Server running on port : <span style="color: #000000;">8124</span></pre> <p>We can now access to the server by using http://hostname:8124 and see the "Hello World".</p> <h3>Adding Socket.IO</h3> <p>The next step is to use Socket.IO to handle long-terms connections, replace the <strong>server.js</strong> content by the following one:</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #006600; font-style: italic;">// Loading required modules</span> <span style="color: #003366; font-weight: bold;">var</span> http <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'http'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>     io <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'/path/to/socket.io'</span><span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #003366; font-weight: bold;">var</span> SERVER_PORT <span style="color: #339933;">=</span> <span style="color: #CC0000;">8124</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Creating HTTP Server</span> <span style="color: #003366; font-weight: bold;">var</span> server <span style="color: #339933;">=</span> http.<span style="color: #660066;">createServer</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Starting the server</span> server.<span style="color: #660066;">listen</span><span style="color: #009900;">&#40;</span>SERVER_PORT<span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Attaching Socket.IO to the HTTP Server</span> <span style="color: #003366; font-weight: bold;">var</span> socket <span style="color: #339933;">=</span> io.<span style="color: #660066;">listen</span><span style="color: #009900;">&#40;</span>server<span style="color: #009900;">&#41;</span>; &nbsp; console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'Server running on port : '</span> <span style="color: #339933;">+</span> SERVER_PORT<span style="color: #009900;">&#41;</span>;</pre> <p>Two more lines, that’s the only things we need to add to attach the Socket.IO module to the http server.</p> <p>You might have noticed that the callback function of the http.createServer() has been removed, this is due to our use case where the server does not serve data to the client when they make a request but directly push data when an event is raised.</p> <p>We can put a callback to the io.listen() method, it will be fired each time a request comes from the Socket.IO client side library.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #003366; font-weight: bold;">var</span> socket <span style="color: #339933;">=</span> io.<span style="color: #660066;">listen</span><span style="color: #009900;">&#40;</span>server<span style="color: #339933;">,</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>client<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>     <span style="color: #006600; font-style: italic;">// new client connected !</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>;</pre> <h3>Twitter tracker module</h3> <p>To retrieve the tweets about the “What’s Next” event we need to use the <a href="http://dev.twitter.com/pages/streaming_api">Twitter Streaming API</a>. The API will return us in real time all the tweets mentioning “WsN_Paris” and "zenika".</p> <p>In order to do that, we are going to create a simple module that will connect to the Twitter API and emit an event each time it found a new tweet related to our topic.</p> <p>Connection to the API require a valid twitter account. The module will encode your credentials and add them to the request header. We do not need to use OAuth to use the Twitter streaming API.</p> <p>Create a new file called <strong>twitter.js</strong> and add the following content :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #006600; font-style: italic;">// Loading required modules for the module</span> <span style="color: #003366; font-weight: bold;">var</span> http <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'http'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #006600; font-style: italic;">// Provide the createClient() method used to create the request.</span>     buffer <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'buffer'</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">Buffer</span><span style="color: #339933;">,</span> <span style="col
or: #006600; font-style: italic;">// Used for credentials encoding.</span>     EventEmitter <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'events'</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">EventEmitter</span>; <span style="color: #006600; font-style: italic;">// Used for event emission.</span> &nbsp; <span style="color: #006600; font-style: italic;">// The tracker constructor.</span> <span style="color: #006600; font-style: italic;">// username &amp; password are your twitter credentials.</span> <span style="color: #006600; font-style: italic;">// Topics are the subject(s) you want to track (separated by comma).</span> <span style="color: #003366; font-weight: bold;">var</span> TwitterTracker <span style="color: #339933;">=</span> exports.<span style="color: #660066;">TwitterTracker</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>username<span style="color: #339933;">,</span> password<span style="color: #339933;">,</span> topics<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #006600; font-style: italic;">// Encoding credentials to base64.</span> 	<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">auth</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> Buffer<span style="color: #009900;">&#40;</span>username <span style="color: #339933;">+</span> <span style="color: #3366CC;">':'</span> <span style="color: #339933;">+</span> password<span style="color: #009900;">&#41;</span>.<span style="color: #660066;">toString</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'base64'</span><span style="color: #009900;">&#41;</span>;         <span style="color: #006600; font-style: italic;">// Adding basic authentication to the header with our credentials.</span> 	<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">header</span> <span style="color: #339933;">=</span>  <span style="color: #009900;">&#123;</span><span style="color: #3366CC;">'Authorization'</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">'Basic '</span> <span style="color: #339933;">+</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">auth</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">'Host'</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">'stream.twitter.com'</span> <span style="color: #009900;">&#125;</span>; 	<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">topics</span> <span style="color: #339933;">=</span> topics; <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #006600; font-style: italic;">// Implementing the observer pattern thanks to Node's EventEmitter object.</span> <span style="color: #006600; font-style: italic;">// This will allow our TwitterTracker object to emit some events.</span> TwitterTracker.<span style="color: #660066;">prototype</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> EventEmitter; &nbsp; <span style="color: #006600; font-style: italic;">// Track method definition.</span> <span style="color: #006600; font-style: italic;">// Calling the track method will send the request to the twitter api and emit event when a new tweet arrives.</span> TwitterTracker.<span style="color: #660066;">prototype</span>.<span style="color: #660066;">track</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span> track<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> &nbsp;         <span style="color: #006600; font-style: italic;">// Creation of the http client used to make the request.</span> 	<span style="color: #003366; font-weight: bold;">var</span> twitter <span style="color: #339933;">=</span> http.<span style="color: #660066;">createClient</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">80</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">'stream.twitter.com'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> &nbsp;         <span style="color: #006600; font-style: italic;">// Creation of the twitter request, we pass the http method, the api link with our topics and the header.</span> 	request <span style="color: #339933;">=</span> twitter.<span style="color: #660066;">request</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'GET'</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">'/1/statuses/filter.json?track='</span> <span style="color: #339933;">+</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">topics</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">header</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> &nbsp;         <span style="color: #006600; font-style: italic;">// We get a reference to our current instance to send event in the callback.</span> 	tracker <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span>; &nbsp;         <span style="color: #006600; font-style: italic;">// Waiting for a response from our request to the api.</span>         <span style="color: #006600; font-style: italic;">// This event is fired only once.</span> 	request.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'response'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span> <span style="color: #009900;">&#40;</span>response<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> &nbsp;         response.<span style="color: #660066;">setEncoding</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'utf8'</span><span style="color: #009900;">&#41;</span>; 		<span style="color: #003366; font-weight: bold;">var</span> body <span style="color: #339933;">=</span> <span style="color: #3366CC;">''</span>; &nbsp;         <span style="color: #006600; font-style: italic;">// Listening to the data event.</span>         <span style="color: #006600; font-style: italic;">// This event will be fired every time the twitter </span>         <span style="color: #006600; font-style: italic;">// api send back a new chunk of json data.</span>         <span style="color: #006600; font-style: italic;">//</span>         <span style="color: #006600; font-style: italic;">// Since the twitter api is streaming us the data, we might receive </span>         <span style="color: #006600; font-style: italic;">// incomplete json that we will not be able to parse wihout error.</span>         <span style="color: #006600; font-style: italic;">//</span>         <span style="color: #006600; font-style: italic;">// The logic implemented in this listener is to concat chunks of data </span>         <span style="color: #006600; font-style: italic;">// in the body variable and detect if we have a full tweet (ending by 'rn')</span>         <span style="color: #006600; font-style: italic;">// befor trying to parse.</span>     	response.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'data'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span> <span style="color: #009900;">&#40;</span>chunk<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		    body <span style="color: #339933;">=</span> body <span style="color: #339933;">+</span> chunk; 			<sp
an style="color: #003366; font-weight: bold;">var</span> tweet<span style="color: #339933;">,</span> index; 			<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span> <span style="color: #009900;">&#40;</span>index <span style="color: #339933;">=</span> body.<span style="color: #660066;">indexOf</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'<span style="color: #000099; font-weight: bold;">r</span><span style="color: #000099; font-weight: bold;">n</span>'</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&gt;</span> <span style="color: #339933;">-</span><span style="color: #CC0000;">1</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			    tweet <span style="color: #339933;">=</span> body.<span style="color: #660066;">slice</span><span style="color: #009900;">&#40;</span>0<span style="color: #339933;">,</span> index<span style="color: #009900;">&#41;</span>; 				body <span style="color: #339933;">=</span> body.<span style="color: #660066;">slice</span><span style="color: #009900;">&#40;</span>index <span style="color: #339933;">+</span> <span style="color: #CC0000;">2</span><span style="color: #009900;">&#41;</span>; 				<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>tweet.<span style="color: #660066;">length</span> <span style="color: #339933;">&gt;</span> 0<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 					<span style="color: #000066; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>                                                 <span style="color: #006600; font-style: italic;">// Parsing the new tweet.</span> 						tweet <span style="color: #339933;">=</span> JSON.<span style="color: #660066;">parse</span><span style="color: #009900;">&#40;</span>tweet<span style="color: #009900;">&#41;</span>;                                                 <span style="color: #006600; font-style: italic;">// Sending the 'tweet' event that our server.js will listen to.</span> 						tracker.<span style="color: #660066;">emit</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'tweet'</span><span style="color: #339933;">,</span> tweet<span style="color: #009900;">&#41;</span>; 					<span style="color: #009900;">&#125;</span> <span style="color: #000066; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span>error<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                                             console.<span style="color: #660066;">error</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'-!- Error while parsing tweet.'</span><span style="color: #009900;">&#41;</span>;                                         <span style="color: #009900;">&#125;</span> 				<span style="color: #009900;">&#125;</span> 			<span style="color: #009900;">&#125;</span> 		<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>; 	<span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>; &nbsp;         <span style="color: #006600; font-style: italic;">// The request to the twitter api is not made until the end() method is call.</span> 	request.<span style="color: #660066;">end</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>; &nbsp; 	<span style="color: #000066; font-weight: bold;">return</span> <span style="color: #000066; font-weight: bold;">this</span>; <span style="color: #009900;">&#125;</span>;</pre> <p>The only tricky part is the logic implemented in the "<strong>data</strong>" event callback. This is Twitter specific and other API are much more easy to deal with.</p> <h3>Using The Tracker</h3> <p>Now that we have a functional tweet tracker module, we include it in the<strong> server.js</strong> and start waiting for "<strong>tweet</strong>" events to broadcast them to the clients.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #006600; font-style: italic;">// Loading required modules</span> <span style="color: #003366; font-weight: bold;">var</span> http <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'http'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> 	io <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'/path/to/socket.io'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> 	twitter <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'./twitter'</span><span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #003366; font-weight: bold;">var</span> SERVER_PORT <span style="color: #339933;">=</span> <span style="color: #CC0000;">8124</span><span style="color: #339933;">,</span>     TWITTER_LOGIN <span style="color: #339933;">=</span> <span style="color: #3366CC;">'login'</span><span style="color: #339933;">,</span>     TWITTER_PASSWORD <span style="color: #339933;">=</span> <span style="color: #3366CC;">'password'</span><span style="color: #339933;">,</span>     TWITTER_TOPICS <span style="color: #339933;">=</span> <span style="color: #3366CC;">'WsN_Paris,zenika'</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Creating HTTP ServerWhat's Next ?</span> server <span style="color: #339933;">=</span> http.<span style="color: #660066;">createServer</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Starting the server</span> server.<span style="color: #660066;">listen</span><span style="color: #009900;">&#40;</span>SERVER_PORT<span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Attaching Socket.IO to the HTTP Server</span> <span style="color: #003366; font-weight: bold;">var</span> socket <span style="color: #339933;">=</span> io.<span style="color: #660066;">listen</span><span style="color: #009900;">&#40;</span>server<span style="color: #009900;">&#41;</span>; &nbsp; console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'Server running on port : '</span> <span style="color: #339933;">+</span> SERVER_PORT<span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Instantiating our tracker</span> <span style="color: #003366; font-weight: bold;">var</span> tracker <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> twitter.<span style="color: #660066;">TwitterTracker</span><span style="color: #009900;">&#40;</span>TWITTER_LOGIN<span style="color: #339933;">,</span> TWITTER_PASSWORD<span style="color: #339933;">,</span> TWITTER_TOPICS<span style="color: #009900;">&#41;</span>; &nbsp; <span style="color: #006600; font-style: italic;">// Start tracking and waiting for 'tweet' events from our tracker.</span> tracker.<span style="color: #660066;">track</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'tweet'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>tweet<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span> &nbsp;         <span style="color: #006600; font-style: italic;">// Print out the tweet</span>         console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'New tweet from :&quot;'</span> <span style="color: #339933;">+</span> tweet.<span s
tyle="color: #660066;">user</span>.<span style="color: #660066;">screen_name</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">'&quot; -&gt; '</span> <span style="color: #339933;">+</span> tweet.<span style="color: #660066;">text</span><span style="color: #009900;">&#41;</span>; &nbsp;         <span style="color: #006600; font-style: italic;">// Using the socket provided by Socket.IO to broadcast the new tweet to all the clients.</span> 	socket.<span style="color: #660066;">broadcast</span><span style="color: #009900;">&#40;</span> 		<span style="color: #006600; font-style: italic;">// To save bandwich we send only the tweet parts we are interested in.</span> 		JSON.<span style="color: #660066;">stringify</span><span style="color: #009900;">&#40;</span> 			<span style="color: #009900;">&#123;</span> 	id <span style="color: #339933;">:</span> tweet.<span style="color: #660066;">id</span><span style="color: #339933;">,</span> 				user <span style="color: #339933;">:</span> tweet.<span style="color: #660066;">user</span>.<span style="color: #660066;">screen_name</span><span style="color: #339933;">,</span> 				text <span style="color: #339933;">:</span> tweet.<span style="color: #660066;">text</span><span style="color: #339933;">,</span> 				picture <span style="color: #339933;">:</span> tweet.<span style="color: #660066;">user</span>.<span style="color: #660066;">profile_image_url</span> 			<span style="color: #009900;">&#125;</span> 		<span style="color: #009900;">&#41;</span> 	<span style="color: #009900;">&#41;</span>; <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>;</pre> <p>As you can see, we just need to add a listener on the "<strong>tweet</strong>" event and send the useful part of the tweet to the clients by calling the socket's <strong>broadcast()</strong> method.</p> <h2>Conclusion</h2> <br/> <p>This close up the first part in the development of a full JavaScript architecture. I hope that reading this help you see how easy it is to build a simple but yet highly scalable application.</p> <p>Node is very powerful and writting an app in JavaScript that is not only meant to wait for onclick events is really a nice experience.</p> <p>You can quickly start developing with Node by using the <a href="http://cloud9ide.com">Cloud9IDE</a>. Just register or sign in with your github account and you will be ready to code within a minute.</p> <p><a href="http://blog.zenika.com/index.php?post/2011/05/11/A-Full-Javascript-Architecture%2C-Part-Two-Chrome-Extension2">In the next part</a> we will see how to develop a Google Chrome extension that will display the tweets in real time by playing with HTML5 notifications.</p> <h2>Ressources</h2> <br/> <ul> <li>Node Official : <a href="http://nodejs.org" title="http://nodejs.org">http://nodejs.org</a></li> <li>Documentation : <a href="http://nodejs.org/docs/v0.4.5/api/index.html" title="http://nodejs.org/docs/v0.4.5/api/index.html">http://nodejs.org/docs/v0.4.5/api/i...</a></li> <li>GitHub : <a href="https://github.com/joyent/node" title="https://github.com/joyent/node">https://github.com/joyent/node</a></li> <li>Modules : <a href="https://github.com/ry/node/wiki/modules" title="https://github.com/ry/node/wiki/modules">https://github.com/ry/node/wiki/mod...</a></li> <li>Google Group : <a href="http://groups.google.com/group/nodejs" title="http://groups.google.com/group/nodejs">http://groups.google.com/group/node...</a></li> <li>Companies <a href="using Node : https://github.com/joyent/node/wiki/Projects,-Applications,-and-Companies-Using-Node" title="using Node : https://github.com/joyent/node/wiki/Projects,-Applications,-and-Companies-Using-Node">using Node : https://github.com/joy...</a></li> <li>Socket.IO : <a href="http://socket.io" title="http://socket.io">http://socket.io</a></li> <li>How To Node : <a href="http://howtonode.org" title="http://howtonode.org">http://howtonode.org</a></li> <li>Mastering Node Free Ebook : <a href="https://github.com/visionmedia/masteringnode" title="https://github.com/visionmedia/masteringnode">https://github.com/visionmedia/mast...</a></li> <li>O'Reilly's Node coming book : <a href="http://ofps.oreilly.com/titles/9781449398583/" title="http://ofps.oreilly.com/titles/9781449398583/">http://ofps.oreilly.com/titles/9781...</a></li> <li>Node Tuts : <a href="http://nodetuts.com" title="http://nodetuts.com">http://nodetuts.com</a></li> </ul>