---
ID: 66
post_title: 'System.out : plus complexe qu’il n’y paraît'
author: ocroisier
post_date: 2008-12-22 17:26:00
post_excerpt: '<p>En analysant la classe <code>java.lang.System</code> du JDK 6.0, on peut tomber sur du code pour le moins surprenant. Vous croyiez connaître <code>System.out</code>&nbsp;? Ce champ à l’allure anodine cache en réalité quelques petites bizarreries amusantes…</p>'
layout: post
permalink: http://blog.zenika-offres.com/?p=66
published: true
---
<p>En analysant la classe <code>java.lang.System</code> du JDK 6.0, on peut tomber sur du code pour le moins surprenant. Vous croyiez connaître <code>System.out</code>&nbsp;? Ce champ à l’allure anodine cache en réalité quelques petites bizarreries amusantes…</p>
<!--more-->
<h4>Une initialisation tarabiscotée</h4> <p>La première surprise vient de la façon dont ce champ est initialisé&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #000000;">PrintStream</span> out = nullPrintStream<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #000000;">PrintStream</span> nullPrintStream<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">NullPointerException</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055;font-weight: bold;">if</span> <span style="color: #000000;">&#40;</span>currentTimeMillis<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&gt;</span> 0<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#123;</span>	<span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #7F0055; font-weight: bold;">null</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">throw</span> <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #000000;">NullPointerException</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Mais pourquoi tant de circonvolutions pour simplement assigner <code>null</code> au champ ?<br />
La javadoc de la méthode <code>nullPrintStream()</code> apporte un élément de réponse&nbsp;:</p> <blockquote><p>The following two methods exist because in, out, and err must be initialized to null. The compiler, however, cannot be permitted to inline access to them, since they are later set to more sensible values by initializeSystemClass().</p></blockquote> <p>Traduction&nbsp;: le compilateur est bien sympa de vouloir optimiser le code en remplaçant les les accès au champ (coûteux) directement par sa valeur, mais dans ce cas précis, on s'en passerait bien, car la valeur nulle n'est que temporaire et sera modifiée par la suite.<br /></p> <p>Ceci explique d'ailleurs pourquoi la méthode <code>nullPrintStream()</code> ne renvoie pas directement <code>null</code>&nbsp;: le compilateur n'est pas stupide et s'en apercevrait&nbsp;; le test sur la date courante permet donc de le mystifier en introduisant un élément d'incertitude, non déterminable à la compilation. <br />
Question bonus&nbsp;: la JVM se lance-t-elle sur un système dont la date est réglée avant <a href="http://en.wikipedia.org/wiki/Epoch_(reference_date)">Epoch</a>, la date de référence&nbsp;?</p> <h4>Final... ou pas&nbsp;?</h4> <p>Et là, une question troublante se pose&nbsp;: puisque <code>System.out</code> est <code>final</code> et qu'on lui assigne <code>null</code>, comment se fait-il que l'on n'obtienne pas un <code>NullPointerException</code> lorsqu'on appelle, par exemple, <code>System.out.println()</code>&nbsp;?</p> <p>Quelques indices nous mettent la puce à l'oreille&nbsp;:</p> <ul> <li>La Javadoc vue plus haut indique qu'une nouvelle valeur sera réassignée à <code>System.out</code> par la méthode <code>initializeSystemClass()</code>.</li> <li>La présence d'un <em>setter</em>&nbsp;:</li> </ul> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">void</span> setOut<span style="color: #000000;">&#40;</span><span style="color: #000000;">PrintStream</span> out<span style="color: #000000;">&#41;</span></div></li></ol></pre> <p>On nous aurait donc menti&nbsp;? Serait-il possible de changer la valeur d'un champ <code>final</code> ?<br />
En fait, pour vous et moi, non. Mais la classe <code>java.lang.System</code> dispose de certains privilèges, comme indiqué dans la <a href="http://java.sun.com/docs/books/jls/third_edition/html/memory.html#17.5.4">JLS, §17.5.4</a>&nbsp;:</p> <blockquote><p>Normally, final static fields may not be modified. However System.in, System.out, and System.err are final static fields that, for legacy reasons, must be allowed to be changed by the methods System.setIn, System.setOut and System.setErr. (...) Therefore, the semantics dictate that these fields be treated as normal fields that cannot be changed by user code, unless that user code is in the System class.</p></blockquote> <p>En y regardant de plus près, l'interaction avec la console est apparemment une fonction très bas niveau, car le <em>setter</em> public fait en réalité appel à une méthode <code>native</code>&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">native</span> <span style="color: #7F0055; font-weight: bold;">void</span> setOut0<span style="color: #000000;">&#40;</span><span style="color: #000000;">PrintStream</span> out<span style="color: #000000;">&#41;</span>;</div></li></ol></pre> <p>En conclusion, il est parfois très instructif de fouiller dans les classes du JDK, on peut y découvrir des choses intéressantes&nbsp;!</p>