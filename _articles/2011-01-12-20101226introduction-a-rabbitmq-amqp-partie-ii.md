---
ID: 95
post_title: 'Introduction à RabbitMQ &#8211; AMQP Partie II'
author: chebert
post_date: 2011-01-12 12:01:00
post_excerpt: |
  <p>Nous avons vu dans <a href="/index.php?post/2010/12/19/Introduction-a-RabbitMQ-AMQP">le billet précédent</a> un aperçu global du fonctionnement du protocole AMQP pour tout ce qui est échange de messages. Cette fois-ci nous allons voir plus en détail les possibilités offertes par le protocole comme l'authentification, la création de VHost et les détails des Exchanges et Queues.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=95
published: true
---
<p>Nous avons vu dans <a href="/index.php?post/2010/12/19/Introduction-a-RabbitMQ-AMQP">le billet précédent</a> un aperçu global du fonctionnement du protocole AMQP pour tout ce qui est échange de messages. Cette fois-ci nous allons voir plus en détail les possibilités offertes par le protocole comme l'authentification, la création de VHost et les détails des Exchanges et Queues.</p>
<!--more-->
<h2>Versions</h2> <p>Avant tout, pour que ce billet ait du sens, il faut savoir qu'il se base entièrement sur la version 0.9.1 du protocole, sortie le 13 novembre 2008; cette version est celle implémentée actuellement dans RabbitMQ.<br />
La spécification étant relativement jeune, des changements sont amenés au cours du temps, et une version 1.0 en cours de rédaction apporte des modifications majeures. Vous pouvez consulter les évolutions du protocole sur <a href="http://www.amqp.org/confluence/download/attachments/720900/amqp-master.1-0r0.pdf?version=1&amp;modificationDate=1282119666000">le draft de spécification</a>.</p> <p>Concernant la version 0.9.1, la spécification étant succincte, 40 pages en tout, dont une vingtaine qui sont intéressantes pour une approche uniquement fonctionnelle du protocole, je vous invite à la lire <a href="http://www.amqp.org/confluence/download/attachments/720900/amqp0-9-1.pdf?version=1&amp;modificationDate=1227526523000">sur le site de AMQP</a>.</p> <h2>Authentification</h2> <p>Comme nous avons pu voir précédemment, la première étape utilisée afin d'envoyer un message, est la connexion de l'utilisateur sur le broker.<br />
Afin de travailler dans un environnement sécurisé et contrôlable, AMQP impose à tous les utilisateurs d'être authentifiés.<br />
Un simple couple user/password est envoyé à la connexion permettant ainsi d'identifier l'auteur de chaque message transitant par le broker.</p> <p>Il est possible selon l'implémentation du protocole d'appliquer un système de sécurité et de rôles aux différents utilisateurs pour autoriser ou non l'accès aux différents éléments disponibles dans le broker (Queues/Exchanges).</p> <p>L'avantage évident de ce système est la sécurité offerte pour les messages et leurs destinataires qui pourront être sûr de la provenance des données. Cependant, ceci nécessite une opération de la part de l'administrateur du broker pour créer et autoriser de nouveaux utilisateurs pour chaque application se connectant.</p> <h2>VHost</h2> <p>Une fois authentifié sur le broker, il est demandé à l'utilisateur de choisir un VHost sur lequel travailler.</p> <p>La fonctionnalité de VHost (<em>hôte virtuel</em>) sur AMQP consiste à offrir la possibilité d'héberger plusieurs "domaines" distincts sur une même infrastructure.<br />
Chaque domaine possède ses propres Queues/Exchanges/Bindings, de cette manière il est possible de déployer deux domaines différents en évitant de multiplier le nombre de processus lancés ou le nombre de serveurs utilisés; dans le même temps les deux domaines étant distincts le système n'est pas prévu dans l'optique d'échanger des données entre les deux ou d'accéder à l'un depuis l'autre.<br />
En tant que client, le changement de VHost nécessite l'ouverture d'une nouvelle connexion vers le broker.</p> <p>Un autre avantage de cette vision par VHost est que la base d'utilisateurs est partagée au travers de tous les domaines d'un même broker, il n'est donc pas nécessaire de recréer tous les utilisateurs en cas de nécessité d'un nouveau domaine parallèle au premier déjà existant.</p> <h2>Exchanges</h2> <p>Une fois connecté et identifié et après avoir choisi un VHost, l'utilisateur aura la possibilité d'interagir avec les Exchages. Tel que vu précédemment, un Exchange sera le point d'entrée utilisé pour envoyer des messages.<br />
Les Exchanges possèdent en plus d'un mode d'utilisation, vu dans la première partie, d'autres propriétés et particularités pour permettre un maximum de modularité.</p> <h3>Propriétés</h3> <p>Un Exchange devra avoir un <strong>nom</strong> qui permettra au client d'identifier l'Exchange sur lequel il souhaite déposer ses messages. Il s'agit d'une simple chaîne de caractère unique spécifiée lors de l'envoi d'un message.</p> <p>Une durée de vie de l'Exchange doit être définie, ceci permet de spécifier si et quand est-ce que l'Exchange doit-être supprimé du broker.<br />
Trois niveaux sont proposés&nbsp;:</p> <ul> <li><strong>Temporary</strong>&nbsp;: L'Exchange sera utilisable tant que le broker n'a pas été arrêté. En cas de redémarrage l'Exchange est détruit.</li> <li><strong>Auto-delete</strong>&nbsp;: L'Exchange est détruit dès lors qu'il n'est plus utilisé.</li> <li><strong>Durable</strong>&nbsp;: L'Exchange est toujours disponible. En cas redémarrage du broker, l'Exchange est toujours disponible.</li> </ul> <p>Enfin le type d'un Exchange permet de définir le système utilisé pour dispatcher les messages sur les Queues appropriées. Les modes <strong>direct</strong>, <strong>fanout</strong> et <strong>topic</strong>  (voir <a href="/index.php?post/2010/12/19/Introduction-a-RabbitMQ-AMQP">Introduction à RabbitMQ - AMQP Partie I</a>) sont décrits dans la spécification et sont donc standards à AMQP.<br />
Selon le choix fait ici il sera possible d'utiliser les binding-keys et routing-keys, avec ou sans wildcards.</p> <p><strong>Attention !</strong> le mode <strong>topic</strong>, même s'il est défini au niveau de la spécification n'est pas obligatoirement disponible dans le broker. <strong>Direct</strong> et <strong>fanout</strong> sont par contre obligatoirement présents.</p> <p>Il est aussi possible dans une perspective de personnalisation de créer un tout autre type d'Exchange personnalisé, dans une implémentation du broker, basé sur d'autres facteurs, il suffira de spécifier le bon type lors de la création de l'Exchange.</p> <h3>Création</h3> <p>Bien que généralement créé par un administrateur, les Exchanges peuvent être déclarés par les utilisateurs. Le système propose même une solution permettant d'accéder a un Exchange, et s'il n'existe pas de le créer dans la foulée.</p> <p>Par défaut le système propose aussi un Exchange <strong>direct</strong> sans nom dont les messages seront transférés selon les Queues existantes.<br />
Un message envoyé sur cet Exchange (qui ne possède pas de nom) se verra transféré sur la Queue dont le nom correspond à la routing key du message.<br />
Avec ce mécanisme automatique, une personne peut envoyer facilement un message sans avoir à se soucier des principes d'Exchanges/Queues/Bindings.</p> <p>Le broker fournira en plus, par défaut, un Exchange de chaque type, ce qui dans un cas courant permet de ne gérer que de la partie Queues et Bindings en laissant les clients se connecter sur les Exchanges pré-existants. Les noms de ces Exchanges par défaut sont définis sous la forme de <strong>amq.direct</strong>, <strong>amq.fanout</strong> et <strong>amq.topic</strong>.</p> <h2>Queues</h2> <p>L'autre entité habituellement manipulée est la Queue, celle-ci permet de stocker dans un ordre précis les messages envoyés au fur et à mesure du temps.<br />
Une fois que le message est récupéré, il n'est plus disponible et ne pourra être relu*, et c'est le suivant disponible sur la Queue qui est mis à disposition.<br />
Les Queues fonctionnent sur la base d'un système FIFO (<em>First In First Out</em>), mais il n'est pas obligatoire (bien que recommandé) que cet ordre soit respecté. Par exemple l'affectation d'un système de priorité dans les messages peut interférer avec le fonctionnement classique.<br />
Tout comme les Exchanges, les Queues peuvent être personnalisées via des propriétés.</p> <p>(*) Exception faite d'un problème durant le transfert du message, celui-ci sera considéré comme "non lu" par le broker.</p> <h3>Propriétés</h3> <p>Très proche du système d'Exchange par rapport aux propriétés, une Queue possédera elle aussi un <strong>nom</strong> utilisable par le client pour obtenir les messages auprès d'une Queue spécifique.</p> <p>La durée de vie d'une Queue a aussi beaucoup d'importance. Lorsqu'une Queue est détruite, tout son contenu, c'est-à-dire les messages non lus, sont eux aussi détruits. Les trois durées de vie sont&nbsp;:</p> <ul> <li><strong>Temporary</strong>&nbsp;: La Queue et ses messages seront stockés jusqu'à l'arrêt du broker.</li> <li><strong>Auto-delete</strong>&nbsp;: La Queue et son contenu sont détruits dès lors qu'il n'y a plus d'utilisateurs connectés à la Queue.</li> <li><strong>Durable</strong>&nbsp;: La Queue est conservée, même après un redémarrage du broker.</li> </ul> <p>Une Queue a aussi la possibilité d'être <strong>exclusive</strong> ou <strong>shared</strong>, ceci permet respectivement d'empêcher ou d'autoriser un autre utilisateur à connecter sur la Queue.<br />
Une Queue <strong>exclusive</strong> a automatiquement une durée de vie d'<strong>auto-delete</strong>.</p> <h3>Création</h3> <p>Les Queues peuvent être gérées par les utilisateurs directement.<br />
Étant donné que le système est forcément authentifié, AMQP permet aux utilisateurs (dans le respect des droits qui leur sont attribués), de créer eux-même des Queues en choisissant leur fonctionnement, ainsi qu'en appliquant des Bindings avec les Exchanges déjà existants.<br />
De la même manière un utilisateur peut supprimer une Queue ou les Bindings associés.</p> <p>Le but ici est de permettre aux différents utilisateurs de greffer leurs propres <em>listes de réception</em> et mettre en place un mapping adapté à leurs besoins sur le système déjà existant tout en évitant la nécessité d'une intervention administrative.</p> <p>Lorsqu'une Queue est créée, il est possible de lui attribuer un nom automatiquement généré pour éviter d'écraser un nom déjà utilisé. En règle générale une queue exclusive à un nom auto-généré.</p> <h2>Implémentations d'AMQP</h2> <h3>Broker</h3> <p>Il existe énormément de choix concernant le broker AMQP.<br />
Parmi les plus communs&nbsp;:</p> <ul> <li><a href="http://www.rabbitmq.com/">RabbitMQ</a> - Par VMWare, écrit en erlang</li> <li><a href="http://qpid.apache.org/">Apache Qpid</a> - Par Apache, écrit en C++/Java</li> <li><a href="http://www.openamq.org/">OpenAMQ</a> - Par iMatix, écrit en C</li> <li><a href="http://www.redhat.com/mrg/">Red Hat Messaging Realtime and Grid</a> - Par Red Hat, basé sur Apache Qpid</li> </ul> <p>Dans les prochains billets nous allons voir plus en détail RabbitMQ les possibilités qui sont offertes spécifiquement par cette implémentation.</p> <h3>Client</h3> <p>Généralement chaque implémentation d'AMQP fourni sa propre librairie cliente qui fonctionnera avec n'importe quel broker. Mais en plus, de par sa nature orientée interopérabilité, AMQP possède une liste assez conséquente de clients disponibles dans la plupart des langages de programmation. Le protocole étant lui-même assez simple, il est relativement facile de créer un client basique pour n'importe quel langage.<br />
<a href="http://www.delicious.com/alexisrichardson/AMQP+Client">Liste de clients AMQP</a> (non exhaustive)</p> <p>Par la suite nous utiliserons <a href="http://www.rabbitmq.com/java-client.html">le client java fourni par RabbitMQ</a> au travers de l'API <a href="http://www.springsource.org/spring-amqp">Spring-AMQP</a>.</p> <h2>Conclusion</h2> <p>Après maintenant une découverte plus poussée d'AMQP, nous allons passer à l'utilisation réelle d'une implémentation via RabbitMQ, voir certaines spécificités de ce broker, comment l'installer, l'administrer.</p>