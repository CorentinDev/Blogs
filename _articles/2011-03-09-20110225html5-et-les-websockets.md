---
ID: 428
post_title: HTML5 et les WebSockets
author: shadjiat
post_date: 2011-03-09 10:13:00
post_excerpt: "<p>Aujourd'hui, nous allons poursuivre notre dossier consacré à HTML5 par une étude du standard qui a eu le plus de succès&nbsp;: les WebSockets. Cette spécification permet d'ouvrir une connexion bi-directionnelle permanente entre un client et un serveur, afin de résoudre certains problèmes posés par le caractère unidirectionnel et déconnecté du protocole HTTP.<br /></p> <p>Les WebSockets autorisent ainsi le développement de véritables applications temps-réel performantes telles que des sites d'informations ou de suivi des cours boursiers, ou des applications multi-utilisateurs (chat, jeux en ligne...).<br /></p> <p>La spécification permettant d'utiliser les WebSockets est développée par le W3C, tandis que le protocole de communication est standardisé par l'IETF.</p>"
layout: post
permalink: http://blog.zenika-offres.com/?p=428
published: true
slide_template:
  - ""
---
<p>Aujourd'hui, nous allons poursuivre notre dossier consacré à HTML5 par une étude du standard qui a eu le plus de succès&nbsp;: les WebSockets. Cette spécification permet d'ouvrir une connexion bi-directionnelle permanente entre un client et un serveur, afin de résoudre certains problèmes posés par le caractère unidirectionnel et déconnecté du protocole HTTP.<br /></p> <p>Les WebSockets autorisent ainsi le développement de véritables applications temps-réel performantes telles que des sites d'informations ou de suivi des cours boursiers, ou des applications multi-utilisateurs (chat, jeux en ligne...).<br /></p> <p>La spécification permettant d'utiliser les WebSockets est développée par le W3C, tandis que le protocole de communication est standardisé par l'IETF.</p>
<!--more-->
<h2>Le protocole WebSocket</h2> <p>Pour établir une connexion WebSocket, une requête de type "upgrade" doit être envoyée par le client, afin de demander la mise à jour de la connexion TCP/HTTP actuelle vers le mode WebSocket. Cette requête peut se présenter de la manière suivante:</p> <pre> GET /chat HTTP/1.1 Host: server.example.com Upgrade: websocket Connection: Upgrade Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ== Sec-WebSocket-Origin: http://example.com Sec-WebSocket-Protocol: chat, superchat Sec-WebSocket-Version: 6 </pre> <p>Et le serveur renvoie une réponse à la requête:</p> <pre> HTTP/1.1 101 Switching Protocols Upgrade: websocket Connection: Upgrade Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo= Sec-WebSocket-Protocol: chat </pre> <p>Cet échange initial est nommé "handshake". A partir de là, la communication entre serveur et client se fait par le protocole WebSocket. Les détails du protocole se trouvent sur le site de l'<a href="http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-06">IETF</a>. De nouvelles versions sont publiées régulièrement, le protocol que j'ai présenté étant la dernière version en date (25/02/11). Je précise que ces publications sont en état de "brouillon" et changent constamment.</p> <h2>L'API WebSocket</h2> <p>L'API, développée par le <a href="http://dev.w3.org/html5/websockets/">W3C</a>, introduit l'interface WebSocket suivante&nbsp;:</p> <pre> [Constructor(in DOMString url, in optional DOMString protocols)] [Constructor(in DOMString url, in optional DOMString[] protocols)] interface WebSocket {   readonly attribute DOMString url;   const unsigned short CONNECTING = 0;   const unsigned short OPEN = 1;   const unsigned short CLOSING = 2;   const unsigned short CLOSED = 3;   readonly attribute unsigned short readyState;   readonly attribute unsigned long bufferedAmount;            attribute Function onopen;            attribute Function onmessage;            attribute Function onerror;            attribute Function onclose;   readonly attribute DOMString protocol;   void send(in DOMString data);   void close(); }; WebSocket implements EventTarget; </pre> <p>Ainsi pour créer une instance de WebSocket, le seul argument qu'on doit fournir est l'URL du serveur (compatible Websocket) avec lequel on souhaite établir une liaison. Elle commence obligatoirement par <code>ws://</code> (ou <code>wss://</code> pour une connexion sécurisée). Ensuite, l'interface comporte les attributs fonctionnels permettant de gérer les évènements associés:</p> <ul> <li><code>onopen</code>&nbsp;: ouverture d'une WebSocket</li> <li><code>onmessage</code>&nbsp;: réception d'un message</li> <li><code>onerror</code>&nbsp;: erreur(s) survenue(s)</li> <li><code>onclose</code>&nbsp;: fermeture de WebSocket</li> </ul> <h3>Support</h3> <h4>Implémentation côté serveur</h4> <p>Il existe à ce jour plusieurs implémentations de WebSocket côté serveur:</p> <ul> <li>Kaazing WebSocket Gateway</li> <li>Socket.IO-Node (NodeJS)</li> <li>Jetty (Java)</li> <li>Netty (Framework Java client serveur)</li> <li>JWebSocket (Java)</li> <li>Web Socket Ruby (Ruby)</li> <li>mod_pyWebSocket (extension en Python pour le serveur Apache HTTP)</li> <li>Websocket (Python)</li> <li>...</li> </ul> <p>De nombreux projets sont en cours pour créer d'autres serveurs et frameworks intégrant les WebSockets.</p> <h4>Implémentation côté client&nbsp;: navigateurs</h4> <ul> <li>Chrome&nbsp;: supporté version 4+</li> <li>Firefox&nbsp;: supporté mais désactivé version 4+</li> <li>IE&nbsp;: non supporté</li> <li>Opéra&nbsp;: supporté mais désactivé version 11+</li> <li>Safari&nbsp;: supporté version 5+</li> </ul> <p>Le manque de support des navigateurs est dû à des failles de sécurité dans la spécification du protocole. J'en parlerai plus en détail dans la section relative à la sécurité.</p> <h2>Application</h2> <p>A présent, nous allons voir comment on peut utiliser l'API WebSocket côté client avec JavaScript.</p> <p>On commence d'abord par créer une instance de websocket avec une url valide:</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #003366; font-weight: bold;">var</span> ws<span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> WebSocket<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;ws://websocketUrl&quot;</span><span style="color: #009900;">&#41;</span>;</pre> <p>Ensuite, on gère les événements survenus suite à la création:</p> <pre class="javascript code javascript" style="font-family:inherit">ws.<span style="color: #660066;">onopen</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>evt<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000066;">alert</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;Connection open ...&quot;</span><span style="color: #009900;">&#41;</span>; <span style="color: #009900;">&#125;</span>; ws.<span style="color: #660066;">onmessage</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>evt<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000066;">alert</span><span style="color: #009900;">&#40;</span> <span style="color: #3366CC;">&quot;Received Message: &quot;</span> <span style="color: #339933;">+</span> evt.<span style="color: #660066;">data</span><span style="color: #009900;">&#41;</span>; <span style="color: #009900;">&#125;</span>; ws.<span style="color: #660066;">onclose</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>evt<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000066;">alert</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;Connection closed.&quot;</span><span style="color: #009900;">&#41;</span>; <span style="color: #009900;">&#125;</span>; ws.<span style="color: #000066;">onerror</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>evt<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000066;">alert</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;WebSocket error : &quot;</span> <span style="color: #339933;">+</span> e.<span style="color: #660066;">data</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#125;</span>;</pre> <p>Pour envoyer des messages ou données on utilise la fonction <code>send</code>&nbsp;:</p> <pre class="javascript code javascript" style="font-family:inherit">myWebSocket.<span style="color: #660066;">send</span><span style="color: #009900;">&#40;</span>MyMessage<span style="color: #009900;">&#41;</span>;</pre> <p>Et enfin, on ferme la WebSocket avec la méthode <code>close</code>&nbsp;:</p> <pre> myWebSocket.close(); </pre> <h3>Démonstration avec Jetty 7:</h3> <p>L'idée est de faire une application de type forum de discussion. J'ai choisi pour cela d'utiliser le serveur Jetty 7 qui gère les WebSockets avec une implémentation de servlets, et qui permet de comprendre simplement comment utiliser l'API. On commence ainsi par créer une classe représentant notre WebSocket et sous la forme suivante&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> ExampleWebSocket <span style="color: #7F0055; font-weight: bold;">extends</span> WebSocketServlet <span style="color: #000000;">&#123;</span> &nbsp; 	<span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span
> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #7F0055; font-weight: bold;">long</span> serialVersionUID = 1L; &nbsp;     	<span style="color: #7F0055; font-weight: bold;">public</span> ExampleWebSocket<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         	<span style="color: #7F0055; font-weight: bold;">super</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     	<span style="color: #000000;">&#125;</span> 	<span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">final</span> Set<span style="color: #000000;">&lt;</span>InternalExampleWebSocket<span style="color: #000000;">&gt;</span> members = <span style="color: #7F0055; font-weight: bold;">new</span> CopyOnWriteArraySet<span style="color: #000000;">&lt;</span>InternalExampleWebSocket<span style="color: #000000;">&gt;</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; &nbsp; 	<span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> doGet<span style="color: #000000;">&#40;</span>HttpServletRequest request, HttpServletResponse response<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> ServletException, <span style="color: #000000;">IOException</span> <span style="color: #000000;">&#123;</span> 		<span style="color: #808080; font-style: italic;">// TODO Auto-generated method stub</span> 	<span style="color: #000000;">&#125;</span> 	<span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> doPost<span style="color: #000000;">&#40;</span>HttpServletRequest request, HttpServletResponse response<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> ServletException, <span style="color: #000000;">IOException</span> <span style="color: #000000;">&#123;</span> 		getServletContext<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getNamedDispatcher</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;default&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">forward</span><span style="color: #000000;">&#40;</span>request, response<span style="color: #000000;">&#41;</span>; 	<span style="color: #000000;">&#125;</span> 	<span style="color: #7F0055; font-weight: bold;">protected</span> WebSocket doWebSocketConnect<span style="color: #000000;">&#40;</span>HttpServletRequest request, <span style="color: #000000;">String</span> protocol<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span> 		<span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #7F0055; font-weight: bold;">new</span> InternalExampleWebSocket<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; 	<span style="color: #000000;">&#125;</span> &nbsp; 	<span style="color: #7F0055; font-weight: bold;">class</span> InternalExampleWebSocket <span style="color: #7F0055; font-weight: bold;">implements</span> WebSocket <span style="color: #000000;">&#123;</span> 		<span style="color: #7F0055; font-weight: bold;">private</span> Outbound outbound; &nbsp; 		<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> onConnect<span style="color: #000000;">&#40;</span>Outbound outbound<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span> 			<span style="color: #7F0055; font-weight: bold;">this</span>.<span style="color: #000000;">outbound</span> = outbound; 			members.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">this</span><span style="color: #000000;">&#41;</span>; 		<span style="color: #000000;">&#125;</span> 		<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> onMessage<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">byte</span> frame, <span style="color: #7F0055; font-weight: bold;">byte</span><span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> data, <span style="color: #7F0055; font-weight: bold;">int</span> offset, <span style="color: #7F0055; font-weight: bold;">int</span> length<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span><span style="color: #000000;">&#125;</span> &nbsp; 		<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> onMessage<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">byte</span> frame, <span style="color: #000000;">String</span> data<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span> 			<span style="color: #7F0055;font-weight: bold;">for</span> <span style="color: #000000;">&#40;</span>InternalExampleWebSocket member : members<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span> 				<span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span> 					member.<span style="color: #000000;">outbound</span>.<span style="color: #000000;">sendMessage</span><span style="color: #000000;">&#40;</span>frame, data<span style="color: #000000;">&#41;</span>; 				<span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #000000;">&#40;</span><span style="color: #000000;">IOException</span> e<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span> 					<span style="color: #808080; font-style: italic;">// org.eclipse.jetty.util.log.Log.warn(e);</span> 					e.<span style="color: #000000;">printStackTrace</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; 				<span style="color: #000000;">&#125;</span> 			<span style="color: #000000;">&#125;</span> 		<span style="color: #000000;">&#125;</span> 		<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> onDisconnect<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span> 			members.<span style="color: #000000;">remove</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">this</span><span style="color: #000000;">&#41;</span>; 		<span style="color: #000000;">&#125;</span> 		<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> onFragment<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">boolean</span> more, <span style="color: #7F0055; font-weight: bold;">byte</span> opcode, <span style="color: #7F0055; font-weight: bold;">byte</span><span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> data, <span style="color: #7F0055; font-weight: bold;">int</span> offset, <span style="color: #7F0055; font-weight: bold;">int</span> length<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span><span style="color: #000000;">&#125;</span> 	<span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Cette servlet hérite de <code>WebSocketServlet</code>, une classe de Jetty, et contient une classe interne qui implémente l'interface WebSocket. Lors d'une connexion, la méthode <code>doWebSocketConnect</code> est appelée et un objet de type WebSocket est créé. Dans la classe interne, des méthodes sont implémentée pour gérer les événements liés à la connexion WebSocket (<code>onConnect</code>, <co
de>onMessage</code>, <code>onDisconnect</code>). On peut générer par ailleurs cette classe en utilisant Eclipse et le plugin Jetty WTP Adaptor.</p> <p>Ensuite on crée une page HTML qui contient le code client de notre servlet. Voici des extraits du code JavaScript&nbsp;:</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #003366; font-weight: bold;">var</span> ws; <span style="color: #003366; font-weight: bold;">var</span> username; <span style="color: #003366; font-weight: bold;">var</span> msg; &nbsp; <span style="color: #003366; font-weight: bold;">function</span> updateStatus<span style="color: #009900;">&#40;</span>id<span style="color: #339933;">,</span> message<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 	document.<span style="color: #660066;">getElementById</span><span style="color: #009900;">&#40;</span>id<span style="color: #009900;">&#41;</span>.<span style="color: #660066;">innerHTML</span> <span style="color: #339933;">=</span> message; <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #003366; font-weight: bold;">function</span> loadWebSocket<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 	<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>window.<span style="color: #660066;">WebSocket</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		<span style="color: #003366; font-weight: bold;">var</span> url <span style="color: #339933;">=</span> <span style="color: #3366CC;">&quot;ws://localhost:8080/Html5WebSocket/ExempleWebSocket/&quot;</span>; 		ws <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> WebSocket<span style="color: #009900;">&#40;</span>url<span style="color: #009900;">&#41;</span>; &nbsp; 		updateStatus<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;wsStatus&quot;</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;webSocket supported !&quot;</span><span style="color: #009900;">&#41;</span>; 		ws.<span style="color: #660066;">onopen</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			updateStatus<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;wsStatus&quot;</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;Connected to WebSocket server!&quot;</span><span style="color: #009900;">&#41;</span>; 		<span style="color: #009900;">&#125;</span> 		ws.<span style="color: #660066;">onmessage</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			displayMessage<span style="color: #009900;">&#40;</span>e.<span style="color: #660066;">data</span><span style="color: #009900;">&#41;</span>; 		<span style="color: #009900;">&#125;</span> 		ws.<span style="color: #660066;">onclose</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			updateStatus<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;wsStatus&quot;</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;WebSocket closed!&quot;</span><span style="color: #009900;">&#41;</span>; 		<span style="color: #009900;">&#125;</span> 		ws.<span style="color: #000066;">onerror</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			updateStatus<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;wsStatus&quot;</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;WebSocket error : &quot;</span> <span style="color: #339933;">+</span> e.<span style="color: #660066;">data</span><span style="color: #009900;">&#41;</span>; 		<span style="color: #009900;">&#125;</span> 	<span style="color: #009900;">&#125;</span> <span style="color: #000066; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span> 		updateStatus<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;wsStatus&quot;</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;Your browser does NOT support webSocket.&quot;</span><span style="color: #009900;">&#41;</span>; 	<span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #006600; font-style: italic;">//fonction qui envoie le texte saisi et validé par l'utilisateur.</span> <span style="color: #003366; font-weight: bold;">function</span> sendMyPost<span style="color: #009900;">&#40;</span>newPost<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 	username <span style="color: #339933;">=</span> document.<span style="color: #660066;">forms</span><span style="color: #009900;">&#91;</span><span style="color: #3366CC;">&quot;myform&quot;</span><span style="color: #009900;">&#93;</span>.<span style="color: #000066;">name</span>.<span style="color: #660066;">value</span>; 	msg <span style="color: #339933;">=</span> document.<span style="color: #660066;">forms</span><span style="color: #009900;">&#91;</span><span style="color: #3366CC;">&quot;myform&quot;</span><span style="color: #009900;">&#93;</span>.<span style="color: #660066;">msg</span>.<span style="color: #660066;">value</span>; 	<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>msg<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		<span style="color: #003366; font-weight: bold;">var</span> post <span style="color: #339933;">=</span> username <span style="color: #339933;">+</span> <span style="color: #3366CC;">&quot; : &quot;</span> <span style="color: #339933;">+</span> msg; 		<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>ws.<span style="color: #660066;">readyState</span> <span style="color: #339933;">==</span> <span style="color: #CC0000;">1</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			ws.<span style="color: #660066;">send</span><span style="color: #009900;">&#40;</span>post<span style="color: #009900;">&#41;</span>; 		<span style="color: #009900;">&#125;</span> <span style="color: #000066; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span> 			<span style="color: #000066;">alert</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;The websocket is not open! try refreshing your browser&quot;</span><span style="color: #009900;">&#41;</span>; 		<span style="color: #009900;">&#125;</span> 	<span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #003366; font-weight: bold;">function</span> displayMessage<span style="color: #009900;">&#40;</span>message<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 	<span style="color: #006600; font-style: italic;">//afficher le message en dessous du formulaire</span> 	<span style="color: #006600; font-style: italic;">//...</span> <span style="color: #009900;">&#125;</span></pre> <p>Une petite explication en ce qui concerne l'initialisation de WebSocket&nbsp;: ici l'url est "ws://localhost:8080/Html5WebSocket/ExempleWebSocket/" sachant que le serveur Jetty est situé à <code>localhost:8080</code>, le nom du projet
 est <code>Html5WebSocket</code>, et le nom de la servlet est <code>ExempleWebSocket</code>.<br /></p> <p>On peut également mémoriser les messages envoyés en local en utilisant l'API LocalStorage (voir mon billet précedent sur <a href="/index.php?post/2011/02/17/Html5%3A-le-mode-Offline">le mode hors-ligne HTML5</a>). A chaque message envoyé, on sauvegarde dans le navigateur le nom de l'utilisateur et le message envoyé, puis à l'ouverture de la page on récupère les données enregistrées.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #003366; font-weight: bold;">function</span> saveData<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 	<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>window.<span style="color: #660066;">localStorage</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		window.<span style="color: #660066;">localStorage</span>.<span style="color: #660066;">setItem</span><span style="color: #009900;">&#40;</span>username<span style="color: #339933;">,</span> msg<span style="color: #009900;">&#41;</span>; 	<span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #003366; font-weight: bold;">function</span> getData<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 	<span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>window.<span style="color: #660066;">localStorage</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		<span style="color: #000066; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span> <span style="color: #003366; font-weight: bold;">var</span> i <span style="color: #339933;">=</span> 0; i <span style="color: #339933;">&lt;</span> window.<span style="color: #660066;">localStorage</span>.<span style="color: #660066;">length</span>; i<span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			<span style="color: #003366; font-weight: bold;">var</span> key <span style="color: #339933;">=</span> window.<span style="color: #660066;">localStorage</span>.<span style="color: #660066;">key</span><span style="color: #009900;">&#40;</span>i<span style="color: #009900;">&#41;</span>; 			<span style="color: #003366; font-weight: bold;">var</span> value <span style="color: #339933;">=</span> window.<span style="color: #660066;">localStorage</span>.<span style="color: #660066;">getItem</span><span style="color: #009900;">&#40;</span>key<span style="color: #009900;">&#41;</span>; 			<span style="color: #003366; font-weight: bold;">var</span> data <span style="color: #339933;">=</span> key <span style="color: #339933;">+</span> <span style="color: #3366CC;">&quot; : &quot;</span> <span style="color: #339933;">+</span> value; 			displayMessage<span style="color: #009900;">&#40;</span>data<span style="color: #009900;">&#41;</span>; 		<span style="color: #009900;">&#125;</span> 	<span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Et voici en images le résultat obtenu:</p> <p><a href="/wp-content/uploads/2015/07/DemoWebSocketForum.JPG"><img src="/wp-content/uploads/2015/07/.DemoWebSocketForum_s.jpg" alt="DemoWebSocketForum.JPG" /></a></p> <p>Vous trouverez le code complet en pièce jointe de l'article.</p> <h2>Sécurité</h2> <p>Des <a href="http://www.adambarth.com/experimental/websocket.pdf">études</a> ont été menées par des experts de sécurité concernant l'utilisation des WebSockets et des failles importantes ont été découvertes, notamment la possibilité de <em>cache-poisoning</em> dans des cas de présence de proxys transparents. Suite à ces études, les navigateurs Opéra et Firefox ont décidé de désactiver leur support des WebSockets (qui peut être réactivé dans les options) jusqu'à la résolution de ces problèmes dans une future version.</p> <h2>Conclusion</h2> <p>Le protocole WebSocket représente une avancée très importante dans la communication client-serveur. Le protocole HTTP est un protocole non connecté et sans état, et n'a pas été prévu pour établir des connexions permanentes ni le <em>push</em> de données&nbsp;: en HTTP, il faut que le client demande explicitement les données au serveur. Bien-entendu, plusieurs techniques ont été developpées pour contourner cette barrière et permettre la réception des données mises à jour quasi-instantanément (polling, long-polling...)&nbsp;; mais elles surchargent le réseau en headers HTTP inutiles. Les WebSocket permettront bientôt d'y remédier.<br /></p> <p>Ces problèmes et lacunes soulevés rappellent que la spécification n'est encore qu'à l'état de brouillon et qu'il nous faudra patienter encore avant de pouvoir utiliser plainement les WebSockets. En attendant, des frameworks comme <a href="http://kaazing.com/">Kaazing WebSocket Gateway</a> nous permettent de développer des applications temps-réel performantes en intégrant de nombreuses fonctionnalités, et accessibles sur tous les navigateurs.</p>