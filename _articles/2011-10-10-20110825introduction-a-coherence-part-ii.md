---
ID: 404
post_title: 'Introduction à Coherence: Part II'
author: team-bourgain-tinon
post_date: 2011-10-10 14:55:00
post_excerpt: |
  <p>Nous avons vu au cours de notre <a href="http://blog.zenika.com/index.php?post/2011/08/12/Coherence-PetCinic">article précédent</a> comment intégrer Oracle Coherence dans l'application PetClinic de SpringSource. Cependant, si l'application est à peu près utilisable, il reste de nombreux points à améliorer.<br />
  Dans cet article, nous allons présenter les topologies de caches offertes par Coherence et remplacer le cache par défaut par notre propre cache.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=404
published: true
slide_template:
  - ""
---
<p>Nous avons vu au cours de notre <a href="http://blog.zenika.com/index.php?post/2011/08/12/Coherence-PetCinic">article précédent</a> comment intégrer Oracle Coherence dans l'application PetClinic de SpringSource. Cependant, si l'application est à peu près utilisable, il reste de nombreux points à améliorer.<br />
Dans cet article, nous allons présenter les topologies de caches offertes par Coherence et remplacer le cache par défaut par notre propre cache.</p>
<!--more-->
<p>Commençons par regarder de plus près les options qui s'offrent à nous.</p> <h3>Les principales topologies de cache</h3> <p>Coherence fournit un certain nombre de <a href="http://coherence.oracle.com/display/COH35UG/Types+of+Caches+in+Coherence">types de caches</a>. Les topologies les plus importantes sont:</p> <ul> <li>le <a href="http://coherence.oracle.com/display/COH35UG/Replicated+Cache+Service">cache répliqué</a></li> </ul> <p>Ce cache duplique chaque entrée qu'il contient sur chaque noeud du cluster. La taille de ce cache est donc limitée par la mémoire individuellement disponible sur chaque machine. Toute écriture de donnée dans ce cache provoque une mise à jour de l'ensemble des noeuds du cluster. Cette topologie convient donc particulièrement au stockage de données peu volumineuses et fréquemment accédées en lecture.</p> <ul> <li>le <a href="http://coherence.oracle.com/display/COH35UG/Partitioned+Cache+Service">cache distribué/partitionné</a></li> </ul> <p>Ce cache répartit ses données de manière équilibrée sur l'ensemble des noeuds. Pour chaque donnée, une ou plusieurs copies de secours sont aussi stockées sur des noeuds différents pour prévenir toute perte en cas de défaillance du noeud maître. La gestion de la localisation de la donnée est totalement transparente pour les utilisateurs du cache. Il est possible d'augmenter la taille du cache simplement en ajoutant des noeuds au cluster.</p> <ul> <li>le <a href="http://coherence.oracle.com/display/COH35UG/Near+Cache">near cache</a></li> </ul> <p>Le near cache est un cache hybride typiquement utilisé pour disposer d'un cache distribué couplé à un <a href="http://coherence.oracle.com/display/COH35UG/Local+Cache">cache local</a> propre à chaque noeud. Si les données et l'utilisation qui en est faite s'y prêtent, la présence du cache local permet d'améliorer sensiblement les performances en lecture au prix d'un surcout en écriture ou de données éventuellement légèrement périmées (en fonction de la politique d'invalidation choisie).</p> <h3>Get the stuff</h3> <p>Pour les courageux qui ont dégainé leur IDE pour suivre l'article précédent, vous pouvez repartir avec le même projet. Pour les autres (on vous a vu !), vous pouvez récupérer le projet prêt-à-coder (collection automne-hiver):</p> <ul> <li>sur Github:</li> </ul> <pre class="bash code bash" style="font-family:inherit"><span style="color: #c20cb9; font-weight: bold;">git</span> clone <span style="color: #660033;">-n</span> <span style="color: #c20cb9; font-weight: bold;">git</span>:<span style="color: #000000; font-weight: bold;">//</span>github.com<span style="color: #000000; font-weight: bold;">/</span>obourgain<span style="color: #000000; font-weight: bold;">/</span>petclinic-coherence.git <span style="color: #c20cb9; font-weight: bold;">git</span> checkout article1-end</pre> <ul> <li>sous forme de zip: <a href="/wp-content/uploads/2015/07/petclinic-coherence-article1-end.zip">zip</a></li> </ul> <p>Vous pouvez alors importer le projet dans votre IDE préféré en suivant les étapes <a href="http://blog.zenika.com/index.php?post/2011/08/12/Coherence-PetCinic#get-the-stuff">décrites ici</a>.</p> <h3>Time to code&nbsp;!</h3> <p>Nous allons dans un premier temps créer les caches dont nous aurons besoin. Pour cela, créez un fichier <strong>petclinic-cache-config.xml</strong> dans le dossier <strong>src/main/resources</strong> avec le contenu suivant:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?xml</span> <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;1.0&quot;</span><span style="color: #000000; font-weight: bold;">?&gt;</span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;cache-config</span></span> <span style="color: #009900;">	<span style="color: #000066;">xmlns:xsi</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span> <span style="color: #009900;">	<span style="color: #000066;">xmlns</span>=<span style="color: #ff0000;">&quot;http://xmlns.oracle.com/coherence/coherence-cache-config&quot;</span></span> <span style="color: #009900;">	<span style="color: #000066;">xsi:schemaLocation</span>=<span style="color: #ff0000;">&quot;http://xmlns.oracle.com/coherence/coherence-cache-config coherence-cache-config.xsd&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/cache-config<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <h4>Définition des caches</h4> <h3>What's the plan&nbsp;?</h3> <p>Les <strong>Vet</strong>s et les <strong>PetType</strong>s sont des données statiques peu volumineuses et donc parfaitement adaptées au stockage dans des caches répliqués. Les <strong>Owner</strong>s, <strong>Pet</strong>s et <strong>Visit</strong>s sont eux amenés à être créés et modifiés régulièrement. Leur nombre peut croître fortement au cours de la vie de l'application, éventuellement au point de ne plus tenir dans la mémoire d'une seule JVM. Nous utiliserons donc un cache distribué pour ces données sans toucher (pour le moment) au modèle: chaque entrée du cache sera donc constituée d'un <strong>Owner</strong> ainsi que des <strong>Pet</strong>s et <strong>Visit</strong>s associés.</p> <p><img src="http://blog.zenika.com/public/Billet_285/petclinic-caches.png" alt="Définition des caches" style="display:block; margin:0 auto;" /></p> <h3>Let's do it&nbsp;!</h3> <p>Coherence stocke toutes ses données dans des <strong><a href="http://download.oracle.com/docs/cd/E18686_01/coh.37/e18677/cache_back.htm#BJFHHFHF">backing maps</a></strong>. Chaque <strong>NamedCache</strong> est une vue sur une backing map et plusieurs caches peuvent utiliser la même backing map. Les données restent strictement séparées logiquement mais la configuration est factorisée.</p> <p>Nous allons donc commencer par définir une backing map commune pour tous nos caches. Il est possible de <a href="http://coherence.oracle.com/display/COH35UG/cache-config">paramétrer finement</a> le comportement de cette backing map mais nous allons faire simple pour le moment.</p> <p>Toujours dans le fichier <strong>petclinic-cache-config.xml</strong>, déclarons une configuration de cache local qui nous servira de backing map&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;local-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>noeviction-backing-map<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/local-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Nous pouvons maintenant définir deux configurations de caches: une pour les caches répliqués et une pour les caches distribués:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;replicated-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>replicated-scheme<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;service-name<span style="color: #000000; font-weight: bold;">&gt;</
span></span></span>ReplicatedCache<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/service-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;backing-map-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;local-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;scheme-ref<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>noeviction-backing-map<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/scheme-ref<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/local-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/backing-map-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/replicated-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;distributed-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>distributed-scheme<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;service-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>DistributedCache<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/service-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;backing-map-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;local-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;scheme-ref<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>noeviction-backing-map<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/scheme-ref<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/local-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/backing-map-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/distributed-scheme<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Finalement, nous pouvons déclarer chaque cache avec sa configuration. Au runtime, nous accéderons aux caches par les noms définis ci-dessous.</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;caching-scheme-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;cache-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;cache-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>pet-types-cache<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/cache-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>replicated-scheme<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/cache-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;cache-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;cache-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>vet-cache<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/cache-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>replicated-scheme<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/cache-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;cache-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;cache-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>owner-cache<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/cache-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>distributed-scheme<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/scheme-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/cache-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/caching-scheme-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <h4>Au revoir la DB&nbsp;!</h4> <p>Tous les éléments de configuration sont désormais en place pour pouvoir remplacer tous les accès à la base de données par des accès à Coherence. Retirez la référence vers la <strong>jdbcClinic</strong> du bean <strong>CoherenceClinic</strong> et supprimez le bean <strong>jdbcClinic</strong> associé dans le fichier <strong>applicationContext-coherence.xml</strong>:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;jdbcClinic&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.samples.petclinic.jdbc.SimpleJdbcClinic&quot;</
span><span style="color: #000000; font-weight: bold;">/&gt;</span></span> &nbsp; <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;clinic&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;com.zenika.petclinic.coherence.CoherenceClinic&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;jdbcClinic&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;jdbcClinic&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>devient donc</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;clinic&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;com.zenika.petclinic.coherence.CoherenceClinic&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></pre> <p>Nous allons ensuite ajouter dans <strong>CoherenceClinic</strong> des méthodes <strong>getPetTypesCache()</strong> et <strong>getVetsCache()</strong> ainsi que mettre à jour <strong>getOwnersCache()</strong> pour utiliser les noms des caches que nous avons définis dans le fichier <strong>petclinic-cache-config.xml</strong>.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">private</span> NamedCache getOwnersCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 	<span style="color: #000000; font-weight: bold;">return</span> CacheFactory.<span style="color: #006633;">getCache</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;owner-cache&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">private</span> NamedCache getPetTypesCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 	<span style="color: #000000; font-weight: bold;">return</span> CacheFactory.<span style="color: #006633;">getCache</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;pet-types-cache&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">private</span> NamedCache getVetsCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 	<span style="color: #000000; font-weight: bold;">return</span> CacheFactory.<span style="color: #006633;">getCache</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;vet-cache&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Les méthodes <strong>storeOwner()</strong> et  <strong>loadOwner()</strong> sont simplifiées puisqu'elles n'accèdent plus à la base de données. Notez qu'auparavant, l'id était généré par la jdbcClinic. Maintenant nous devons le faire nous même.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> storeOwner<span style="color: #009900;">&#40;</span><span style="color: #003399;">Owner</span> owner<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> DataAccessException <span style="color: #009900;">&#123;</span> 	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>owner.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		owner.<span style="color: #006633;">setId</span><span style="color: #009900;">&#40;</span>RandomUtils.<span style="color: #006633;">nextInt</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 	<span style="color: #009900;">&#125;</span> 	getOwnersCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>owner.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>, owner<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Owner</span> loadOwner<span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">int</span> id<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> DataAccessException <span style="color: #009900;">&#123;</span> 	<span style="color: #000000; font-weight: bold;">return</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Owner</span><span style="color: #009900;">&#41;</span> getOwnersCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">get</span><span style="color: #009900;">&#40;</span>id<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Pour récupérer tous les <strong>Owner</strong>s dont le nom correspond à celui donné, nous allons itérer sur le cache des <strong>Owner</strong>s et construire une liste de tous ceux dont le nom matche le paramètre. Cette solution est loin d'être optimale puisque la méthode <strong>values()</strong> va faire transiter sur le réseau, de-sérialiser et monter dans la mémoire de la JVM qui effectue le traitement tout le contenu du cache. Dans le prochain article, nous verrons comment distribuer cette opération sur tous les noeuds du cache afin de réduire l'utilisation du réseau et de la mémoire.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> Collection<span style="color: #339933;">&lt;</span>Owner<span style="color: #339933;">&gt;</span> findOwners<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> lastName<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> DataAccessException <span style="color: #009900;">&#123;</span> 	Collection<span style="color: #339933;">&lt;</span>Owner<span style="color: #339933;">&gt;</span> owners <span style="color: #339933;">=</span> getOwnersCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">values</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 	<span style="color: #003399;">String</span> lowerCasedLastName <span style="color: #339933;">=</span> lastName.<span style="color: #006633;">toLowerCase</span><span style="color: #009900;">&#40;</span><span style="co
lor: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; 	List<span style="color: #339933;">&lt;</span>Owner<span style="color: #339933;">&gt;</span> result <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> ArrayList<span style="color: #339933;">&lt;</span>Owner<span style="color: #339933;">&gt;</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 	<span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Owner</span> owner <span style="color: #339933;">:</span> owners<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>owner.<span style="color: #006633;">getLastName</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">toLowerCase</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">startsWith</span><span style="color: #009900;">&#40;</span>lowerCasedLastName<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			result.<span style="color: #006633;">add</span><span style="color: #009900;">&#40;</span>owner<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 		<span style="color: #009900;">&#125;</span> 	<span style="color: #009900;">&#125;</span> 	<span style="color: #000000; font-weight: bold;">return</span> result<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Pour <strong>loadPet()</strong>, nous devons aussi parcourir le cache des <strong>Owner</strong>s pour trouver celui qui porte le <strong>Pet</strong> recherché. Cette méthode pourra être optimisée avec le même mécanisme que pour <strong>findOwners()</strong>.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> Pet loadPet<span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">int</span> id<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> DataAccessException <span style="color: #009900;">&#123;</span> 	Collection<span style="color: #339933;">&lt;</span>Owner<span style="color: #339933;">&gt;</span> owners <span style="color: #339933;">=</span> getOwnersCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">values</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 	<span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Owner</span> owner <span style="color: #339933;">:</span> owners<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		<span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span>Pet pet <span style="color: #339933;">:</span> owner.<span style="color: #006633;">getPets</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>pet.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">equals</span><span style="color: #009900;">&#40;</span>id<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 				<span style="color: #000000; font-weight: bold;">return</span> pet<span style="color: #339933;">;</span> 			<span style="color: #009900;">&#125;</span> 		<span style="color: #009900;">&#125;</span> 	<span style="color: #009900;">&#125;</span> 	<span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>L'enregistrement des <strong>Pet</strong>s est particulier. En effet, ils appartiennent à la grappe d'objets liée à un <strong>Owner</strong> dans le cache. Il faudra donc récupérer ledit <strong>Owner</strong>, ajouter/modifier le <strong>Pet</strong> puis remettre le <strong>Owner</strong> dans le cache (et donc son graphe complet). Cette façon de faire n'est pas transactionnelle: si une modification du <strong>Owner</strong> par un autre accès au cache survient entre le <strong>get()</strong> et le <strong>put()</strong>, cette modification disparaîtra. Les opérations <strong>get()</strong> et <strong>put()</strong> sont par contre garanties atomiques. L'approche grossière ci-dessous suffira pour l'instant mais nous verrons dans un prochain article comment faire les choses proprement.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #666666; font-style: italic;">// FIXME not transactional !!!</span> <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> storePet<span style="color: #009900;">&#40;</span>Pet pet<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> DataAccessException <span style="color: #009900;">&#123;</span> 	<span style="color: #003399;">Owner</span> owner <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Owner</span><span style="color: #009900;">&#41;</span> getOwnersCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">get</span><span style="color: #009900;">&#40;</span>pet.<span style="color: #006633;">getOwner</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; 	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>owner <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		<span style="color: #000000; font-weight: bold;">throw</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">IllegalStateException</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Owner with id: &quot;</span> <span style="color: #339933;">+</span> pet.<span style="color: #006633;">getOwner</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot; not found&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 	<span style="color: #009900;">&#125;</span> &nbsp; 	<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>pet.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		pet.<span style="color: #006633;">setId</span><span style="color: #009900;">&#40;</span>RandomUtils.<span style="color: #006633;"
>nextInt</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 		owner.<span style="color: #006633;">addPet</span><span style="color: #009900;">&#40;</span>pet<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 	<span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span> 		Pet existingPet <span style="color: #339933;">=</span> owner.<span style="color: #006633;">getPet</span><span style="color: #009900;">&#40;</span>pet.<span style="color: #006633;">getName</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 		existingPet.<span style="color: #006633;">setBirthDate</span><span style="color: #009900;">&#40;</span>pet.<span style="color: #006633;">getBirthDate</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 		existingPet.<span style="color: #006633;">setName</span><span style="color: #009900;">&#40;</span>pet.<span style="color: #006633;">getName</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 		existingPet.<span style="color: #006633;">setType</span><span style="color: #009900;">&#40;</span>pet.<span style="color: #006633;">getType</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 	<span style="color: #009900;">&#125;</span> 	getOwnersCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>owner.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>, owner<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p><strong>storeVisit()</strong> pose un problème similaire: il faut retrouver le <strong>Pet</strong> puis le <strong>Owner</strong> associé. Ici non plus, la modification n'est pas transactionnelle et il faudra attendre un futur article pour faire mieux (et avoir un code plus élégant :).</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> storeVisit<span style="color: #009900;">&#40;</span>Visit visit<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> DataAccessException <span style="color: #009900;">&#123;</span> 	<span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Owner</span> owner <span style="color: #339933;">:</span> <span style="color: #009900;">&#40;</span>Collection<span style="color: #339933;">&lt;</span>Owner<span style="color: #339933;">&gt;</span><span style="color: #009900;">&#41;</span> getOwnersCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">values</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 		<span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span>Pet pet <span style="color: #339933;">:</span> owner.<span style="color: #006633;">getPets</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 			<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>pet.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">equals</span><span style="color: #009900;">&#40;</span>visit.<span style="color: #006633;">getPet</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 				<span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>visit.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 					visit.<span style="color: #006633;">setId</span><span style="color: #009900;">&#40;</span>RandomUtils.<span style="color: #006633;">nextInt</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 				<span style="color: #009900;">&#125;</span> 				pet.<span style="color: #006633;">addVisit</span><span style="color: #009900;">&#40;</span>visit<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 				getOwnersCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>owner.<span style="color: #006633;">getId</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>, owner<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 				<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span> 			<span style="color: #009900;">&#125;</span> 		<span style="color: #009900;">&#125;</span> 	<span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Les méthodes <strong>getVets()</strong> et <strong>getPetTypes()</strong> ne posent pas particulièrement de problèmes, nous utilisons l'API <strong>Map</strong> pour récupérer toutes les valeurs. Notez que la collection renvoyée par Coherence est immuable, nous ne pourrions donc pas y ajouter ou supprimer de données. Pour notre application, ces données sont en <em>read only</em>, nous n'avons donc pas de problème.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> Collection<span style="color: #339933;">&lt;</span>Vet<span style="color: #339933;">&gt;</span> getVets<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> DataAccessException <span style="color: #009900;">&#123;</span> 	<span style="color: #000000; font-weight: bold;">return</span> getVetsCache<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">values</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> Collection<span style="color: #339933;">&lt;</span>PetType<span style="color: #339933;">&gt;</span> getPetTypes<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> DataAccessException <span style="color: #009900;">&#123;</span> 	<span style="color: #000000; font-weight: bold;">return</span> getPetTypesCache<span style="color:
 #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">values</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Pour limiter la quantité de code moche (et surtout non transactionnel) dans cet article, nous traiterons <strong>deletePet()</strong> plus tard, avec des fonctionnalité plus avancées de Coherence.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> deletePet<span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">int</span> id<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> DataAccessException <span style="color: #009900;">&#123;</span> 	<span style="color: #000000; font-weight: bold;">throw</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">UnsupportedOperationException</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Pet with id &quot;</span> <span style="color: #339933;">+</span> id <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot; is not allowed to die&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <h3>Ready to test</h3> <p>Nous avons maintenant du joli code tout neuf, mais comment le tester puisque nous n'accédons plus à la base de donnée&nbsp;? Et bien nous avons préparé pour vous une petite classe qui va injecter des données dans le cache au démarrage de Tomcat (oui, notre générosité n'a pas de limites...)&nbsp;: <a href="public/Billet_285/DataInitializer.java">DataInitializer.java</a>. Il faut ajouter dans le web.xml&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;listener<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;listener-class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>com.zenika.petclinic.coherence.DataInitializer<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/listener-class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/listener<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Vous pouvez tester l'application et tout devrait fonctionner à part, évidement, la suppression de <strong>Pet</strong>s.</p> <p>Le résultat final est récupérable sur Github&nbsp;:</p> <pre class="bash code bash" style="font-family:inherit"><span style="color: #c20cb9; font-weight: bold;">git</span> clone <span style="color: #660033;">-n</span> <span style="color: #c20cb9; font-weight: bold;">git</span>:<span style="color: #000000; font-weight: bold;">//</span>github.com<span style="color: #000000; font-weight: bold;">/</span>obourgain<span style="color: #000000; font-weight: bold;">/</span>petclinic-coherence.git <span style="color: #c20cb9; font-weight: bold;">git</span> checkout article2-end</pre> <p>et en <a href="/wp-content/uploads/2015/07/petclinic-coherence-article2-end.zip">zip</a></p> <p>Au programme du prochain article: comment faire proprement des recherches dans un cache Coherence&nbsp;!</p> <p><em>Article co-écrit par Guillaume Tinon et Olivier Bourgain.</em></p> <p>Index des articles de la série Coherence&nbsp;:</p> <ul> <li><a href="index.php?post/2011/08/12/Coherence-PetCinic">Introduction à Coherence: Part I</a></li> <li><a href="index.php?post/2011/08/25/Introduction-à-Coherence%3A-Part-II">Introduction à Coherence: Part II</a></li> <li><a href="index.php?post/2011/10/07/Introduction-à-Coherence%3A-Part-III">Coherence Part III&nbsp;: Filtres</a></li> <li><a href="index.php?post/2012/01/09/Coherence-Part-IV-%3A-extracteurs-et-recherches-distribuées-sur-le-cluster">Coherence Part IV&nbsp;: extracteurs et recherches distribuées sur le cluster</a></li> <li><a href="index.php?post/2012/01/03/Coherence-Part-IV-%3A-optimisations-des-requêtes-avec-des-index6">Coherence Part V&nbsp;: optimisations des requêtes avec des index</a></li> <li><a href="index.php?post/2012/01/06/Coherence-Part-VI-%3A-traitement-de-données-distribuées%2C-in-place-processing4">Coherence Part VI&nbsp;: traitement de données distribuées, concurrence et in-place processing</a></li> </ul>