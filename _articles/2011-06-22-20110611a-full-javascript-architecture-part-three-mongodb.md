---
ID: 193
post_title: 'A Full Javascript Architecture, Part Three &#8211; MongoDB'
author: nletaifa
post_date: 2011-06-22 16:29:00
post_excerpt: '<p>This is the last part in a series of three showing how to build a simple JavaScript architecture.</p> <p>After seeing how to <a href="http://blog.zenika.com/index.php?post/2011/04/10/NodeJS">create a NodeJS application </a> to track tweets and <a href="http://blog.zenika.com/index.php?post/2011/05/11/A-Full-Javascript-Architecture%2C-Part-Two-Chrome-Extension2">send them to a Google Chrome Extension</a> in real time, we are going to see how to store and query them using a <a href="http://www.mongodb.org/">MongoDB</a> database.</p> <p>For a better understanding, this post starts by explaining the basics of MongoDB and then deals with its integration in a NodeJS application.</p>'
layout: post
permalink: http://blog.zenika-offres.com/?p=193
published: true
---
<p>This is the last part in a series of three showing how to build a simple JavaScript architecture.</p> <p>After seeing how to <a href="http://blog.zenika.com/index.php?post/2011/04/10/NodeJS">create a NodeJS application </a> to track tweets and <a href="http://blog.zenika.com/index.php?post/2011/05/11/A-Full-Javascript-Architecture%2C-Part-Two-Chrome-Extension2">send them to a Google Chrome Extension</a> in real time, we are going to see how to store and query them using a <a href="http://www.mongodb.org/">MongoDB</a> database.</p> <p>For a better understanding, this post starts by explaining the basics of MongoDB and then deals with its integration in a NodeJS application.</p>
<!--more-->
<p><img src="/wp-content/uploads/2015/07/node-mongo.png" alt="NodeJS - MongoDB" style="display:block; margin:0 auto;" title="NodeJS - MongoDB" /></p> <h2>Introduction to MongoDB</h2> <br/> <p><img src="/wp-content/uploads/2015/07/mongo.png" alt="mongodb" style="display:block; margin:0 auto;" title="mongodb" /></p> <h3>Presentation</h3> <p>MongoDB presents itself as a <em>scalable</em>, <em>high-performance</em>, <em>open source</em> and <em>document-oriented</em> database written in C++.</p> <p>Each of the concepts behind the first three characteristics are well known so let's focus on the fourth one : <em>document-oriented</em>.</p> <p>To clearly understand this concept we need some basic MongoDB terminology. Since we are going to see a lot of JSON let's start right away :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #009900;">&#123;</span> 	<span style="color: #3366CC;">&quot;terminology&quot;</span> <span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span> 		<span style="color: #3366CC;">&quot;Database&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Database&quot;</span><span style="color: #339933;">,</span> 		<span style="color: #3366CC;">&quot;Table&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Collection&quot;</span><span style="color: #339933;">,</span> 		<span style="color: #3366CC;">&quot;Row&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Document&quot;</span> 	<span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>A <strong>document-oriented</strong> database is a database where each <strong>document</strong> in a same <strong>collection</strong> may have a totally different structure. With this orientation, any number of fields of any length can be added to a document even after its creation.</p> <p>Because all the information of the same entity can be dynamically stored within a single document, <em>joins</em> operations are no longer needed in this type of database.</p> <p><em>Joins</em> operations are really expensive, they require a strong consistency and a fixed schema. Avoiding them results in a great capacity of <strong>horizontal scaling</strong>.</p> <h3>Data Types</h3> <p>MongoDB uses <a href="http://bsonspec.org/">BSON</a> as the data storage and network transfer format. BSON stands for "<em>Binary JSON</em>" and is a bin­ary-en­coded seri­al­iz­a­tion of JSON-like doc­u­ments. According to the <a href="http://bsonspec.org/">bsonspec.org</a>, it was de­signed to be lightweight, traversable and efficient.</p> <p>Its key advantage over XML and JSON is <strong>efficiency</strong> in term of  <strong>space</strong> and <strong>compute time</strong>.</p> <p>BSON documents can be used  to store several data types like ''string, integer, boolean, double, null, array, object, date, binary data, regular expression and source code''. You can find more by exploring <a href="http://bsonspec.org/#/specification">the specification</a>.</p> <h3>Advanced Features</h3> <p>MongoDB has a set of advanced features like <strong>full-index</strong>, <strong>replication</strong>, <strong>sharding</strong> and <strong>map/reduce</strong>. Unfortunately they won't be approached in this post.</p> <h2>Why MongoDB ?</h2> <br/> <p>Choosing MongoDB for our use case was motivated by a set of features that characterize this database.</p> <h3>JavaScript</h3> <p>Requests in MongoDB are written in JavaScript and that is a perfect fit for our architecture. In addition, these requests use a RDBMS style query that reduce the gap for developers used to traditional structured query language.</p> <h3>JSON Document-Oriented</h3> <p>MongoDB uses parsed JSON document (<em>BSON</em>) as data structure. Since the Twitter API send us data in JSON, tweets can be stored immediately and without any pretreatment. The key/value approach of other NoSQL databases like <a href="http://redis.io/">Redis</a> is not suitable for us because we need to store more than a simple value.</p> <h3>Schemaless</h3> <p>It's capital for our application to store data in a flexible manner, indeed tweets we are going to receive can have a different JSON structure. For instance, a retweet can have more fields than a regular one.</p> <h3>Real-Time</h3> <p>MongoDB is very good at real-time inserts by keeping transaction support extremely simple.</p> <h3>NodeJS driver</h3> <p>MongoDB has a <a href="https://github.com/christkv/node-mongodb-native">native and open source driver</a> written by Christian Amor Kvalheim .</p> <h2>Getting started</h2> <h3>Installation</h3> <p>To install MongoDB check the latest recommended version on <a href="http://www.mongodb.org/downloads" title="http://www.mongodb.org/downloads">http://www.mongodb.org/downloads</a> and wget it. Debian and Ubuntu users can try using apt packages, check out <a href="http://www.mongodb.org/display/DOCS/Ubuntu+and+Debian+packages">this page</a> for more information.</p> <pre class="bash code bash" style="font-family:inherit">$ <span style="color: #c20cb9; font-weight: bold;">wget</span> http:<span style="color: #000000; font-weight: bold;">//</span>fastdl.mongodb.org<span style="color: #000000; font-weight: bold;">/</span>linux<span style="color: #000000; font-weight: bold;">/</span>mongodb-linux-x86_64-1.8.1.tgz</pre> <p>When the download is done unpack the archive :</p> <pre class="bash code bash" style="font-family:inherit">$ <span style="color: #c20cb9; font-weight: bold;">tar</span> xzf mongodb-linux-x86_64-1.8.1.tgz</pre> <p>Before starting the database we need to create and set the rights on the folder where the data will be stored, by default MongoDB  configuration uses <strong>/data/db</strong>.</p> <pre class="bash code bash" style="font-family:inherit">$ <span style="color: #c20cb9; font-weight: bold;">mkdir</span> <span style="color: #660033;">-p</span> <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>db<span style="color: #000000; font-weight: bold;">/</span> $ <span style="color: #c20cb9; font-weight: bold;">chown</span> <span style="color: #000000; font-weight: bold;">`</span><span style="color: #c20cb9; font-weight: bold;">id</span> -u<span style="color: #000000; font-weight: bold;">`</span> <span style="color: #000000; font-weight: bold;">/</span>data<span style="color: #000000; font-weight: bold;">/</span>db</pre> <p>Then we can start the database by calling Mongo's deamon :</p> <pre class="bash code bash" style="font-family:inherit">$ <span style="color: #000000; font-weight: bold;">/</span>opt<span style="color: #000000; font-weight: bold;">/</span>mongodb<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mongod</pre> <h3>The MongoDB Interactive Shell</h3> <p>MongoDB comes with a JavaScript shell used to manage and query the database.</p> <p>To start the shell use the mongo executable :</p> <pre class="bash code bash" style="font-family:inherit">$ <span style="color: #000000; font-weight: bold;">/</span>opt<span style="color: #000000; font-weight: bold;">/</span>mongodb<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>mongo MongoDB shell version: 1.8.1 connecting to: <span style="color: #7a0874; font-weight: bold;">test</span></pre> <p>As we can see, once in the shell we are automatically connected to the <em>test</em> database.</p> <h4>Basic Commands</h4> <ul> <li><ins>help</ins></li> </ul> <p>We can get <strong>help</strong> at anytime by using this command.</p> <pre class="bash code bash" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">&gt;</span> <span style="color: #7a0874; font-weight: bold;">help</span></pre> <p>Help is also a method we can call on database or collection objects to get all the functions associated to them. The <strong>db</strong> object always refer to the database currently used and collections are its attributes.</p> <
pre class="bash code bash" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">&gt;</span> db.help<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #000000; font-weight: bold;">&gt;</span> db.my_collection.help<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #000000; font-weight: bold;">&gt;</span> db.another_collection.help<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span></pre> <ul> <li><ins>show</ins></li> </ul> <p>With <strong>show</strong> you can list all the databases or collections.</p> <p>To list all the the <strong>databases</strong> use :</p> <pre class="bash code bash" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">&gt;</span> show dbs admin   <span style="color: #7a0874; font-weight: bold;">&#40;</span>empty<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">local</span>   <span style="color: #7a0874; font-weight: bold;">&#40;</span>empty<span style="color: #7a0874; font-weight: bold;">&#41;</span> <span style="color: #7a0874; font-weight: bold;">test</span>    <span style="color: #7a0874; font-weight: bold;">&#40;</span>empty<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre> <p>To list all the the <strong>collections</strong> in a database use :</p> <pre class="bash code bash" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">&gt;</span> show collections</pre> <ul> <li><ins>use</ins></li> </ul> <p><strong>use</strong> allows to connect to a database :</p> <pre class="bash code bash" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">&gt;</span> use database_name switched to db database_name</pre> <p><strong>There is no need to create a database or a collection before connecting to it, MongoDB will automatically do it when the first insert is made.</strong></p> <h4>JavaScript Functions</h4> <p>Since we are in JavaScript, we can enhance objects in the shell. For example we can add a method to a collection that we will use later.</p> <p>This method will print the percentage of documents for the <em>tweets</em> collection corresponding to the provided parameter.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">percentage</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>value<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span> <span style="color: #000066;">print</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span>value<span style="color: #339933;">*</span><span style="color: #CC0000;">100</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">/</span> <span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">&quot;%&quot;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#125;</span></pre> <h2>Requests</h2> <br/> <p>Requests are made using a set of methods on database's collections objects.</p> <p>For a better understanding on how to use these methods we will see specific examples for each one of them.</p> <h3>Inserting</h3> <p>To feed our collection with data the <strong>insert()</strong> method is used.</p> <p>The document we want to insert need to be JSON formatted and passed as a parameter.</p> <p>As an example we can create a collection containing all the speakers who participated in the <em>What's Next</em>.</p> <pre class="javascript code javascript" style="font-family:inherit">db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Shay&quot;</span>         <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Banon&quot;</span>        <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;kimchy&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Neal&quot;</span>         <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Gafter&quot;</span>       <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;gafter&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Adrian&quot;</span>       <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Colyer&quot;</span>       <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;adriancolyer&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Boris&quot;</span>        <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Bokowski&quot;</span>     <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;bokowski&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Jonas&quot;</span>        <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Bonér&quot;</span>        <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;jboner&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Rob &quot;</span>         <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Harrop&quot;</span>       <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;robertharrop&quot;</span> <span style="color:
 #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Kohsuke&quot;</span>      <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Kawaguchi&quot;</span>    <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;kohsukekawa&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Howard Lewis&quot;</span> <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Ship&quot;</span>         <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;hlship&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Jevgeni&quot;</span>      <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Kabanov&quot;</span>      <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;ekabanov&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Theo&quot;</span>         <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Schlossnagle&quot;</span> <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;postwait&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Michaël&quot;</span>      <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Chaize&quot;</span>       <span style="color: #339933;">,</span> twitter <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;mchaize&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Brad&quot;</span>         <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Drysdale&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Jags&quot;</span>         <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Ramnarayan&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span></pre> <p>As you can see, we can insert a document without taking care of its structure or generating an id.</p> <p>In fact, when we insert a document in a collection and do not provide an explicit id (with the field name "<strong>_id </strong>") Mongo will automatically generate a unique <strong>ObjectId</strong>  and store it the "<strong>_id</strong>" field. Ids must be unique for each documents in a collection and it's the program job to make sure they are otherwise an error will be thrown.</p> <h3>Updating</h3> <p>The <strong>update()</strong> method as its name suggests allows us to update a document or a set of documents depending on the parameters used.</p> <p>It can take up to 4 parameters :</p> <ul> <li><em>criteria</em> : The query which selects the document to update</li> <li><em>newObj</em> : The updated object</li> <li><em>upsert</em> : A boolean to indicate that the <em>newObj</em> is inserted if the document does not exist (default : false)</li> <li><em>multi</em> : A boolean that indicate if all documents matching the <em>criteria</em> should be updated (default : false)</li> </ul> <p>Let's update a speaker to add his performed talk name.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">update</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Brad&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Brad&quot;</span> <span style="color: #339933;">,</span> lastname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Drysdale&quot;</span><span style="color: #339933;">,</span> talk <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;HTML5 WebSockets&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span></pre> <p>If you need to update a single document using its <strong> _id </strong> you can use the shorthand method <strong>save()</strong>. It only takes one parameter which is the object to update, the <strong> _id</strong> field of this object must be filled out correctly so that the update is done.</p> <p>Let's update another speaker using this method :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #003366; font-weight: bold;">var</span> theo <span style="color: #339933;">=</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">findOne</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Theo&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> theo.<span style="color: #660066;">talk</span> <span style="color: #339933;">=</span> <span style="color: #3366CC;">&quot;Service Decoupling in Carrier-Class&quot;</span> <span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">save</span><span style="color: #009900;">&#40;</span>theo<span style="color: #009900;">&#41;</span></pre> <p>Since we don't know the speaker <strong>_id</strong>, we start by finding it. The <strong>findOne()</strong> method query the collection and retrieve the first document ( <strong>_id</strong> included ) with "<strong>Theo</strong>" as a firstname.</p> <h3>Query
ing</h3> <p>With MongoDB you can query the data by using several methods. Each one takes a JSON formatted query parameter in which you can use some operators to fetch the data you need. You should always remember that <strong>queries are case sensitive</strong>.</p> <p>To sample our queries we are going to use a collection named <em><strong>tweets</strong></em>. The data contained in this collection are all the tweets that have been tracked by our NodeJS application during the two days of  the <em>What's Next</em> event. How they were recorded is explained later in this post.</p> <p>Here is what a tweet stored in the collection looks like (a lot of fields are omitted here on purpose):</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #009900;">&#123;</span>    <span style="color: #3366CC;">&quot;_id&quot;</span><span style="color: #339933;">:</span>ObjectId<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;4dde17241b1dc31f5a0000f5&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>    <span style="color: #3366CC;">&quot;date&quot;</span><span style="color: #339933;">:</span>NumberLong<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;1306400548416&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>    <span style="color: #3366CC;">&quot;tweet&quot;</span><span style="color: #339933;">:</span><span style="color: #009900;">&#123;</span>       <span style="color: #3366CC;">&quot;text&quot;</span><span style="color: #339933;">:</span><span style="color: #3366CC;">&quot;At @adriancolyer's talk #wsnparis  http://t.co/UO3jCBU&quot;</span><span style="color: #339933;">,</span>       <span style="color: #3366CC;">&quot;retweet_count&quot;</span><span style="color: #339933;">:</span><span style="color: #CC0000;">0</span><span style="color: #339933;">,</span>       <span style="color: #3366CC;">&quot;source&quot;</span><span style="color: #339933;">:</span><span style="color: #3366CC;">&quot;Twitter for iPhone&quot;</span><span style="color: #339933;">,</span>       <span style="color: #3366CC;">&quot;entities&quot;</span><span style="color: #339933;">:</span><span style="color: #009900;">&#123;</span>          <span style="color: #3366CC;">&quot;urls&quot;</span><span style="color: #339933;">:</span><span style="color: #009900;">&#91;</span>             <span style="color: #009900;">&#123;</span>                <span style="color: #3366CC;">&quot;url&quot;</span><span style="color: #339933;">:</span><span style="color: #3366CC;">&quot;http://t.co/UO3jCBU&quot;</span><span style="color: #339933;">,</span>             <span style="color: #009900;">&#125;</span>          <span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span>          <span style="color: #3366CC;">&quot;user_mentions&quot;</span><span style="color: #339933;">:</span><span style="color: #009900;">&#91;</span>             <span style="color: #009900;">&#123;</span>                <span style="color: #3366CC;">&quot;screen_name&quot;</span><span style="color: #339933;">:</span><span style="color: #3366CC;">&quot;adriancolyer&quot;</span><span style="color: #339933;">,</span>                <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span><span style="color: #3366CC;">&quot;Adrian Colyer&quot;</span>             <span style="color: #009900;">&#125;</span>          <span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span>          <span style="color: #3366CC;">&quot;hashtags&quot;</span><span style="color: #339933;">:</span><span style="color: #009900;">&#91;</span>             <span style="color: #009900;">&#123;</span>                <span style="color: #3366CC;">&quot;text&quot;</span><span style="color: #339933;">:</span><span style="color: #3366CC;">&quot;wsnparis&quot;</span>             <span style="color: #009900;">&#125;</span>          <span style="color: #009900;">&#93;</span>       <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span>       <span style="color: #3366CC;">&quot;user&quot;</span><span style="color: #339933;">:</span><span style="color: #009900;">&#123;</span>          <span style="color: #3366CC;">&quot;screen_name&quot;</span><span style="color: #339933;">:</span><span style="color: #3366CC;">&quot;jawher&quot;</span><span style="color: #339933;">,</span>          <span style="color: #3366CC;">&quot;lang&quot;</span><span style="color: #339933;">:</span><span style="color: #3366CC;">&quot;en&quot;</span><span style="color: #339933;">,</span>          <span style="color: #3366CC;">&quot;name&quot;</span><span style="color: #339933;">:</span><span style="color: #3366CC;">&quot;Jawher Moussa&quot;</span><span style="color: #339933;">,</span>       <span style="color: #009900;">&#125;</span>    <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <h4>find()</h4> <p>To search for documents in a collection run :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span></pre> <p>A call to the <strong>find()</strong> method display only the first 20 documents in the shell, use the <strong>it</strong> keyword after the request to display the next results.</p> <p>By default all the fields of the documents are returned, you can choose what field you want by using the second parameter of the method. For example this request will only return the <em>username</em> and the <em>text</em> field of the documents :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span> <span style="color: #009900;">&#123;</span><span style="color: #009900;">&#125;</span> <span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;tweet.text&quot;</span> <span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#41;</span></pre> <p>To limit the number of document returned use the <strong>limit</strong> method. Using <strong>limit()</strong> with 1 as parameter equals to using the <strong>findOne()</strong> method.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">limit</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">100</span><span style="color: #009900;">&#41;</span></pre> <p>To skip the firsts documents returned use the <strong>skip()</strong> method :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">skip</span><span style="color: #009900;">&#40;</span><span style="color: #CC0000;">100</span><span style="color: #009900;">&#41;</span></pre> <p>To count the number of documents returned use the <strong>count()</strong> method :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</sp
an><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #CC0000;">1699</span></pre> <p>To filter your request add a query parameter to the <strong>find()</strong> method. A query parameter is a simple JSON object, for example let's count the number of tweets that have been created from twitter.com and not from a mobile or desktop client application.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.source&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;web&quot;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#41;</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #CC0000;">242</span></pre> <p>Let's use this query to try the <strong>percentage()</strong> method added earlier :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">percentage</span><span style="color: #009900;">&#40;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.source&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;web&quot;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#41;</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span> <span style="color: #CC0000;">14.24</span><span style="color: #339933;">%</span></pre> <h5>Operators</h5> <p>These are the operator you can use in your queries :</p> <ul> <li><strong>$lt</strong> (&lt;), <strong>$lte</strong> (&lt;=), <strong>$gt</strong> (&gt;) and <strong>$gte</strong> (&gt;=)</li> </ul> <p>Let's count how many tweets have been at least retweeted 2 times.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.retweet_count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span> $gte <span style="color: #339933;">:</span> <span style="color: #CC0000;">2</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #CC0000;">125</span></pre> <ul> <li><strong>$ne</strong> (!=)</li> </ul> <p>How many tweets have not been tweeted by the official <em>What's Next Paris</em> twitter account (<a href="http://twitter.com/WsN_Paris">@WsN_Paris</a>)</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span> $ne <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;WsN_Paris&quot;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #CC0000;">1688</span></pre> <ul> <li><strong>$exists</strong></li> </ul> <p>This operator allows to test if a field exists in a document structure. We can for example count how many tweets are retweeted ones.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.retweeted_status&quot;</span> <span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span> $exists <span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #CC0000;">448</span></pre> <ul> <li><strong>$size</strong></li> </ul> <p>The $size operator allows to check the size of an array. For example let's see how many tweets contain a single link :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.entities.urls&quot;</span> <span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span> $size <span style="color: #339933;">:</span> <span style="color: #CC0000;">1</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #CC0000;">341</span></pre> <ul> <li><strong>$in</strong> , <strong>$nin</strong></li> </ul> <p>The <em>$in</em> operator allows to specify an array of possible matches thanks to an array. With it we can count how many tweets have been created by an official Twitter client on Apple devices.</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.source&quot;</span> <span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span> $in <span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span><span style="color: #3366CC;">&quot;Twitter for Mac&quot;</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;Twitter for iPhone&quot;</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;Twitter for iPad&quot;</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #CC0000;">485</span></pre> <ul> <li><strong>$or</strong> , <strong>$nor</strong></li> </ul> <p>The $or operator allow to combine a list of boolean expression. Let's count how many tweets was made by <a href="http://twitter.com/WsN_Paris">@WsN_Paris</a> or that mentions it :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;
">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">find</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> $or <span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;WsN_Paris&quot;</span> <span style="color: #009900;">&#125;</span> <span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.entities.user_mentions.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;WsN_Paris&quot;</span><span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">count</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #CC0000;">41</span></pre> <h4>distinct()</h4> <p>Like in standard SQL, we can make a request to return a list of distinct documents based on a key. In order to do that we use the <strong>distinct()</strong> method on the collection.</p> <p>As an example let's see how many different twitter clients have been used :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">distinct</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;tweet.source&quot;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">length</span> <span style="color: #CC0000;">52</span></pre> <p>Like the <strong>find()</strong> method, you can add a second parameter to filter your query.</p> <p>Let's see how many users have made a tweet mentioning Jevgeni Kabanov (<a href="http://twitter.com/ekabanov">@ekabanov</a>)</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">distinct</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.entities.user_mentions.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;ekabanov&quot;</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">length</span> <span style="color: #CC0000;">45</span></pre> <p>You noticed that we have used the <strong>length</strong> property instead of the <strong>count()</strong> method, that's simply because <strong>distinct()</strong> returns an array when <strong>find()</strong> was returning a <a href="http://www.mongodb.org/display/DOCS/Queries+and+Cursors">cursor</a>.</p> <h4>group()</h4> <p>The <strong>group()</strong> method is used to return an array of grouped item. It takes an object as parameter with the following 3 required properties :</p> <ul> <li><em>key</em> : The fields to group by on</li> <li><em>initial</em> : The initial value of the aggregation counter object.</li> <li><em>reduce</em> : The reduce function takes two arguments, the current document being iterated over and the aggregation counter object.</li> </ul> <p>To sample this function let's do a request that group on the users and count their tweets. We will sort the results by count number in descending order. For readability only the first 10 results are shown :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span>db.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">group</span> <span style="color: #009900;">&#40;</span> 	<span style="color: #009900;">&#123;</span> 	key <span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">true</span> <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span> 		initial <span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span> count <span style="color: #339933;">:</span> <span style="color: #CC0000;">0</span> <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span> 		reduce <span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>obj<span style="color: #339933;">,</span>prev<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span> prev.<span style="color: #660066;">count</span><span style="color: #339933;">++;</span> <span style="color: #009900;">&#125;</span> 	<span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#41;</span>.<span style="color: #660066;">sort</span><span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>a<span style="color: #339933;">,</span>b<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span><span style="color: #000066; font-weight: bold;">return</span> b.<span style="color: #660066;">count</span> <span style="color: #339933;">-</span> a.<span style="color: #660066;">count</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> &nbsp; <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;LostInBrittany&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">93</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;bcourtine&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">60</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;antoine_sd&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">53</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;samklr&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">40</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;dadoonet&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">38</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #336
6CC;">&quot;slemesle&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">37</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;jawher&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">33</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;framiere&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">31</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;obazoud&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">30</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#123;</span> <span style="color: #3366CC;">&quot;tweet.user.screen_name&quot;</span> <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;nmartignole&quot;</span> <span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;count&quot;</span> <span style="color: #339933;">:</span> <span style="color: #CC0000;">27</span> <span style="color: #009900;">&#125;</span></pre> <p>The <strong>group()</strong> method should only be used in non sharded MongoDB configurations and for a result smaller than 10,000 keys. For large scale aggregation, <a href="http://www.mongodb.org/display/DOCS/MapReduce">Map/Reduce</a> is the answer.</p> <h3>Deleting</h3> <p>To delete a document the method <strong>remove()</strong> is used. It takes a JSON object query to define which argument in the collection will be removed. A call to <strong>remove()</strong> without any query will remove all the documents in the collection</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">remove</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> _id <span style="color: #339933;">:</span> ObjectId<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;4d9db8c5cac30037d92e39fc&quot;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">remove</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#123;</span> firstname <span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Jonas&quot;</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">remove</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span></pre> <p>If needed, we can delete a collection from a database by calling its <strong>drop()</strong> method:</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #339933;">&gt;</span> db.<span style="color: #660066;">speakers</span>.<span style="color: #660066;">drop</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#91;</span>conn1<span style="color: #009900;">&#93;</span> CMD<span style="color: #339933;">:</span> drop wsn.<span style="color: #660066;">speakers</span> <span style="color: #003366; font-weight: bold;">true</span></pre> <h3>Full-Text Search</h3> <p>As I speak MongoDB <strong>Production Release</strong> is 1.8.1 and doesn't have a real full-text search support.</p> <p>You can find in the documentation a way to do some basic full-text search using arrays but you will have to code some logic on your own to implement it.</p> <p>Many discussions shows that todays best option for doing full-text search is using your database with another tool like <a href="http://sphinxsearch.com/">Sphinx</a>, <a href="http://www.elasticsearch.org/">ElasticSearch</a> or <a href="http://lucene.apache.org/solr/">Solr</a>.</p> <p>The status of the full-text search implementation in MongoDB can be followed <a href="https://jira.mongodb.org/browse/SERVER-380">here</a>.</p> <h2>MongoDB &amp; NodeJS</h2> <h3>Driver</h3> <p>To establish a connection with our database in NodeJS we need to install the <a href="https://github.com/christkv/node-mongodb-native">node-mongodb-native</a> driver.</p> <p>Clone it from the git repository and install :</p> <pre class="bash code bash" style="font-family:inherit">$ <span style="color: #c20cb9; font-weight: bold;">git</span> clone https:<span style="color: #000000; font-weight: bold;">//</span>github.com<span style="color: #000000; font-weight: bold;">/</span>christkv<span style="color: #000000; font-weight: bold;">/</span>node-mongodb-native.git $ <span style="color: #7a0874; font-weight: bold;">cd</span> node-mongodb-native $ <span style="color: #c20cb9; font-weight: bold;">make</span></pre> <h3>Database Module</h3> <p>Like what we did back in the <a href="/index.php?post/2011/04/10/NodeJS">first post</a>, we are going to make a simple module that deals with the database and call it from the main program.</p> <p>Our module will use the driver to connect with the database and get a reference to the collection in which tweets will be stored. To add a tweet to the collection our module will have an <strong>insertTweet()</strong> method.</p> <p>Create a new file called <strong>database.js</strong> and add the following content :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #006600; font-style: italic;">// Loading required librairies</span> <span style="color: #003366; font-weight: bold;">var</span> mongodb <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'/path/to/mongodb'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>         DB_NAME <span style="color: #339933;">=</span> <span style="color: #3366CC;">&quot;wsn&quot;</span><span style="color: #339933;">,</span>         DB_HOST <span style="color: #339933;">=</span> <span style="color: #3366CC;">&quot;localhost&quot;</span><span style="color: #339933;">,</span>         DB_PORT <span style="color: #339933;">=</span> <span style="color: #CC0000;">27017</span><span style="color: #339933;">,</span>         COL_NAME <span style="color: #339933;">=</span> <span style="color: #3366CC;">&quot;tweets&quot;</span><span style="color: #339933;">;</span> &nbsp; <span style="color: #003366; font-weight: bold;">var</span> getCollection <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>callback<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>         <span style="color: #003366; font-weight: bold;">var</span> db <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> mongodb.<span style="color: #660066;">Db</span><span style="color: #009900;">&#40;</span>DB_NAME<span style="color:
#339933;">,</span> <span style="color: #003366; font-weight: bold;">new</span> mongodb.<span style="color: #660066;">Server</span><span style="color: #009900;">&#40;</span>DB_HOST<span style="color: #339933;">,</span> DB_PORT<span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span><span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span><span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #006600; font-style: italic;">// Database connection</span>         db.<span style="color: #000066;">open</span><span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>error<span style="color: #339933;">,</span> client<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>                 <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>error<span style="color: #009900;">&#41;</span> console.<span style="color: #660066;">error</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;-- Error with database : &quot;</span> <span style="color: #339933;">+</span> error<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>                 <span style="color: #006600; font-style: italic;">// Getting a reference to the tweets collection </span>                 db.<span style="color: #660066;">collection</span><span style="color: #009900;">&#40;</span>COL_NAME<span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>error<span style="color: #339933;">,</span> collection<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                         callback<span style="color: #009900;">&#40;</span>collection<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>                         db.<span style="color: #000066;">close</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>                 <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>         <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #006600; font-style: italic;">// Called by server.js</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">insertTweet</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>tweet<span style="color: #339933;">,</span> callback<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>         <span style="color: #006600; font-style: italic;">// Opening the connection and getting the collection</span>         getCollection<span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>collection<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>                 <span style="color: #006600; font-style: italic;">// Tweet insertion</span>                 collection.<span style="color: #660066;">insert</span><span style="color: #009900;">&#40;</span>tweet<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#125;</span></pre> <p>Finally the only thing left is to add our module into the <strong>server.js</strong> and store each new tweet after sending it to the clients.</p> <p>Edit the <strong>server.js</strong> to add it the two new lines :</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #003366; font-weight: bold;">var</span> http <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'http'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> 	io <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'/path/to/socket.io'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>         twitter <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'./twitter'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>         <span style="color: #006600; font-style: italic;">// Loading our database module </span> 	database <span style="color: #339933;">=</span> require<span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'./database'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; <span style="color: #009900;">&#91;</span> ... <span style="color: #009900;">&#93;</span> &nbsp; tracker.<span style="color: #660066;">track</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">on</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'tweet'</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>tweet<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>         console.<span style="color: #660066;">log</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'New tweet from :&quot;'</span> <span style="color: #339933;">+</span> tweet.<span style="color: #660066;">user</span>.<span style="color: #660066;">screen_name</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">'&quot; -&gt; '</span> <span style="color: #339933;">+</span> tweet.<span style="color: #660066;">text</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 	socket.<span style="color: #660066;">broadcast</span><span style="color: #009900;">&#40;</span> JSON.<span style="color: #660066;">stringify</span><span style="color: #009900;">&#40;</span> <span style="color: #009900;">&#91;</span> ... <span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #006600; font-style: italic;">// Tweet insertion, timestamp is added to simplify time based query</span>         database.<span style="color: #660066;">insertTweet</span><span style="color: #009900;">&#40;</span> <span style="color: #009900;">&#123;</span> tweet <span style="color: #339933;">:</span> tweet<span style="color: #339933;">,</span> date <span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">new</span> Date<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #660066;">getTime</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre> <h2>Conclusion</h2> <h3>MongoDB</h3> <p>In this introduction we really only scratched the surface of the features offered by MongoDB but I hope that it will make you curious enough to learn more about this database.</p> <p>MongoDB and more generally the NoSQL movement makes us look differently at databases. In Mongo, replacing SQL by Javascript can be a disturbing factor at first sight but it quickly appears easy and flexib
le.</p> <p>Thanks to its Javascript shell you can start practicing MongoDB very quickly. In fact you can even start without installing it as <a href="http://try.mongodb.org">try.mongodb.org</a> offers an interactive shell tutorial.</p> <p>As the large and growing number of <a href="http://www.mongodb.org/display/DOCS/Drivers">drivers available</a> (Java, Scala, C#, Erlang, C, C++, etc..) shows, MongoDB is quickly evolving since its was released by <a href="http://www.10gen.com">10gen</a> back in 2009.</p> <p>Using the node-mongodb-native is pretty simple but it can be harder to work with on more complex projects due to its callbacks accumulation. To solve this issue you can take a look on the <a href="http://mongoosejs.com">Mongoose ORM</a>.</p> <h3>Architecture</h3> <p>While use cases are still a minority on the market for this type of architecture, it's very interesting to see that there is a way of using the same language for each components. JavaScript is now a widely used language and should no longer have to be only confined on web browsers.</p> <p>Mobile internet, since it has dramatically increased in recent years, is also concerned by this kind of architecture with smartphones or tablets applications that should handle a large number of continuously connected users.</p> <p>NodeJS and MongoDB are both built with scalability as the main goal and are today one of the best couple for building real time web applications.</p> <p>Companies feedbacks shows that they are useful for reducing the complexity of existing architecture and that they will be used even more in the future.</p> <h2>Resources</h2> <br/> <ul> <li>MongoDB Official : <a href="http://www.mongodb.org/" title="http://www.mongodb.org/">http://www.mongodb.org/</a></li> <li>Documentation : <a href="http://www.mongodb.org/display/DOCS/Home" title="http://www.mongodb.org/display/DOCS/Home">http://www.mongodb.org/display/DOCS...</a></li> <li>Companies using MongoDB : <a href="http://www.mongodb.org/display/DOCS/Production+Deployments" title="http://www.mongodb.org/display/DOCS/Production+Deployments">http://www.mongodb.org/display/DOCS...</a></li> <li>10 gen reference cards : <a href="http://www.10gen.com/reference" title="http://www.10gen.com/reference">http://www.10gen.com/reference</a></li> <li>MongoDB &amp; NodeJS : <a href="http://www.mongodb.org/display/DOCS/node.JS" title="http://www.mongodb.org/display/DOCS/node.JS">http://www.mongodb.org/display/DOCS...</a></li> <li>node-mongodb-native : <a href="https://github.com/joyent/node" title="https://github.com/joyent/node">https://github.com/joyent/node</a></li> </ul> <br/> 