---
ID: 73
post_title: RAP, Sessions et Workbench
author: lbertholet
post_date: 2009-06-30 09:00:00
post_excerpt: |
  <p>Le projet <a href="http://www.eclipse.org/rap/" hreflang="en">RAP</a> (pour Rich Application Platform) offre la possibilité de créer des applications internet riches (RIA) J2ee en utilisant les principes et le modèle de développement des applications Eclipse RCP. N'hésitez pas à consulter ce <a href="/index.php?post/2009/05/18/Eclipse-RAP-%3A-Sortie-imminente-de-RAP-1.2-RC1">billet</a> pour une présentation générale de cette technologie. Pour entrer un peu plus dans les détails, Equinox (l'implémentation d'OSGI sur laquelle est basé Eclipse) fournit des bundles permettant sa propre intégration au sein d'un conteneur de servlet. RAP utilise ce support afin d'exécuter vos applications RCP coté serveur.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=73
published: true
---
<p>Le projet <a href="http://www.eclipse.org/rap/" hreflang="en">RAP</a> (pour Rich Application Platform) offre la possibilité de créer des applications internet riches (RIA) J2ee en utilisant les principes et le modèle de développement des applications Eclipse RCP. N'hésitez pas à consulter ce <a href="/index.php?post/2009/05/18/Eclipse-RAP-%3A-Sortie-imminente-de-RAP-1.2-RC1">billet</a> pour une présentation générale de cette technologie. Pour entrer un peu plus dans les détails, Equinox (l'implémentation d'OSGI sur laquelle est basé Eclipse) fournit des bundles permettant sa propre intégration au sein d'un conteneur de servlet. RAP utilise ce support afin d'exécuter vos applications RCP coté serveur.</p>
<!--more-->
<p>Lors d'un développement RAP, il faut avoir à l'esprit qu'il existe quelques différences très importantes entre ces deux cousins pourtant très proches. Par exemple, contrairement à RCP qui est généralement mono-utilisateur, une application RAP est destinée à être utilisée par plusieurs utilisateurs simultanément via des sessions HTTP. Le concept de singleton très présent dans les plugins Eclipse a donc été revu par l'équipe du projet afin d'assurer la cohérence de l'unicité d'une instance aux différents niveaux de portée classique&nbsp;: application, session et request. En effet, sans cette intervention, tout singleton se trouverait automatiquement au niveau application et je vous laisse imaginer les soucis engendrés quand on sait, par exemple, que le Workbench en est un. C'est donc naturellement qu'il a été placé en tant que singleton au niveau de la session. Cette assignation est faite facilement, son arbre d'héritage devant simplement inclure SessionSingletonBase qui définit tous les mécanismes adéquat dont la méthode statique suivante&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">/** </span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">&nbsp;  * Returns the singleton instance of the specified type that is stored</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">&nbsp;  * in the current session context. If no instance exists yet, a new</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">&nbsp;  * one will be created. Therefore the specified type should have</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">&nbsp;  * an parameterless default constructor.</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">&nbsp;  * </span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">&nbsp;  * @param type specifies the session singleton instance type.</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">&nbsp;  * @return the unique instance of the specified type that is associated</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">&nbsp;  *         with the current user session context.  </span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #808080; font-style: italic;">&nbsp;  */</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #000000;">Object</span> getInstance<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #7F0055; font-weight: bold;">Class</span> type <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    IServiceStateInfo stateInfo = ContextProvider.<span style="color: #000000;">getContext</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getStateInfo</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">Object</span> result = <span style="color: #7F0055; font-weight: bold;">null</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span> stateInfo <span style="color: #000000;">!</span>= <span style="color: #7F0055; font-weight: bold;">null</span> <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      result = stateInfo.<span style="color: #000000;">getAttribute</span><span style="color: #000000;">&#40;</span> getInstanceKey<span style="color: #000000;">&#40;</span> type <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span> result == <span style="color: #7F0055; font-weight: bold;">null</span> <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055; font-weight: bold;">synchronized</span><span style="color: #000000;">&#40;</span> getInstanceLock<span style="color: #000000;">&#40;</span> type <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        result = getInstanceInternal<span style="color: #000000;">&#40;</span> type <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span> stateInfo <span style="color: #000000;">!</span>= <span style="color: #7F0055; font-weight: bold;">null</span> <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li s
tyle="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        stateInfo.<span style="color: #000000;">setAttribute</span><span style="color: #000000;">&#40;</span> getInstanceKey<span style="color: #000000;">&#40;</span> type <span style="color: #000000;">&#41;</span>, result <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #7F0055; font-weight: bold;">return</span> result;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>A noter l'utilisation du ContextProvider permettant d'obtenir le ServiceContext propre à la session de l'utilisateur dont la requête est en cours de traitement. Le ServiceContext stocke, en autres, un ServiceStateInfo qui conserve diverses informations internes nécessaires au bon fonctionnement de l'application.</p> <p>Lorsqu'une session utilisateur est invalidée, la fermeture du Workbench correspondant est réalisée grâce à l'utilisation d'un SessionStoreListener qui guette toute destruction.</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #7F0055; font-weight: bold;">class</span> ShutdownHandler <span style="color: #7F0055; font-weight: bold;">implements</span> SessionStoreListener</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	  <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	    <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> beforeDestroy<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">final</span> SessionStoreEvent event <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	      <span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span> Workbench.<span style="color: #000000;">getInstance</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">started</span> <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	        Workbench.<span style="color: #000000;">getInstance</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">sessionInvalidated</span> = <span style="color: #7F0055; font-weight: bold;">true</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	        Workbench.<span style="color: #000000;">getInstance</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">close</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	    <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	  <span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Jusqu'à RAP 1.2 RC1, le processus complet de fermeture par invalidation de session n'était pas exactement le même que celui déroulé lors de la fermeture manuelle du Workbench via la croix rouge standard. Le ServiceContext n'était pas explicitement disposé et le ServiceStateInfo qui tient le Workbench était alors toujours référencé. Dans un cas basique d'utilisation de RAP cette différence ne posait pas particulièrement de problème car seul le Thread Graphique tenait le ServiceContext et comme il était en train de se terminer, tout était bien garbage-collecté. Cependant si l'application utilisait BIRT, elle utilisait indirectement la classe XMLTypeUtil du projet EMF qui peut parfois créer une référence statique sur ce fameux Thread Graphique. Il n'était alors plus garbage collecté et tout le Workbench était conservé en mémoire malgré la déconnexion de l'utilisateur.</p> <p>Notre utilisation conjointe de RAP et BIRT dans un projet en cours nous a permis de détecter cette fuite mémoire et le <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=275332">patch</a> proposé à l'équipe RAP a très rapidement été intégré.</p>