---
ID: 77
post_title: 'RAP et les Jobs &#8211; Part 2'
author: lbertholet
post_date: 2010-02-02 15:00:00
post_excerpt: |
  <p>Nous avons vu dans le <a href="/index.php?post/2010/01/26/RAP-et-les-Jobs-Part-1">billet précédent</a> qu'il était important de bien redéfinir certaines méthodes de la classe Job afin d'éviter les fuites mémoires. Cependant, après avoir appliqué ces préconisations, il est facile de constater que les Jobs exécutés ne sont pas garbage collectés tant que la session de l'utilisateur les ayant sollicités est active.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=77
published: true
---
<p>Nous avons vu dans le <a href="/index.php?post/2010/01/26/RAP-et-les-Jobs-Part-1">billet précédent</a> qu'il était important de bien redéfinir certaines méthodes de la classe Job afin d'éviter les fuites mémoires. Cependant, après avoir appliqué ces préconisations, il est facile de constater que les Jobs exécutés ne sont pas garbage collectés tant que la session de l'utilisateur les ayant sollicités est active.</p>
<!--more-->
<p>En effet, lors de chaque exécution, le JobManagerAdapter appelle la méthode bindToSession définie ci-dessous avec le Job en argument.</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">void</span> bindToSession<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">Object</span> keyToRemove <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    ISessionStore session = RWT.<span style="color: #000000;">getSessionStore</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    HttpSessionBindingListener watchDog = <span style="color: #7F0055; font-weight: bold;">new</span> HttpSessionBindingListener<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> valueBound<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">final</span> HttpSessionBindingEvent event <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> valueUnbound<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">final</span> HttpSessionBindingEvent event <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          handleWatchDog<span style="color: #000000;">&#40;</span> keyToRemove <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">finally</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #7F0055; font-weight: bold;">synchronized</span><span style="color: #000000;">&#40;</span> lock <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            jobs.<span style="color: #000000;">remove</span><span style="color: #000000;">&#40;</span> keyToRemove <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      ...</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">&#125;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    session.<span style="color: #000000;">setAttribute</span><span style="color: #000000;">&#40;</span> <span style="color: #000000;">String</span>.<span style="color: #000000;">valueOf</span><span style="color: #000000;">&#40;</span> watchDog.<span style="color: #000000;">hashCode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>, watchDog <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Cette méthode place en session un objet possédant une référence directe sur le Job. Malheureusement, la valeur de la clé de stockage étant créée localement, il est ensuite incapable de le retirer. Autre conséquence, le code contenu dans <em>valueUnbound</em>, qui peut sembler important, ne sera jamais exécuté.</p> <p>Pour contourner cette fuite mémoire, je n'ai pas trouvé d'autre moyen que de patcher le code de RAP. La solution proposée consiste à indiquer au Job la clé avec laquelle il sera mis en session lors du <em>valueBound</em>&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">void</span> bindToSession<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">Object</span> keyToRemove <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    ISessionStore session = RWT.<span style="color: #000000;">getSessionStore</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    HttpSessionBindingListener watchDog = <span style="color: #7F0055; font-weight: bold;">new</span> HttpSessionBindingListener<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div styl
e="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> valueBound<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">final</span> HttpSessionBindingEvent event <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    	  <span style="color: #808080; font-style: italic;">/* START : Patch */</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    	  <span style="color: #7F0055;font-weight: bold;">if</span> <span style="color: #000000;">&#40;</span>keyToRemove <span style="color: #7F0055; font-weight: bold;">instanceof</span> Job<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">				<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#40;</span>Job<span style="color: #000000;">&#41;</span> keyToRemove<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">setProperty</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> QualifiedName<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">null</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">						<span style="color: #888888;">&quot;watchDogKey&quot;</span><span style="color: #000000;">&#41;</span>, <span style="color: #000000;">String</span>.<span style="color: #000000;">valueOf</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">this</span>.<span style="color: #000000;">hashCode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    	  <span style="color: #808080; font-style: italic;">/* END : Patch */</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> valueUnbound<span style="color: #000000;">&#40;</span> <span style="color: #7F0055; font-weight: bold;">final</span> HttpSessionBindingEvent event <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          handleWatchDog<span style="color: #000000;">&#40;</span> keyToRemove <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">finally</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #7F0055; font-weight: bold;">synchronized</span><span style="color: #000000;">&#40;</span> lock <span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            jobs.<span style="color: #000000;">remove</span><span style="color: #000000;">&#40;</span> keyToRemove <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      ...</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">&#125;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    session.<span style="color: #000000;">setAttribute</span><span style="color: #000000;">&#40;</span> <span style="color: #000000;">String</span>.<span style="color: #000000;">valueOf</span><span style="color: #000000;">&#40;</span> watchDog.<span style="color: #000000;">hashCode</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>, watchDog <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Puis de redéfinir le constructeur de notre classe de Job en ajoutant systématiquement un listener responsable de le retirer de la session à la fin de son exécution&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> MonJob<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">String</span> name<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #7F0055; font-weight: bold;">super</span><span style="color: #000000;">&#40;</span>name<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; backgro
und:inherit;">        addJobChangeListener<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> JobChangeAdapter<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            @Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> done<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">final</span> IJobChangeEvent event<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">               RWT.<span style="color: #000000;">getSessionStore</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">removeAttribute</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">                <span style="color: #000000;">String</span>.<span style="color: #000000;">valueOf</span><span style="color: #000000;">&#40;</span>event.<span style="color: #000000;">getJob</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getProperty</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> QualifiedName<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">null</span>, <span style="color: #888888;">&quot;watchDogKey&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Vous pouvez suivre l'évolution de cette anomalie sur le bug-tracking du projet RAP à <a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=274021" hreflang="en">l'adresse suivante</a>.</p>