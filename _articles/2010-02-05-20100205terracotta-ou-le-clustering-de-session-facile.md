---
ID: 400
post_title: >
  Terracotta, ou le clustering de session
  facile
author: ocroisier
post_date: 2010-02-05 20:23:00
post_excerpt: |
  <p>Dans un récent article intitulé "<a href="/index.php?post/2009/12/07/Terracotta%2C-un-an-apr%C3%A8s">Terracotta, un an après</a>", je vous décrivais la volonté de <a href="http://www.terracotta.org/">Terracotta</a> de simplifier la mise en oeuvre du framework sur ses principaux cas d'utilisation&nbsp;: clustering de sessions HTTP, clustering de cache EHCache ou Hibernate, intégration avec Spring et Quartz... <br />
  Peu à peu apparaissent donc des <a href="http://www.terracotta.org/solutions/technology-solutions">solutions packagées et pré-configurées</a>, reconnaissables à leur suffixe "Express".<br /></p> <p>Si vous suivez ce blog, vous savez déjà <a href="/index.php?post/2009/06/22/Clusteriser-une-application-web-avec-TCServer-et-Terracotta">clusteriser des sessions HTTP avec Terracotta et TCServer</a>, en configurant manuellement la plateforme&nbsp;; aujourd'hui, je vous parlerai du module "HTTP Session Clustering Express", introduit avec Terracotta 3.2.1-beta, qui simplifie nettement le processus.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=400
published: true
---
<p>Dans un récent article intitulé "<a href="/index.php?post/2009/12/07/Terracotta%2C-un-an-apr%C3%A8s">Terracotta, un an après</a>", je vous décrivais la volonté de <a href="http://www.terracotta.org/">Terracotta</a> de simplifier la mise en oeuvre du framework sur ses principaux cas d'utilisation&nbsp;: clustering de sessions HTTP, clustering de cache EHCache ou Hibernate, intégration avec Spring et Quartz... <br />
Peu à peu apparaissent donc des <a href="http://www.terracotta.org/solutions/technology-solutions">solutions packagées et pré-configurées</a>, reconnaissables à leur suffixe "Express".<br /></p> <p>Si vous suivez ce blog, vous savez déjà <a href="/index.php?post/2009/06/22/Clusteriser-une-application-web-avec-TCServer-et-Terracotta">clusteriser des sessions HTTP avec Terracotta et TCServer</a>, en configurant manuellement la plateforme&nbsp;; aujourd'hui, je vous parlerai du module "HTTP Session Clustering Express", introduit avec Terracotta 3.2.1-beta, qui simplifie nettement le processus.</p>
<!--more-->
<h3>Standard ou Express&nbsp;?</h3> <p>Mais avant de se lancer dans le code, il est nécessaire de comprendre les avantages et inconvénients des deux solutions.</p> <ul> <li>Dans la solution traditionnelle, les sessions HTTP et leurs attributs sont instrumentés et surveillés par Terracotta, grâce à un <em>bootjar</em> chargé au démarrage de la JVM. Grâce à cette instrumentation, Terracotta est alors capable de détecter et répercuter le moindre changement sur les champs de ces objets. <br />Cette granularité ultra-fine offre des performances maximales, et ne nécessite pas que les objets répliqués soient <code>Serializable</code>. En revanche, la configuration de la plateforme peut se révéler complexe (il faut notamment déclarer manuellement les classes à instrumenter), et le bootjar n'est pas portable sur toutes les JVMs.</li> <li>La version Express, au contraire, s'appuie au contraire sur des mécanismes comme des filtres de servlets (Jetty, Weblogic) ou des Valves (Tomcat, JBoss) pour détecter les changements et les transmettre au serveur terracotta, et sont livrés sous la forme d'un simple Jar à intégrer sur les serveurs d'application.<br />L'avantage de cette solution est évidemment sa simplicité de mise en oeuvre et sa portabilité inter-JVM. L'inconvénient, c'est que la réplication se base désormais sur le mécanisme de sérialisation standard de Java, nettement moins performant, et qui nécessite que les objets manipulés implémentent <code>Serializable</code>. De plus, la configuration diffère légèrement d'un serveur d'application à l'autre.</li> </ul> <p>A vous de choisir la solution la plus adaptée à votre projet, sachant qu'il n'est pas forcément indolore de passer de l'une à l'autre...</p> <p><br />
<br /></p> <h3>Mise en place de la plateforme de test</h3> <h4>Présentation de l'application</h4> <p>L'application que nous utiliserons est disponible en annexe de ce billet.</p> <p>Elle est fort simple&nbsp;: à chaque rafraîchissement de son unique page, un compteur de visites est incrémenté et affiché. <br />
Comme la version Express du module de clustering HTTP se base sur l'interception des méthodes de <code>HttpSession</code> (<code>setAttribute()</code>, <code>removeAttribute()</code>...) pour détecter et répercuter les modifications apportées aux sessions, il est nécessaire de réassocier le compteur à la session après chaque incrémentation - c'est l'une des quelques différences subtiles avec la version standard.</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> CounterServlet <span style="color: #7F0055; font-weight: bold;">extends</span> HttpServlet <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">String</span> COUNTER_SESSION_ATTRIBUTE = <span style="color: #888888;">&quot;counter&quot;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> doGet<span style="color: #000000;">&#40;</span>HttpServletRequest request, HttpServletResponse response<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> ServletException, <span style="color: #000000;">IOException</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		HttpSession session = request.<span style="color: #000000;">getSession</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #000000;">Integer</span> counter = <span style="color: #000000;">&#40;</span><span style="color: #000000;">Integer</span><span style="color: #000000;">&#41;</span> session.<span style="color: #000000;">getAttribute</span><span style="color: #000000;">&#40;</span>COUNTER_SESSION_ATTRIBUTE<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		request.<span style="color: #000000;">setAttribute</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;counterValue&quot;</span>, counter<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		session.<span style="color: #000000;">setAttribute</span><span style="color: #000000;">&#40;</span>COUNTER_SESSION_ATTRIBUTE, ++counter<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		RequestDispatcher dispatcher = request.<span style="color: #000000;">getRequestDispatcher</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;/WEB-INF/jsp/counter.jsp&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		dispatcher.<span style="color: #000000;">forward</span><span style="color: #000000;">&#40;</span>request, response<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Le compteur est initialisé à 0 lors du démarrage de l'application, à l'aide d'un <code>Listener</code>.</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> CounterInitializerListener <span style="color: #7F0055; font-weight: bold;">implements</span> HttpSessionListener <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> sessionCreated<span style="color: #000000;">&#40;</span>HttpSessionEvent event<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		HttpSession session = event.<span style="color: #000000;">getSession</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		session.<span style="color: #000000;">setAttribute</span><span style="color: #000000;">&#40;</span>CounterServlet.<span style="color: #000000;">COUNTER_SESSION_ATTRIBUTE</span>, 0<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margi
n:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> sessionDestroyed<span style="color: #000000;">&#40;</span>HttpSessionEvent event<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <h4>Installation de TCServer</h4> <p>Pour l'installation de <a href="http://www.springsource.com/products/tcserver">TCServer</a> et la configuration de deux instances, je vous laisse vous reporter à l'article "<a href="/index.php?post/2009/06/22/Clusteriser-une-application-web-avec-TCServer-et-Terracotta">Clusteriser une application web avec Terracotta et TCServer</a>".</p> <p>Dans la suite de l'article, nous considèrerons que TCServer est installé dans le répertoire <code>&lt;TCSERVER_INSTALL_DIR&gt;</code> et que les deux instances écoutent respectivement sur les ports 8081 et 8082.</p> <h4>Installation de Terracotta</h4> <p>Pour le moment, Terracotta 3.2.1-beta n'est disponible que <a href="http://www.terracotta.org/beta/darwin">sur inscription</a>, mais les fonctionnalités évoquées ici seront sans doute bientôt disponibles dans la prochaine version publique.</p> <p>Une fois l'archive téléchargée sur le site de Terracotta, décompressez-la dans un répertoire (par exemple "/opt/Java/Tools/Terracotta") que nous nommerons "<code>&lt;TERRACOTTA_INSTALL_DIR&gt;</code>".</p> <p><br />
<br /></p> <h3>Configuration</h3> <h4>Configuration du serveur Terracotta</h4> <p>Le mode Express porte bien son nom&nbsp;: pour les cas simples, aucune configuration spécifique n'est nécessaire sur le serveur Terracotta !<br />
Vous pourriez donc le lancer immédiatement avec ses paramètres par défaut&nbsp;:</p> <pre class="bash code bash" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000; font-weight: bold;">&lt;</span>TERRACOTTA_INSTALL_DIR<span style="color: #000000; font-weight: bold;">&gt;/</span>bin<span style="color: #000000; font-weight: bold;">/</span>start-tc-server.sh <span style="color: #000000; font-weight: bold;">&amp;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">Ex: <span style="color: #000000; font-weight: bold;">/</span>opt<span style="color: #000000; font-weight: bold;">/</span>Java<span style="color: #000000; font-weight: bold;">/</span>Tools<span style="color: #000000; font-weight: bold;">/</span>Terracotta<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>start-tc-server.sh <span style="color: #000000; font-weight: bold;">&amp;</span></div></li></ol></pre> <p>Toutefois, c'est une bonne pratique de redéfinir au moins les répertoires contenant les données et les logs.<br />
Créez un fichier "tc-config.xml" dans le répertoire "<code>&lt;TERRACOTTA_INSTALL_DIR&gt;</code>", et choisissez où placer les données et les logs&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?xml</span> <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;1.0&quot;</span> <span style="color: #000066;">encoding</span>=<span style="color: #ff0000;">&quot;UTF-8&quot;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;tc:tc-config</span> <span style="color: #000066;">xmlns:tc</span>=<span style="color: #ff0000;">&quot;http://www.terracotta.org/config&quot;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;">  <span style="color: #000066;">xmlns:xsi</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;">  <span style="color: #000066;">xsi:schemaLocation</span>=<span style="color: #ff0000;">&quot;http://www.terracotta.org/schema/terracotta-5.xsd&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;servers<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;server<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;data<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/home/olivier/Java/Tools/Terracotta/data<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/data<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;logs<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/home/olivier/Java/Tools/Terracotta/logs/server<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/logs<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dso-port<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>9510<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dso-port<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/server<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/servers<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;clients<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #808080; font-style: italic;">&lt;!-- Le %i représente l'IP des clients connectés --&gt;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;logs<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/home/olivier/Java/Tools/Terracotta/logs/clients/%i<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/logs<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/clients<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/tc:tc-config<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>Il suffit alors d'indiquer l'emplacement de ce fichier au serveur Terracotta&nbsp;:</p> <pre class="bash code bash" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000; font-weight: bold;">&lt;</span>TERRACOTTA_INSTALL_DIR<span style="color: #000000; font-weight: bold;">&gt;/</span>bin<span style="color: #000000; font-weight: bold;">/</span>start-tc-server.sh <span style="color: #660033;">-f</span> <span style="color: #000000; font-weight: bold;">&lt;</span>TERRACOTTA_INSTALL_DIR<span style="color: #000000; font-weight: bold;">&gt;/</span>tc-config.xml</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">Ex : <span style="color: #000000; font-weight: bold;">/</span>opt<span style="color: #000000; font-weight: bold;">/</span>Java<span style="color: #000000; font-weight: bold;">/</span>Tools<span sty
le="color: #000000; font-weight: bold;">/</span>Terracotta<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>start-tc-server.sh <span style="color: #660033;">-f</span> <span style="color: #000000; font-weight: bold;">/</span>opt<span style="color: #000000; font-weight: bold;">/</span>Java<span style="color: #000000; font-weight: bold;">/</span>Tools<span style="color: #000000; font-weight: bold;">/</span>Terracotta<span style="color: #000000; font-weight: bold;">/</span>tc-config.xml</div></li></ol></pre> <p>Pour vérifier que le serveur est bien démarré, utilisez la console d'administration de Terracotta&nbsp;:</p> <pre class="bash code bash" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000; font-weight: bold;">&lt;</span>TERRACOTTA_INSTALL_DIR<span style="color: #000000; font-weight: bold;">&gt;/</span>bin<span style="color: #000000; font-weight: bold;">/</span>dev-console.sh <span style="color: #000000; font-weight: bold;">&amp;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">Ex: <span style="color: #000000; font-weight: bold;">/</span>opt<span style="color: #000000; font-weight: bold;">/</span>Java<span style="color: #000000; font-weight: bold;">/</span>Tools<span style="color: #000000; font-weight: bold;">/</span>Terracotta<span style="color: #000000; font-weight: bold;">/</span>bin<span style="color: #000000; font-weight: bold;">/</span>dev-console.sh <span style="color: #000000; font-weight: bold;">&amp;</span></div></li></ol></pre> <p><img src="/wp-content/uploads/2015/07/DevConsole1.png" alt="DevConsole1.png" /></p> <h4>Configuration de l'application et de TCServer</h4> <p>Comme indiqué plus haut, la configuration du module HttpSessions Clustering Express dépend du serveur d'application utilisé - dans notre cas, TCServer se configure comme Tomcat, dont il est dérivé.</p> <p>La configuration est effectivement très simple. Il suffit de&nbsp;:</p> <ul> <li>Copier le jar <code>&lt;TERRACOTTA_INSTALL_DIR&gt;/sessions/terracotta-session-1.0.0-SNAPSHOT.jar</code> dans le répertoire <code>&lt;TCSERVER_INSTALL_DIR&gt;/tomcat-&lt;version&gt;/lib</code>.</li> <li>Déclarer la Valve appropriée dans le fichier <code>/META-INF/context.xml</code> de notre application&nbsp;:</li> </ul> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Context<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Valve</span> <span style="color: #000066;">className</span>=<span style="color: #ff0000;">&quot;org.terracotta.session.TerracottaTomcat60xSessionValve&quot;</span> <span style="color: #000066;">tcConfigUrl</span>=<span style="color: #ff0000;">&quot;localhost:9510&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Context<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>Notez que c'est dans la "valve" que l'on configure le serveur Terracotta auquel l'application sera connectée - ici, notre serveur local, sur le port par défaut 9510.</p> <p>Pour finir, démarrez les deux instances de TCServer, et déployez l'application dessus.<br />
La console d'administration de Terracotta devrait alors signaler que deux clients se sont connectés au serveur&nbsp;:</p> <p><img src="/wp-content/uploads/2015/07/DevConsole2.png" alt="DevConsole2.png" /></p> <h3>Test du clustering</h3> <p>Dans un navigateur, ouvrez un onglet sur chaque serveur&nbsp;:</p> <ul> <li><a href="http://localhost:8081/WebCounter/CounterServlet">http://localhost:8081/WebCounter/CounterServlet</a></li> <li><a href="http://localhost:8082/WebCounter/CounterServlet">http://localhost:8082/WebCounter/CounterServlet</a></li> </ul> <p>Rafraîchissez un onglet plusieurs fois pour voir le compteur de visites s'incrémenter.<br />
Maintenant, passez sur le second onglet et rafraîchissez-le. Le compteur devrait continuer à s'incrémenter à partir de la valeur atteinte sur le premier onglet, prouvant que les sessions HTTP des deux serveurs ont été synchronisées par Terracotta. Félicitations&nbsp;!</p> <h3>Conclusion</h3> <p>Nous avons vu au cours de cet article que la mise en cluster de sessions HTTP avec Terracotta était relativement simple, en utilisant le module HTTP Sessions Clustering Express&nbsp;: très peu de configuration côté serveur, un simple jar sur le serveur d'applications, et la déclaration d'une "valve" au niveau de l'application.<br />
Mais cette simplicité vient au prix d'une perte notable en performances par rapport à la version "standard", à cause de l'utilisation de la sérialisation Java...</p> <p>En tant qu'architecte, ma préférence reste au mode de configuration standard, qui me permet de tirer toute la puissance de la plateforme Terracotta, et qui ne me lie pas à un serveur d'applications particulier. Mais pour tester rapidement une application à grande échelle, notamment pour détecter des problèmes d'accès concurrents, le déploiement de la version Express est une option séduisante, surtout sur TCServer qui permet de créer instantanément un cluster de serveurs.</p> <p>Vous trouverez en annexe de ce billet une archive "war" immédiatement déployable, qui contient également le code source de l'application.</p>