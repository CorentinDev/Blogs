---
ID: 479
post_title: >
  Testing SQL queries with Spring and
  DbUnit, part 2
author: Arnaud Cogolu√®gnes
post_date: 2010-02-15 09:18:00
post_excerpt: '<p>The <a href="/index.php?post/2010/02/04/Testing-SQL-queries-with-Spring-and-DbUnit%2C-part-1">first part of this article</a> covered the basics of the Spring TestContext Framework and DbUnit. We saw how to integrate DbUnit into a test to put the database into a known state before test methods are executed, to keep them isolated from each other. It worked great but this integration is too intrusive and does not scale when the number of test grows. This second part shows how to make the injection of test data into the database a cross-cutting concern, to let tests focus on their job and to allow them adding this feature with an optional, annotation-based configuration.</p>'
layout: post
permalink: http://blog.zenika-offres.com/?p=479
published: true
---
<p>The <a href="/index.php?post/2010/02/04/Testing-SQL-queries-with-Spring-and-DbUnit%2C-part-1">first part of this article</a> covered the basics of the Spring TestContext Framework and DbUnit. We saw how to integrate DbUnit into a test to put the database into a known state before test methods are executed, to keep them isolated from each other. It worked great but this integration is too intrusive and does not scale when the number of test grows. This second part shows how to make the injection of test data into the database a cross-cutting concern, to let tests focus on their job and to allow them adding this feature with an optional, annotation-based configuration.</p>
<!--more-->
<h2>The usual suspect</h2> <p>Remember, the test of our repository looked like this:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@RunWith<span style="color: #000000;">&#40;</span>SpringJUnit4ClassRunner.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@ContextConfiguration<span style="color: #000000;">&#40;</span>locations=<span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #888888;">&quot;classpath:/repository-test-context.xml&quot;</span>	</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> JdbcContactRepositoryTest <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Autowired</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	ContactRepository contactRepository;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Autowired</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	SimpleJdbcTemplate jdbcTemplate;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Autowired</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	DataSource dataSource;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Before <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> setUp<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		IDataSet dataSet = <span style="color: #7F0055; font-weight: bold;">new</span> FlatXmlDataSetBuilder<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">build</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #000000;">File</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #888888;">&quot;./src/test/resources/dataset.xml&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		IDatabaseConnection dbConn = <span style="color: #7F0055; font-weight: bold;">new</span> DatabaseDataSourceConnection<span style="color: #000000;">&#40;</span>dataSource<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		DatabaseOperation.<span style="color: #000000;">CLEAN_INSERT</span>.<span style="color: #000000;">execute</span><span style="color: #000000;">&#40;</span>dbConn, dataSet<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Test <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> create<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">int</span> initialCount = jdbcTemplate.<span style="color: #000000;">queryForInt</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;select count(1) from contact&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		Contact contact = <span style="color: #7F0055; font-weight: bold;">new</span> Contact<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;Arnaud&quot;</span>, <span style="color: #888888;">&quot;Cogoluegnes&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		contactRepository.<span style="color: #000000;">create</span><span style="color: #000000;">&#40;</span>contact<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertEquals</span><span style="color: #000000;">&#40;</span>initialCount+<span style="color: #cc66cc;">1</span>,jdbcTemplate.<span sty
le="color: #000000;">queryForInt</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;select count(1) from contact&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Test <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> selectByLastname<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertEquals</span><span style="color: #000000;">&#40;</span>0,contactRepository.<span style="color: #000000;">selectByLastname</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;cogo&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">size</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertEquals</span><span style="color: #000000;">&#40;</span><span style="color: #cc66cc;">1</span>,contactRepository.<span style="color: #000000;">selectByLastname</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;our&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">size</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertEquals</span><span style="color: #000000;">&#40;</span><span style="color: #cc66cc;">2</span>,contactRepository.<span style="color: #000000;">selectByLastname</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;o&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">size</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>The test injects itself the test data set in the <code>setUp</code> method, by leveraging the DbUnit API. It works fine, but wouldn't it be better if the test could only say "I want this data set to be injected before each of my test methods" and let someone else do the job? This approach makes sense as JUnit tests are a good example of the Inversion of Control pattern: an external component - the runner - is in charge of calling the test methods. This makes it possible to add behavior <em>around</em> the test methods, namely during the lifecycle of the test.</p> <p>Let's see how the Spring TestContext Framework allows us to do that.</p> <h2>TestExecutionListeners to react to the test lifecycle</h2> <p>The Spring TestContext Framework provides a very simple yet powerful extension hook: the <code>TestExecutionListener</code>. The Spring test runner maintains a list of <code>TestExecutionListener</code>s that can react to the test lifecycle. Here is the definition of the <code>TestExecutionListener</code> interface:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">interface</span> TestExecutionListener <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">void</span> beforeTestClass<span style="color: #000000;">&#40;</span>TestContext testContext<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">void</span> prepareTestInstance<span style="color: #000000;">&#40;</span>TestContext testContext<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">void</span> beforeTestMethod<span style="color: #000000;">&#40;</span>TestContext testContext<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">void</span> afterTestMethod<span style="color: #000000;">&#40;</span>TestContext testContext<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">void</span> afterTestClass<
span style="color: #000000;">&#40;</span>TestContext testContext<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Spring provides some <code>TestExecutionListener</code>s: one of them, the <code>DependencyInjectionTestExecutionListener</code> is in charge of injecting dependencies from the Spring application context into the test instance. This is this listener that interprets the <code>Autowired</code> annotation we add on the test properties. This means that Spring adds automatically some <code>TestExecutionListener</code>s on its default list.</p> <p>Imagine we add the data set injection feature by implementing our <code>TestExecutionListener</code>, the <code>CleanInsertTestExecutionListener</code>. We can add our own listeners by using the <code>TestExecutionListeners</code> annotation on the test class:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@RunWith<span style="color: #000000;">&#40;</span>SpringJUnit4ClassRunner.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@ContextConfiguration<span style="color: #000000;">&#40;</span>locations=<span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #888888;">&quot;classpath:/repository-test-context.xml&quot;</span>	</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@TestExecutionListeners<span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#123;</span>DependencyInjectionTestExecutionListener.<span style="color: #7F0055; font-weight: bold;">class</span>,CleanInsertTestExecutionListener.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> JdbcContactRepositoryTest <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Note that as soon as we use the <code>TestExecutionListeners</code> annotation, we override the default stack of listeners, which means we have to add ourselves the ones we need (that's what we do with the dependency injection listener).</p> <p>We have enough theory to build our <code>CleanInsertTestExecutionListener</code>!</p> <h2>Writing the CleanInsertTestExecutionListener</h2> <p>So our <code>CleanInsertTestExecutionListener</code> will inject data into the test database during the <code>beforeTestMethod</code>. But how can he know about the data set to inject? A nice way to locate the data set would be to provide a default behavior ("convention over configuration") but also allows explicit configuration. Let's see first the explicit configuration! What about a annotation? The test class could accept a annotation that locates the data set. Let's call this annotation <code>DataSetLocation</code>. Here is how to use it on the test:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@RunWith<span style="color: #000000;">&#40;</span>SpringJUnit4ClassRunner.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@ContextConfiguration<span style="color: #000000;">&#40;</span>locations=<span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #888888;">&quot;classpath:/repository-test-context.xml&quot;</span>	</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@TestExecutionListeners<span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#123;</span>DependencyInjectionTestExecutionListener.<span style="color: #7F0055; font-weight: bold;">class</span>,CleanInsertTestExecutionListener.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@DataSetLocation<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;classpath:/dataset.xml&quot;</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> JdbcContactRepositoryTest <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span></div></li><li style="font-we
ight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Note the annotation accepts the syntax of the Spring's resource abstraction (prefixes like <code>classpath</code>, <code>file</code>, etc.). The definition of the annotation is straightforward:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">package</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">test</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.lang.annotation.Documented;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.lang.annotation.ElementType;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.lang.annotation.Inherited;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.lang.annotation.Retention;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.lang.annotation.RetentionPolicy;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.lang.annotation.Target;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@Retention<span style="color: #000000;">&#40;</span>RetentionPolicy.<span style="color: #000000;">RUNTIME</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@Target<span style="color: #000000;">&#40;</span>ElementType.<span style="color: #000000;">TYPE</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@Inherited</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@Documented</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> @<span style="color: #7F0055; font-weight: bold;">interface</span> DataSetLocation <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #000000;">String</span> value<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>And what about the default behavior? Let's say the default location of a data set would be based on the class name of the test, with <code>-dataset.xml</code> added at the end. The file must be on the class path, in the same package as the test.</p> <p>We have now everything to write the <code>CleanInsertTestExecutionListener</code>:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">package</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">test</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import javax.sql.DataSource;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.dbunit.database.DatabaseDataSourceConnection;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.dbunit.database.IDatabaseConnection;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.dbunit.dataset.IDataSet;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.dbunit.dataset.xml.FlatXmlDataSetBuilder;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.dbunit.operation.DatabaseOperation;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.slf4j.Logger;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.slf4j.LoggerFactory;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.core.io.Resource;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.test.context.TestContext;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-st
yle: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.test.context.TestExecutionListener;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.springframework.util.StringUtils;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> CleanInsertTestExecutionListener <span style="color: #7F0055; font-weight: bold;">implements</span> TestExecutionListener <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">final</span> Logger LOG = LoggerFactory.<span style="color: #000000;">getLogger</span><span style="color: #000000;">&#40;</span>CleanInsertTestExecutionListener.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> beforeTestMethod<span style="color: #000000;">&#40;</span>TestContext testContext<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>		</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #808080; font-style: italic;">// location of the data set</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #000000;">String</span> dataSetResourcePath = <span style="color: #7F0055; font-weight: bold;">null</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #808080; font-style: italic;">// first, the annotation on the test class</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		DataSetLocation dsLocation = testContext.<span style="color: #000000;">getTestInstance</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getClass</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getAnnotation</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			DataSetLocation.<span style="color: #7F0055; font-weight: bold;">class</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span>dsLocation <span style="color: #000000;">!</span>= <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #808080; font-style: italic;">// found the annotation</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			dataSetResourcePath = dsLocation.<span style="color: #000000;">value</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			LOG.<span style="color: #000000;">info</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;annotated test, using data set: {}&quot;</span>,dataSetResourcePath<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #000000;">&#125;</span> <span style="color: #7F0055;font-weight: bold;">else</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #808080; font-style: italic;">// no annotation, let's try with the name of the test</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #000000;">String</span> tempDsRes = testContext.<span style="color: #000000;">getTestInstance</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getClass</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getName</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			tempDsRes = StringUtils.<span style="color: #000000;">replace</span><span style="color: #000000;">&#40;</span>tempDsRes, <span style="color: #888888;">&quot;.&quot;</span>, <span style="color: #888888;">&quot;/&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			tempDsRes = <span style="color: #888888;">&quot;/&quot;</span>+tempDsRes+<span style="color: #888888;">&quot;-dataset.xml&quot;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: no
rmal; margin:0; padding:0; background:inherit;">			<span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span>getClass<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getResourceAsStream</span><span style="color: #000000;">&#40;</span>tempDsRes<span style="color: #000000;">&#41;</span> <span style="color: #000000;">!</span>= <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">				LOG.<span style="color: #000000;">info</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;detected default dataset: {}&quot;</span>,tempDsRes<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">				dataSetResourcePath = tempDsRes;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #000000;">&#125;</span> <span style="color: #7F0055;font-weight: bold;">else</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">				LOG.<span style="color: #000000;">info</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;no default dataset&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span>dataSetResourcePath <span style="color: #000000;">!</span>= <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			Resource dataSetResource = testContext.<span style="color: #000000;">getApplicationContext</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getResource</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">				dataSetResourcePath</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			IDataSet dataSet = <span style="color: #7F0055; font-weight: bold;">new</span> FlatXmlDataSetBuilder<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">build</span><span style="color: #000000;">&#40;</span>dataSetResource.<span style="color: #000000;">getInputStream</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			IDatabaseConnection dbConn = <span style="color: #7F0055; font-weight: bold;">new</span> DatabaseDataSourceConnection<span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">					testContext.<span style="color: #000000;">getApplicationContext</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getBean</span><span style="color: #000000;">&#40;</span>DataSource.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			DatabaseOperation.<span style="color: #000000;">CLEAN_INSERT</span>.<span style="color: #000000;">execute</span><span style="color: #000000;">&#40;</span>dbConn, dataSet<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #000000;">&#125;</span> <span style="color: #7F0055;font-weight: bold;">else</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">			LOG.<span style="color: #000000;">info</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;{} does not have any data set, no data injection&quot;</span>,testContext.<span style="color: #000000;">getClass</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getName</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #000000;">&#125;</span>		</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span> the remaining methods of the <span style="color: #7F0055; font-weight: bold;">interface</span> are not used</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0
; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>The implementation of the test execution listener is rather simple. Let's see how to change the test now.</p> <h2>The new version of the database test</h2> <p>The test doesn't need the <code>setUp</code> any more, only the <code>TestExecutionListeners</code> annotation to customize the default list and the <code>DataSetLocation</code> annotation to locate the data set:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@RunWith<span style="color: #000000;">&#40;</span>SpringJUnit4ClassRunner.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@ContextConfiguration<span style="color: #000000;">&#40;</span>locations=<span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #888888;">&quot;classpath:/repository-test-context.xml&quot;</span>	</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@TestExecutionListeners<span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#123;</span>DependencyInjectionTestExecutionListener.<span style="color: #7F0055; font-weight: bold;">class</span>,CleanInsertTestExecutionListener.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">@DataSetLocation<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;classpath:/dataset.xml&quot;</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> JdbcContactRepositoryTest <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Autowired</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	ContactRepository contactRepository;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Autowired</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	SimpleJdbcTemplate jdbcTemplate;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Test <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> create<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">int</span> initialCount = jdbcTemplate.<span style="color: #000000;">queryForInt</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;select count(1) from contact&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		Contact contact = <span style="color: #7F0055; font-weight: bold;">new</span> Contact<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;Arnaud&quot;</span>, <span style="color: #888888;">&quot;Cogoluegnes&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		contactRepository.<span style="color: #000000;">create</span><span style="color: #000000;">&#40;</span>contact<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertEquals</span><span style="color: #000000;">&#40;</span>initialCount+<span style="color: #cc66cc;">1</span>,jdbcTemplate.<span style="color: #000000;">queryForInt</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;select count(1) from contact&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	@Test <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> selectByLastname<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertEquals</span><span style="color: #000000;">&#40;</span>0,contactRepository.<span style="color: #000000;">selectByLastname</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;cogo&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">size</span><span style="color: #000000;">&#40;</span><span sty
le="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertEquals</span><span style="color: #000000;">&#40;</span><span style="color: #cc66cc;">1</span>,contactRepository.<span style="color: #000000;">selectByLastname</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;our&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">size</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">		<span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">assertEquals</span><span style="color: #000000;">&#40;</span><span style="color: #cc66cc;">2</span>,contactRepository.<span style="color: #000000;">selectByLastname</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;o&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">size</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Note we could have moved the data set file beside the test class, called it <code>JdbcContactRepositoryTest-dataset.xml</code> and we could have removed the <code>DataSetLocation</code>!</p> <p>What have we done exactly? We made a cross-cutting concern of the data injection into the database. Any test can benefit from this feature just by adding some annotations, no need to extend any class or implement any interface. The data injection feature is now centralized into the <code>CleanInsertTestExecutionListener</code>: if we add any feature to it, any test will be able to benefit from it. This is far more powerful that the simple approach we chose first, which would have scattered the code into all test classes. Let's enhance our execution listener thanks to a DbUnit's feature.</p> <h2>Enhancing the CleanInsertTestExecutionListener with substitution</h2> <p>Imagine that some data in the data set can't be static but should be computed at runtime. A good example would be a date column that must take the date of the day for the test. We would like to be able to use a kind of variable in our data sets, like the following:</p> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dataset<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;contact</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;-1&quot;</span> <span style="color: #000066;">firstname</span>=<span style="color: #ff0000;">&quot;Carl&quot;</span> <span style="color: #000066;">lastname</span>=<span style="color: #ff0000;">&quot;Azoury&quot;</span> <span style="color: #000066;">creation_date</span>=<span style="color: #ff0000;">&quot;[NOW]&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;contact</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;-2&quot;</span> <span style="color: #000066;">firstname</span>=<span style="color: #ff0000;">&quot;Olivier&quot;</span> <span style="color: #000066;">lastname</span>=<span style="color: #ff0000;">&quot;Croisier&quot;</span> <span style="color: #000066;">creation_date</span>=<span style="color: #ff0000;">&quot;[NOW]&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dataset<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>We can do this thanks to DbUnit's <code>ReplacementDataSet</code>, which acts as a decorator on a data set and accepts substition patterns. The following snippet shows how to modify the data set injection to make a <code>[NOW]</code> variable available:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">Resource dataSetResource = testContext.<span style="color: #000000;">getApplicationContext</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getResource</span><span style="color: #000000;">&#40;</span>dataSetResourcePath<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">IDataSet dataSet = <span style="color: #7F0055; font-weight: bold;">new</span> FlatXmlDataSetBuilder<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">build</span><span style="color: #000000;">&#40;</span>dataSetResource.<span style="color: #000000;">getInputStream</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">ReplacementDataSet replaceDataSet = <span style="color: #7F0055; font-weight: bold;">new</span> ReplacementDataSet<span style="color: #000000;">&#40;</span>dataSet<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">replaceDataSet.<span style="color: #000000;">addReplacementObject</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;[NULL]&quot;</span>, <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; pa
dding:0; background:inherit;"><span style="color: #000000;">Calendar</span> cal = <span style="color: #000000;">Calendar</span>.<span style="color: #000000;">getInstance</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">Locale</span>.<span style="color: #000000;">getDefault</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">replaceDataSet.<span style="color: #000000;">addReplacementObject</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;[NOW]&quot;</span>, cal.<span style="color: #000000;">getTime</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">IDatabaseConnection dbConn = <span style="color: #7F0055; font-weight: bold;">new</span> DatabaseDataSourceConnection<span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	testContext.<span style="color: #000000;">getApplicationContext</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getBean</span><span style="color: #000000;">&#40;</span>DataSource.<span style="color: #7F0055; font-weight: bold;">class</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">DatabaseOperation.<span style="color: #000000;">CLEAN_INSERT</span>.<span style="color: #000000;">execute</span><span style="color: #000000;">&#40;</span>dbConn, replaceDataSet<span style="color: #000000;">&#41;</span>;</div></li></ol></pre> <p>That's it! A new feature added to our <code>CleanInsertTestExecutionListener</code>! This is only an example, we can imagine many more features: deleting the whole content of the database before injecting the data set, data sets injected on a per-method basis thanks to annotations on the method itself, etc.</p> <h2>Summary</h2> <p>We pushed our integration between the Spring TestContext Framework and DbUnit a step further in this second part. Injecting data in the database before executing test methods became a cross-cutting concern. This is a good example of how Inversion of Control and annotations allow to add behavoir around methods execution in a very simple way. It makes the data injection feature more flexible, easier to use and centralized.</p>