---
ID: 177
post_title: Intégrer RPM avec Maven et Jenkins 2/2
author: dboukelmoune
post_date: 2012-08-02 09:30:00
post_excerpt: |
  <p>Après avoir découvert avec vous le <a href="/index.php?post/2012/07/25/RPM-Maven-Jenkins-1" hreflang="fr" title="Première partie">rpm-maven-plugin</a>, je vous propose de continuer l'immersion dans le packaging natif avec le même cocktail Maven-RPM, toujours servi par Jenkins. Cette fois, je vais par contre présenter une approche plus en phase avec ce que j'ai pu expérimenter sur le terrain. C'est donc parti pour un petit retour d'expérience DevOps.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=177
published: true
---
<p>Après avoir découvert avec vous le <a href="/index.php?post/2012/07/25/RPM-Maven-Jenkins-1" hreflang="fr" title="Première partie">rpm-maven-plugin</a>, je vous propose de continuer l'immersion dans le packaging natif avec le même cocktail Maven-RPM, toujours servi par Jenkins. Cette fois, je vais par contre présenter une approche plus en phase avec ce que j'ai pu expérimenter sur le terrain. C'est donc parti pour un petit retour d'expérience DevOps.</p>
<!--more-->
<h3>Contexte du projet</h3> <p>Si vous êtes normalement constitué, la première partie devrait vous avoir laissé un goût de <em>c'est-super-j'ai-fait-une-assembly-mais-pas-vraiment-et-avec-un-peu-de-magie-noire-j'ai-eu-un-RPM</em> (enfin j'exagère peut-être une peu). On va donc se construire un RPM (toujours <a href="/index.php?post/2012/07/25/RPM-Maven-Jenkins-1#sirkuttaa" hreflang="fr" title="Sirkuttaa">Sirkuttaa</a> ) mais cette fois en prenant le problème sous un autre angle.</p> <p>Mon expérience personnelle porte sur le packaging d'une application <acronym title="World Wide Web, yeah baby">WEB</acronym> Java déployée sur un serveur Tomcat, avec un Varnish en frontal. Il a donc fallu packager Tomcat et Varnish, en plus de l'application. Les besoins en terme d'exploitation ont émergé progressivement, ce qui m'a permis d'absorber facilement les demandes sachant que je découvrais <em>rpmbuild</em>. Au final le RPM Tomcat n'est qu'une coquille vide contenant binaires et scripts, le RPM Varnish a été forké à partir du <a href="http://repo.varnish-cache.org/redhat/varnish-3.0/">RPM pour RHEL</a> et le RPM applicatif contient au final l'essentiel de l'intelligence (non exhaustif)&nbsp;:</p> <ul> <li>des scripts variés (<em>init.d</em>, contrôle de l'instance ...)</li> <li>divers fichiers (binaires, configuration, documentation ...)</li> <li>la glue avec l'installation de Tomcat (<code>CATALINA_BASE</code>)</li> <li>des <em>scriptlets</em> pour gérer <ul> <li>les montés de version</li> <li>l'enregistrement des services au démarrage du système</li> </ul></li> </ul> <p>Une des contraintes était de ne pas utiliser de plugin Maven et d'invoquer explicitement <em>rpmbuild</em>, en partant d'un template de spec RPM (chose amusante, les RPM partis en production n'ont plus rien de commun avec le template de départ). La première difficulté était l'intégration de deux outils de build.</p> <p>Plusieurs questions se posent&nbsp;:</p> <ul> <li>quel point d'entrée pour le build&nbsp;?</li> <li>comment gérer les montés de version&nbsp;?</li> <li>intégrer Maven à la spec RPM ou les invoquer séparément&nbsp;?</li> <li>...</li> </ul> <p>Le contexte de Sirkuttaa étant différent de mon expérience en projet (eg. <em>jar</em> vs <em>war</em>), j'ai décidé de m'attaquer au problème en partant de zéro. Mais avant d'y répondre, allons explorer la <em>spec RPM</em> et les différentes sections qu'on y trouve.</p> <h3>Ce que le rpm-maven-plugin nous cache</h3> <p>Je l'ai dit précédemment, une des choses que je n'apprécie pas avec l'utilisation d'un plugin Maven, c'est l'effet boîte noire qui nous masque ce qui se passe sous le capôt. On voit des logs <em>rpmbuild</em> défiler dans la console, encore faut-il être attentif. Tout est masqué donc, par un genre d'assembly... vraiment&nbsp;?</p> <p>Et si on jetait un coup d'oeil au fichier <code>${project.build.directory}/rpm/${project.artifactId}/SPECS/${project.artifactId}.spec</code>&nbsp;? Après tout, si je suis parti d'un template, pourquoi pas vous&nbsp;?</p> <pre> Name: sirkuttaa Version: 1 Release: 1 Summary: sirkuttaa License: GPLv2+ Group: Zenika/Blog Packager: Zenika Requires: java autoprov: yes autoreq: yes BuildRoot: /path/to/repo/target/rpm/sirkuttaa/buildroot %description %files %defattr(644,root,root,755)  /usr/lib/sirkuttaa %attr(755,root,root) /usr/bin/sirkuttaa %config(noreplace)  /etc/sirkuttaa/default.properties %config(noreplace)  /etc/sysconfig/sirkuttaa </pre> <p>Hum, c'est vide... Pourquoi&nbsp;? Parce que le plugin s'occupe de tout et prémache une <em>spec</em> minimaliste à <em>rpmbuild</em>. On trouve la fiche d'identité du paquet, une description vide (parce que je n'en ai pas défini dans le pom.xml) et la liste des fichiers et des droits.</p> <h4>La section %files</h4> <p>On trouve d'abord les attributs par défauts&nbsp;:</p> <ul> <li>droits d'accès des fichiers</li> <li>utilisateur propriétaire</li> <li>groupe propriétaire</li> <li>droits d'accès des dossiers</li> </ul> <p>Vient ensuite la liste des fichiers et dossier à embarquer, qui peuvent être modifiés au cas par cas&nbsp;: on ajoute par exemple des droits d'exécution sur le script de lancement de Sirkuttaa. Par défaut, tous les fichiers déclarés doivent être présents dans la <strong>buildroot</strong>, et réciproquement, tout fichier dans la <strong>buildroot</strong> doit être déclaré ici.</p> <p>Ici le plugin prend le parti d'embarquer le dossier contenant les JAR plutôt que de les déclarer un par un. Le risque est d'embarquer dans le RPM des fichiers qui n'étaient pas prévus. Dans le cas d'un <em>mvn clean package</em> ce n'est pas grave, mais maintenant que nous allons construire le RPM <em>à la main</em> on va s'assurer de déclarer chaque fichier pour éviter les mauvaises surprises (<code>mvn dependency:tree</code>...), et puis si on oublie de mettre à jour la liste <strong>Jenkins ne manquera pas de nous le rappeler, c'est aussi son rôle</strong>.</p> <pre> %files %defattr(644,root,root,755) /usr/lib/sirkuttaa /usr/lib/sirkuttaa/commons-io-2.3.jar /usr/lib/sirkuttaa/jackson-core-asl-1.9.7.jar /usr/lib/sirkuttaa/jackson-mapper-asl-1.9.7.jar /usr/lib/sirkuttaa/sirkuttaa-1-1.jar %attr(755,root,root) /usr/bin/sirkuttaa %config(noreplace) /etc/sirkuttaa/default.properties %config(noreplace) /etc/sysconfig/sirkuttaa </pre> <h4>La fiche d'identité</h4> <p>En dehors des fichiers, j'en profite pour compléter la liste des tags en début de <em>spec</em>, pour ajouter l'architecture cible, et une petite description. J'en profite aussi pour retirer certains tags qui, d'expérience, ne me serviront pas pour Sirkuttaa.</p> <pre> Name:      sirkuttaa Version:   1 Release:   1 BuildArch: noarch Summary:   The famous CLI Twitter client License:   GPLv2+ Group:     Zenika/Blog Packager:  Zenika Requires:  java %description The ultimate command line experience for Twitter written in Java. </pre> <p>Maintenant, nous allons pouvoir renseigner les différentes <em>sections</em> de notre <em>spec</em> et créer notre RPM, mais avant ça, un petit mot sur les macros.</p> <h4>Le cauchemar des macros</h4> <p>RPM propose un système de macros puissant, mais déroutant. Dans la <a href="/index.php?post/2012/07/25/RPM-Maven-Jenkins-1#construire-des-rpm" hreflang="fr" title="Construire des RPM">première partie</a> j'ai présenté quelques sections et leur syntaxe. On trouve par exemple <code>%prep</code>. Dans la section <code>%files</code>, on trouve aussi des <strong>directives</strong> dont la syntaxe est identique comme <code>%dir</code> ou paramétrée comme <code>%attr(750,root,root)</code>. En plus des sections on peut déclarer des scriptlets, encore avec la même syntaxe (eg. <code>%post</code>).</p> <p>A cela nous pouvons ajouter les macros, toujours avec des syntaxes similaires&nbsp;:</p> <ul> <li><code>%une_macro</code></li> <li><code>%{une_macro}</code></li> <li><code>%(du shell à exécuter)</code></li> </ul> <p>On a beau utiliser systématiquement un <code>%</code>, on s'y retrouve très rapidement entre sections, scriptlets et macros ;). Avec un bon éditeur de texte (<em>emacs</em>, <em>vim</em> voire <em>gedit</em>) la coloration syntaxique facilite encore plus la lecture d'une <em>spec</em>.</p> <p>Chaque installation de <em>rpmbuild</em> vient avec son lot de macros prédéfinies, pour faciliter certaines opérations et les rendre portables. On trouvera traditionnellement les macros <code>%setup</code> et <code>%configure</code> invoquées dans la section <code>%prep</code>, la macro <code>%__make</code> invoquée dans la section <code>%build</code>, parfois une exécution de <code>%__make check</code> dans la section <code>%check</code> et la macro <code>%makeinstall</code> dans la section <code>%install</code>. Sauf qu'ici on utilise <strong>Maven</strong>, donc, pourquoi ne pas créer nos propres macros pour garder ce niveau de simplicité&nbsp;?</p> <h4>Intégration du build Maven</h4> <p>Un des inconvénients du packaging natif, c'est qu'il s'intègre moins bien avec les plateformes de plus haut niveau. On trouve par exemple en java les packaging <
acronym title="Java ARchive">JAR</acronym> ou <acronym title="Web ARchive">WAR</acronym>, Maven va chercher lui-même ses dépendances, Ruby propose un système de <em>gems</em>... Je devrais donc en théorie ajouter une dépendence (<code>BuildRequires</code> NDLR) vers Maven, mais non. Trop de complications, je préfère partir de l'hypothèse qu'un développeur installera lui-même Maven, et que côté <acronym title="Continuous Integration">CI</acronym> c'est Jenkins qui mettra <code>mvn</code> dans le <code>PATH</code>. Tiens, Jenkins, encore une plateforme qui vient avec son propre packaging pour ses plugins<sup>[<a href="#pnote-363-1" id="rev-pnote-363-1">1</a>]</sup> ;).</p> <p>Cette petite digression terminée, on commence une intégration de Maven <strong>à la make</strong>. On va donc invoquer <code>mvn</code> dans les sections <code>%prep</code>, <code>%build</code> et <code>%install</code>. Il faudra aussi transmettre à Maven le numéro de version, et sans version, pas de build&nbsp;: premier réflexe, utiliser les mécanismes de properties. Pour émuler la macro <code>%makeinstall</code>, je n'ai rien trouvé de mieux qu'une <em>assembly</em> de type répertoire pour aller copier les fichiers directement dans la <em>build root</em>. Pour que le build Maven fonctionne en dehors de l'exécution de <em>rpmbuild</em>, j'ajoute des propriétés par défaut&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;properties<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;project</span>.rpm.version<span style="color: #000000; font-weight: bold;">&gt;</span></span>dev<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/project</span>.rpm.version<span style="color: #000000; font-weight: bold;">&gt;</span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;project</span>.rpm.installDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span>${project.build.directory}/${project.artifactId}<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/project</span>.rpm.installDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;project</span>.rpm.appendAssemblyId<span style="color: #000000; font-weight: bold;">&gt;</span></span>true<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/project</span>.rpm.appendAssemblyId<span style="color: #000000; font-weight: bold;">&gt;</span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/properties<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Côté <em>rpmbuild</em>, on transmet les propriétés en ligne de commande, et pour une intégration <em>à la make</em> je me crée quelques macros avec la macro <code>%define</code>&nbsp;:</p> <pre> %define mvn_opts -Dproject.rpm.version=%{version}-%{build_id} \                  -Dproject.rpm.installDirectory=%{buildroot} \                  -Dproject.rpm.appendAssemblyId=false %define mvn mvn %{mvn_opts} </pre> <p>Il ne reste plus qu'à invoquer la macro <code>%mvn</code>, et j'ai opté pour le mapping section-phase suivant&nbsp;:</p> <pre> %prep %{mvn} clean %build %{mvn} package %install %{mvn} verify </pre> <p>La configuration du <em>maven-assembly-plugin</em> avec les propriétés définies ci-dessus&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>maven-assembly-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>2.3<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;attach<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>false<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/attach<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;finalName<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/finalName<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;appendAssemblyId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>${project.rpm.appendAssemblyId}<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/appendAssemblyId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>${project.rpm.installDirectory}<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;descriptors<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;descriptor<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>src/main/assembly/rpm.xml<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/descriptor<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/descriptors<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;executions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;execution<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;phase<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>verify<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/phase<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;goals<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 				<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;goal<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>single<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/goal<span styl
e="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/goals<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/execution<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/executions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Et enfin l'assembly correspondante (allégée grâce à la section <code>%files</code> de la <em>spec</em>)&nbsp;:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;assembly</span></span> <span style="color: #009900;">	<span style="color: #000066;">xmlns</span>=<span style="color: #ff0000;">&quot;http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2&quot;</span></span> <span style="color: #009900;">	<span style="color: #000066;">xmlns:xsi</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span> <span style="color: #009900;">	<span style="color: #000066;">xsi:schemaLocation</span>=<span style="color: #ff0000;">&quot;</span> <span style="color: #009900;">		http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.2</span> <span style="color: #009900;">		http://maven.apache.org/xsd/assembly-1.1.2.xsd&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span> &nbsp; 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;id<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>rpm<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/id<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;formats<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;format<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>dir<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/format<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/formats<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;includeBaseDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>false<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/includeBaseDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;fileSets<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;fileSet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>src/main/scripts<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/usr/bin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/fileSet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;fileSet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>src/main/config<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/directory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/etc<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/fileSet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/fileSets<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dependencySets<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dependencySet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 			<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/usr/lib/${project.artifactId}<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dependencySet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dependencySets<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/assembly<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>J'ai prise le parti d'invoquer <code>%mvn verify</code> dans la section <code>%install</code> car aucune <a href="2012/07/25/RPM-Maven-Jenkins-1#construire-des-rpm" hreflang="fr" title="Construire des RPM">section</a> ne lui correspond réellement. En attendant la dernière phase pour générer l'assembly, c'est du temps gagné côté développement lorsqu'on veut juste construire son JAR/WAR ou exécuter les tests d'intégration. Les phases <code>install</code> et <code>deploy</code> perdent aussi de l'intérêt avec cette aproche. C'est plutôt le RPM que je chercherai à archiver. Côté intégration continue d'ailleurs, le principe de snapshot Maven a disparu, et n'existe plus que du côté développeur.</p> <h4>Gérer les versions</h4> <p>La gestion des versions n'est pas vraiment abordée dans cet article, et dans le cas de Sirkuttaa, c'est en dur dans la <em>spec</em>. Attention cependant, le numéro de version complet se compose du duo <code>%{version}-%{release}</code>. Pour la partie <em>release</em> on peut utiliser la variable d'environnement <code>BUILD_NUMBER</code> de Jenkins.</p> <p>Pour plus de fiabilité, je vais utiliser la variable <code>BUILD_ID</code>. On pourrait récupérer cette valeur facilement avec la macro <code>%(echo $BUILD_ID)</code>, mais je préfère créer un script de build indép
endant qui puisse être exécuté en dehors de Jenkins. Au passage, l'utilisation du plugin <a href="https://wiki.jenkins-ci.org/display/JENKINS/ZenTimestamp+Plugin" hreflang="en">ZenTimestamp</a> devient indispensable car par défaut le <code>BUILD_ID</code> contient des tirets.</p> <p><img src="/wp-content/uploads/2015/07/jenkins-build-id.png" alt="Configuration du plugin ZenTimestamp" style="display:block; margin:0 auto;" /></p> <p>Le seul réel point noir dans la gestion des versions, c'est que Maven ne fonctionne pas sans. De mon point de vue, le périmètre de Maven est beaucoup trop large et certains aspects (même lorsqu'ils sont issus de plugins) débordent du simple <strong>build</strong> (au hasard les releases ou la création de site). Du coup Maven nous averti qu'il n'apprécie pas du tout notre hack et qu'à terme il ne fonctionnerait plus&nbsp;:</p> <pre> [INFO] Scanning for projects... [WARNING] [WARNING] Some problems were encountered while building the effective model for com.zenika.blog.rpm:sirkuttaa:jar:1-SNAPSHOT [WARNING] 'version' contains an expression but should be a constant. @ com.zenika.blog.rpm:sirkuttaa:${project.rpm.version}, pom.xml, line 10, column 11 [WARNING] [WARNING] It is highly recommended to fix these problems because they threaten the stability of your build. [WARNING] [WARNING] For this reason, future Maven versions might no longer support building such malformed projects. [WARNING] </pre> <p>En attendant certains outils de <strong>build</strong> comme Gradle s'en sortent très bien avec un numéro de version transmis en ligne de commande, voire même sans version ;).</p> <h3>Script de build</h3> <p>A la racine d'un projet, j'apprécie la présence de quelques scripts utilitaires. Par exemple pour générer la configuration de l'IDE quand celui-ci ne sait pas importer directement un projet Maven. Dans le cas du build, le script a deux utilités&nbsp;: reproduire un build local et simplifier la configuration du job de construction sur le serveur d'intégration continue. Toujours dans une optique DevOps, le développeur doit pouvoir construire facilement son paquet natif s'il y apporte des modifications. Au lieu d'exécuter <code>mvn</code>, on exécutera <code>./build.sh</code> pour reconstruire un RPM "snapshot".</p> <h4>Intégration avec Maven</h4> <p>Une chose qu'il faut savoir avec <em>rpmbuild</em>, c'est que le répertoire de travail (par exemple <code>~/rpmbuild</code>) est partagé par défaut par les différentes <em>specs</em>, il correspond à la macro <code>%_topdir</code>. Dans l'arborescence, certains dossiers seront partagés par les différentes <em>specs</em> alors que d'autres seront spécifiques à une version spécifique d'une <em>spec</em>. Une des choses que j'apprécie avec Maven, c'est que tout se passe par défaut dans un dossier <code>target</code> et qu'on peut supprimer (<code>mvn clean</code>) ce dossier en toute sécurité. On va donc faire pareil pour notre construction de RPM (ce que fait le <em>rpm-maven-plugin</em> au passage) mais de façon moins radicale&nbsp;: on ne redéfinit que les dossiers utilisés (macros <code>%_rpmdir</code> et <code>%_builddir</code>).</p> <h4>Intégration avec Jenkins</h4> <p>L'intégration avec Jenkins consiste en fait à réutiliser l'environnement fourni par Jenkins. La variable <code>BUILD_ID</code> a déjà été évoquée, j'utilise également la variable <code>WORKSPACE</code> pour atteindre le dossier <code>$WORKSPACE/target</code> de Maven. Par défaut <em>rpmbuild</em> va créer le RPM dans un sous-dossier <code>noarch</code>, qui correspond à l'architecture cible. Une dernière chose, je configure manuellement l'archivage des RPM générés avec le pattern <code>target/noarch/*.rpm</code>.</p> <p><img src="/wp-content/uploads/2015/07/jenkins-build.png" alt="Intégration dans Jenkins" style="display:block; margin:0 auto;" /></p> <h4>build.sh</h4> <pre> #!/bin/sh set -e if [ -z &quot;$WORKSPACE&quot; ] ; then 	case &quot;$0&quot; in 		/*) 			WORKSPACE=&quot;`dirname $0`&quot; 			;; 		*) 			WORKSPACE=&quot;`pwd`/`dirname $0`&quot; 			;; 	esac fi rpmbuild -bb $WORKSPACE/sirkuttaa.spec  	--define &quot;_builddir $WORKSPACE&quot;  	--define &quot;_rpmdir   $WORKSPACE/target&quot;  	--define &quot;build_id  ${BUILD_ID:-SNAPSHOT}&quot; </pre> <h3>Conclusion</h3> <p>Et voilà, nous avons gratté la surface du packaging natif avec RPM. J'apprécie beaucoup la simplicité d'une <em>spec</em> RPM (une fois la syntaxe des sections/scriptlets/macros assimilée) en particulier après avoir eu affaire à des <code>pom.xml</code> sur des projets de moyenne ou grande envergures. Le packaging natif est puissant, mais n'est pas une fin en soit. Certaines limitations peuvent être un frein à la distribution au grand public, mais dans un environnement maîtrisé, ce n'est pas un problème. C'est aussi un socle solide, mais trop bas niveau et limité à la machine cible. Pour une vraie infrastructure de déploiement automatisable, une surcouche ajoutant des possibilités "réseau" sera nécessaire. J'ai cité <em>YUM</em> qui ajoute la notion de <em>repository</em>, mais d'autres outils radicalement différents comme <a href="http://wiki.opscode.com/display/chef/Resources#Resources-Package" hreflang="en">Chef</a> permettent de gérer des RPM.</p> <p>Pour ce qui est de l'intégration avec Maven, je pense que le <em>rpm-maven-plugin</em> est la solution la plus adaptée. Le build n'est cependant plus portable, et je trouve ça dommage lorsqu'on fait du java. Avoir un build qui ne soit pas portable n'est pas gênant en soit dans un projet d'entreprise, mais toujours dans une optique DevOps, ça le devient lorsque les développeurs travaillent sous Windows. Il y a de toute façon des choses à redire dans les deux approches que j'ai présentées.</p> <p>Jenkins de son côté ne sert pas à grand chose. De toute façon, Jenkins se résume (j'exagère un peu) à un orchestrateur de jobs, des notifications et un système de plugins... On pourrait par contre pousser l'intégration beaucoup plus loin en testant l'installation, la mise à jour à partir de la version en production et exécuter une <em>scriptlet</em> <code>%verifyscript</code>. Le tout dans une <acronym title="Machine Virtuelle">VM</acronym> créée <a href="http://vagrantup.com/" hreflang="en" title="Vagrant">à la volée</a>.</p> <p>Enfin, comment parler d'une intégration Maven/RPM sans évoquer <a href="http://www.debian.org/doc/manuals/debian-faq/ch-pkgtools.en.html" hreflang="en">dpkg</a>&nbsp;? Pour construire des paquets <em>Deb</em>, on trouve plusieurs plugins. Le <a href="http://mojo.codehaus.org/deb-maven-plugin/" hreflang="en" title="Maven Deb Plugin">maven-deb-plugin</a> qui fonctionne comme le <a href="http://mojo.codehaus.org/rpm-maven-plugin/" hreflang="en" title="RPM plugin for Maven">rpm-maven-plugin</a>, c'est un wrapper de l'outil <a href="http://www.debian.org/doc/manuals/debian-faq/ch-pkgtools.en.html" hreflang="en">dpkg</a>. Une alternative intéressante existe, le plugin <a href="https://github.com/tcurdt/jdeb/" hreflang="en">jdeb</a> qui propose une implémentation 100% en Java qui règle les problèmes de portabilité.</p> <p>Pour le mot de la fin, l'intégration avec Maven est plutôt bancale, mais représente peu d'effort pour résultat très satisfaisant. RPM quant à lui est vraiment un outil puissant qui permet de faire bien plus que le peu que j'ai présenté.</p> <p>Pour démarrer avec RPM, le site <a href="http://www.rpm.org/" hreflang="en">rpm.org</a> est un bon début.</p> <p>Les sources de l'article sont récupérables sur <a href="https://github.com/Zenika/Blogs/tree/master/20120802_RPM-Maven-Jenkins-2">github</a>.</p> <div class="footnotes"><h4>Notes</h4> <p>[<a href="#rev-pnote-363-1" id="pnote-363-1">1</a>] Jenkins propose beaucoup de paquets natifs, y compris des <a href="http://jenkins-ci.org/" hreflang="en">RPM</a></p></div> 