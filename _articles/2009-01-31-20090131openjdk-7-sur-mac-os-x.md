---
ID: 68
post_title: OpenJDK 7 sur Mac OS X
author: pqueinnec
post_date: 2009-01-31 17:10:00
post_excerpt: |
  <p>Dans certains contextes client, il est nécessaire d'avoir un contrôle complet des sources s'exécutant sur un serveur ou une appliance donnée, par exemple pour un service critique et/ou ayant des contraintes de pérennité fortes. Avec la mise à disposition d'<a href="http://openjdk.java.net">OpenJDK</a>, il est tout à fait possible de compiler et de packager sa propre JVM, et ainsi de positionner Java dans des secteurs traditionnellement frileux à exécuter du code binaire non audité. Il est aussi possible de créer son propre packaging du JDK afin par exemple de réduire sa surface d'attaque en ne conservant que les fonctionnalités minimales souhaitées, ou même de modifier le code source afin de rajouter des probes <a href="http://opensolaris.org/os/community/dtrace/">DTrace</a>, etc.</p> <p>Ce billet a pour but de signaler la possibilité récente de compiler facilement (entendre: sans avoir à patcher soi-même le code source) OpenJDK 7 sous Mac OS X. Le code étant en perpétuel changement, il est possible que votre expérience de compilation soit différente de la mienne (voir la fin de ce billet qui contient toutes les informations techniques sur la révision stable utilisée).</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=68
published: true
---
<p>Dans certains contextes client, il est nécessaire d'avoir un contrôle complet des sources s'exécutant sur un serveur ou une appliance donnée, par exemple pour un service critique et/ou ayant des contraintes de pérennité fortes. Avec la mise à disposition d'<a href="http://openjdk.java.net">OpenJDK</a>, il est tout à fait possible de compiler et de packager sa propre JVM, et ainsi de positionner Java dans des secteurs traditionnellement frileux à exécuter du code binaire non audité. Il est aussi possible de créer son propre packaging du JDK afin par exemple de réduire sa surface d'attaque en ne conservant que les fonctionnalités minimales souhaitées, ou même de modifier le code source afin de rajouter des probes <a href="http://opensolaris.org/os/community/dtrace/">DTrace</a>, etc.</p> <p>Ce billet a pour but de signaler la possibilité récente de compiler facilement (entendre: sans avoir à patcher soi-même le code source) OpenJDK 7 sous Mac OS X. Le code étant en perpétuel changement, il est possible que votre expérience de compilation soit différente de la mienne (voir la fin de ce billet qui contient toutes les informations techniques sur la révision stable utilisée).</p>
<!--more-->
<p>Le code source du JDK est publié dans des repositories <a href="http://openjdk.java.net/guide/repositories.html">Mercurial</a> hébergés sur java.net. Le minimum vital de commandes Mercurial est précisé ci-dessous, pour plus de détail se reporter à cette <a href="http://hgbook.red-bean.com">documentation</a>. La première chose à faire est de se procurer Mercurial; vous pouvez par exemple passer par <a href="http://www.macports.org">MacPorts</a> pour l'installer:</p> <pre> port install mercurial </pre> <p>Il faut de plus se procurer une extension Mercurial appelée 'forest' qui est utilisée par les équipes d'OpenJDK. Par ailleurs cela peut vous servir à étrenner votre nouvelle installation de Mercurial. A noter que sous Mac j'ai dû forcer ma locale pour éviter à Mercurial de planter:</p> <pre> LC_ALL='C' hg clone http://hg.akoha.org/hgforest </pre> <p>Il faut ensuite déclarer cette extension dans le fichier ~/.hgrc en rajoutant les lignes suivantes:</p> <pre> [ui] username = votreLoginDeCommitter [extensions] forest=/usr/local/src/openjdk/hgforest/forest.py </pre> <p>Vous êtes maintenant prêts à récupérer le code. Il vous faut un 'port' spécial du JDK, c'est-à-dire un code maintenu pour votre plateforme (FreeBSD, Linux, Windows, etc). Sans entrer dans les détails, Mac OS X est rangé dans la catégorie des <a href="http://en.wikipedia.org/wiki/BSD">BSD</a>, et le travail de maintenance de la branche contenant ce port est partagé entre des committers et des contributeurs venant des mondes FreeBSD, OpenBSD, NetBSD, et Mac. La récupération du code donc se fait de la façon suivante:</p> <pre> LC_ALL='C' hg fclone http://hg.openjdk.java.net/bsd-port/bsd-port </pre> <p>Cette commande va créer un répertoire bsd-port, contenant une arborescence de projets divers et variés formant un JDK. Pour compiler un JDK, vous allez devoir en posséder déjà un sur votre disque, et pas n'importe lequel, puisque ceux d'Apple ne conviendront pas (vous obtiendriez une erreur de type ('ld: library not found for -ljvm'). Il vous faudra en récupérer un déjà compilé tel que celui mis à disposition par Landon Fuller, <a href="http://landonf.bikemonkey.org/static/soylatte/">SoyLatte-1.6-1.0.3</a>. Il vous faudra de même récupérer sur cette même page une archive tar appelée 'jdk-7-icedtea-plugs', contenant des classes SNMP, audio et AWT fournies par le projet <a href="http://icedtea.classpath.org">IcedTea</a> et provenant de <a href="http://www.gnu.org/software/classpath/">GNU Classpath</a> et destinées à remplacer celles de SUN en cours d'ouverture.</p> <p>Après avoir décompressé les deux archives dans un répertoire (nommé '/usr/local/src/openjdk' par la suite), il est nécessaire de supprimer la variable d'environnement JAVA_HOME et de vérifier la présence de ANT dans le PATH.</p> <pre> unset JAVA_HOME which ant </pre> <p>Enfin, OpenJDK fournit une commande de vérification d'environnement afin de tester la présence de toutes les dépendances et outils nécessaires à la bonne conduite du build:</p> <pre> ALT_BOOTDIR=/usr/local/src/openjdk/soylatte16-i386-1.0.3  ALT_BINARY_PLUGS_PATH=/usr/local/src/openjdk/jdk-7-icedtea-plugs  ALT_CUPS_HEADERS_PATH=/usr/include  ALT_FREETYPE_LIB_PATH=/usr/X11R6/lib  ALT_FREETYPE_HEADERS_PATH=/usr/X11R6/include  gmake sanity </pre> <p>Si tout est OK, vous pouvez lancer le build:</p> <pre> ALT_BOOTDIR=/usr/local/src/openjdk/soylatte16-i386-1.0.3  ALT_BINARY_PLUGS_PATH=/usr/local/src/openjdk/jdk-7-icedtea-plugs  ALT_CUPS_HEADERS_PATH=/usr/include  ALT_FREETYPE_LIB_PATH=/usr/X11R6/lib  ALT_FREETYPE_HEADERS_PATH=/usr/X11R6/include  gmake all </pre> <p>Si tout se termine de façon satisfaisante, vous êtes maintenant l'heureux possesseur d'un build d'OpenJDK 7. Il vous suffit de lancer les commandes suivantes pour vous en rendre compte par vous-même:</p> <pre> export JAVA_HOME=/usr/local/src/openjdk/bsd-port/build/bsd-i586/j2sdk-image export PATH=${JAVA_HOME}/bin:$PATH </pre> <pre> $ java -version openjdk version &quot;1.7.0-internal&quot; OpenJDK Runtime Environment (build 1.7.0-internal-queinnec_2009_01_17_13_49-b00) OpenJDK Server VM (build 14.0-b10, mixed mode) </pre> <p>Si le build a échoué ou pour toute autre raison, vous pouvez nettoyer votre répertoire de compilation en lançant la tâche dédiée:</p> <pre> ALT_BOOTDIR=/usr/local/src/openjdk/soylatte16-i386-1.0.3  ALT_BINARY_PLUGS_PATH=/usr/local/src/openjdk/jdk-7-icedtea-plugs  ALT_CUPS_HEADERS_PATH=/usr/include  ALT_FREETYPE_LIB_PATH=/usr/X11R6/lib  ALT_FREETYPE_HEADERS_PATH=/usr/X11R6/include  gmake clean </pre> <p>Enfin, il est bien sûr simple de maintenir vos sources à jour en utilisant Mercurial. Voici les commandes à lancer depuis le répertoire 'bsd-port':</p> <pre> LC_ALL='C' hg fincoming LC_ALL='C' hg fpull LC_ALL='C' hg fupdate </pre> <p>Nota Bene 1: cette compilation est basée sur le changeset 55:310ab698eb58, avec le patch corrigeant des erreurs de cast de pointeurs dans HotSpot que j'ai envoyé à la liste bsd-port-dev@openjdk.java.net, cf <a href="http://mail.openjdk.java.net/pipermail/bsd-port-dev/2009-January/000396.html">mail</a>. Mon patch est basé sur celui de Michael Franz, un grand merci à lui. Normalement tout ceci (ou des variantes) vient d'être committé dans le bsd-port, il est donc probable que tout compile immédiatement, sans patch supplémentaire.</p> <p>Nota Bene 2: cette compilation produit une JVM 32 bits. Produire une JVM 64 bits nécessite de passer la variable d'environnement LP64=1.</p> <p>Nota Bene 3: cet article a été écrit avec les outils suivants:</p> <pre> $ ant -version Apache Ant version 1.7.1 compiled on June 27 2008 $ uname -a Darwin pasiphae 9.6.0 Darwin Kernel Version 9.6.0: Mon Nov 24 17:37:00 PST 2008; root:xnu-1228.9.59~1/RELEASE_I386 i386 $ xcodebuild -version Xcode 3.1.1 Component versions: DevToolsCore-1114.0; DevToolsSupport-1102.0 BuildVersion: 9M2517 $ gcc -v Using built-in specs. Target: i686-apple-darwin9 Configured with: /var/tmp/gcc/gcc-5488~2/src/configure --disable-checking -enable-werror --prefix=/usr --mandir=/share/man --enable-languages=c,objc,c++,obj-c++ --program-transform-name=/^[cg][^.-]*$/s/$/-4.0/ --with-gxx-include-dir=/include/c++/4.0.0 --with-slibdir=/usr/lib --build=i686-apple-darwin9 --with-arch=apple --with-tune=generic --host=i686-apple-darwin9 --target=i686-apple-darwin9 Thread model: posix gcc version 4.0.1 (Apple Inc. build 5488) </pre>