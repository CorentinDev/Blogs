---
ID: 452
post_title: Composant JavaScript et composant ZK
author: Gérald Quintana
post_date: 2013-03-04 09:02:00
post_excerpt: |
  <p><a href="http://www.zkoss.org/" hreflang="en">ZK</a> est un framework Web qui permet de produire des applications web simplement et entièrement en Java (malgré toute ressemblance, Zenika n'est pas à l'origine de ZK). Comme JSF ou Wicket, il s'agit d'un framework orienté composants, dans lequel des composants côté serveur, écrits en Java, pilotent des composants côté navigateur, écrits en JavaScript.</p> <p>Nous souhaitons utiliser une librairie JavaScript existante (<a href="https://developers.google.com/chart/" hreflang="en">Google Chart</a> en l'occurrence) dans notre application ZK. Cet article explique comment développer son propre composant ZK à partir d'un composant JavaScript sur étagère.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=452
published: true
slide_template:
  - ""
---
<p><a href="http://www.zkoss.org/" hreflang="en">ZK</a> est un framework Web qui permet de produire des applications web simplement et entièrement en Java (malgré toute ressemblance, Zenika n'est pas à l'origine de ZK). Comme JSF ou Wicket, il s'agit d'un framework orienté composants, dans lequel des composants côté serveur, écrits en Java, pilotent des composants côté navigateur, écrits en JavaScript.</p> <p>Nous souhaitons utiliser une librairie JavaScript existante (<a href="https://developers.google.com/chart/" hreflang="en">Google Chart</a> en l'occurrence) dans notre application ZK. Cet article explique comment développer son propre composant ZK à partir d'un composant JavaScript sur étagère.</p>
<!--more-->
<h4>Démarrage du projet</h4> <p>ZK propose des archetypes Maven pour démarrer rapidement un projet, il suffit d'une ligne de commande pour commencer:</p> <pre> mvn archetype:generate -DarchetypeCatalog=http://mavensync.zkoss.org/maven2/     -DarchetypeGroupId=org.zkoss -DarchetypeArtifactId=zk-archetype-component     -DgroupId=com.zenika.zk -DartifactId=gchartz -Dversion=1.0-SNAPSHOT     -Dpackage=com.zenika.zk.gchartz -Dcomponent-class=GChart -Dcomponent-name=gchart     -Dzk-version-since=6.5 </pre> <p>On obtient alors un embryon de composant Java (GChart.java), un embryon de composant JavaScript (GChart.js), et des fichiers de configuration pour faire le lien entre les deux (zk.wpd et lang-addon.xml). Le pom.xml contient un plugin yuicompressor-maven-plugin-zk chargé d'assembler les fichiers JavaScript en un module et de le "minifier" façon JSMin. Enfin, le module test contient une application Web pour tester notre composant, on pourra facilement la lancer en utilisant le plugin Jetty préconfiguré dans le pom.xml. Bref, pour voir apparaître notre premier composant, il suffit de faire: <a href="/wp-content/uploads/2015/07/zk-gchart-1.png"><img src="/wp-content/uploads/2015/07/.zk-gchart-1_t.jpg" alt="Composant ZK Etape 1" style="float:right; margin: 0 0 1em 1em;" title="Composant ZK Etape 1" /></a></p> <pre> mvn jetty:run </pre> <h4>Chargement de la librairie JavaScript</h4> <p>Si la librairie JavaScript à envelopper se présente sous la forme d'un fichier .js, c'est très simple, une directive script dans la vue et le tour est joué.</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?script</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;text/javascript&quot;</span> <span style="color: #000066;">src</span>=<span style="color: #ff0000;">&quot;/js/gchart.js&quot;</span><span style="color: #000000; font-weight: bold;">?&gt;</span></span></pre> <p>Mais en procédant ainsi, toutes les applications mettant en oeuvre le composant seraient contraintes d'embarquer par elles-mêmes le fichier gchart.js. Pour rendre notre composant réutilisable, on peut joindre la librairie avec le composant. Pour demander à ZK de la charger, on ajoute une ligne dans le fichier zk.wpd (Web Package Descriptor):</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;script</span> <span style="color: #000066;">src</span>=<span style="color: #ff0000;">&quot;gchart.js&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></pre> <p>Certains préféreront charger la librairie depuis un CDN (Content Distribution Network); Pour la librairie Google Chart on n'a guère le choix en fait, il faut la récupérer dynamiquement sur les serveurs de Google. On peut se servir de jQuery (jq est l'alias du jQuery fourni par ZK) pour obtenir un script, comme le chargement se fait alors de manière asynchrone, il ne faut pas oublier retarder l'utilisation de la librairie après son chargement au moyen d'une callback:</p> <pre class="javascript code javascript" style="font-family:inherit">jq.<span style="color: #660066;">getScript</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;http://host/gchart.js&quot;</span><span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     <span style="color: #006600; font-style: italic;">// Load Callback</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>;</pre> <p>Certaines librairies, comme Dojo ou Google Chart (encore!), utilisent AMD (Asynchronous Module Definition) pour découper le code JavaScript en modules et paralléliser les téléchargements. Il faut, ici aussi, penser à retarder l'utilisation de la librairie après le chargement du module:</p> <pre class="javascript code javascript" style="font-family:inherit"><span style="color: #006600; font-style: italic;">// Chargement Google Loader</span> jq.<span style="color: #660066;">getScript</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;https://www.google.com/jsapi&quot;</span><span style="color: #339933;">,</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     <span style="color: #003366; font-weight: bold;">var</span> googleLoader<span style="color: #339933;">=</span>window.<span style="color: #660066;">google</span>; &nbsp;     <span style="color: #006600; font-style: italic;">// Chargement Google Chart</span>     googleLoader.<span style="color: #660066;">load</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;visualization&quot;</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">&quot;1&quot;</span><span style="color: #339933;">,</span> <span style="color: #009900;">&#123;</span>         packages<span style="color: #339933;">:</span><span style="color: #009900;">&#91;</span><span style="color: #3366CC;">&quot;corechart&quot;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span>         callback<span style="color: #339933;">:</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             <span style="color: #003366; font-weight: bold;">var</span> googleChart<span style="color: #339933;">=</span>window.<span style="color: #660066;">google</span>.<span style="color: #660066;">visualization</span>; &nbsp;             <span style="color: #006600; font-style: italic;">// Utilisation Google Chart</span>             <span style="color: #003366; font-weight: bold;">var</span> chart <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">new</span> googleChart.<span style="color: #660066;">LineChart</span><span style="color: #009900;">&#40;</span>document.<span style="color: #660066;">getElementById</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'chart_div'</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>;             chart.<span style="color: #660066;">draw</span><span style="color: #009900;">&#40;</span>data<span style="color: #339933;">,</span> options<span style="color: #009900;">&#41;</span>;         <span style="color: #009900;">&#125;</span>     <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>; <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>;</pre> <p>Etant donnée que ZK possède son propre système de chargement modulaire, on ne peut pas servir de l'<a href="http://api.jquery.com/load-event/">événement jQuery load</a> ou de la fonction Google setOnLoadCallback.</p> <h4>Naissance d'un composant ZK</h4> <p><img src="/wp-content/uploads/2015/07/zk-gchart-lifecycle.png" alt="Cycle de vie composant ZK" style="display:block; margin:0 auto;" title="Cycle de vie composant ZK" /> A la réception de la première requête HTTP, ZK va charger la vue, généralement sous forme de fichier ZUL, qui contient notre composant sous la forme d'une balise &lt;gchart&gt; (DemoWindowComposer n'est que le contrôleur de cette vue):</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;zk<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;window</span> <span style="color: #000066;">title</span>=<span style="color: #ff0000;">&quot;Google Chart&quot;</span> <span style="color: #000066;">border</span>=<span style="color: #ff0000;">&quot;
normal&quot;</span> <span style="color: #000066;">width</span>=<span style="color: #ff0000;">&quot;640px&quot;</span> <span style="color: #000066;">height</span>=<span style="color: #ff0000;">&quot;480px&quot;</span></span> <span style="color: #009900;">        <span style="color: #000066;">apply</span>=<span style="color: #ff0000;">&quot;com.zenika.zk.gchart.DemoWindowComposer&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>         <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;gchart</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;gChart&quot;</span> <span style="color: #000066;">title</span>=<span style="color: #ff0000;">&quot;Le titre&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/window<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/zk<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>A partir de ce fichier XML, ZK va instancier notre composant Java, le configurer, puis le placer dans l'arbre de composants, et enfin ordonner au navigateur de faire de même avec le composant JavaScript correspondant. L'association balise XML/ classe Java/classe JavaScript est décrite dans un fichier lang-addon.xml</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;component<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #808080; font-style: italic;">&lt;!-- Balise XML --&gt;</span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;component-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>gchart<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/component-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #808080; font-style: italic;">&lt;!-- Classe Java --&gt;</span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;component-class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>com.zenika.zk.gchart.GChart<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/component-class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>     <span style="color: #808080; font-style: italic;">&lt;!-- Classe JavaScript --&gt;</span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;widget-class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>gchartz.GChart<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/widget-class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/component<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Côté Java la classe GChart étend XulElement, et contient juste quelques propriétés. La seule méthode notable est renderProperties() destinée à sérialiser ces propriétés pour les envoyer au navigateur sous forme de JSON:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">String</span> _title; <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #000000;">String</span> getTitle<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span> <span style="color: #7F0055; font-weight: bold;">return</span> _title; <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> setTitle<span style="color: #000000;">&#40;</span><span style="color: #000000;">String</span> title<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span> _title=title <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> renderProperties<span style="color: #000000;">&#40;</span>ContentRenderer renderer<span style="color: #000000;">&#41;</span>         <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">IOException</span> <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055; font-weight: bold;">super</span>.<span style="color: #000000;">renderProperties</span><span style="color: #000000;">&#40;</span>renderer<span style="color: #000000;">&#41;</span>;     render<span style="color: #000000;">&#40;</span>renderer, <span style="color: #888888;">&quot;title&quot;</span>, _title<span style="color: #000000;">&#41;</span>; <span style="color: #000000;">&#125;</span></pre> <p>Les valeurs, comme _title ci-dessus, doivent être convertible en JSON. Pour cela, ZK s'inspire beaucoup de la librairie <a href="http://code.google.com/p/json-simple/" hreflang="en">JSON Simple</a>, sont donc autorisés:</p> <ul> <li>Les types Java standard: Integer, Long, Float, Boolean, String, etc.</li> <li>Toute classe qui implémente JSONAware et définit une méthode toJSONString()</li> <li>Deux types composites qui imitent JavaScript: JSONObject (= Map) et JSONArray (= List)</li> </ul> <p>Côté JavaScript, on retrouve les mêmes propriétés que côté serveur, le $define automatise la génération des getter/setters. Une fonction redraw (ou bien un moule/mold) génère le HTML: un &lt;div&gt; avec un id spécifique est ajouté au DOM. Puis une fonction bind_ permet d'activer l'écoute d'événements sur le DOM; Nous nous en servirons pour initialiser le composant Google en récupérant, grâce à la fonction $n(), le &lt;div&gt; précédemment créé:</p> <pre class="javascript code javascript" style="font-family:inherit">_title<span style="color: #339933;">:</span><span style="color: #3366CC;">''</span><span style="color: #339933;">,</span> $define<span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>     title<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">null</span> <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span> redraw<span style="color: #339933;">:</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>out<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     out.<span style="color: #660066;">push</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'&amp;lt;div '</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">domAttrs_</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">'&amp;gt;'</span><span style="color: #009900;">&#41;</span>;     out.<span style="color: #660066;">push</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'Google Chart &quot;'</span><span style="color: #339933;">,</span><span style="color: #000066; font-weight: bold;">this</span>._title<span style="color: #339933;">,</span><span style="color: #3366CC;">'&quot; loading...'</span><span style="color: #009900;">&#41;</span>;     out.<span style="color: #660066;">push</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">'&lt;/div&gt;'</span><span style="color: #009900;">&#41;</span>; <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span> bind_<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">function</spa
n> <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     <span style="color: #003366; font-weight: bold;">var</span> self<span style="color: #339933;">=</span><span style="color: #000066; font-weight: bold;">this</span>;     <span style="color: #000066; font-weight: bold;">this</span>.$supers<span style="color: #009900;">&#40;</span>gchartz.<span style="color: #660066;">GChart</span><span style="color: #339933;">,</span><span style="color: #3366CC;">'bind_'</span><span style="color: #339933;">,</span> arguments<span style="color: #009900;">&#41;</span>;     requireGoogleChart<span style="color: #009900;">&#40;</span><span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span>googleChart<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #003366; font-weight: bold;">var</span> data <span style="color: #339933;">=</span> ...<span style="color: #339933;">,</span> options <span style="color: #339933;">=</span> <span style="color: #009900;">&#123;</span> title<span style="color: #339933;">:</span> self._title <span style="color: #009900;">&#125;</span>;         self._gChart<span style="color: #339933;">=</span><span style="color: #003366; font-weight: bold;">new</span> googleChart.<span style="color: #660066;">LineChart</span><span style="color: #009900;">&#40;</span>self.$n<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>;         self._gChart.<span style="color: #660066;">draw</span><span style="color: #009900;">&#40;</span>data<span style="color: #339933;">,</span> options<span style="color: #009900;">&#41;</span>;     <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span>; <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span></pre> <p><a href="/wp-content/uploads/2015/07/zk-gchart-2.png"><img src="/wp-content/uploads/2015/07/.zk-gchart-2_t.jpg" alt="Composant ZK Etape 2" style="float:right; margin: 0 0 1em 1em;" title="Composant ZK Etape 2" /></a> Une fois le Google Chart instancié, on garde sa référence ( _gChart) pour pouvoir le mettre à jour par la suite. En initialisant les variables data et options de la même manière que title, on arrive rapidement au résultat attendu:</p> <h4>Mettre à jour le composant</h4> <p>Une fois le graphique affiché, on va vouloir le modifier, changer le titre ou les valeurs affichées parce que l'utilisateur aura cliqué sur un bouton. Par exemple, pour changer le titre du graphique, le contrôleur de la page appellera la méthode setTitle du composant. Celle-ci déclenchera alors un smartUpdate, qui provoquera la mise à jour de l'attribut côté JavaScript. La méthode smartUpdate fonctionne de manière similaire à la méthode render utilisée pendant l'initialisation.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> setTitle<span style="color: #000000;">&#40;</span><span style="color: #000000;">String</span> title<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055;font-weight: bold;">if</span> <span style="color: #000000;">&#40;</span><span style="color: #000000;">!</span>Objects.<span style="color: #000000;">equals</span><span style="color: #000000;">&#40;</span>_title, title<span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         _title = title;         smartUpdate<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;title&quot;</span>, _title<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Lorsque la fonction setTitle du composant JavaScript sera invoquée, on pourra en profiter mettre à jour le graphique:</p> <pre class="javascript code javascript" style="font-family:inherit">$define<span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span>     title<span style="color: #339933;">:</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #000066; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">this</span>._gChart<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             <span style="color: #006600; font-style: italic;">// Mettre à jour le Google Chart</span>         <span style="color: #009900;">&#125;</span>     <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Sur le même principe, si on souhaite appeler la fonction updateChart sur le composant JavaScript, on écrira dans le composant Java:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> updateChart<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     Clients.<span style="color: #000000;">response</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> AuInvoke<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">this</span>, <span style="color: #888888;">&quot;updateChart&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>; <span style="color: #000000;">&#125;</span></pre> <p>Pour résumer, smartUpdate et Clients.response permettent au composant Java de donner des ordres au composant JavaScript et de le télécommander à distance.</p> <h4>Remontée des événements</h4> <p>Jusqu'ici nous avons vu la descente des ordres de modification des composants Java vers JavaScript, à présent nous allons voir la remontée des événements. On s'abonne aux événements émis par le Google Chart immédiatement après l'avoir créé dans la fonction bind_. Lorsqu'un événement survient la fonction _onSelect sera appelée:</p> <pre class="javascript code javascript" style="font-family:inherit">self._gChart<span style="color: #339933;">=</span><span style="color: #003366; font-weight: bold;">new</span> googleChart.<span style="color: #660066;">LineChart</span><span style="color: #009900;">&#40;</span>self.$n<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>;         googleChart.<span style="color: #660066;">events</span>.<span style="color: #660066;">addListener</span><span style="color: #009900;">&#40;</span>self._gChart<span style="color: #339933;">,</span> <span style="color: #3366CC;">'select'</span><span style="color: #339933;">,</span>             <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                 self._onSelect<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>             <span style="color: #009900;">&#125;</span>         <span style="color: #009900;">&#41;</span>;</pre> <p>Dans la fonction _onSelect, on prépare un nouvelle événement à destination du serveur. Cet événement est émis avec la fonction fire qui déclenchera un requête Ajax.</p> <pre>ZK est néanmoins assez malin, car si aucun listener n'a été enregistré coté serveur, la fonction fire sera sans effet, le composant restera muet puisque personne ne l'écoute.</pre> <pre class="javascript code javascript" style="font-family:inherit">_onSelect<span style="color: #339933;">:</span><span style="color: #00336
6; font-weight: bold;">function</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     <span style="color: #003366; font-weight: bold;">var</span> selectedItems <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span>._gChart.<span style="color: #660066;">getSelection</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span>         eventData;     <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>selectedItems <span style="color: #339933;">&amp;&amp;</span> selectedItems.<span style="color: #660066;">length</span><span style="color: #339933;">&gt;</span>0<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         eventData<span style="color: #339933;">=</span><span style="color: #009900;">&#123;</span>             row<span style="color: #339933;">:</span>selectedItems<span style="color: #009900;">&#91;</span>0<span style="color: #009900;">&#93;</span>.<span style="color: #660066;">row</span><span style="color: #339933;">,</span>             column<span style="color: #339933;">:</span>selectedItems<span style="color: #009900;">&#91;</span>0<span style="color: #009900;">&#93;</span>.<span style="color: #660066;">column</span>         <span style="color: #009900;">&#125;</span>         <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">fire</span><span style="color: #009900;">&#40;</span><span style="color: #3366CC;">&quot;onSelect&quot;</span><span style="color: #339933;">,</span> eventData<span style="color: #009900;">&#41;</span>;     <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span></pre> <p>Côté serveur, la méthode service du composant Java accueille la requête Ajax brute, et permet de la traiter: Parsing JSON de l'événement JavaScript, puis émission d'un événement Java dans la file événementielle à destination du contrôleur de la page.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #000000;">&#123;</span>     addClientEvent<span style="color: #000000;">&#40;</span>GChart.<span style="color: #7F0055; font-weight: bold;">class</span>, <span style="color: #888888;">&quot;onSelect&quot;</span>, 0<span style="color: #000000;">&#41;</span>; <span style="color: #000000;">&#125;</span> &nbsp; <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> service<span style="color: #000000;">&#40;</span>AuRequest request, <span style="color: #7F0055; font-weight: bold;">boolean</span> everError<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055;font-weight: bold;">if</span> <span style="color: #000000;">&#40;</span>request.<span style="color: #000000;">getCommand</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">equals</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;onSelect&quot;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         <span style="color: #808080; font-style: italic;">// Parsing JSON</span>         <span style="color: #000000;">Integer</span> row=   <span style="color: #000000;">&#40;</span><span style="color: #000000;">Integer</span><span style="color: #000000;">&#41;</span> request.<span style="color: #000000;">getData</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">get</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;row&quot;</span><span style="color: #000000;">&#41;</span>;         <span style="color: #000000;">Integer</span> column=<span style="color: #000000;">&#40;</span><span style="color: #000000;">Integer</span><span style="color: #000000;">&#41;</span> request.<span style="color: #000000;">getData</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">get</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;column&quot;</span><span style="color: #000000;">&#41;</span>;         <span style="color: #808080; font-style: italic;">// Emission d'un événement onSelect</span>         SelectEvent event=<span style="color: #7F0055; font-weight: bold;">new</span> SelectEvent<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;onSelect&quot;</span>, <span style="color: #7F0055; font-weight: bold;">this</span>, row, column<span style="color: #000000;">&#41;</span>;         Events.<span style="color: #000000;">postEvent</span><span style="color: #000000;">&#40;</span>event<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #7F0055;font-weight: bold;">else</span> <span style="color: #000000;">&#123;</span>         <span style="color: #7F0055; font-weight: bold;">super</span>.<span style="color: #000000;">service</span><span style="color: #000000;">&#40;</span>request, everError<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Pour conclure, si savoir développer un composant n'est pas vital pour réaliser une application web avec ZK, ce n'est pas très compliqué et assez bien cadré par le framework. Cela permet en outre, de comprendre le fonctionnement interne du moteur Ajax qui synchronise une classe Java côté serveur avec une classe JavaScript dans le navigateur.</p>