---
ID: 170
post_title: 'Création d&#039;un plugin Gradle – Part 1'
author: Grégory Boissinot
post_date: 2009-06-15 00:08:00
post_excerpt: |
  <p><a href="http://www.gradle.org/">Gradle</a> est un système de build à base de plugins. Chaque plugin apporte un ensemble de conventions et le traitement nécessaire à l’exécution de la chaîne de build. En dehors des plugins Gradle core comme java, groovy, ant, maven, jetty, …, vous pouvez avoir le besoin de créer votre propre plugin.</p> <p>Cette fonctionnalité n'est actuellement pas documentée, et une série de billets sur ce sujet va vous montrer pas à pas la création d'un plugin avec un cycle de vie.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=170
published: true
---
<p><a href="http://www.gradle.org/">Gradle</a> est un système de build à base de plugins. Chaque plugin apporte un ensemble de conventions et le traitement nécessaire à l’exécution de la chaîne de build. En dehors des plugins Gradle core comme java, groovy, ant, maven, jetty, …, vous pouvez avoir le besoin de créer votre propre plugin.</p> <p>Cette fonctionnalité n'est actuellement pas documentée, et une série de billets sur ce sujet va vous montrer pas à pas la création d'un plugin avec un cycle de vie.</p>
<!--more-->
<h4>Première étape</h4> <p>Nous allons créer notre projet plugin et le builder avec Gradle lui-même. Nous allons utiliser une structure groovy conventionnée par Gradle (l'utilisation d'une structure Groovy au lieu d’une structure Java sera expliquée dans les prochains billets).</p> <pre> firstplugin +-- build.gradle +-- libs +--- gradle-0.6.jar +--- groovy-all-1.5.6.jar +--- slf4j-api-1.5.3.jar +-- src/main/groovy/com/zenika/plugins/FirstPlugin.java </pre> <p>Nous définissions notre script Gradle build.gradle comme suit</p> <pre class="groovy code groovy" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">usePlugin<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'groovy'</span><span style="color: #66cc66;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">version<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1.0</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">repositories <span style="color: #66cc66;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  flatDir<span style="color: #66cc66;">&#40;</span>dirs: file<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'lib'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #66cc66;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">dependencies <span style="color: #66cc66;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">   groovy <span style="color: #ff0000;">&quot;:groovy-all:1.5.6&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">   groovy <span style="color: #ff0000;">&quot;:gradle:0.6&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">   groovy <span style="color: #ff0000;">&quot;:slf4j-api:1.5.3&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #66cc66;">&#125;</span></div></li></ol></pre> <p>Notre plugin est pour le moment constitué d’une classe FirstPlugin.java. Voici son contenu</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">package</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">gradle</span>.<span style="color: #000000;">plugins</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.gradle.api.*;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.gradle.api.Plugin;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.gradle.api.Project;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import org.gradle.api.internal.project.PluginRegistry;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #a1a100;">import java.util.Map;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> FirstPlugin <span style="color: #7F0055; font-weight: bold;">implements</span> Plugin <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> apply<span style="color: #000000;">&#40;</span>Project project, PluginRegistry pluginRegistry, <span style="color: #7F0055; font-weight: bold;">final</span> Map<span style="color: #000000;">&lt;</span>String, <span style="color: #000000;">?&gt;</span> customValues<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">	   <span style="color: #000000;">System</span>.<span style="color: #000000;">out</span>.<span style="color: #000000;">println</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;Hello World!&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Il nous reste plus qu’à compiler et à packager notre plugin</p> <blockquote><p>gradle clean libs</p></blockquote> <h4>Deuxième étape.</h4> <p>Après avoir construit notre plugin, il nous faut le déclarer pour l’utiliser dans notre projet Gradle. Il faut tout premièrement
créer un fichier "settings.gradle" avec le contenu suivant</p> <pre class="groovy code groovy" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">flatDir<span style="color: #66cc66;">&#40;</span>dirs:<span style="color: #ff0000;">&quot;C:/dev/gradle/firstplugin/build/libs&quot;</span><span style="color: #66cc66;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">dependencies<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">&quot;:firstplugin:1.0&quot;</span><span style="color: #66cc66;">&#41;</span></div></li></ol></pre> <p>Nous déclarons une dépendance vers notre plugin Gradle.</p> <p><ins>Note:</ins> dans le cadre de ce billet, nous avons choisi d’utiliser directement le plugin à l’emplacement où il a été construit. En production, la mise à disposition du plugin dans une infrastructure d’entreprise comme dans un gestionnaire de repository <a href="http://nexus.sonatype.org/">Nexus</a> sera plus judicieuse.</p> <p>Ensuite dans le descripteur Gradle de notre projet, il nous reste à déclarer son utilisation</p> <pre class="groovy code groovy" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">usePlugin<span style="color: #66cc66;">&#40;</span>com.<span style="color: #006600;">zenika</span>.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">FirstPlugin</span><span style="color: #66cc66;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">task test <span style="color: #66cc66;">&lt;&lt;</span><span style="color: #66cc66;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"> <span style="color: #993399;">println</span> <span style="color: #ff0000;">&quot;Testing plugin&quot;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #66cc66;">&#125;</span></div></li></ol></pre> <p>Nous ajoutons une tâche fictive "test" pour pouvoir l’invoquer et le tester. En effet, pour le moment, notre plugin ne définit pas de tâches Gradle, et toute invocation de plugin doit être démarrée par l'exécution d’au moins une tâche Gradle.</p> <p>Nous exécutons</p> <blockquote><p>gradle test</p></blockquote> <p>et le résultat est</p> <pre> Hello World! :test Testing plugin </pre> <p><ins>Remarque:</ins> La présence du fichier "settings.gradle", comparée à un plugin core, peut paraître un peu lourde pour la prise en compte d’un plugin utilisateur. Les prochaines versions de Gradle ne manqueront sûrement pas d’améliorer ce point.</p> <p><ins>Note:</ins>  Si vous déployez votre plugin avec le code de la distribution, la déclaration de la dépendance vers le plugin Gradle n’est pas necessaire. Et vous pourrez aussi, utiliser un shortcut grâce au fichier "plugin.properties" avec un contenu comme ceci</p> <pre class="groovy code groovy" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">java<span style="color: #66cc66;">=</span>org.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">api</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">JavaPlugin</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">groovy<span style="color: #66cc66;">=</span>org.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">api</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">GroovyPlugin</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">war<span style="color: #66cc66;">=</span>org.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">api</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">WarPlugin</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">osgi<span style="color: #66cc66;">=</span>org.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">api</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">osgi</span>.<span style="color: #006600;">OsgiPlugin</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">jetty<span style="color: #66cc66;">=</span>org.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">api</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">jetty</span>.<span style="color: #006600;">JettyPlugin</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">maven<span style="color: #66cc66;">=</span>org.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">api</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">MavenPlugin</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">project<span style="color: #66cc66;">-</span>reports<span style="color: #66cc66;">=</span>org.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">api</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">ProjectReportsPlugin</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">ant<span style="color: #66cc66;">=</span>org.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">api</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">ant</span>.<span style="color: #006600;">AntPlugin</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">firstplugin<span style="color: #66cc66;">=</span>com.<span style="color: #006600;">zenika</span>.<span style="color: #006600;">gradle</span>.<span style="color: #006600;">plugins</span>.<span style="color: #006600;">FirstPlugin</span></div></li></ol></pre> <h4>Conclusion</h4> <p>Nous savons maintenant créer un nouveau plugin Gradle. Dans les prochains billets, nous verrons les différentes manières de passer des propriétés à un plugin, puis nous verrons comment définir des tâches et des dépendances entre ces tâches afin de constituer un cycle de vie.</p>