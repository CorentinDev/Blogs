---
ID: 117
post_title: >
  Introduction à la programmation
  concurrente en Java (2/2)
author: ocroisier
post_date: 2012-04-17 09:00:00
post_excerpt: |
  <p>Dans un précédent article, nous avons vu comment lancer plusieurs threads pour <a href="/index.php?post/2012/04/11/Introduction-programmation-concurrente-Java-1sur2">exécuter des traitements concurrents en Java</a>, manuellement ou via le framework Executor.</p> <p>Dans cet article, nous étudierons les problèmes qui se posent lorsque plusieurs threads tentent d'accéder simultanément à une ressource, ainsi que quelques techniques simples pour les résoudre.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=117
published: true
---
<p>Dans un précédent article, nous avons vu comment lancer plusieurs threads pour <a href="/index.php?post/2012/04/11/Introduction-programmation-concurrente-Java-1sur2">exécuter des traitements concurrents en Java</a>, manuellement ou via le framework Executor.</p> <p>Dans cet article, nous étudierons les problèmes qui se posent lorsque plusieurs threads tentent d'accéder simultanément à une ressource, ainsi que quelques techniques simples pour les résoudre.</p>
<!--more-->
<h3>La problème des accès concurrents</h3> <h4>Le problème</h4> <p>Avant toute chose, il faut se rappeler que les différents threads s'exécutant au sein d'une application sont autorisés à accéder, en lecture comme en écriture, à toutes les données présentes dans l'espace mémoire réservée par cette application.</p> <p>A cause de cet accès libre et de l'exécution concurrente des threads, il peut arriver que deux d'entre eux tentent d'accéder simultanément à une même donnée&nbsp;; on parle alors de <em>race condition</em>.</p> <p>Des accès simultanés en lecture seule sont évidemment inoffensifs. Mais deux problèmes fondamentaux surviennent lors des accès en écriture&nbsp;:</p> <ul> <li>Un problème de <strong>visibilité</strong>&nbsp;: la modification apportée par un thread est-elle immédiatement visible par les autres threads&nbsp;?</li> <li>Un problème de <strong>cohérence</strong>&nbsp;: que se passe-t-il en cas de modification concurrente&nbsp;? Est-ce le dernier thread qui écrit qui gagne, ou les données risquent-elles d'être corrompues&nbsp;?</li> </ul> <p>Ces problèmes sont en réalité les mêmes que ceux posés par le partage d'un fichier sur un réseau&nbsp;: que se passe-t-il si plusieurs personnes tentent de l'éditer simultanément&nbsp;? Les modifications sont-elles immédiatement visibles par tous les participants&nbsp;? Et si une personne effectue une copie locale du fichier au lieu de l'éditer à distance&nbsp;?</p> <h4>Corruption des données</h4> <p>Pour démonter le risque de corruption des données en environnement multithreadé, prenons l'exemple d'un simple compteur. Notez que les méthodes <code>increment()</code>, <code>decrement()</code> ou <code>getValue()</code> lisent ou modifient la valeur du champ <code>value</code>, qui est donc notre donnée partagée.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Counter <span style="color: #009900;">&#123;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000066; font-weight: bold;">int</span> value <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> increment<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         value<span style="color: #339933;">++;</span>     <span style="color: #009900;">&#125;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">int</span> getValue<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #000000; font-weight: bold;">return</span> value<span style="color: #339933;">;</span>     <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #009900;">&#125;</span></pre> <p>Pour tester le comportement de ce compteur, le test ci-dessous lance <code>NB_THREADS</code> threads qui effectuent chacun <code>NB_INCREMENTS</code> appels à la méthode <code>increment()</code>. A la fin du test, on s'attend donc à ce que la valeur du compteur soit de <code>NB_THREADS * NB_INCREMENTS</code>.</p> <p>Exemple&nbsp;: avec 5 threads et 100 incréments, le compteur vaut normalement 500.</p> <p>Le test est répété plusieurs fois afin de vérifier sa stabilité.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CounterTest <span style="color: #009900;">&#123;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #000066; font-weight: bold;">int</span> NB_THREADS <span style="color: #339933;">=</span> <span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span>     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #000066; font-weight: bold;">int</span> NB_INCREMENTS <span style="color: #339933;">=</span> <span style="color: #cc66cc;">1</span>_000_000<span style="color: #339933;">;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000066; font-weight: bold;">void</span> main<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> args<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">InterruptedException</span> <span style="color: #009900;">&#123;</span> &nbsp;         <span style="color: #000000; font-weight: bold;">final</span> Counter counter <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Counter<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;         <span style="color: #666666; font-style: italic;">// A job that increments the counter NB_INCREMENT times</span>         <span style="color: #003399;">Runnable</span> incrementer <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">Runnable</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             @Override             <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                 <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">int</span> i <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> NB_INCREMENTS<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                     counter.<span style="color: #006633;">increment</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>                 <span style="color: #009900;">&#125;</span>             <span style="color: #009900;">&#125;</span>         <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span> &nbsp;         <span style="color: #666666; font-style: italic;">// Submit several jobs that increment the counter</span>         ExecutorService pool <span style="color: #339933;">=</span> Executors.<span style="color: #006633;">newFixedThreadPool</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">4</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">int</span> i <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> NB_THREADS<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span> <span style
="color: #009900;">&#123;</span>             pool.<span style="color: #006633;">submit</span><span style="color: #009900;">&#40;</span>incrementer<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span>         pool.<span style="color: #006633;">shutdown</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         pool.<span style="color: #006633;">awaitTermination</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">5</span>, TimeUnit.<span style="color: #006633;">SECONDS</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;         <span style="color: #666666; font-style: italic;">// Verify the counter's final value</span>         <span style="color: #000066; font-weight: bold;">int</span> counterValue <span style="color: #339933;">=</span> counter.<span style="color: #006633;">getValue</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #003399;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">printf</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;%d thread(s) X %7d increments = %d %n&quot;</span>, NB_THREADS, NB_INCREMENTS, counterValue<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #009900;">&#125;</span></pre> <p>Avec 1 thread, tout se passe bien&nbsp;:</p> <pre> 1 thread(s) X 1000000 increments = 1000000 1 thread(s) X 1000000 increments = 1000000 1 thread(s) X 1000000 increments = 1000000 1 thread(s) X 1000000 increments = 1000000 </pre> <p>Tentons avec 2 threads&nbsp;:</p> <pre> 2 thread(s) X 1000000 increments = 1007644 2 thread(s) X 1000000 increments = 1999360 2 thread(s) X 1000000 increments = 1999384 2 thread(s) X 1000000 increments = 1784593 </pre> <p>Le résultat n'est visiblement pas celui que l'on espérait. Non seulement la valeur obtenue n'est pas correcte, mais elle varie à chaque test&nbsp;! Comment expliquer ce comportement&nbsp;?</p> <h4>Explication</h4> <p>Plusieurs facteurs expliquent les résultats surprenants obtenus plus haut.</p> <h5>Indiana Jones and the Lost Updates</h5> <p>Premièrement, certaines mises à jour ont été malencontreusement "écrasées".<br />
Cela est dû au fait que, malgré les apparences, l'opération <code>++</code> utilisée pour incrémenter le compteur n'est pas atomique. Elle consiste en réalité en 3 opérations successives&nbsp;:</p> <ul> <li>lecture de la valeur actuelle en mémoire</li> <li>incrémentation de la valeur</li> <li>écriture de la nouvelle valeur en mémoire</li> </ul> <p>La séquence suivante peut alors se produire&nbsp;:</p> <ul> <li>Un thread A lit la valeur actuelle (ex: 42) puis est mis en pause par le processeur&nbsp;;</li> <li>Un thread B lit également la valeur 42, l'incrémente, puis écrit 43 en mémoire&nbsp;;</li> <li>Le thread A se réveille, incrémente la valeur qu'il a lue et écrit également 43 en mémoire.</li> </ul> <p>Une mise à jour a donc été oubliée au passage, ce qui explique (en partie) les valeurs incorrectes obtenues lors du test. La littérature anglophone parle de "<em>lost updates</em>".</p> <p>La solution à ce problème consiste à s'assurer que les trois opérations seront toujours exécutées de manière atomique, c'est-à-dire que leur séquence sera toujours exécutée en intégralité et sans interruption de la part d'autres threads.<br />
Les <em>moniteurs</em> et les <em>locks</em> de Java donnent justement cette garantie.</p> <h5>Cachez cette valeur que je ne saurais voir</h5> <p>La deuxième source de corruption vient du fait que chaque thread est autorisé, sous certaines conditions, à mettre en cache certaines valeurs dans des registres locaux plutôt que de les lire ou écrire dans la mémoire commune. On touche donc ici à un problème de visibilité et de fraîcheur des données.</p> <p>La JVM est s'autorise ce genre de manipulation pour des raisons de performances&nbsp;: il est toujours plus rapide d'accéder à un registre de thread qu'à la mémoire commune.</p> <p>Là encore, l'emploi judicieux de <em>moniteurs</em> ou de <em>locks</em> permet de garantir la bonne visibilité mémoire des données partagées.</p> <h3>Contrôler l'accès aux ressources</h3> <p>Voyons maintenant comment utiliser les mécanismes que Java met à notre disposition pour garantir l'atomicité des opérations et la fraîcheur des données.</p> <p>La solution la plus simple est souvent la plus sûre et la plus maintenable (à défaut d'être la plus performante). Puisque le problème vient de l'accès concurrent à la donnée, supprimons l'accès concurrent&nbsp;! Ou du moins contrôlons-le, par exemple à l'aide de verrous.</p> <p>Java propose deux types de verrous, les <em>moniteurs</em> et les <em>locks</em>. Si leur syntaxe d'utilisation diffère, leur principe de fonctionnement est identique&nbsp;: un thread souhaitant accéder à une donnée partagée doit préalablement obtenir le verrou qui la protège, et le libérer ensuite.</p> <p>Pour chaque donnée exposée à une utilisation concurrente, il convient donc de définir (et de documenter<sup>[<a href="#pnote-332-1" id="rev-pnote-332-1">1</a>]</sup> !) quel verrou la protège, puis de s'assurer que tous les accès à cette donnée (en lecture comme en écriture) sont convenablement protégés.</p> <p>Maintenant, mettons toute cette théorie en pratique.</p> <h3>Les moniteurs</h3> <p>Tout d'abord, voyons les <em>moniteurs</em>, également appelés "verrous implicites" ou "verrous intrinsèques".</p> <p>Chaque instance d'objet Java possède un moniteur, sur lequel on peut décider de se baser pour protéger une donnée. Attention, ce moniteur n'est pas un champ de l'instance&nbsp;; c'est plutôt une de ses propriétés intrinsèques.</p> <h4>Mode d'emploi</h4> <p>Le mot-clé <code>synchronized</code> permet de demander l'acquisition d'un moniteur donné pour la durée d'un bloc de code&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">synchronized</span><span style="color: #009900;">&#40;</span>someInstance<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     <span style="color: #666666; font-style: italic;">// Accès aux données protégées par le moniteur de &quot;someInstance&quot;</span> <span style="color: #009900;">&#125;</span></pre> <p>Une question se pose alors&nbsp;: quel moniteur utiliser&nbsp;?</p> <p>Une bonne pratique générale consiste à séparer les données métiers des données techniques. Dans une table de base de données par exemple, la colonne servant de clé primaire est souvent une clé purement technique.</p> <p>Le même raisonnement s'applique avec les moniteurs&nbsp;: il est fréquent de créer une instance d'un quelconque objet (généralement un simple Object) dans l'unique but de disposer de son moniteur.</p> <p>Avantage additionnel, le nom de cette instance technique permet d'expliciter son rôle. Par exemple, le verrou protégeant la donnée <code>clientList</code> peut être appelé <code>clientListMonitor</code>.</p> <p>Passons à la mise en oeuvre.<br />
Pour sécuriser notre compteur, nous utiliserons une instance technique appelée <code>valueMonitor</code>, déclarée <code>private</code> et <code>final</code>.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Counter <span style="color: #009900;">&#123;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000066; font-weight: bold;">int</span> value <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">Object</span> valueMonitor <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">Object</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Protects &quot;value&quot;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> increment<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// Acquire the monitor before modifying the data</span>         <span style="color: #000000; font-weight: bold;">synchronized</span> <span style="color: #009900;">&#40;</span>valueMonitor<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             value<span style="color: #339933;">++;</span>         <span style="color: #009900;">&#125;</span>     <span style="color: #009900;">&#125;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">int</span> getValue<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// Acquire the monitor before reading the data too !</span>         <span style="color: #000000; font-weight: bold;">synchronized</span> <span style="color: #009900;">&#40;</span>valueMonitor<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             <span style="color: #000000; font-weight: bold;">return</span> value<span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span>     <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #009900;">&#125;</span></pre> <p>L'exécution du test avec 5 threads donne cette fois le résultat attendu, et de manière reproductible&nbsp;:</p> <pre> 5 thread(s) X 1000000 increments = 5000000 5 thread(s) X 1000000 increments = 5000000 5 thread(s) X 1000000 increments = 5000000 5 thread(s) X 1000000 increments = 5000000 </pre> <h4>Syntaxe alternative</h4> <p>Note&nbsp;: il existe également une syntaxe alternative, que personnellement je déconseille&nbsp;: l'utilisation du mot-clé <code>synchronized</code> directement dans la signature des méthodes&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">synchronized</span> <span style="color: #000066; font-weight: bold;">void</span> foo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>    <span style="color: #666666; font-style: italic;">// (...)</span> <span style="color: #009900;">&#125;</span></pre> <p>Si cette syntaxe vous est sans doute plus familière, elle présente beaucoup d'inconvénients&nbsp;:</p> <ul> <li>Le moniteur utilisé est celui de l'instance courante de la classe, c'est-à-dire un objet utile à l'application</li> <li>Le moniteur n'est pas nommé, donc peu explicite</li> <li>Le moniteur est acquis pendant toute la durée de la méthode, même si 90% de son code n'en a pas besoin</li> </ul> <p>Utilisez donc plutôt un moniteur explicite&nbsp;!</p> <h4>Avantages et limitations</h4> <p>Les moniteurs présentent deux avantages&nbsp;:</p> <ul> <li>Ils sont simples à utiliser,</li> <li>Il est impossible d'oublier de libérer le verrou&nbsp;: la sémantique du langage le garantit, à la sortie du bloc protégé.</li> </ul> <p>Mais ils présentent également un inconvénient majeur&nbsp;: un thread en attente d'un moniteur est bloqué jusqu'à ce qu'il l'obtienne. Impossible d'abandonner après un certain temps, d'être prévenu par un autre thread que ce n'est plus la peine d'attendre (interruption), de simplement tester l'état du moniteur avant d'essayer de le verrouiller...</p> <p>Les moniteurs doivent donc être utilisés avec beaucoup de précaution, pour éviter de provoquer des <em>deadlocks</em> irrattrapables.</p> <h3>Les locks</h3> <p>Pour pallier les problèmes des moniteurs, Java 5 propose dans son package <code>java.util.concurrent.locks</code> une nouvelle variété de verrous&nbsp;: les <em>locks</em>, représentés par l'interface <code>Lock</code>.</p> <h4>Mode d'emploi</h4> <p>Le principe d'utilisation d'un <em>lock</em> est exactement le même que celui d'un moniteur&nbsp;: il faut le verrouiller avant d'accéder à la ressource partagée, puis le déverrouiller ensuite.</p> <p>Par contre, sa syntaxe est plus verbeuse, car il n'existe pas de support natif des <em>locks</em> au niveau du langage même.</p> <p>L'usage canonique est le suivant&nbsp;:</p> <pre class="java code java" style="font-family:inherit">Lock lock <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> ReentrantLock<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> lock.<span style="color: #006633;">lock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>     <span style="color: #666666; font-style: italic;">// Read/Write resource</span> <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">finally</span> <span style="color: #009900;">&#123;</span>     lock.<span style="color: #006633;">unlock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Mettons à jour notre compteur pour utiliser un <em>lock</em> au lieu d'un moniteur&nbsp;:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Counter <span style="color: #009900;">&#123;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000066; font-weight: bold;">int</span> value <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> Lock valueLock <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> ReentrantLock<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> increment<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// Acquire the monitor before modifying the data</sp
an>         valueLock.<span style="color: #006633;">lock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>             value<span style="color: #339933;">++;</span>         <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">finally</span> <span style="color: #009900;">&#123;</span>             valueLock.<span style="color: #006633;">unlock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span>     <span style="color: #009900;">&#125;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">int</span> getValue<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// Acquire the monitor before reading the data too !</span>         valueLock.<span style="color: #006633;">lock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>             <span style="color: #000000; font-weight: bold;">return</span> value<span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">finally</span> <span style="color: #009900;">&#123;</span>             valueLock.<span style="color: #006633;">unlock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span> &nbsp;     <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #009900;">&#125;</span></pre> <p>L'exécution du test avec 5 threads produit évidemment le même résultat qu'avec un moniteur.</p> <pre> 5 thread(s) X 1000000 increments = 5000000 5 thread(s) X 1000000 increments = 5000000 5 thread(s) X 1000000 increments = 5000000 5 thread(s) X 1000000 increments = 5000000 </pre> <h4>Fonctionnalités avancées</h4> <p>Pour le moment, les locks semblent moins pratiques que les moniteurs&nbsp;; leur syntaxe est plus verbeuse, et le risque d'erreur est plus élevé. Toute leur puissance réside en fait dans leurs fonctionnalités avancées, qui les rendent indispensables sur des projets complexes.</p> <h5>Read/Write Lock</h5> <p>Tout d'abord, étudions le ReadWriteLock.</p> <p>Cette classe part du constat qu'il n'est pas dangereux de laisser plusieurs threads accéder <em>en lecture seule</em> à une ressource&nbsp;: en l'abence de toute de modification, il est impossible de corrompre la donnée. Dans ces conditions, imposer l'acquisition d'un verrou exclusif est donc inutile, et ne ferait que brider artificiellement les performances du système.<br />
En revanche, toute opération de modification doit être réalisée sous la protection d'un verrou exclusif.</p> <p>L'interface <code>ReadWriteLock</code>, et son implémentation <code>ReentrantReadWriteLock</code>, propose donc de différencier les deux modes d'accès grâce à deux sous-verrous&nbsp;: un pour la lecture (<em>readLock</em>), et un pour l'écriture (<em>writeLock</em>). Le premier peut être acquis par plusieurs threads simultanément, alors que le second est exclusif (et exclusif avec les verrous en lecture également).</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">interface</span> ReadWriteLock <span style="color: #009900;">&#123;</span>     Lock readLock<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>     Lock writeLock<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Dans notre exemple, la méthode <code>getValue()</code> est une opération de lecture&nbsp;: elle peut donc être protégée par un <em>readLock</em>. La méthode <code>increment()</code>, au contraire, modifie la valeur du compteur, et doit donc être réalisée de manière atomique&nbsp;; elle sera donc protégée par un <em>writeLock</em>.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CounterRWL <span style="color: #009900;">&#123;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000066; font-weight: bold;">int</span> value <span style="color: #339933;">=</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> ReadWriteLock valueLock <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> ReentrantReadWriteLock<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> increment<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// Acquire the monitor before modifying the data</span>         valueLock.<span style="color: #006633;">writeLock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">lock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>             value<span style="color: #339933;">++;</span>         <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">finally</span> <span style="color: #009900;">&#123;</span>             valueLock.<span style="color: #006633;">writeLock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">unlock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span>     <span style="color: #009900;">&#125;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">int</span> getValue<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// Acquire the monitor before reading the data too !</span>         valueLock.<span style="color: #006633;">readLock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">lock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>             <span style="color: #000000; font-weight: bold;">return</span> value<span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">finally</span> <span style="color: #009900;">&#123;</span>             valueLock.<span style="color: #006633;">readLock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">unlock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span>     <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #009900;">&#125;</span></pre> <p>L'utilisation d'un <code>ReadWriteLock</code> dans notre exemple n'améliore pas significativement ses performances, car nous appelons principalement la méthode <code>increment()</code>. En revanche, une structure de type cache, utilisée à 90% en lecture et 10% en écriture, verrait sa scalabilité considérablement améliorée.</p> <h5>Lock avec timeout</h5> <p>Le plus grand danger auquel font face les applications multithreadées est le fameux, terrible <em>deadlock</em>.</p> <p>Cette situation fort déplaisante survient lorsque deux (ou plus) threads tentent chacun d'obtenir un verrou déjà possédé par l'autre. Ces threads se bloquent alors mutuellement, et ne peuvent être débloqués que par un arrêt de la JVM - un peu gênant en production...</p> <p>Pour éviter cela, les <em>locks</em> proposent une variante de l'opération de verrouillage, permettant de définir un délai maximal d'attente (<em>timeout</em>)&nbsp;: <code>tryLock()</code>.<br />
Cette méthode tente d'obtenir le verrou, mais renonce après un certain temps, évitant ainsi de rester bloqué indéfiniment.</p> <pre class="java code java" style="font-family:inherit">ReentrantLock lock <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> ReentrantLock<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>lock.<span style="color: #006633;">tryLock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>     <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>         <span style="color: #666666; font-style: italic;">// Read/Write resource</span>     <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">finally</span> <span style="color: #009900;">&#123;</span>         lock.<span style="color: #006633;">unlock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>     <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Notez la présence d'un bloc <code>try/finally</code> assurant la libération du verrou en toutes circonstances.</p> <p>Pour illustrer son utilisation, je vous propose un exemple légèrement plus complexe&nbsp;; prenez le temps de l'étudier&nbsp;!</p> <p>L'application ci-dessous demande son nom à l'utilisateur, puis attend une saisie sur l'entrée standard (<code>System.in</code>). Un thread tourne en arrière-plan, et vérifie périodiquement si un nom a été saisi&nbsp;; dans la négative, il demande à l'utilisateur de se dépêcher.</p> <p>Afin de réagir immédiatement à la saisie du nom de l'utilisateur (et non après un certain temps), un <em>lock</em> est utilisé. Celui-ci est détenu par le thread principal, et relâché dès que la saisie est effectuée. Le thread de vérification, quant à lui, utilise <code>tryLock()</code> pour patienter deux secondes entre chaque relance.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> ImpatientGreeter <span style="color: #009900;">&#123;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">String</span> name<span style="color: #339933;">;</span>     <span style="color: #000000; font-weight: bold;">private</span> Lock nameLock <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> ReentrantLock<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">String</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> sentences <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">String</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#123;</span>             <span style="color: #0000ff;">&quot;Please, tell me your name !&quot;</span>,             <span style="color: #0000ff;">&quot;Tell me your name, or else !!!&quot;</span>,             <span style="color: #0000ff;">&quot;Y U NO tell me your name ???&quot;</span>,             <span style="color: #0000ff;">&quot;Come on, what's your name ?&quot;</span>     <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000066; font-weight: bold;">void</span> main<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span><span style="color: #009900;">&#91;</span><span style="color: #009900;">&#93;</span> args<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span> <span style="color: #009900;">&#123;</span>         <span style="color: #000000; font-weight: bold;">new</span> ImpatientGreeter<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">launch</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>     <span style="color: #009900;">&#125;</span> &nbsp;     <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000066; font-weight: bold;">void</span> launch<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>         <span style="color: #003399;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Hi, what's your name ?&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;         <span style="color: #666666; font-style: italic;">// The impatient greeter thread. Asks for the name every 2 seconds.</span>         <span style="color: #003399;">Thread</span> readerThread <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">Thread</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;reader&quot;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             @Override             <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                 <span style="color: #000000; font-weight: bold;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">true</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                     <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>                         <span style="color: #666666; font-style: italic;">// Try to acquire the lock, but only for 2 seconds</span>                         <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>nameLock.<span style="color: #006633;">tryLock</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">2</span>, TimeUnit.<span style="color: #006633;">SECONDS</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                             <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>                                 <span style="color: #003399;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Hi, &quot;</span> <span style="color: #339933;">+</span> name <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot; !&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>                                 <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>                             <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">finally</span> <span style="col
or: #009900;">&#123;</span>                                 nameLock.<span style="color: #006633;">unlock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>                             <span style="color: #009900;">&#125;</span>                         <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span>                             <span style="color: #666666; font-style: italic;">// Couldn't lock, ask again</span>                             <span style="color: #003399;">System</span>.<span style="color: #006633;">out</span>.<span style="color: #006633;">println</span><span style="color: #009900;">&#40;</span>sentences<span style="color: #009900;">&#91;</span>ThreadLocalRandom.<span style="color: #006633;">current</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">nextInt</span><span style="color: #009900;">&#40;</span>sentences.<span style="color: #006633;">length</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>                         <span style="color: #009900;">&#125;</span>                     <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">InterruptedException</span> e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>                         <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span>                     <span style="color: #009900;">&#125;</span>                 <span style="color: #009900;">&#125;</span>             <span style="color: #009900;">&#125;</span>         <span style="color: #009900;">&#125;</span><span style="color: #339933;">;</span>         readerThread.<span style="color: #006633;">start</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp;         <span style="color: #666666; font-style: italic;">// Wait for the user to enter his name in the console</span>         <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">InputStreamReader</span> isr <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">InputStreamReader</span><span style="color: #009900;">&#40;</span><span style="color: #003399;">System</span>.<span style="color: #006633;">in</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>              <span style="color: #003399;">BufferedReader</span> reader <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">BufferedReader</span><span style="color: #009900;">&#40;</span>isr<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             nameLock.<span style="color: #006633;">lock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>             <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>                 <span style="color: #666666; font-style: italic;">// Wait for the name, while holding the lock</span>                 name <span style="color: #339933;">=</span> reader.<span style="color: #006633;">readLine</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>             <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">finally</span> <span style="color: #009900;">&#123;</span>                 nameLock.<span style="color: #006633;">unlock</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>             <span style="color: #009900;">&#125;</span>         <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">IOException</span> e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>             e.<span style="color: #006633;">printStackTrace</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>         <span style="color: #009900;">&#125;</span> &nbsp;     <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #009900;">&#125;</span></pre> <p>Ce qui donne&nbsp;:</p> <pre> Hi, what's your name ? Y U NO tell me your name ??? Please, tell me your name ! Please, tell me your name ! Y U NO tell me your name ??? toto Hi, toto ! </pre> <h4>Avantages et limitations</h4> <p>Les <em>locks</em> offrent des fonctionnalités uniques qui permettent de déjouer certains problèmes de <em>deadlock</em>. Utilisés à bon escient, ils peuvent rendre les applications concurrentes considérablement plus robustes et performantes.</p> <p>Toutefois, leur syntaxe plus verbeuse et l'absence de support natif par le langage, notamment pour le déverrouillage automatique, peut augmenter les risques d'erreurs.</p> <p>Ma recommandation est donc de privilégier les moniteurs en première approche, et de passer aux <em>locks</em> lorsque leurs fonctionnalités avancées peuvent faire la différence.</p> <h3>Conclusion</h3> <p>Dans cet article, nous avons vu qu'autoriser l'accès concurrent à une ressource pouvait mener à la corruption de celle-ci.</p> <p>Pour résoudre ce problème, Java propose deux mécanismes de verrouillage&nbsp;: les moniteurs (<code>synchronized</code>) et les <em>locks</em> (dans <code>java.util.concurrent.locks.Lock</code>). Nous avons vu le mode d'emploi ainsi que les avantages et inconvénients de chaque solution.</p> <p>Quelques ressources pour aller plus loin&nbsp;:</p> <ul> <li>Le livre <a href="http://jcip.net/">Java Concurrency in Practice</a>, de Brian Goetz, Doug Lea, Joshua Bloch...</li> <li>La formation <a href="http://zenika.com/formation_java_specialiste.html">Java Specialists Master Course</a></li> <li>La formation <a href="http://zenika.com/formation-java-concurrency-specialist.html">Java Concurrency Specialist</a></li> </ul> <div class="footnotes"><h4 class="footnotes-title">Note</h4> <p>[<a href="#rev-pnote-332-1" id="pnote-332-1">1</a>] Par exemple à l'aide des annotations proposées sur le site du livre Java Concurrency In Practice : http://jcip.net/ </p></div> 