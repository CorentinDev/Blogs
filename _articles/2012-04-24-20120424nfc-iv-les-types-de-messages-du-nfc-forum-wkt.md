---
ID: 443
post_title: 'NFC IV &#8211; Les types de messages du NFC Forum'
author: Guillaume Gerbaud
post_date: 2012-04-24 08:47:00
post_excerpt: |
  <p>Ce billet sera l'occasion de rentrer dans les détails de plusieurs type de message Ndef définis par le <a href="http://www.nfc-forum.org/specs/spec_list/" hreflang="en">NFC Forum</a>. Nous verrons dans un premier temps, les différents Type Name Format (TNF) prévus par le consortium, puis je décrirai les types des messages <a href="/index.php?tag/nfc">NFC</a> les plus courants, tels que l'Uri et le Text.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=443
published: true
slide_template:
  - ""
---
<p>Ce billet sera l'occasion de rentrer dans les détails de plusieurs type de message Ndef définis par le <a href="http://www.nfc-forum.org/specs/spec_list/" hreflang="en">NFC Forum</a>. Nous verrons dans un premier temps, les différents Type Name Format (TNF) prévus par le consortium, puis je décrirai les types des messages <a href="/index.php?tag/nfc">NFC</a> les plus courants, tels que l'Uri et le Text.</p>
<!--more-->
<h3>L'En-tête d'un message Ndef</h3> <p>Les premiers octets d'un message Ndef constituent son en-tête. Ils contiennent divers informations sur la nature du message. Pour être plus précis, un message Ndef peut contenir plusieurs enregistrements (Record) et  ce sont ces Record Ndef qui contiennent un en-tête.</p> <p><br />
<img src="/wp-content/uploads/2015/07/NFC_Record_Layout.png" alt="Structure d&#039;un enregistrement Ndef" style="display:block; margin:0 auto;" title="Structure d&#039;un enregistrement Ndef" /> <br /></p> <h5>MB, ME et CR</h5> <p>Les 3 premiers bits permettent de situer le Record par rapport aux autres. Le premier, MB (pour Message Begin), permet d'indiquer si le Record est le premier du message, le second, ME (pour Message End), permet d'indiquer s'il est le dernier. Ainsi, un message qui contient un unique enregistrement commencera par 11.<br />
Le troisième bit, CR (pour Chunk Record), permet d'indiquer que le payload est tronqué et partagé sur plusieurs enregistrements. Nous ne rentrerons pas dans les détails de ce mécanisme dans cet article mais précisons tout de même que tout les enregistrements doivent être dans le même message.<br /></p> <h5>SR</h5> <p>Le quatrième bit, SR (pour Short Record), permet d'indiquer que l'enregistrement est de petite taille. Par conséquent, le champs Payload Length sera d'un octet (taille maximale du payload de 255 octets) contre 4 octets dans le cas contraire.</p> <h5>IL</h5> <p>Le cinquième bit, IL (pour ID Length field present), permet d'indiquer la présence d'un identifiant de Record. S'il vaut 1, alors les champs ID Length et ID seront présents (voir schéma récapitulatif).</p> <h5>TNF</h5> <p>Enfin, les 3 derniers bits de ce premier octet décrivent le TNF (Type Name Format) de l'enregistrement. Les différents TNF sont&nbsp;:</p> <ul> <li>0x00 Vide&nbsp;: Enregistrement vide</li> <li>0x01 Well-Known Type (WKT)&nbsp;: Type défini par le NFC Forum (voir plus loin)</li> <li>0x02 Type MIME</li> <li>0x03 Absolute Uri (voir plus loin le WKT Uri)</li> <li>0x04 External (voir <a href="/index.php?post/2012/03/20/NFC-Lecture-d-un-Tag-sur-Android">le second billet de cette série</a>)</li> <li>0x05 Type non connu</li> <li>0x06 Type inchangé (utilisé pour les enregistrements tronqués)</li> <li>0x07 réservé pour un usage futur</li> </ul> <h5>Type Length</h5> <p>Le deuxième octet de l'en-tête précise le taille du type. Le TNF indique une sorte de <q>catégorie</q> de type, mais pas le type lui-même. Le type précis étant de taille variable ("image/jpeg", "Sp", ...), ce champs permet d'indiquer le nombre d'octet qu'occupera le type dans l'en-tête.</p> <h5>Payload Length</h5> <p>Ce champs détaille la taille en octet du payload. En fonction de la valeur de SR, ce champs a une taille de 1 ou 4 octets.</p> <h5>ID Length</h5> <p>Ce champs, s'il est présent indique la taille en octet de l'identifiant de l'enregistrement.</p> <h5>Type et ID</h5> <p>L'en-tête se termine par successivement les champs Type et ID dont la taille et/ou la présence sont conditionnées par les champs précédents et représentant respectivement le type du payload et l'identifiant de l'enregistrement.</p> <h3>Les Well-Known Types</h3> <p>Je vais maintenant présenter 3 des WKT que sont Uri, Text et SmartPoster. Les deux premiers types, bien que pouvant laisser présager de leur simplicité, ont été spécifiés de manière à optimiser la taille du message, ce qui nécessite de les détailler.</p> <h2>URI</h2> <p><br />
Le type URI permet comme son nom l'indique de stocker une URI (Uniform Resource Identifier). Un message URI utilise donc le TNF WKT (0x01) et son type de taille 1 octet est désigné par la lettre U majuscule (0x55). Mais l’intérêt du type URI réside dans le fait qu'on s'affranchit d'encoder le préfixe de l'URI dans le payload, ce qui peut faire économiser jusqu'à une dizaine d'octets.</p> <p>Le premier octet du payload désigne donc le préfixe de l'URI. Voici une sélection des préfixes définis par le NFC Forum.</p> <ul> <li>0x00&nbsp;: <em>pas de préfixe</em></li> <li>0x01&nbsp;: http://www.</li> <li>0x02&nbsp;: https://www.</li> <li>0x03&nbsp;: http://</li> <li>0x04&nbsp;: https://</li> <li>0x05&nbsp;: tel:</li> <li>0x06&nbsp;: mailto:</li> <li>0x1D&nbsp;: file://</li> <li>0x24...0xFF&nbsp;: réservés pour un usage futur</li> </ul> <p>Ainsi, si on reprend l'exemple donné dans <a href="/index.php?post/2012/03/13/NFC-Nouvelle-Fa%C3%A7on-de-Communiquer">le premier billet</a> <br /></p> <pre> D1 01 10 55 03 62 6C 6F 67 2E 7A 65 6E 69 6B 61 2E 63 6F 6D </pre> <p><strong>D1</strong>&nbsp;: MB=1, ME=1, CR=0, SR=1, IL=0, TNF=001<br />
<strong>01</strong>&nbsp;: type sur 1 octet<br />
<strong>10</strong>&nbsp;: payload sur 16 octets<br />
<strong>55</strong>&nbsp;: type U (URI)<br />
<strong>03</strong>&nbsp;: préfixe http://<br />
<strong>626C6F672E7A656E696B612E636F6D</strong>&nbsp;: blog.zenika.com<br /></p> <blockquote><p>Il est également possible d'utiliser le TNF Absolute Uri (0x03) si on ne souhaite pas utiliser les préfixes.</p></blockquote> <h2>Text</h2> <p><br />
Le type Text permet de contenir du texte brut, mais en indiquant son encodage ainsi que sa langue. Un message Text utilise donc le TNF WKT (0x01) et son type de taille 1 octet est désigné par la lettre T majuscule (0x54). Le premier octet du payload d'un enregistrement Text indique l'encodage du texte et le nombre d'octets qui sont utilisés pour décrire la langue. Ainsi, le premier bit indique l'encodage UTF-8 s'il vaut 0 et UTF-16 s'il vaut 1. Le second bit n'est pas utilisé pour le moment et doit être positionné à 0. Les 6 bits suivants indique la taille en octets de la langue.<br />
Les n octets qui suivent le premier indiquent donc la langue du texte, puis les octets suivants le texte.</p> <p>Voici le message pour le texte "Hello World !" avec comme langue "en-US" et encodé en utf-8. <br /></p> <pre> D1 01 13 54  //  x x x T 05 65 6E 2D  //  x e n - 55 53 48 65  //  U S H e 6C 6C 6F 20  //  l l o 57 6F 72 6C  //  W o r l 64 20 21 00  //  d   ! x </pre> <p><br />
et le texte "NFC" avec pour langue "fr" en utf-8 <br /></p> <pre> D1 01 06 54  //  x x x T 02 66 72 4E  //  x f r N 46 43 00 00  //  F C x x </pre> <h2>SmartPoster</h2> <p><br />
Le type SmartPoster est une sorte d'extension du type Uri. Il permet autour d'un enregistrement Uri, d'ajouter des informations supplémentaires. Ces informations supplémentaires peuvent être un titre (enregistrement Text), éventuellement dans plusieurs langues, une icône, la taille et le type de la ressource vers laquelle pointe l'Uri.<br />
Un message SmartPoster est un enregistrement unique dont le type de taille 2 est désigné par les lettres Sp (0x53, 0x70); ce n'est pas un ensemble d'enregistrements. Par contre, son payload est constitué d'un enregistrement Uri et des différents enregistrements correspondant aux informations supplémentaires. L'Uri et ses ajouts sont ainsi <q>encapsulés</q> dans le SmartPoster.<br /></p> <p>Voici pour exemple, un SmartPoster constitué de l'Url du blog et du titre <q>Blog</q> en français (fr). <br /></p> <pre> D1 02 1F 53  //  x x x S 70 91 01 10  //  p x x x 55 03 62 6C  //  U x b l 6F 67 2E 7A  //  o g . z 65 6E 69 6B  //  e n i k 61 2E 63 6F  //  a . c o 6D 51 01 07  // m x x x 54 02 66 72  //  T x f r 42 6C 6F 67  //  B l o g </pre> <p>Le 5 premiers octets nous indiquent qu'il s'agit d'un enregistrement unique (MB = 1 et ME = 1) de 31 octets (0x1F) dont le type est <q>Sp</q>. Par contre le sixième octet (0x91) indique un premier enregistrement qui ne sera pas le dernier (MB = 1 et ME = 0). De même, le 26ème octet indique un enregistrement final (MB = 0 et ME = 1).</p> <h3>Et avec Android&nbsp;?</h3> <p>Les WKT du NFC Forum permettent d'optimiser les messages Ndef, mais nécessitent de <q>mettre les mains dans le cambouis</q>. Malheureusement, en l’état actuel des choses, l'API NFC d'Android ne nous sera pas d'un grand secours. La seule facilité offerte pour le moment permet de transformer une <code>Uri</code> en <code>NdfRecord</code>. Il n'y a rien pour le texte ou les SmartPoster et rien pour les opérations inverses.</p> <p>Voici comment créer le SmartPoster de l'exemple précédent</p> <pre class="java code java" style="font-family:inherit">NdefRecord uriRecord = NdefRecord.<span style="color: #000000;">createUri</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;http://blog.zenika.com&quot;</span><span style="color: #000000;">&#41;</span>; &nbsp; <span style="color: #000000;">String</span> title = <span style="color: #888888;">&quot;Blog&quot;</span>; <span style="color: #7F0055; font-weight: bold;">byte</span><span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> textPayload = <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #7F0055; font-weight: bold;">byte</span><span style="color: #000000;">&#91;</span>title.<span style="color: #000000;">length</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> + <span style="color: #cc66cc;">3</span><span style="color: #000000;">&#93;</span>; textPayload<span style="color: #000000;">&#91;</span>0<span style="color: #000000;">&#93;</span> = 0x02; <span style="color: #000000;">String</span> lg = <span style="color: #888888;">&quot;fr&quot;</span>; <span style="color: #000000;">System</span>.<span style="color: #000000;">arraycopy</span><span style="color: #000000;">&#40;</span>lg.<span style="color: #000000;">getBytes</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>, 0, textPayload, <span style="color: #cc66cc;">1</span>, lg.<span style="color: #000000;">length</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>; <span style="color: #000000;">System</span>.<span style="color: #000000;">arraycopy</span><span style="color: #000000;">&#40;</span>title.<span style="color: #000000;">getBytes</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>, 0, textPayload, <span style="color: #cc66cc;">1</span> + lg.<span style="color: #000000;">length</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>, title.<span style="color: #000000;">length</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>; NdefRecord textRecord = <span style="color: #7F0055; font-weight: bold;">new</span> NdefRecord<span style="color: #000000;">&#40;</span>NdefRecord.<span style="color: #000000;">TNF_WELL_KNOWN</span>, NdefRecord.<span style="color: #000000;">RTD_TEXT</span>, <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #7F0055; font-weight: bold;">byte</span><span style="color: #000000;">&#91;</span>0<span style="color: #000000;">&#93;</span>, textPayload<span style="color: #000000;">&#41;</span>; &nbsp; NdefMessage payloadSp = <span style="color: #7F0055; font-weight: bold;">new</span> NdefMessage<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> NdefRecord<span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> <span style="color: #000000;">&#123;</span>uriRecord, textRecord<span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span>; &nbsp; NdefRecord spRecord = <span style="color: #7F0055; font-weight: bold;">new</span> NdefRecord<span style="color: #000000;">&#40;</span>NdefRecord.<span style="color: #000000;">TNF_WELL_KNOWN</span>, NdefRecord.<span style="color: #000000;">RTD_SMART_POSTER</span>, <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #7F0055; font-weight: bold;">byte</span><span style="color: #000000;">&#91;</span>0<span style="color: #000000;">&#93;</span>, payloadSp.<span style="color: #000000;">toByteArray</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>; &nbsp; NdefMessage spMsg = <span style="color: #7F0055; font-weight: bold;">new</span> NdefMessage<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> NdefRecord<span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> <span style="color: #000000;">&#123;</span>spRecord<span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span>;</pre>