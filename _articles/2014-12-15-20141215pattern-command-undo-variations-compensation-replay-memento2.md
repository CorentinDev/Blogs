---
ID: 498
post_title: 'Pattern Command: Undo, variations Compensation/Replay/Memento'
author: lclaisse
post_date: 2014-12-15 17:00:00
post_excerpt: |
  <p>La dernière fois je vous avez parlé de <a href="http://blog.zenika.com/index.php?post/2014/06/11/Quelques-patterns-d-implementation-avec-les-enums-java" title="quelques patterns d&#039;implémentation avec les enums java">quelques patterns d'implémentation avec les enums java</a> et en particulier de l'application des enums au Domain Driven Design grâce à l'inversion de dépendance. Aujourd'hui nous allons parler d'un design pattern classique, le pattern Command. Après un rappel de sa structure et de ses utilisations, nous irons un peu plus loin en analysant en particulier 3 variations permettant d'implémenter l'undo/redo.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=498
published: true
slide_template:
  - ""
---
<p>La dernière fois je vous avez parlé de <a href="http://blog.zenika.com/index.php?post/2014/06/11/Quelques-patterns-d-implementation-avec-les-enums-java" title="quelques patterns d&#039;implémentation avec les enums java">quelques patterns d'implémentation avec les enums java</a> et en particulier de l'application des enums au Domain Driven Design grâce à l'inversion de dépendance. Aujourd'hui nous allons parler d'un design pattern classique, le pattern Command. Après un rappel de sa structure et de ses utilisations, nous irons un peu plus loin en analysant en particulier 3 variations permettant d'implémenter l'undo/redo.</p>
<!--more-->
<h4>Rappels sur le pattern Command</h4> <p>Dans le langage commun, un pattern désigne un motif répétitif, tel ceux qui décorent les tapis et le carrelage. En programmation, un pattern désigne une solution fréquente à un problème récurrent. Il existe plusieurs types de patterns:</p> <ul> <li>Les analysis patterns modélisent des domaines métiers particuliers (mesures et observations, comptabilité, ..)</li> <li>Les design patterns offrent des solutions à des problèmes de conceptions généraux (dans le monde objet: structure, création, comportement et interactions des objets)</li> <li>Les implementation patterns recensent les techniques d'implémentation propres à chaque langage (dans l'article précédent, l'utilisation des enums polymorphiques de Java)</li> </ul> <p>Ainsi le pattern Command est un design pattern, utilisable dans tout langage orienté objet.</p> <p>Le livre de loin le plus connu sur les design patterns est <a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612">Design Patterns: Elements of Reusable Object-Oriented Software</a>. On l'appelle souvent le GOF, abbréviation de Gang of Four qui désigne ses auteurs. Selon le GOF, l'intention du pattern Command, est d<em>'encapsuler une requête comme un objet, autorisant ainsi le paramétrage des clients par différentes requêtes, file d'attente et récapitulatifs de requêtes, et de plus permettant la révision des opérations</em>. Le GOF fait ici allusion à deux utilisations des commandes: découpler la création d'une requête de son exécution, et implémenter l'undo. Ce dernier point est le sujet principal de ce post.</p> <p>La structure du pattern Commande telle qu'expliquée dans le GOF est la suivante:<br /></p> <p><img src="/wp-content/uploads/2015/07/.commande-1-general_m.jpg" alt="commande-1-general.png" /></p> <p>Expliquons les rôles intervenant dans ce pattern: -Command: l'abstraction d'une action, qui permet de découpler la création de l'action de son exécution -Invocator: celui qui déclenche l'exécution des commandes (ex: un item d'un menu d'IHM) -ConcreteCommand: un type de commande particulier -Client: l'instanciateur de ConcreteCommand. Il capture les paramètres passés au constructeur de ConcreteCommand. Attention, le terme Client n'est pas à prendre au sens remoting ni au sens IHM. -Receptor: la cible d'un type de commande particulier (ex: un graphique pour une commande "drawLine"). Attention, le terme Receptor n'est pas à prendre au sens remoting.</p> <p>Ils interagissent de la façon suivante:</p> <ul> <li>Le Client capture dans le système les valeurs permettant de paramétrer une ConcreteCommand . Il l'instancie en lui passant ces paramètres.</li> <li>L'Invocator déclenche une Command,</li> <li>La ConcreteCommand exécute une action impactant le Receptor, en utilisant les paramètres que son constructeur a capturés.</li> </ul> <p>On voit que ce pattern permet bien de découpler l'instanciation d'un traitement de son exécution. C'est pour cela qu'on introduit souvent ce degré d'abstraction lorsque les lieux d'instanciation et d'exécution d'un traitement sont éloignés, dans l'espace ou dans le temps.</p> <h4>Découplage modulaire</h4> <p>Sans aller jusqu’à la séparation physique, la séparation entre modules (même co-localisés) est une motivation suffisante; le pattern Command permet&nbsp;:</p> <ul> <li>De garder des modules faiblement couplés: le module d’exécution a juste à connaitre l’interface de Command sans se soucier de la création de nouvelles commandes.</li> <li>En particulier, d'ajouter de nouveaux types de commandes (de nouvelles ConcreteCommand) dans le module de création, sans modifier le module d'exécution. Cette approche correspond au principe <a href="https://docs.google.com/a/cleancoder.com/file/d/0BwhCYaYDn8EgN2M5MTkwM2EtNWFkZC00ZTI3LWFjZTUtNTFhZGZiYmUzODc1/edit?hl=en">open-close</a> de Robert Martin (voir aussi <a href="http://www.butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod">les autres principes SOLID du même auteur</a>)</li> </ul> <h4>Découplage spatial ou temporel avec le pattern Command</h4> <p>Le problème à résoudre est ici que le point de création de la commande, qui est le seul à connaître les données nécessaires à l'exécution d'un traitement, peut être différent du point d'exécution de la commande, qui est le seul à connaître le contexte (portée/scope d'une séquence de commandes, et/ou ressources techniques) nécessaires à son exécution.</p> <h5>Découplage spatial: commande remote</h5> <p>Dans le cas spatial, la commande est typiquement créée localement et exécutée sur un serveur distant/remote (les rôles du pattern Command sont indiqués sous forme de stéréotypes UML quand il diffèrent des types propres à la variation Remote Command):</p> <p><img src="/wp-content/uploads/2015/07/.commande-2-remoting_m.jpg" alt="commande-2-remoting.png" style="display:block; margin:0 auto;" /></p> <p>La cinématique de la création d'une commande côté local et de son exécution côté distant est la suivante:</p> <ul> <li>Le Client (attention, pas au sens client-serveur) instancie la ConcreteCommand en lui passant les paramètres propres à une opération particulière</li> <li>Le constructeur de la ConcreteCommand capture ces paramètres</li> <li>Côté local, le LocalInvocator (ex: un client-proxy EJB) déclenche l'exécution de la commande en l'envoyant au RemoteInvocator distant (sérialisation/remoting)</li> <li>Côté serveur, la commande est reçue par le RemoteInvocator (ex: un server-proxy EJB)</li> <li>Le RemoteInvocator instancie un ConcreteExecutionEnvironment, en passant au constructeur de ce dernier les ressources techniques nécessaires (EntityManager, ...). Le RemoteInvocator peut par exemple être un EJB @Remote.</li> <li>Le ConcreteExecutionEnvironment construit les récepteurs concrets (DAO, ...) en utilisant les ressources techniques fournies par le RemoteInvocator (EntityManager, ...)</li> <li>Le RemoteInvocator invoque la méthode execute de la commande en lui passant cette instance de ConcreteExecutionEnvironment</li> <li>La méthode execute de la commande concrète invoque un ou plusieurs récepteurs abstraits (ex: Repository). Pour ce faire, elle récupère les Receptors cibles de la commande dans l'ExecutionEnvironment (ex: executionEnvironment.getRepository() )</li> </ul> <h5>Découplage temporel: l'undo</h5> <p>Dans le cas temporel, le problème est différent: la commande peut être exécutée tout de suite, mais elle doit pouvoir être annulée ou rejouée à un instant ultérieur et indéfini. Comme le dit le GOF, <em>un objet Commande peut avoir une durée de vie indépendante de la requête originelle</em>. Il est donc nécessaire qu'un contexte maintienne une référence vers la commande exécutée. Dans la suite on nomme ce contexte <em>Conversation</em>. Ce découplage temporel peut être utilisé de plusieurs façons:</p> <ul> <li>Introduire un niveau d’asynchronisme (léger différé) entre la création de la commande et son exécution</li> <li>Rejouer la commande ou son inverse (déclenché par la conversation)</li> </ul> <p>Dans le cas qui nous intéresse ici, la conversation mémorise les commandes exécutées et déclenche l'undo/redo. Chacune des commandes stockée par la conversation continue à contenir les paramètres spécifiques à une exécution particulière, qui avaient étés capturés lors de l'instanciation de la commande. Ce type de commande est typiquement exécutée dans le même environnement que celui où la commande a été instanciée, et la méthode execute n'a donc pas besoin d'un paramétre ExecutionEnvironnement (les ressources nécessaires à l'exécution peuvent être passées dès l'instanciation).</p> <p>L'undo par commande a la structure suivante (les rôles du pattern Command sont indiqués sous forme de stéréotypes UML quand il diffèrent des types propres à la variation Undo Command - en UML on devrait utiliser une «&nbsp;collaboration paramétrée&nbsp;» mais par simplicité on utilise ici de simples stéréotypes):</p> <p><img src="/wp-
content/uploads/2015/07/.commande-3-undo_m.jpg" alt="commande-3-undo.png" style="display:block; margin:0 auto;" /></p> <h5>Cas spatial et temporel</h5> <p>Il est évidemment possible de cumuler les deux difficultés, auquel cas le serveur devra à la fois fournir un ExecutionEnvironment, et maintenir une pile des commandes déjà exécutées (un EJB Stateful permet par exemple de remplir ces deux fonctionnalités). Puisque ce post concerne l'undo, on simplifiera cependant en supposant que les commandes sont locales (intra-JVM, sans remoting)</p> <h4>Implémentations de l'undo avec le pattern Command, tests et variations</h4> <p>Venons-en au coeur du sujet: quelles sont les implémentation possibles? Laquelle choisir pour un type de commande particulier?</p> <p>La fonctionnalité d'undo/redo est fréquemment demandée pour une IHM car l'être humain se trompe. Elle est souvent lié à une action utilisateur Ctrl+Z/Ctrl+Y. Elle n'est cependant pas triviale à implémenter, car les implémentations possibles dépendent du type de commande (comme on le verra dans la partie Critères de choix d'une variation). On propose ici trois variations du pattern, plus ou moins adaptées selon le type de commande:</p> <ul> <li>Compensation: pour chaque commande, on définit une commande inverse appelée compensation</li> <li>Memento: lors de chaque exécution de commande, on mémorise l'état du système; annuler une commande consiste alors à revenir à l'état précédent</li> <li>Replay: pour annuler la dernière commande, on commence par repositionner le système dans l'état initial (reset), puis on ré-exécute toutes les commandes sauf la dernière</li> </ul> <p>Le code est <a href="https://github.com/vandekeiser/cmd-pattern">disponible sur Github</a>. Il nécessite java 8. Le projet contient un framework d'undo par commandes. Les tests junit implémentent la commande <em>Typing</em> de saisie d'un message sur un affichage (<em>Display</em>). Il comprend une même suite de tests appliquée aux 3 variations.</p> <h5>Les interfaces principales: Command et Conversation</h5> <p>Puisqu'on se place dans le cas simple sans ExecutionEnvironment, l'interface Command est la suivante:</p> <pre class="java code java" style="font-family:inherit">@FunctionalInterface <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">interface</span> Command <span style="color: #009900;">&#123;</span> <span style="color: #000066; font-weight: bold;">void</span> execute<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>L'annotation @FunctionalInterface n'est pas obligatoire, mais elle a les avantages suivants:</p> <ul> <li>Demande au compilateur de vérifier que notre interface est une Single Abstract Method Interface, qui peut être implémentée par un lambda</li> <li>Documente ce fait aux utilisateurs de l'interface, et signale l'engagement de l'auteur du framework à maintenir cette caractéristique dans les version futures</li> </ul> <p>Introduisons la conversation, qui est le scope dans lequel on execute, annule, et rejoue des commandes:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">interface</span> Conversation<span style="color: #339933;">&lt;</span>C <span style="color: #000000; font-weight: bold;">extends</span> Command<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000066; font-weight: bold;">void</span> exec<span style="color: #009900;">&#40;</span>C cmd<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000066; font-weight: bold;">void</span> undo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000066; font-weight: bold;">void</span> redo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Le nom Conversation souligne le fait qu'il arrive souvent que le résultat d'une suite de commandes soit committé atomiquement, ce qui correspond à un scope conversation. La conversation est identifiée à l'Invocator (du pattern Command du GOF), qui a le double rôle de mémoriser et de déclencher les commandes. Ici, c'est le même Client qui instancie les commandes concrètes et qui demande à l'Invocator de les déclencher. Notons que l'interface Conversation est générique: elle porte un <em>type parameter</em> <strong>C extends Command</strong>. Le but est d'avoir une seule interface Conversation commune aux 3 variations d'undo, tout en permettant l’utilisation par ses implémentations des 3 déclinaisons de Command que nous allons présenter.</p> <h5>Les tests exécutés pour toutes les variations</h5> <p>On montre les tests (ce qu'on veut faire) avant de montrer l'implémentation (comment on le fait). Les tests utilisent une commande TypeString qui représente la saisie d'un String dans un Display (les interfaces CompensableCommand et MementoableCommand sont expliquées dans les parties sur les variations correspondantes)</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> TypeString <span style="color: #000000; font-weight: bold;">implements</span> CompensableCommand, MementoableCommand <span style="color: #009900;">&#123;</span> &nbsp; <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> Display display<span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> stringToType<span style="color: #339933;">;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> TypeString<span style="color: #009900;">&#40;</span>Display display, <span style="color: #003399;">String</span> stringToType<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">display</span> <span style="color: #339933;">=</span> display<span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">stringToType</span> <span style="color: #339933;">=</span> stringToType<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> execute<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> display.<span style="color: #006633;">append</span><span style="color: #009900;">&#40;</span>stringToType<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #009900;">&#91;</span>...<span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#125;</span></pre> <p>Le code passé sous silence pour l'instant est spécifique à une des 3 variations</p> <p>Le <em>receptor</em> (cf. partie <em>Rappels sur le pattern Command</em>) Display est la cible de la commande concrète Typing:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Display <span style="color: #009900;">&#123;</span> &nbsp; <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> LinkedList<span style="color: #339933;">&lt;</span>Stri
ng<span style="color: #339933;">&gt;</span> displayElements <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> LinkedList<span style="color: #339933;">&lt;&gt;</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> append<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> stringToAppend<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> displayElements.<span style="color: #006633;">addLast</span><span style="color: #009900;">&#40;</span>stringToAppend<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">String</span> displayed<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #666666; font-style: italic;">//Collectors.joining est équivalent à un foreach+StringBuilder mais plus fonctionnel </span> <span style="color: #666666; font-style: italic;">//(évite l'itération externe/style impératif)</span> <span style="color: #000000; font-weight: bold;">return</span> displayElements.<span style="color: #006633;">stream</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">collect</span><span style="color: #009900;">&#40;</span>Collectors.<span style="color: #006633;">joining</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #009900;">&#91;</span>...<span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#125;</span></pre> <p>Le code passé sous silence est spécifique à une des 3 variations.</p> <p>Pour s'assurer que les 3 variations sont fonctionnellement équivalentes, on écrit les tests dans une classe abstraite CommandUndoTest_Typing. Les tests commencent par les cas triviaux et vont jusqu'à une conversation complexe:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #008000; font-style: italic; font-weight: bold;">/** * Undo is noop when there were no execs * undo --&gt; &quot;&quot; */</span> @Test <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> basicNoopUndo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> Conversation<span style="color: #339933;">&lt;</span>C<span style="color: #339933;">&gt;</span> commands <span style="color: #339933;">=</span> newConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">undo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #008000; font-style: italic; font-weight: bold;">/** * Redo is noop when there were no undos * redo --&gt; &quot;&quot; */</span> @Test <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> basicNoopRedo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> Conversation<span style="color: #339933;">&lt;</span>C<span style="color: #339933;">&gt;</span> commands <span style="color: #339933;">=</span> newConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">redo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #008000; font-style: italic; font-weight: bold;">/** * Basic undo * a    --&gt; &quot;a&quot; * undo --&gt; &quot;&quot; */</span> @Test <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> basicUndo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> Conversation<span style="color: #339933;">&lt;</span>C<span style="color: #339933;">&gt;</span> commands <span style="color: #339933;">=</span> newConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">exec</span><span style="color: #009900;">&#40;</span>typeString<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;a&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;a&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">undo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #008000; font-style: italic; font-weight: bold;">/** * Basic redo * a    --&gt; &quot;a&quot; * undo --&gt; &quot;&quot; * redo --&gt; &quot;a&quot; */</span> @Test <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> basicRedo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> Conversation<span style="color: #339933;">&lt;</span>C<span style="color: #339933;">&gt;</span> commands <span style="color: #339933;">=</span> newConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">exec</span><span style="color: #009900;">&#40;</span>typeString<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;a&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;a&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</
span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">undo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">redo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;a&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #008000; font-style: italic; font-weight: bold;">/** * a    --&gt; &quot;a&quot; * b    --&gt; &quot;ab&quot; * undo --&gt; &quot;a&quot; * undo --&gt; &quot;&quot; * redo --&gt; &quot;a&quot; * redo --&gt; &quot;ab&quot; */</span> @Test <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> exec_exec_undo_undo_redo_redo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> Conversation<span style="color: #339933;">&lt;</span>C<span style="color: #339933;">&gt;</span> commands <span style="color: #339933;">=</span> newConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">exec</span><span style="color: #009900;">&#40;</span>typeString<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;a&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;a&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">exec</span><span style="color: #009900;">&#40;</span>typeString<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;b&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;ab&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">undo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;a&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">undo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">redo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;a&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; commands.<span style="color: #006633;">redo</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;ab&quot;</span>, display.<span style="color: #006633;">displayed</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Certains des tests peuvent être consultés dans le code sur Github mais ne sont pas mentionnés ici pour alléger l'article.</p> <p>Les classes concrètes spécifiques aux 3 variations ne font qu'instancier un type différent de Conversation (à un détail technique près, propre aux génériques java):</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CommandUndoTest_Compensation_Typing_Test <span style="color: #000000; font-weight: bold;">extends</span> CommandUndoTest_Typing<span style="color: #339933;">&lt;</span>CompensableCommand<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> @Override <span style="color: #000000; font-weight: bold;">protected</span> Conversation<span style="color: #339933;">&lt;</span>CompensableCommand<span style="color: #339933;">&gt;</span> newConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> CompensationConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">protected</span> CompensableCommand typeString<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> stringToType<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> TypeString<span style="color: #009900;">&#40;</span>display, stringToType<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CommandUndoTest_Replay_Typing_Test <span style="color: #000000; font-weight: bold;">extends</span> CommandUndoTest_Typing<span style="color: #339933;">&lt;</span>Command<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> @Override <span style="color: #000000; font-weight: bold;">protected</span> Conversation<span style="color: #339933;">&lt;</span>Command<span style="color: #339933;">&gt;</span> newConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> <span s
tyle="color: #000000; font-weight: bold;">new</span> ReplayConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">-&gt;</span><span style="color: #009900;">&#123;</span> display.<span style="color: #006633;">reset</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">protected</span> Command typeString<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> stringToType<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> TypeString<span style="color: #009900;">&#40;</span>display, stringToType<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CommandUndoTest_Memento_Typing_Test <span style="color: #000000; font-weight: bold;">extends</span> CommandUndoTest_Typing<span style="color: #339933;">&lt;</span>MementoableCommand<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> @Override <span style="color: #000000; font-weight: bold;">protected</span> Conversation<span style="color: #339933;">&lt;</span>MementoableCommand<span style="color: #339933;">&gt;</span> newConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> MementoConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">protected</span> MementoableCommand typeString<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> stringToType<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> TypeString<span style="color: #009900;">&#40;</span>display, stringToType<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <h5>Coeur de l'implémentation</h5> <p>Le coeur de l'implémentation est l'utilisation de 2 stacks (FIFO), une pour l'undo et une pour le redo: intuitivement, on sent bien que:</p> <ul> <li>chaque exécution de commande rajoute un undo potentiel</li> <li>chaque undo rajoute un redo potentiel</li> </ul> <p>La classe AbstractConversation utilise 2 paramètres de type, <strong>C</strong> et <strong>S</strong>. En effet, chacune des 3 implémentations concrètes de Conversation a besoin de connaître:</p> <ul> <li>Le type de commandes exécutés (paramètre <strong>C</strong>), qui dérive de Command. Par exemple CompensationConversation ne peut accepter que des CompensableCommand.</li> <li>Le type d'état conversationnel stocké (paramètre <strong>S</strong>). Dans la variante Memento, on ne mémorise pas les commandes mais plutôt des snapshots de l'état du système (dans l'interface Conversation il n'y a toujours que le paramètre C, car le type d'état conversationnel stocké est un détail d'implémentation du point de vue de l'utilisateur de l'API Conversation)</li> </ul> <p>La classe AbstractConversation se présente ainsi:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #008000; font-style: italic; font-weight: bold;">/** *  @param &lt;C&gt; Type of executed commands * @param &lt;S&gt; Type of stored state (commands or mementos) */</span> <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">abstract</span> <span style="color: #000000; font-weight: bold;">class</span> AbstractConversation<span style="color: #339933;">&lt;</span>C <span style="color: #000000; font-weight: bold;">extends</span> Command, S<span style="color: #339933;">&gt;</span> <span style="color: #000000; font-weight: bold;">implements</span> Conversation<span style="color: #339933;">&lt;</span>C<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000000; font-weight: bold;">final</span> Stack<span style="color: #339933;">&lt;</span>S<span style="color: #339933;">&gt;</span> undos, redos<span style="color: #339933;">;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> AbstractConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">undos</span><span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Stack<span style="color: #339933;">&lt;</span>S<span style="color: #339933;">&gt;</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">redos</span><span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Stack<span style="color: #339933;">&lt;</span>S<span style="color: #339933;">&gt;</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span> AbstractConversation utilise la classe <span style="color: #003399;">Stack</span> <span style="color: #009900;">&#40;</span>classe interne au framework<span style="color: #009900;">&#41;</span><span style="color: #339933;">:</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Stack<span style="color: #339933;">&lt;</span>T<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> &nbsp; <span style="color: #666666; font-style: italic;">//Delegate to avoid exposing too many Deque methods</span> <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> Deque<span style="color: #339933;">&lt;</span>T<span style="color: #339933;">&gt;</span> stack <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> LinkedList<span style="color: #339933;">&lt;&gt;</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; <span style="color: #008000; font-style: italic; font-weight: bold;">/** * @return null if stack is empty */</span> <span style="color: #000000; font-weight: bold;">public</span> T pop<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> stack.<span style="color: #006633;">pollLast</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">//Not using pop since it throws NoSuchElementException if the deque is empty</span> <span style="color: #009900;"
>&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> push<span style="color: #009900;">&#40;</span>T cmd<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> stack.<span style="color: #006633;">addLast</span><span style="color: #009900;">&#40;</span>cmd<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> clear<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> stack.<span style="color: #006633;">clear</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> forEachFifo<span style="color: #009900;">&#40;</span>Consumer<span style="color: #339933;">&lt;?</span> <span style="color: #000000; font-weight: bold;">super</span> T<span style="color: #339933;">&gt;</span> action<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> stack.<span style="color: #006633;">stream</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">forEachOrdered</span><span style="color: #009900;">&#40;</span>action<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Stack délègue à une Deque (double-ended queue) l'implémentation de la stack; en effet il existe une classe java.util.Stack mais elle est obsolète comme Vector. Déléguer à LinkedList plutôt que l'étendre présente 2 avantages:</p> <ul> <li>Evite la pollution d'API: Stack n'expose que les méthodes utiles pour notre framework</li> <li>Liberté de nommage: dans Deque, push() et pop() n'ont pas la sémantique souhaitée (pop(): exception si vide) donc on utilise pollLast()/addLast(). Mais push et pop sont plus compréhensibles donc ce sont ces noms-là qu'on expose à notre framework</li> </ul> <p>Enfin, précisons que forEachFifo() est utilisé par la variation Replay. FIFO signifie first-in first-out donc un parcours dans l'ordre d'insertion.</p> <h5>Variation: Undo par Compensation</h5> <p>L'infrastructure étant en place, regardons la première variation qui est la plus naturelle. Une action compensatoire d'une action A consiste à effectuer l'action inverse -A. Par exemple, l'action compensatoire d'un débit erronné de x EUR est un crédit de x EUR.</p> <p>Dans le pattern Command, ceci se traduit par une commande compensable:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">interface</span> CompensableCommand <span style="color: #000000; font-weight: bold;">extends</span> Command <span style="color: #009900;">&#123;</span> <span style="color: #000066; font-weight: bold;">void</span> compensate<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>On a vu dans le paragraphe <em>Découplage temporel: l'undo</em> que la conversation pouvait être identifiée à l'acteur <em>Invocator</em> du pattern Command du GOF. CompensationConversation est l'Invocator spécialisé pour les commandes compensables:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CompensationConversation <span style="color: #000000; font-weight: bold;">extends</span> AbstractConversation<span style="color: #339933;">&lt;</span>CompensableCommand, CompensableCommand<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> exec<span style="color: #009900;">&#40;</span>CompensableCommand todo<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> todo.<span style="color: #006633;">execute</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> undos.<span style="color: #006633;">push</span><span style="color: #009900;">&#40;</span>todo<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> redos.<span style="color: #006633;">clear</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> undo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> CompensableCommand latestCmd <span style="color: #339933;">=</span> undos.<span style="color: #006633;">pop</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>latestCmd<span style="color: #339933;">==</span><span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">return</span><span style="color: #339933;">;</span> latestCmd.<span style="color: #006633;">compensate</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> redos.<span style="color: #006633;">push</span><span style="color: #009900;">&#40;</span>latestCmd<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> redo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> CompensableCommand latestCmd <span style="color: #339933;">=</span> redos.<span style="color: #006633;">pop</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>latestCmd<span style="color: #339933;">==</span><span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">return</span><span style="color: #339933;">;</span> latestCmd.<span style="color: #006633;">execute</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> undos.<span style="color: #006633;">push</span><span style="color: #009900;">&#40;</span>latestCmd<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Dans la variation Compensation, les deux type parameters sont identiques (<strong>S=C=CompensableCommand</strong> dans <strong>AbstractConversation&lt;C,S&gt;</strong>), puisque l'état mémorisé est constitué de commandes. En effet, la compensation utilise les commandes déjà exécutées pour les compenser (undo) ou les réexécuter (redo).</p> <p>A la fin d'exec(), on vide la stack de redo: les commandes undoées qui précèdent l'exécution d'une commande sont complètem
ent effacées de la mémoire. La raison de ce choix est de se conformer aux conventions de toutes les IHM offrant un undo/redo (principe de moindre surprise).</p> <p>Il est évidemment nécessaire dans cette variation que les commandes utilisées soient compensable; pour la commande de test TypeString, cette fonctionnalité se traduit par le fait que TypeString implémente CompensableCommand et non pas simplement Command:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> TypeString <span style="color: #000000; font-weight: bold;">implements</span> CompensableCommand <span style="color: #009900;">&#123;</span> @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> compensate<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> display.<span style="color: #006633;">unappend</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <h5>Variation: Undo par Replay</h5> <p>Il est parfois difficile de trouver une action compensatrice. Dans ce cas si on a invoqué N commandes, une implémentation alternative de l'undo est de réinitialiser l'état à zéro, puis de rejouer les N-1 premières commandes. Le redo consiste ensuite à rejouer la Nième commande.</p> <p>Contrairement à la variation <em>Compensation</em>, puisque la variation <em>Replay</em> se repose uniquement sur l'exécution des commandes dans leur sens normal, ReplayConversation n'a pas besoin d'un type de commande particulier de commandes: <strong>S=C=Command</strong> dans <strong>AbstractConversation&lt;C,S&gt;</strong>). Par contre elle a besoin d'une instance de commande capable de resetter l'état à zéro:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> ReplayConversation <span style="color: #000000; font-weight: bold;">extends</span> AbstractConversation<span style="color: #339933;">&lt;</span>Command, Command<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> Command reset<span style="color: #339933;">;</span> &nbsp; <span style="color: #000000; font-weight: bold;">public</span> ReplayConversation<span style="color: #009900;">&#40;</span>Command reset<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">reset</span> <span style="color: #339933;">=</span> reset<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> exec<span style="color: #009900;">&#40;</span>Command todo<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> todo.<span style="color: #006633;">execute</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> undos.<span style="color: #006633;">push</span><span style="color: #009900;">&#40;</span>todo<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> redos.<span style="color: #006633;">clear</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> undo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> Command latestCmd <span style="color: #339933;">=</span> undos.<span style="color: #006633;">pop</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>latestCmd<span style="color: #339933;">==</span><span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">return</span><span style="color: #339933;">;</span> redos.<span style="color: #006633;">push</span><span style="color: #009900;">&#40;</span>latestCmd<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> reset.<span style="color: #006633;">execute</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> undos.<span style="color: #006633;">forEachFifo</span><span style="color: #009900;">&#40;</span>cmd<span style="color: #339933;">-&gt;</span>cmd.<span style="color: #006633;">execute</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> redo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> Command latestCmd <span style="color: #339933;">=</span> redos.<span style="color: #006633;">pop</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>latestCmd<span style="color: #339933;">==</span><span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">return</span><span style="color: #339933;">;</span> latestCmd.<span style="color: #006633;">execute</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> undos.<span style="color: #006633;">push</span><span style="color: #009900;">&#40;</span>latestCmd<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Le reset de l'état utilise une commande spécifique au type d'état modifié par les commandes. Dans le cas de la commande Typing (saisie) qui modifie un Display (affichage), on peut simplement effacer complètement l'affichage:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CommandUndoTest_Replay_Typing_Test <span style="color: #000000; font-weight: bold;">extends</span> CommandUndoTest_Typing<span style="color: #339933;">&lt;</span>Command<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> @Override <span style="color: #000000; font-weight: bold;">protected</span> Conversation<span style="color: #339933;">&lt;</span>Command<span style="color: #339933;">&gt;</span> newConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> ReplayConversation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">-&gt;</span><span style="
color: #009900;">&#123;</span> display.<span style="color: #006633;">clear</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Le lambda qui est passé au constructeur de ReplayConversation correspond au champ <strong>ReplayConversation.reset</strong>. Il vide l'affichage.</p> <h5>Variation: Undo par Memento</h5> <p>Plutôt que de mémoriser les commandes, on peut aussi implémenter l'undo en mémorisant leur effet, plus précisément l'état du système avant et après chaque exécution.</p> <p>Ceci évoque un autre pattern du GOF, le <em>Memento</em>:</p> <p><img src="/wp-content/uploads/2015/07/.commande-4-memento_m.jpg" alt="commande-4-memento.png" style="display:block; margin:0 auto;" /></p> <p>L<em>'Originator</em> instancie un <em>Memento</em> en passant à son constructeur un snapshot de l'état du système. Le <em>CareTaker</em> est chargé de connaître le Memento, afin de pouvoir demander, ultérieurement, la restauration de l'état capturé.</p> <p>Le Memento doit être capable de restaurer un état capturé antérieurement, d'où l'exigence d'immutabilité. On ne veut pas voir les changements de l'état du système postérieurs au snapshot, il faut donc utiliser des techniques comme la <em>copie défensive</em>. Comme Memento est une interface, on précise cette exigence dans le contrat sous forme de javadoc:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #008000; font-style: italic; font-weight: bold;">/** * Implementations must be immutable (the memento must capture a snapshot) */</span> @FunctionalInterface <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">interface</span> Memento <span style="color: #009900;">&#123;</span> <span style="color: #000066; font-weight: bold;">void</span> restore<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Chaque type de commande peut modifier un type d'état différent, pour lequel la façon de capturer un Memento sera différente. Par exemple la capture d'un état persisté en BD sera très différente de la capture de l'état d'un logiciel de dessin. Le plus simple est donc de spécialiser Command en MementoableCommand, pour que les implémentations de MementoableCommand réalisent à la fois la modification et la capture de cet état, suivant les spécificités de ce dernier:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">interface</span> MementoableCommand <span style="color: #000000; font-weight: bold;">extends</span> Command <span style="color: #009900;">&#123;</span> Memento takeSnapshot<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span></pre> <p>Dans la variation Memento, les deux type parameters ne sont pas identiques (<strong>C=MementoableCommand</strong>, <strong>S=BeforeAfter dans AbstractConversation&lt;C,S&gt;</strong>), puisque l'état mémorisé est constitué de captures successives de l'état et non de commandes. Petite subtilité: pour implémenter le redo, on a besoin de capturer l'état avant ET après exécution de la commande:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> MementoConversation <span style="color: #000000; font-weight: bold;">extends</span> AbstractConversation<span style="color: #339933;">&lt;</span>MementoableCommand, BeforeAfter<span style="color: #339933;">&gt;</span> <span style="color: #009900;">&#123;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> exec<span style="color: #009900;">&#40;</span>MementoableCommand todo<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> Memento before <span style="color: #339933;">=</span> todo.<span style="color: #006633;">takeSnapshot</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> todo.<span style="color: #006633;">execute</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> Memento after <span style="color: #339933;">=</span> todo.<span style="color: #006633;">takeSnapshot</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> &nbsp; undos.<span style="color: #006633;">push</span><span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">new</span> BeforeAfter<span style="color: #009900;">&#40;</span>before, after<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> redos.<span style="color: #006633;">clear</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> undo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> BeforeAfter latestMemento <span style="color: #339933;">=</span> undos.<span style="color: #006633;">pop</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>latestMemento<span style="color: #339933;">==</span><span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">return</span><span style="color: #339933;">;</span> Memento latestBefore <span style="color: #339933;">=</span> latestMemento.<span style="color: #006633;">before</span><span style="color: #339933;">;</span> latestBefore.<span style="color: #006633;">restore</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> redos.<span style="color: #006633;">push</span><span style="color: #009900;">&#40;</span>latestMemento<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> redo<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> BeforeAfter latestMemento <span style="color: #339933;">=</span> redos.<span style="color: #006633;">pop</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">&#40;</span>latestMemento<span style="color: #339933;">==</span><span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">return</span><span style="color: #339933;">;</span> Memento latestAfter <span style="color: #339933;">=</span> latestMemento.<span style="color: #006633;">after</span><span style="color: #339933;">;</span> latestAfter.<span style="color: #006633;">restore</span><span style="color: #009900;">&#40;</span
><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> undos.<span style="color: #006633;">push</span><span style="color: #009900;">&#40;</span>latestMemento<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span> &nbsp; <span style="color: #666666; font-style: italic;">//@Immutable</span> <span style="color: #000000; font-weight: bold;">class</span> BeforeAfter <span style="color: #009900;">&#123;</span> &nbsp; <span style="color: #000000; font-weight: bold;">final</span> Memento before, after<span style="color: #339933;">;</span> &nbsp; <span style="color: #008000; font-style: italic; font-weight: bold;">/** * @param before must be immutable * @param after  must be immutable */</span> <span style="color: #000000; font-weight: bold;">public</span> BeforeAfter<span style="color: #009900;">&#40;</span>Memento before, Memento after<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">before</span> <span style="color: #339933;">=</span> before<span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">after</span> <span style="color: #339933;">=</span> after<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <p>Dans cette variation, la commande est donc l<em>'Originator</em> du pattern Memento du GOF (l'acteur qui déclenche le snapshot), et la conversation en est le Caretaker (l'acteur qui mémorise les mementos). Les rôles du pattern Memento sont indiqués sous forme de stéréotypes UML quand il diffèrent des types propres à la variation Memento Undo Command)</p> <p><img src="/wp-content/uploads/2015/07/.commande-5-memento_m.jpg" alt="commande-5-memento.png" style="display:block; margin:0 auto;" /></p> <h4>Critères de choix d'une variation</h4> <p>Le critère éliminatoire est la possibilité d'implémenter une variation. Cette possibilité ou impossibilité dépend essentiellement de deux facteurs:</p> <ul> <li>Le type de <em>Receptor</em> des commandes: les tests communs aux 3 variations utilisent tous le même type de Receptor, la classe Display. Celle-ci implémente des méthodes permettant de choisir n'importe laquelle des variations. Ainsi unappend() est nécessaire pour implémenter la variation Compensation, getState()/setState() sont nécessaires pour implémenter la variation Memento; et clear() est nécessaire pour implémenter la variation Replay. Pour un Receptor réel, il est peu vraisemblable d'avoir autant de liberté de choix.</li> <li>Le type de commandes concrètes: certaines commandes ne se prêtent pas du tout à certaines variations.</li> </ul> <p>Voyons pour chacune des trois variations quelques critères spécifiques.</p> <h5>Compensation Undo</h5> <p>Facteurs favorables:</p> <ul> <li>La Compensation est la plus naturelle (symétrie entre la commande et son inverse)</li> <li>Cette variation est idéale quand il existe une commande inverse naturelle dont le nom est évident: le contraire d'une création est une suppression (et vice-versa), le contraire d'un débit est un crédit (vice-versa)</li> <li>Ceci fonctionne bien quand la sémantique de la commande est très précise et a peu de degrés de libertés</li> <li>Du point de vue de l'utilisation mémoire, une stack de commandes est souvent plus léger que des snapshots de l'état complet (VS Memento),</li> <li>Du point de vue performance, elle évite de rejouer une séquence de commandes (VS Replay) ou de repositionner un gros état (VS Memento).</li> </ul> <p>Facteurs défavorables:</p> <ul> <li>Les commandes non-compensables ne peuvent utiliser cette variation. Par exemple l'écriture dans un log ne peut être compensée.</li> <li>Une commande très générale comme un "update" est difficile à compenser: il faut mémoriser tous les champs mis à jour, utiliser l'introspection, ..</li> <li>Le nombre et la variété de commandes concrètes: pour choisir cette variation, il faut être sûr à l'avance qu'on pourra compenser toutes les commandes (même celles qui peuvent être introduites par une évolution future de l'application)</li> <li>Il est difficile de compenser les modifications de relations entre objets d'un graphe, surtout si ces relations sont bidirectionnelles</li> </ul> <p>Remarques:</p> <ul> <li>La méthode Domain Driven Design préconise de toute façon d'éviter les commandes très générales comme l'update générique (POST), et de modéliser les changements d'état par des transitions déclenchées par des événements (<strong>PUT /event {eventData}</strong>). Les transitions ont une sémantique plus précise et sont plus facile à compenser.</li> <li>Quand tous les changements de l'état applicatif sont stockés comme une séquence d'événements (Event Sourcing), doit-on forcément utiliser les actions compensatoires? Pas forcément, tant que l'événement qu'on veut annuler n'est pas définitif (tant qu'il fait partie d'une conversation pas encore commitée).</li> </ul> <h5>Variation: Memento Undo</h5> <p>Facteurs favorables:</p> <ul> <li>Quand les commandes individuelles ne sont pas (ou difficilement) compensables, ou que le système présente une hysteresis</li> <li>Quand l'API du <em>Receptor</em> donne un moyen direct de réaliser des snapshots</li> <li>Quand on peut modifier ou wrapper un Receptor existant pour se ramener au cas précédent</li> </ul> <p>Facteurs défavorables:</p> <ul> <li>Quand le Receptor est write-only ou qu'il est difficile de capturer son état</li> <li>Lorsque les contraintes sur la mémoire sont trop importantes</li> </ul> <h5>Variation: Replay Undo</h5> <p>Facteurs favorables:</p> <ul> <li><em>When all else fails</em>: cette variation est celle qui fait le moins d'hypothèses sur le Receptor: il suffit qu'il puisse être remis à zéro.</li> <li>Si on ne peut pas utiliser la variation Compensation, le Replay utilise dans la plupart des cas moins de mémoire car les commandes prennent moins de place que les mementos</li> </ul> <p>Facteurs défavorables:</p> <ul> <li>Pas très élégant quand on peut faire autrement</li> <li>Ne doit pas être rédhibitoire du point de vue des performances</li> </ul> <h4>Autres considérations</h4> <h5>Profondeur de l'undo-redo</h5> <p>Dans notre exemple, les stacks d'undo/redo ont une profondeur illimitée. Ceci peut provoquer une OutOfMemoryError, et de toute façon l'utilisateur ne se rappelle plus des opérations trop anciennes. Le principe GRASP (attribution de responsabilités) <em>expert en information</em> nous suggère de placer la gestion de cette limitation dans le type qui a la connaissance de la profondeur actuelle de la stack, donc Stack.</p> <h5>Commandes et macros</h5> <p>A partir du pattern Command il est très simple de définir des macros: il suffit d'utiliser en plus le pattern Composite (les rôles du pattern Composite sont indiqués sous forme de stéréotypes UML quand il diffèrent des types propres à la variation Command Macro):</p> <p><img src="/wp-content/uploads/2015/07/.commande-6-macro_m.jpg" alt="commande-6-macro.png" style="display:block; margin:0 auto;" /></p> <p>Les macros sont simples à implémenter avec le pattern Command:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Macro <span style="color: #000000; font-weight: bold;">implements</span> Command <span style="color: #009900;">&#123;</span> &nbsp; <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">final</span> List<span style="color: #339933;">&lt;</span>Command<span style="color: #339933;">&gt;</span> parts<span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">public</span> Macro<span style="color: #009900;">&#40;</span>List<span style="color: #3399
33;">&lt;</span>Command<span style="color: #339933;">&gt;</span> parts<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">parts</span> <span style="color: #339933;">=</span> parts<span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> &nbsp; @Override <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> execute<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <span style="color: #000000; font-weight: bold;">this</span>.<span style="color: #006633;">parts</span>.<span style="color: #000000; font-weight: bold;">forEach</span><span style="color: #009900;">&#40;</span>c <span style="color: #339933;">-&gt;</span> c.<span style="color: #006633;">execute</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#125;</span></pre> <h4>Conclusion</h4> <p>Le pattern Command est la façon la plus répandue d'implémenter l'undo. Comme souvent en conception orientée objet, la solution est de remplacer l'invocation directe d'une méthode par la création d'un objet (ici, la commande). Cette technique est également très utile pour refactorer du code procédural (cf. Working effectively with legacy code).</p> <p>La fonction d'undo/redo peut être difficile à implémenter suivant le type d'état modifié. Cette fonctionnalité est structurante, et ne peut pas toujours être rajoutée a posteriori dans une conception existante sans un très gros refactor, alors incluez-la dès le début si c'est nécessaire. Attention aux bugs de type effet de bord, cette fonctionnalité doit absolument avoir une bonne couverture de tests.</p>