---
ID: 131
post_title: 'Unfiltered &#8211; Implémenter des services REST en Scala'
author: Florian Hussonois
post_date: 2013-02-04 09:30:00
post_excerpt: |
  <p>La définition de REST trouve toute son essence à travers le protocole HTTP. Pourtant, la plupart des frameworks actuels reposent sur des API Java encore trop éloignées de ce dernier. La spécification de la JAX-RS (Java API for RESTful Web Services) a permis de simplifier la création de services REST au sein des applications JEE, entre autre, via l’utilisation des annotations. Cependant, ces implémentations gardent le plus souvent un accès direct à l’API Servlet rendant ainsi les applications web dépendantes du serveur d’applications sur lequel elles sont déployées. <br />
  <br />
  Unfiltered (<a href="http://unfiltered.databinder.net" hreflang="en">http://unfiltered.databinder.net</a>) est un “micro framework” web qui permet ni plus ni moins l’intégration de services REST en Scala. Il est développé en partie par Nathan Hamblen. Unfiltered définit, entre autre, un niveau d’abstraction élevé pour le traitement des requêtes et des réponses, de manière à pouvoir exécuter toutes applications, utilisant la librairie “core”, sur une variété de serveurs, tel que Tomcat ou encore Netty. <br />
  <br />
  La librairie se présente comme une simple couche de transition entre HTTP et Scala. Comme beaucoup d’autres frameworks, elle adopte pleinement certains concepts du langage comme pierre angulaire de son API. Pour cela, elle offre une approche élégante pour router les requêtes HTTP entrantes à travers l’utilisation du pattern matching.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=131
published: true
---
<p>La définition de REST trouve toute son essence à travers le protocole HTTP. Pourtant, la plupart des frameworks actuels reposent sur des API Java encore trop éloignées de ce dernier. La spécification de la JAX-RS (Java API for RESTful Web Services) a permis de simplifier la création de services REST au sein des applications JEE, entre autre, via l’utilisation des annotations. Cependant, ces implémentations gardent le plus souvent un accès direct à l’API Servlet rendant ainsi les applications web dépendantes du serveur d’applications sur lequel elles sont déployées. <br />
<br />
Unfiltered (<a href="http://unfiltered.databinder.net" hreflang="en">http://unfiltered.databinder.net</a>) est un “micro framework” web qui permet ni plus ni moins l’intégration de services REST en Scala. Il est développé en partie par Nathan Hamblen. Unfiltered définit, entre autre, un niveau d’abstraction élevé pour le traitement des requêtes et des réponses, de manière à pouvoir exécuter toutes applications, utilisant la librairie “core”, sur une variété de serveurs, tel que Tomcat ou encore Netty. <br />
<br />
La librairie se présente comme une simple couche de transition entre HTTP et Scala. Comme beaucoup d’autres frameworks, elle adopte pleinement certains concepts du langage comme pierre angulaire de son API. Pour cela, elle offre une approche élégante pour router les requêtes HTTP entrantes à travers l’utilisation du pattern matching.</p>
<!--more-->
<h3>Un premier exemple</h3> <p>Pour vous présenter les différents éléments de l’API et le vocabulaire utilisé au sein de celle-ci, voici un premier exemple.</p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">object</span> SayHello <span style="color: #F78811;">&#123;</span>   <span style="color: #0000ff; font-weight: bold;">val</span> intent <span style="color: #000080;">=</span> unfiltered.<span style="color: #000000;">Cycle</span>.<span style="color: #000000;">Intent</span><span style="color: #F78811;">&#91;</span>Any, Any<span style="color: #F78811;">&#93;</span> <span style="color: #F78811;">&#123;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> req<span style="color: #000080;">@</span>Path<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;/hello&quot;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> POST<span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">&amp;</span> Params<span style="color: #F78811;">&#40;</span>params<span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> 	Ok ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;Hello &quot;</span> + params<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;name&quot;</span><span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#40;</span>0<span style="color: #F78811;">&#41;</span>.<span style="color: #000000;">toString</span><span style="color: #F78811;">&#41;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #000080;">_</span> <span style="color: #000080;">=&gt;</span> MethodNotAllowed ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;Method must be POST&quot;</span><span style="color: #F78811;">&#41;</span>     <span style="color: #F78811;">&#125;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> req<span style="color: #000080;">@</span>Path<span style="color: #F78811;">&#40;</span>Seg<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;hello&quot;</span> <span style="color: #000080;">::</span> name <span style="color: #000080;">::</span> Nil<span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> GET<span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> 	Ok ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;Hello &quot;</span> + name<span style="color: #F78811;">&#41;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #000080;">_</span> <span style="color: #000080;">=&gt;</span> MethodNotAllowed ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;Method must be GET&quot;</span><span style="color: #F78811;">&#41;</span>     <span style="color: #F78811;">&#125;</span>   <span style="color: #F78811;">&#125;</span> <span style="color: #F78811;">&#125;</span></pre> <h4>Intents</h4> <p>Tout d’abord, dans notre exemple nous avons commencé par implémenter une fonction appelée <em>Intent</em> et dont la spécification est la suivante:</p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">type</span> ResponseFunction<span style="color: #F78811;">&#91;</span>B<span style="color: #F78811;">&#93;</span> <span style="color: #000080;">=</span> HttpResponse<span style="color: #F78811;">&#91;</span>B<span style="color: #F78811;">&#93;</span> <span style="color: #000080;">=&gt;</span> HttpResponse<span style="color: #F78811;">&#91;</span>B<span style="color: #F78811;">&#93;</span> <span style="color: #0000ff; font-weight: bold;">type</span> Intent<span style="color: #F78811;">&#91;</span>T<span style="color: #F78811;">&#93;</span> <span style="color: #000080;">=</span> PartialFunction<span style="color: #F78811;">&#91;</span>HttpRequest<span style="color: #F78811;">&#91;</span>T<span style="color: #F78811;">&#93;</span>, ResponseFunction<span style="color: #F78811;">&#93;</span></pre> <p>Cette fonction représente l’interface principale de l’API avec pour objectif de matcher une requête et de retourner une fonction permettant de produire la réponse correspondante. <br />
<br />
Dans le cas présent, notre Intent matche les deux requêtes ci-dessous:</p> <ul> <li>POST /hello</li> <li>GET /hello/{name}</li> </ul> <p>Puis, elle retourne en réponse la chaîne de caractères “Hello “ suivi du paramètre ‘name’. Par ailleurs, si une des URI est appelée avec une méthode HTTP qui n’est pas supportée, une erreur est alors retournée.</p> <h4>Plans</h4> <p>La définition d’une <em>Intent</em> n’est pas directement liée à une interface serveur particulière. De ce fait, Unfiltered définit un ensemble de traits dont le rôle est de lier une <em>Intent</em> à une interface serveur spécifique. Ces traits sont désignés sous le nom de <em>Plan</em>. Par exemple, le trait <code>unfiltered.filter.Plan</code> est une implémentation de l’interface <code>javax.servlet.Filter</code> qui délègue le traitement de la requête à sa méthode ‘intent’.</p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">object</span> SayHelloFilter <span style="color: #0000ff; font-weight: bold;">extends</span> 	unfiltered.<span style="color: #000000;">filter</span>.<span style="color: #000000;">Planify</span><span style="color: #F78811;">&#40;</span>SayHello.<span style="color: #000000;">intent</span><span style="color: #F78811;">&#41;</span></pre> <p>De la même manière, l’API définit un channel handler pour Netty. <br /></p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">object</span> SayHelloHandler <span style="color: #0000ff; font-weight: bold;">extends</span> 	unfiltered.<span style="color: #000000;">netty</span>.<span style="color: #000000;">cycle</span>.<span style="color: #000000;">Planify</span><span style="color: #F78811;">&#40;</span>SayHello.<span style="color: #000000;">intent</span><span style="color: #F78811;">&#41;</span></pre> <p>Unfiltered utilise des classes génériques HttpRequest et HttpResponse pour encapsuler les objets propres à l’interface serveur sous-adjacente. Cependant, chacune d’entre elles, expose une méthode ‘underlying’ donnant un accès direct aux objets en question. Ainsi, dans un contexte de conteneur de servlets, il reste possible de manipuler directement les objets HttpServletRequest/HttpServletResponse au sein de votre application.</p> <h4>Extractors</h4> <p>Intéressons-nous plus en détail à l’implémentation de notre Intent et plus précisément, à la manière dont une HttpRequest est routée. Comme mentionné un peu plus tôt, Unfiltered repose sur l’utilisation du pattern matching mais également sur celle des extracteurs. Les extracteurs sont un des mécanismes Scala permettant d’extraire des données d’un objet sur lequel est appliqué un pattern matching. <br />
La plupart des extracteurs, fournis par l’API d’Unfiltered, définissent une méthode unapply() qui accepte en argument un objet HttpRequest:</p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">def</span> unapply<span style="color: #F78811;">&#40;</span>x<span style="color: #000080;">:</span> HttpRequest<span style="color: #F78811;">&#41;</span><span style="color: #000080;">:</span> <span style="color: #F78811;">&#40;</span>Y, HttpRequest<span style="color: #F78811;">&#41;</span></pre> <p>Souvent, cette méthode retournera l’objet extrait de la requête sous la forme d’un <code>Option[T]</code>. Cependant, il peut s’avérer utile de retourner l’objet HttpRequest pour permettre le chaînage des extracteurs entre eux. <br />
Dans l’exemple ci-dessus, nous utilisons quelques-uns d’entre eux pour router notre requête en fonction du <code>Path( )</code> ou encore de la méthode HTTP avec <code>GET(_)</code> et <code>POST(_)</code>. On trouve également l’objet Seg qui permet d’extraire une liste de String depuis les différents éléments du Path (séparés par des slashes (‘/’)). Enfin, nous utilisons l’objet Params pour extraire les paramètres HTTP sous la forme d’une <code>Map[String, Seq[String]]</code>. <br />
<br />
Unfiltered possède de nombreux autres extracteurs, très intuitifs de par leur nom, pour matcher une HttpRequest. Cependant, vous serez rapidement amenés à créer vos propres extracteurs dans le but d’extraire le corps de la requête dans un certain format (par exemple Json) ou encore valider des paramètres. La validation des données étant une problématique récurrente, dès qu’il s’agit de manipuler des données client, Unfiltered propose la classe Params.Extract pour faciliter la création d’extracteurs dont le rôle s’y prête. <br />
<br />
L’utilisation de l’extracteur Params ne permet pas d’effectuer de contrôle sur les données dans le cas d’une requête POST; Il serait alors tout à fait possible de passer un paramètre vide. <br />
<br />
Il suffit alors de définir un extracteur à l’aide de la classe <code>Params.Extract</code>, et de le chaîner à l’extracteur Params: <br /></p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">object</span> NonEmptyName <span style="color: #0000ff; font-weight: bold;">extends</span> Params.<span style="color: #000000;">Extract</span><span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;name&quot;</span>,Params.<span style="color: #000000;">first</span> ~<span style="color: #000080;">&gt;</span> Params.<span style="color: #000000;">nonempty</span><span style="color: #F78811;">&#41;</span></pre> <p>Le premier paramètre correspond au nom du paramètre à extraire. Le deuxième paramètre correspond à un ParamMapper permettant d’effectuer une transformation sur le paramètre extrait. La définition de cette fonction  est la suivante: <code>Seq[String] =&gt; Option[T]</code>. Il peut alors s'agir d’une condition de filtre ou d’une simple méthode de transformation. Unfiltered fournit un certain nombre de ParamMapper tel que <code>Params.first</code> et <code>Params.noempty</code>, qui sont chaînables via la méthode ~&gt;. <br /></p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">object</span> SayHello <span style="color: #F78811;">&#123;</span> &nbsp;   <span style="color: #0000ff; font-weight: bold;">val</span> intent <span style="color: #000080;">=</span> unfiltered.<span style="color: #000000;">Cycle</span>.<span style="color: #000000;">Intent</span><span style="color: #F78811;">&#91;</span>Any, Any<span style="color: #F78811;">&#93;</span> <span style="color: #F78811;">&#123;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> req<span style="color: #000080;">@</span>Path<span style="color: #F78811;">&#40;</span>Seg<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;hello&quot;</span> <span style="color: #000080;">::</span> name <span style="color: #000080;">::</span> Nil<span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> GET<span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> 	Ok ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;Hello &quot;</span> + name<span style="color: #F78811;">&#41;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #000080;">_</span> <span style="color: #000080;">=&gt;</span> MethodNotAllowed ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;Method must be GET&quot;</span><span style="color: #F78811;">&#41;</span>     <span style="color: #F78811;">&#125;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> req<span style="color: #000080;">@</span>Path<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;/hello&quot;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> POST<span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">&amp;</span> Params<span style="color: #F78811;">&#40;</span>NonEmptyName<span style="color: #F78811;">&#40;</span>name<span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> 	Ok ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;Hello &quot;</span> + name.<span style="color: #000000;">toString</span><span style="color: #F78811;">&#41;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> POST<span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> 	BadRequest ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;&quot;</span><span style="color: #6666FF;">&quot;The parameter &quot;</span>name<span style="color: #6666FF;">&quot; is missing&quot;</span><span style="color: #6666FF;">&quot;&quot;</span><span style="color: #F78811;">&#41;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #000080;">_</span> <span style="color: #000080;">=&gt;</span> MethodNotAllowed ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;Method must be POST&quot;</span><span style="color: #F78811;">&#41;</span>     <span style="color: #F78811;">&#125;</span>   <span style="color: #F78811;">&#125;</span> <span style="color: #F78811;">&#125;</span></pre> <p><br />
<em>Note&nbsp;: Au-delà d’effectuer une simple validation, l’extracteur créé nous permet de router la requête en fonction de la présence ou non d’un paramètre.</em></p> <h4>ResponseFunction</h4> <p>Enfin, une Intent doit retourner une ResponseFunction. Pour cela, L’API offre des implémentations appelées Responders qui sont chaînables via l’utilisation de la méthode ~&gt;. Ainsi, dans l’exemple ci-dessus les réponses sont composées en chaînant les Responders ‘Ok’/’MethodNotAllowed’ et ‘ResponseString’. De plus, l’utilisation des codes retour HTTP n’étant pas très explicites Unfiltered définit un objet pour chaque code retour, ici Ok pour Status (200). <br /></p> <h3>Configuration serveur</h3> <p>Maintenant que vous connaissez tout, ou presque, des mécanismes d’Unfiltered, il est temps de tester notre premier exemple.<br />Vous pouvez, dans un premier temps, télécharger le projet SBT ou Maven sur le repository GitHub suivant:<br />
<a href="https://github.com/Zenika/unfiltered-demo-json">https://github.com/Zenika/unfiltered-demo-json</a> <br />
<br />
<em>Note: le projet contient l’ensemble des exemples qui sont présentés dans la suite de ce billet.</em> <br />
<br />
Une première approche consiste à ajouter la déclaration du SayHelloFilter dans le descripteur de déploiement web.xml de votre application, avant de la déployer dans votre conteneur de servlets favori. <br /></p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;web-app<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;filter<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;filter-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>SayHello<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/filter-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;filter-class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>com.example.filter.SayHelloFilter<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/filter-class<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/filter<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;filter-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;filter-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>SayHello<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/filter-name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 		<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;url-pattern<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>/*<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/url-pattern<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> 	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/filter-mapping<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/web-app<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre> <p>Mais, il est très probable que beaucoup de personnes trouvent cette approche quelque peu fastidieuse. Heureusement, Unfiltered nous facilite la vie et offre la possibilité de réaliser des applications standalones, grâce à une intégration native de Jetty en tant que serveur embarqué. Pour cela, il suffit de créer un point d’entrée à notre application de la manière suivante:</p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">object</span> Server <span style="color: #F78811;">&#123;</span>   <span style="color: #0000ff; font-weight: bold;">def</span> main<span style="color: #F78811;">&#40;</span>args<span style="color: #000080;">:</span> Array<span style="color: #F78811;">&#91;</span>String<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#123;</span>     unfiltered.<span style="color: #000000;">jetty</span>.<span style="color: #000000;">Http</span>.<span style="color: #000000;">local</span><span style="color: #F78811;">&#40;</span><span style="color: #F78811;">8080</span><span style="color: #F78811;">&#41;</span>       .<span style="color: #000000;">filter</span><span style="color: #F78811;">&#40;</span>SayHelloFilter<span style="color: #F78811;">&#41;</span>       .<span style="color: #000000;">run</span>   <span style="color: #F78811;">&#125;</span> <span style="color: #F78811;">&#125;</span></pre> <h3>Un cas concret - Implémentation de services {Json}</h3> <p>Nous allons maintenant réaliser une application CRUD  qui stockera des recettes de cocktails et exposera uniquement des services REST/Json. <br />
<br />
Nous utiliserons pour cela, la classe suivante pour modéliser notre objet métier Cocktail.</p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">package</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<span style="color: #000000;">demo</span>.<span style="color: #000000;">domain</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">object</span> Cocktail <span style="color: #F78811;">&#123;</span>   <span style="color: #0000ff; font-weight: bold;">type</span> Ingredient <span style="color: #000080;">=</span> String   <span style="color: #0000ff; font-weight: bold;">type</span> Quantity   <span style="color: #000080;">=</span> String <span style="color: #F78811;">&#125;</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #0000ff; font-weight: bold;">class</span> Cocktail<span style="color: #F78811;">&#40;</span>   <span style="color: #0000ff; font-weight: bold;">val</span> name<span style="color: #000080;">:</span> String,   <span style="color: #0000ff; font-weight: bold;">val</span> recipe<span style="color: #000080;">:</span> String,   <span style="color: #0000ff; font-weight: bold;">val</span> ingredients<span style="color: #000080;">:</span> List<span style="color: #F78811;">&#91;</span><span style="color: #F78811;">&#40;</span>Cocktail.<span style="color: #000000;">Ingredient</span>, Cocktail.<span style="color: #000000;">Quantity</span><span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#93;</span> <span style="color: #F78811;">&#41;</span></pre> <p>Pour manipuler des données au format Json, Unfiltered s’appuie sur la librairie Json de Lift (<a href="https://github.com/lift/lift/tree/master/framework/lift-base/lift-json/" hreflang="en">https://github.com/lift/lift/tree/master/framework/lift-base/lift-json/</a>). Cette librairie offre, en autre, une DSL pour écrire directement du Json en Scala ainsi que des parsers pour convertir des cases classes en Json et inversement. Si vous n’êtes pas familiarisés avec cette librairie, je vous invite à lire la documentation. Néanmoins cela n’est pas requis pour la suite de ce billet. <br />
<br />
Unfiltered fournit&nbsp;:</p> <ul> <li>unfiltered.response.Json; Il s’agit d’un Responder pour retourner une réponse au format Json.</li> <li>unfiltered.request.JsonBody; Il s’agit d’un extracteur pour transformer les données.</li> </ul> <p>Ces objets manipulant la classe <code>net.liftweb.json.JsonAST.JValue</code>, nous allons définir une conversion implicite de notre objet Cocktail en un objet <code>JValue</code>. Pour cela, nous utiliserons simplement la DSL offerte par l’API Json. <br />
<br />
Pour des raisons d’organisation, les conversions seront définies dans un objet <code>CocktailRepresentations</code> que nous pourrons, par la suite, importer dans notre Plan.</p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">package</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<span style="color: #000000;">demo</span>.<span style="color: #000000;">representation</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">import</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<span style="color: #000000;">demo</span>.<span style="color: #000000;">domain</span>.<span style="color: #000000;">Cocktail</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">import</span> net.<span style="color: #000000;">liftweb</span>.<span style="color: #000000;">json</span>.<span style="color: #000000;">JsonDSL</span>.<span style="color: #000080;">_</span> <span style="color: #0000ff; font-weight: bold;">import</span> net.<span style="color: #000000;">liftweb</span>.<span style="color: #000000;">json</span>.<span style="color: #000000;">JsonAST</span>.<span style="color: #000000;">JValue</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">object</span> CocktailRepresentation <span style="color: #F78811;">&#123;</span> &nbsp;   <span style="color: #0000ff; font-weight: bold;">implicit</span> <span style="color: #0000ff; font-weight: bold;">def</span> toJValue<span style="color: #F78811;">&#40;</span>cocktails<span style="color: #000080;">:</span> Seq<span style="color: #F78811;">&#91;</span>Cocktail<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span><span style="color: #000080;">:</span> JValue <span style="color: #000080;">=</span>   <span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;cocktails&quot;</span> -<span style="color: #000080;">&gt;</span> cocktails.<span style="color: #000000;">map</span><span style="color: #F78811;">&#40;</span>c <span style="color: #000080;">=&gt;</span> toJValue<span style="color: #F78811;">&#40;</span>c<span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span> &nbsp;   <span style="color: #0000ff; font-weight: bold;">implicit</span> <span style="color: #0000ff; font-weight: bold;">def</span> toJValue<span style="color: #F78811;">&#40;</span>cocktail<span style="color: #000080;">:</span> Cocktail<span style="color: #F78811;">&#41;</span><span style="color: #000080;">:</span> JValue <span style="color: #000080;">=</span>     <span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;name&quot;</span> -<span style="color: #000080;">&gt;</span> cocktail.<span style="color: #000000;">name</span><span style="color: #F78811;">&#41;</span> ~     <span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;recipe&quot;</span> -<span style="color: #000080;">&gt;</span> cocktail.<span style="color: #000000;">recipe</span><span style="color: #F78811;">&#41;</span> ~     <span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;ingredients&quot;</span> -<span style="color: #000080;">&gt;</span>       cocktail.<span style="color: #000000;">ingredients</span>.<span style="color: #000000;">map</span><span style="color: #F78811;">&#40;</span>i <span style="color: #000080;">=&gt;</span>       <span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;name&quot;</span> -<span style="color: #000080;">&gt;</span> i.<span style="color: #000080;">_</span>1<span style="color: #F78811;">&#41;</span> ~       <span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;quantity&quot;</span> -<span style="color: #000080;">&gt;</span> i.<span style="color: #000080;">_</span>2<span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span>     <span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#125;</span></pre> <p><em>Note: Dans les conversions implicites ci-dessus, les méthodes ‘~’ et ‘-&gt;’ font partie de la DSL Json de Lift.</em> <br />
<br />
Nous pouvons dès à présent implémenter les services GET qui seront accessibles via les commandes CURL suivantes: <br /></p> <pre> curl -X GET http://localhost:8080/cocktails --header “Accept: application/json” curl -X GET http://localhost:8080/cocktails/{id} --header “Accept: application/json” </pre> <p>Voici l’implémentation des services REST. Pour rester simple, nous utilisons une Map pour enregistrer les cocktails.</p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">package</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<span style="color: #000000;">demo</span>.<span style="color: #000000;">plan</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">import</span> unfiltered.<span style="color: #000000;">request</span>.<span style="color: #000080;">_</span> <span style="color: #0000ff; font-weight: bold;">import</span> unfiltered.<span style="color: #000000;">response</span>.<span style="color: #000080;">_</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">import</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<span style="color: #000000;">demo</span>.<span style="color: #000000;">domain</span>.<span style="color: #000000;">Cocktail</span> <span style="color: #0000ff; font-weight: bold;">import</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<span style="color: #000000;">demo</span>.<span style="color: #000000;">representation</span>.<span style="color: #000000;">CocktailRepresentation</span>.<span style="color: #000080;">_</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">object</span> CocktailPlan <span style="color: #0000ff; font-weight: bold;">extends</span> unfiltered.<span style="color: #000000;">filter</span>.<span style="color: #000000;">Plan</span> <span style="color: #F78811;">&#123;</span> &nbsp;   <span style="color: #0000ff; font-weight: bold;">val</span> repository<span style="color: #000080;">:</span> scala.<span style="color: #000000;">collection</span>.<span style="color: #000000;">mutable</span>.<span style="color: #000000;">Map</span><span style="color: #F78811;">&#91;</span><span style="color: #9999cc; font-weight: bold;">Int</span>, Cocktail<span style="color: #F78811;">&#93;</span> <span style="color: #000080;">=</span> scala.<span style="color: #000000;">collection</span>.<span style="color: #000000;">mutable</span>.<span style="color: #000000;">Map</span>.<span style="color: #000000;">empty</span> &nbsp;   <span style="color: #0000ff; font-weight: bold;">def</span> intent <span style="color: #000080;">=</span> <span style="color: #F78811;">&#123;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> req<span style="color: #000080;">@</span> Path<span style="color: #F78811;">&#40;</span> Seg<span style="color: #F78811;">&#40;</span> <span style="color: #6666FF;">&quot;cocktails&quot;</span> <span style="color: #000080;">::</span> id <span style="color: #000080;">::</span> Nil <span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> GET<span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span> 	<span style="color: #0000ff; font-weight: bold;">case</span> Accepts.<span style="color: #000000;">Json</span><span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> 	  repository.<span style="color: #000000;">get</span><span style="color: #F78811;">&#40;</span>id.<span style="color: #000000;">toInt</span><span style="color: #F78811;">&#41;</span>.<span style="color: #000000;">map</span><span style="color: #F78811;">&#40;</span> 	  <span style="color: #F78811;">&#40;</span>c<span style="color: #000080;">:</span> Cocktail<span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> Ok ~<span style="color: #000080;">&gt;</span> Json<span style="color: #F78811;">&#40;</span>c<span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#41;</span> getOrElse<span style="color: #F78811;">&#123;</span>NotFound ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;resource not found&quot;</span><span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#125;</span> 	<span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #000080;">_</span> <span style="color: #000080;">=&gt;</span> 	  NotAcceptable ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;You must accept application/json&quot;</span><span style="color: #F78811;">&#41;</span>       <span style="color: #F78811;">&#125;</span>     <span style="color: #F78811;">&#125;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> req<span style="color: #000080;">@</span> Path<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;/cocktails&quot;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> GET<span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span> 	<span style="color: #0000ff; font-weight: bold;">case</span> Accepts.<span style="color: #000000;">Json</span><span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> Ok ~<span style="color: #000080;">&gt;</span> Json<span style="color: #F78811;">&#40;</span>repository.<span style="color: #000000;">values</span>.<span style="color: #000000;">toSeq</span><span style="color: #F78811;">&#41;</span> 	<span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #000080;">_</span> <span style="color: #000080;">=&gt;</span> 	  NotAcceptable ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;You must accept application/json&quot;</span><span style="color: #F78811;">&#41;</span>       <span style="color: #F78811;">&#125;</span>     <span style="color: #F78811;">&#125;</span>   <span style="color: #F78811;">&#125;</span> <span style="color: #F78811;">&#125;</span></pre> <p>Avant d’implémenter nos services PUT et POST, il est nécessaire de convertir un flux Json en un objet Cocktail. Unfiltered propose la classe <code>unfiltered.request.JsonBody</code> qui permet d’extraire les données d’une requête au format Json en un objet <code>JValue</code> de la librairie Lift.  Son utilisation étant quelque peu limitée, nous allons définir deux nouvelles classes pour faciliter la manipulation de nos objets.</p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">package</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<span style="color: #000000;">demo</span>.<span style="color: #000000;">common</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">import</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<s
pan style="color: #000000;">domain</span>.<span style="color: #000000;">Cocktail</span> <span style="color: #0000ff; font-weight: bold;">import</span> unfiltered.<span style="color: #000000;">request</span>.<span style="color: #000080;">_</span> <span style="color: #0000ff; font-weight: bold;">import</span> net.<span style="color: #000000;">liftweb</span>.<span style="color: #000000;">json</span>.<span style="color: #000000;">JsonAST</span>.<span style="color: #000080;">_</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">class</span> JsonMapper<span style="color: #F78811;">&#91;</span>A<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#40;</span>f<span style="color: #000080;">:</span> Option<span style="color: #F78811;">&#91;</span>JValue<span style="color: #F78811;">&#93;</span> <span style="color: #000080;">=&gt;</span> Option<span style="color: #F78811;">&#91;</span>A<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span> <span style="color: #0000ff; font-weight: bold;">extends</span> <span style="color: #F78811;">&#40;</span>Option<span style="color: #F78811;">&#91;</span>JValue<span style="color: #F78811;">&#93;</span> <span style="color: #000080;">=&gt;</span> Option<span style="color: #F78811;">&#91;</span>A<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#123;</span>   <span style="color: #0000ff; font-weight: bold;">def</span> apply<span style="color: #F78811;">&#40;</span>oj<span style="color: #000080;">:</span> Option<span style="color: #F78811;">&#91;</span>JValue<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=</span> f<span style="color: #F78811;">&#40;</span>oj<span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#125;</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">object</span> JsonObjectBody  <span style="color: #F78811;">&#123;</span> &nbsp;   <span style="color: #0000ff; font-weight: bold;">implicit</span> <span style="color: #0000ff; font-weight: bold;">val</span> formats <span style="color: #000080;">=</span> net.<span style="color: #000000;">liftweb</span>.<span style="color: #000000;">json</span>.<span style="color: #000000;">DefaultFormats</span> &nbsp;   <span style="color: #0000ff; font-weight: bold;">class</span> Extract<span style="color: #F78811;">&#91;</span>A<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#40;</span> f<span style="color: #000080;">:</span> JsonMapper<span style="color: #F78811;">&#91;</span>A<span style="color: #F78811;">&#93;</span> <span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#123;</span> &nbsp;     <span style="color: #0000ff; font-weight: bold;">def</span> <span style="color: #0000ff; font-weight: bold;">this</span><span style="color: #F78811;">&#40;</span>  <span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#40;</span><span style="color: #0000ff; font-weight: bold;">implicit</span> mf<span style="color: #000080;">:</span> Manifest<span style="color: #F78811;">&#91;</span>A<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=</span> <span style="color: #0000ff; font-weight: bold;">this</span><span style="color: #F78811;">&#40;</span> <span style="color: #0000ff; font-weight: bold;">new</span> JsonMapper<span style="color: #F78811;">&#91;</span>A<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#40;</span> <span style="color: #000080;">_</span>.<span style="color: #000000;">map</span><span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span>.<span style="color: #000000;">extractOpt</span><span style="color: #F78811;">&#91;</span>A<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span>.<span style="color: #000000;">getOrElse</span><span style="color: #F78811;">&#40;</span>None<span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#41;</span> &nbsp;     <span style="color: #0000ff; font-weight: bold;">def</span> unapply<span style="color: #F78811;">&#91;</span>T<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#40;</span>req<span style="color: #000080;">:</span> HttpRequest<span style="color: #F78811;">&#91;</span>T<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span><span style="color: #000080;">:</span> Option<span style="color: #F78811;">&#91;</span>A<span style="color: #F78811;">&#93;</span> <span style="color: #000080;">=</span> f<span style="color: #F78811;">&#40;</span> unfiltered.<span style="color: #000000;">request</span>.<span style="color: #000000;">JsonBody</span><span style="color: #F78811;">&#40;</span>req<span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#41;</span> &nbsp;   <span style="color: #F78811;">&#125;</span> <span style="color: #F78811;">&#125;</span></pre> <p>La classe <code>JsonMapper</code> n’est rien d’autre qu’une fonction qui prend en argument un <code>Option[JValue]</code> et qui retourne un <code>Option[A]</code>. Comme son nom l’indique, son rôle est de mapper un objet Json vers notre objet métier, qui dans notre cas n’est autre que Cocktail. <br />
<br />
Ensuite, l’objet <code>JsonObject</code> contient une classe Extract dont le but est de faciliter la création d’extracteurs à l’aide d’un <code>JsonMapper</code>. Par défaut, elle utilise un <code>JsonMapper</code> qui transforme naturellement l’objet Json en un certain objet de type A via la méthode <code>extractOpt[A]</code> de la librairie Lift. <br />
<br />
Nous allons, cependant, devoir créer un Mapper spécifique pour notre objet. En effet, si vous regardez bien la structure de classe Cocktail, vous remarquez que les ingrédients sont représentés par une <code>List[(Cocktail.Ingredient, Cocktail.Quantity)]</code>. <br />
<br />
Traduit directement en Json, nous aurons un flux sous la forme&nbsp;: <br />
<br />
<strong>{ingredients: [{"_1": "rhum", "_2": "100ml"}, {"_1": "orange", "_2": "300ml"}]}</strong> <br />
<br />
Vous conviendrez que l’utilisation de la notation Scala n’est ici pas très explicite. Il serait préférable d’avoir un flux Json de la forme suivante: <br />
<br />
<strong>{ingredients: [{"name": "rhum", "quantity": "100ml"}, {"name": "orange", "quantity": "300ml"}]}</strong> <br />
<br />
Pour cela, il est nécessaire de transformer, après extraction, l’objet Json pour le faire matcher avec la classe Cocktail. Cette opération est réalisable à l’aide de la méthode transform( ) de la classe JValue qui accepte en argument une fonction partielle pour réaliser le mapping. <br />
Nous pouvons alors nous en servir pour créer l’Extracteur suivant: <br /></p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">import</span> unfiltered.<span style="color: #000000;">request</span>.<span style="color: #000080;">_</span> <span style="color: #0000ff; font-weight: bold;">import</span> unfiltered.<span style="color: #000000;">response</span>.<span style="color: #000080;">_</span> <span style="color: #0000ff; font-weight: bold;">import</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<span style="color: #000000;">demo</span>.<span style="color: #000000;">domain</span>.<span style="color: #000000;">Cocktail</span> <span style="color: #0000ff; font-weight: bold;">import</span> com.<span style="color: #000000;">zenika</span>.<span style="color: #000000;">unfiltered</span>.<span style="color: #000000;">demo</span>.<span style="color: #000000;">common</span>.<span style="color: #F78811;">&#123;</span>JsonBody, JsonMapper<span style="color: #F78811;">&#125;</span> <span style="color: #0000ff; font-weight: bold;">import</span> net.<span style="color: #000000;">liftweb</span>.<span style="color: #000000;">json</span>.<span style="color: #000000;">JsonAST</span>.<span style="color: #F78811;">&#123;</span>JValue, JObject, JField<span style="color: #F78811;">&#125;</span> &nbsp; <span style="color: #0000ff; font-weight: bold;">object</span> CocktailBody <span style="color: #0000ff; font-weight: bold;">extends</span> JsonBody.<span style="color: #000000;">Extract</span><span style="color: #F78811;">&#91;</span>Cocktail<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#40;</span><span style="color: #0000ff; font-weight: bold;">new</span> JsonMapper<span style="color: #F78811;">&#40;</span><span style="color: #F78811;">&#40;</span>o<span style="color: #000080;">:</span> Option<span style="color: #F78811;">&#91;</span>JValue<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> <span style="color: #F78811;">&#123;</span> &nbsp;   <span style="color: #0000ff; font-weight: bold;">implicit</span> <span style="color: #0000ff; font-weight: bold;">val</span> formats <span style="color: #000080;">=</span> net.<span style="color: #000000;">liftweb</span>.<span style="color: #000000;">json</span>.<span style="color: #000000;">DefaultFormats</span> &nbsp;   o.<span style="color: #000000;">map</span><span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span>.<span style="color: #000000;">transform</span> <span style="color: #F78811;">&#123;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> JObject<span style="color: #F78811;">&#40;</span>List<span style="color: #F78811;">&#40;</span>JField<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;name&quot;</span>, n<span style="color: #F78811;">&#41;</span>, JField<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;quantity&quot;</span>, q<span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> JObject<span style="color: #F78811;">&#40;</span>List<span style="color: #F78811;">&#40;</span>JField<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;_1&quot;</span>, n<span style="color: #F78811;">&#41;</span>, JField<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;_2&quot;</span>, q<span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span>   <span style="color: #F78811;">&#125;</span>.<span style="color: #000000;">extractOpt</span><span style="color: #F78811;">&#91;</span>Cocktail<span style="color: #F78811;">&#93;</span><span style="color: #F78811;">&#41;</span>.<span style="color: #000000;">getOrElse</span><span style="color: #F78811;">&#40;</span>None<span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#125;</span><span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span></pre> <p>Il est alors possible d’utiliser cette classe comme tout autre extracteur pour matcher l’HttpRequest. <br />
<em>Note: une partie du code a été omise pour ne pas surcharger l’article.</em></p> <pre class="scala code scala" style="font-family:inherit"><span style="color: #0000ff; font-weight: bold;">case</span> req<span style="color: #000080;">@</span> Path<span style="color: #F78811;">&#40;</span> Seg<span style="color: #F78811;">&#40;</span> <span style="color: #6666FF;">&quot;cocktails&quot;</span> <span style="color: #000080;">::</span> id <span style="color: #000080;">::</span> Nil <span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>   <span style="color: #008000; font-style: italic;">// PUT /cocktails/{id} --header &quot;Content-Type: application/json&quot;</span>   <span style="color: #0000ff; font-weight: bold;">case</span> PUT<span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">&amp;</span> RequestContentType<span style="color: #F78811;">&#40;</span>ct<span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> ct <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #6666FF;">&quot;application/json&quot;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> CocktailBody<span style="color: #F78811;">&#40;</span>c<span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> <span style="color: #F78811;">&#123;</span> 	<span style="color: #0000ff; font-weight: bold;">if</span><span style="color: #F78811;">&#40;</span> repository.<span style="color: #000000;">contains</span><span style="color: #F78811;">&#40;</span>id.<span style="color: #000000;">toInt</span><span style="color: #F78811;">&#41;</span><span style="color: #F78811;">&#41;</span> <span style="color: #F78811;">&#123;</span> 	  repository.<span style="color: #000000;">update</span><span style="color: #F78811;">&#40;</span>id.<span style="color: #000000;">toInt</span>, c<span style="color: #F78811;">&#41;</span> 	  Ok ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;The cocktail has been successfully updated&quot;</span><span style="color: #F78811;">&#41;</span> 	<span style="color: #F78811;">&#125;</span> <span style="color: #0000ff; font-weight: bold;">else</span> NotFound ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;resource not found&quot;</span><span style="color: #F78811;">&#41;</span>       <span style="color: #F78811;">&#125;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #000080;">_</span> <span style="color: #000080;">=&gt;</span> BadRequest ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;data must be valid application/json&quot;</span><span style="color: #F78811;">&#41;</span>     <span style="color: #F78811;">&#125;</span> &nbsp;     <span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #000080;">_</span> <span style="color: #000080;">=&gt;</span> UnsupportedMediaType ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;content-type must be application/json&quot;</span><span style="color: #F78811;">&#41;</span>   <span style="color: #F78811;">&#125;</span>   <span style="color: #0000ff; font-weight: bold;">case</span> req<span style="color: #000080;">@</span> Path<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;/cocktails&quot;</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>     <span style="color: #008000; font-style: italic;">// POST /cocktails --header &quot;Content-Type: application/json&quot;</span>     <span style="color: #0000ff; font-weight: bold;">case</span> POST<span style="color: #F78811;">&#40;</span><span style="color: #000080;">_</span><span style="color: #F78811;">&#41;</span> <span style="color: #000080;">&amp;</span> RequestContentType<span style="color: #F78811;">&#40;</span>ct<span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> ct <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span>       <span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #6666FF;">&quot;application/json&quot;</span> <span style="color: #000080;">=&gt;</span> req <span style="color: #0000ff; font-weight: bold;">match</span> <span style="color: #F78811;">&#123;</span> 	<span style="color: #0000ff; font-weight: bold;">case</span> CocktailBody<span style="color: #F78811;">&#40;</span>c<span style="color: #F78811;">&#41;</span> <span style="color: #000080;">=&gt;</span> <span style="color: #F78811;">&#123;</span> 	  repository +<span style="color: #000080;">=</span> <span style="color: #F78811;">&#40;</span>repository.<span style="color: #000000;">lastOption</span>.<span style="color: #000000;">map</span><span style="color: #F78811;">&#40;</span>x <span style="color: #000080;">=&gt;</span> x.<span style="color: #000080;">_</span>1<span style="color: #F78811;">&#41;</span>.<span style="color: #000000;">getOrElse</span><span style="color: #F78811;">&#40;</span>0<span style="color: #F78811;">&#41;</span> + <span style="color: #F78811;">1</span><span style="color: #F78811;">&#41;</span> -<span style="color: #000080;">&gt;</span> c 	    Created ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;The cocktail has been successfully created&quot;</span><span style="color: #F78811;">&#41;</span> 	<span style="color: #F78811;">&#125;</span> 	<span style="color: #0000ff; font-weight: bold;">case</span> <span style="color: #000080;">_</span> <span style="color: #000080;">=&gt;</span> BadRequest ~<span style="color: #000080;">&gt;</span> ResponseString<span style="color: #F78811;">&#40;</span><span style="color: #6666FF;">&quot;Invalid json data&quot;</span><span style="color: #F78811;">&#41;</span>     <span style="color: #F78811;">&#125;</span>   <span style="color: #F78811;">&#125;</span> <span style="color: #F78811;">&#125;</span></pre> <p>Nous pouvons maintenant ajouter notre premier cocktail. Pour cela, vous pouvez utiliser la commande suivante: <br /></p> <pre> curl -i -X POST http://localhost:8080/cocktails  --header &quot;Content-Type:application/json&quot;  --data '{&quot;name&quot;:&quot;Mojito&quot;,&quot;recipe&quot;:&quot;Mélanger les ingrédients&quot;,&quot;ingredients&quot;:[{&quot;name&quot;:&quot;Rhum&quot;,&quot;quantity&quot;:&quot;6cl&quot;},{&quot;name&quot;:&quot;jus de citron&quot;,&quot;quantity&quot;:&quot;3cl&quot;},{&quot;name&quot;:&quot;eau gazeuse&quot;,&quot;quantity&quot;:&quot;30cl&quot;}]}' </pre> <p><br />
Mais vous avez oublié l’ingrédient secret! Vous pouvez modifier votre cocktail avec la commande suivante: <br /></p> <pre> curl -i -X PUT http://localhost:8080/cocktails/1  --header &quot;Content-Type:application/json&quot;  --data '{&quot;name&quot;:&quot;Mojito&quot;,&quot;recipe&quot;:&quot;Mélanger les ingrédients&quot;,&quot;ingredients&quot;:[{&quot;name&quot;:&quot;Rhum&quot;,&quot;quantity&quot;:&quot;6cl&quot;},{&quot;name&quot;:&quot;jus de citron&quot;,&quot;quantity&quot;:&quot;3cl&quot;},{&quot;name&quot;:&quot;eau gazeuse&quot;,&quot;quantity&quot;:&quot;30cl&quot;}, {&quot;name&quot;: &quot;feuilles de menthe&quot;, &quot;quantity&quot;:&quot;3&quot;}]}' </pre> <h3>Conclusion</h3> <p><br />
Au-delà du fait qu’Unfiltered offre l’avantage d’être simple d’approche, celui-ci n’impose aucune contrainte en terme d’implémentation. La manière dont une Intent doit être définie est ainsi laissée aux développeurs. Unfiltered reste extensible de par la simplicité de son API. Bien que l’on puisse lui reprocher certains manques sur le binding des paramètres, vous pouvez être certain qu’il n’y a aucune magie derrière le traitement des requêtes. Et, comme le dit Maxime Lévesque (créateur de l’ORM Squeryl écrit en Scala): <br /></p> <blockquote><p>“In my opinion, Unfiltered’s main strength is in what it doesn’t do.”</p></blockquote> <p><br />
Enfin, pour les points négatifs (il y en a  toujours), la documentation n’est pas forcément complète et il peut rapidement s’avérer nécessaire de regarder le code source. <br />
N’hésitez pas à consulter directement la documentation d’Unfiltered pour plus d’éléments (gestion des services asynchrones, des cookies ou encore de l’authentification). Par ailleurs, je vous invite aussi à regarder la présentation faite par Nathan Hamblen; <a href="http://vimeo.com/39951111" hreflang="en">http://vimeo.com/39951111</a>. Merci à vous et n'hésitez pas à me faire part de vos remarques ou de vos retours d’expérience sur Unfiltered.</p> <h3>Références</h3> <p>Documentation Unfiltered: <a href="http://unfiltered.databinder.net/" hreflang="en">http://unfiltered.databinder.net/</a> <br />
Slides de Présentation, par Doug Tangren: <a href="http://unfiltered.lessis.me/" hreflang="en">http://unfiltered.lessis.me/</a> <br />
Github Lift-Json: <a href="https://github.com/lift/lift/blob/master/framework/lift-base/lift-json/README.md" hreflang="en">https://github.com/lift/lift/blob/master/framework/lift-base/lift-json/README.md</a> <br />
Github Unfiltered: <a href="https://github.com/softprops/Unfiltered/blob/master/README.markdown" hreflang="en">https://github.com/softprops/Unfiltered/blob/master/README.markdown</a> <br /></p>