---
ID: 119
post_title: 'Spring Batch and MongoDB: cursor-based item reader'
author: Arnaud Cogolu√®gnes
post_date: 2012-05-23 09:18:00
post_excerpt: |
  <p><a href="http://static.springsource.org/spring-batch/">Spring Batch</a> is a popular open source batch framework. It integrates with lots of RDBM technologies like JDBC, Hibernate or JPA, but doesn't have official support for NoSQL datastores yet. This post shows how to integrate Spring Batch and <a href="http://www.mongodb.org/">MongoDB</a> to read large datasets from this document-oriented datastore.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=119
published: true
---
<p><a href="http://static.springsource.org/spring-batch/">Spring Batch</a> is a popular open source batch framework. It integrates with lots of RDBM technologies like JDBC, Hibernate or JPA, but doesn't have official support for NoSQL datastores yet. This post shows how to integrate Spring Batch and <a href="http://www.mongodb.org/">MongoDB</a> to read large datasets from this document-oriented datastore.</p>
<!--more-->
<h2>What for?</h2> <p>MongoDB is often used to store large sets of data like logs. When it comes to analyze such data, MongoDB provides simple aggregation operators or even MapReduce, but these technics are somewhat limited. There's even a new project to integrate MongoDB with Hadoop, but, hey, apart from web-scale applications, who wants to set up a Hadoop cluster to make something out their last week logs?</p> <p>That's where integrating with a lightweight project like Spring Batch is interesting. Spring Batch provides advanced batch features out of the box: transaction management, monitoring, retry, skip, restart after failure, complex flow of steps, and so on, all of this working on any Java-compliant platform.</p> <p>Let's start by something simple: reading documents from a collection by implementing a restartable Spring Batch <code>ItemReader</code>.</p> <h2>What kind of item reader for MongoDB?</h2> <p>Reading large dataset isn't as simple as it looks like. I considered 3 strategies for a MongoDB item reader:</p> <ul> <li>cursor: sending the query, getting a cursor, and iterating over the cursor until it's exhausted. The whole dataset is never in memory, it is streamed thanks to the cursor.</li> <li>paging: sending a query to retrieve one page of data. Once the page is exhausted, retrieving the next one, reading it, until there's no more page. We usually use paging when cursor-based reading doesn't work well (e.g. memory leaks). Hopefully, the cursor will work correctly with MongoDB.</li> <li>ranges: sending a query to retrieve one page, but using a specific range. This implies a knowledge of the data to be read (e.g. ranges of IDs), but could be the most effective strategy, especially on a restart.</li> </ul> <p>The cursor-based strategy is the simplest and usually works great if correctly implemented. This is the one I chose in this post, but investigating the 2 other strategies should be interesting too (perhaps in upcoming posts  :-)   ).</p> <h2>The reader skeleton</h2> <p>Spring Batch's <code>ItemReader</code> interface is very simple:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">interface</span> ItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #000000;">&#123;</span> &nbsp;   T read<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span>, UnexpectedInputException, <span style="color: #000000;">ParseException</span>, NonTransientResourceException; &nbsp; <span style="color: #000000;">&#125;</span></pre> <p>But we won't start from scratch: we'll use the <code>AbstractItemCountingItemStreamItemReader</code> as a base class. It provides a good foundation and handles error-prone, boilerplate code (e.g. for restartability). Here is the skeleton of our item reader:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> MongoDbCursorItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">extends</span> AbstractItemCountingItemStreamItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">implements</span> InitializingBean <span style="color: #000000;">&#123;</span> &nbsp;   <span style="color: #7F0055; font-weight: bold;">private</span> Mongo mongo; &nbsp;   <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">String</span> databaseName; &nbsp;   <span style="color: #7F0055; font-weight: bold;">private</span> DBCollection collection; &nbsp;   <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">String</span> collectionName; &nbsp;   <span style="color: #7F0055; font-weight: bold;">private</span> DBCursor cursor; &nbsp;   <span style="color: #808080; font-style: italic;">// the document fields to select	</span>   <span style="color: #7F0055; font-weight: bold;">private</span> <span style="color: #000000;">String</span> <span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> fields; &nbsp;   <span style="color: #808080; font-style: italic;">// the criteria document </span>   <span style="color: #7F0055; font-weight: bold;">private</span> DBObject refDbObject; &nbsp;   @Override   <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> doOpen<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>     <span style="color: #808080; font-style: italic;">// opening cursor</span>   <span style="color: #000000;">&#125;</span> &nbsp;   @Override   <span style="color: #7F0055; font-weight: bold;">protected</span> T doRead<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>     <span style="color: #808080; font-style: italic;">// reading!</span>   <span style="color: #000000;">&#125;</span> &nbsp;   @Override   <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> doClose<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>     <span style="color: #808080; font-style: italic;">// cleaning up</span>   <span style="color: #000000;">&#125;</span> &nbsp;   @Override   <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> afterPropertiesSet<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>     <span style="color: #808080; font-style: italic;">// getting things ready</span>   <span style="color: #000000;">&#125;</span> &nbsp;   <span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span> setters <span style="color: #000000;">&#125;</span></pre> <p>We're going to see the implementation of each method.</p> <h2>Getting things ready</h2> <p>Our item reader initializes its resources (server connection, database, collection) in the appropriate callback:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> MongoDbCursorItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">extends</span> AbstractItemCountingItemStreamItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">implements</span> InitializingBean <span style="color: #000000;">&#123;</span>   <span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span>   @Override   <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> afterPropertiesSet<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055; fon
t-weight: bold;">Assert</span>.<span style="color: #000000;">notNull</span><span style="color: #000000;">&#40;</span>mongo,<span style="color: #888888;">&quot;Mongo must be specified&quot;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">notNull</span><span style="color: #000000;">&#40;</span>databaseName,<span style="color: #888888;">&quot;Mongo AND database must be set&quot;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #7F0055; font-weight: bold;">Assert</span>.<span style="color: #000000;">notNull</span><span style="color: #000000;">&#40;</span>collectionName,<span style="color: #888888;">&quot;collectionName must be set&quot;</span><span style="color: #000000;">&#41;</span>;     DB db = mongo.<span style="color: #000000;">getDB</span><span style="color: #000000;">&#40;</span>databaseName<span style="color: #000000;">&#41;</span>;     collection = db.<span style="color: #000000;">getCollection</span><span style="color: #000000;">&#40;</span>collectionName<span style="color: #000000;">&#41;</span>;   <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Nothing fancy, just validation and resource handling.</p> <h2>Opening and closing the cursor</h2> <p>It's time now to open the cursor we'll iterate on. We'll use the <code>find</code> method of the <code>DBCollection</code> class. This method needs a criteria document (this is the query) and the fields to retrieve. Both parameters are optional.</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> MongoDbCursorItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">extends</span> AbstractItemCountingItemStreamItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">implements</span> InitializingBean <span style="color: #000000;">&#123;</span>   <span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span>   @Override   <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> doOpen<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>     cursor = collection.<span style="color: #000000;">find</span><span style="color: #000000;">&#40;</span>createDbObjectRef<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>,createDbObjectKeys<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;   <span style="color: #000000;">&#125;</span> &nbsp;   <span style="color: #7F0055; font-weight: bold;">protected</span> DBObject createDbObjectKeys<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span>fields == <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>       <span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #7F0055; font-weight: bold;">new</span> BasicDBObject<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #7F0055;font-weight: bold;">else</span> <span style="color: #000000;">&#123;</span>       BasicDBObjectBuilder builder = BasicDBObjectBuilder.<span style="color: #000000;">start</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;       <span style="color: #7F0055;font-weight: bold;">for</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">String</span> field : fields<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>         builder.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span>field,<span style="color: #cc66cc;">1</span><span style="color: #000000;">&#41;</span>;       <span style="color: #000000;">&#125;</span>       <span style="color: #7F0055; font-weight: bold;">return</span> builder.<span style="color: #000000;">get</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span>   <span style="color: #000000;">&#125;</span> &nbsp;   <span style="color: #7F0055; font-weight: bold;">protected</span> DBObject createDbObjectRef<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span>refDbObject == <span style="color: #7F0055; font-weight: bold;">null</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>       <span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #7F0055; font-weight: bold;">new</span> BasicDBObject<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #7F0055;font-weight: bold;">else</span> <span style="color: #000000;">&#123;</span>       <span style="color: #7F0055; font-weight: bold;">return</span> refDbObject;     <span style="color: #000000;">&#125;</span>   <span style="color: #000000;">&#125;</span> &nbsp;   @Override   <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> doClose<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>     cursor.<span style="color: #000000;">close</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;   <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Note the item reader uses two properties the developer can inject when they configure the reader.</p> <h2>Just reading...</h2> <p>We're now starting reading. After a call to <code>next</code>, the MongoDB cursor returns a <code>DBObject</code>, which behaves pretty much as a map. The reader could return a <code>DBObject</code> for every item it reads, but wouldn't it be good to provide a strategy to convert the <code>DBObject</code> into something more meaningful, like a domain object? No need to create a dedicated interface, we can use Spring's <code>Converter</code> API.</p> <p>By using this interface, we can easily  integrate with <a href="http://static.springsource.org/spring-data/data-mongodb/docs/current/reference/html/#mongo.custom-converters">Spring Data MongoDB converters</a> and benefit from a full-blown document-object mapping engine.</p> <p>Here is how the reader would end up reading and leveraging the converter API:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> MongoDbCursorItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">extends</span> AbstractItemCountingItemStreamItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">implements</span> InitializingBean <span style="color: #000000;">&#123;</span>   <span style="color: #000000;">&#40;</spa
n>...<span style="color: #000000;">&#41;</span>   <span style="color: #7F0055; font-weight: bold;">private</span> Converter<span style="color: #000000;">&lt;</span>DBObject,T<span style="color: #000000;">&gt;</span> dbObjectConverter; &nbsp;   @Override   <span style="color: #7F0055; font-weight: bold;">protected</span> T doRead<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>     <span style="color: #7F0055;font-weight: bold;">if</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">!</span>cursor.<span style="color: #000000;">hasNext</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>       <span style="color: #7F0055; font-weight: bold;">return</span> <span style="color: #7F0055; font-weight: bold;">null</span>;     <span style="color: #000000;">&#125;</span> <span style="color: #7F0055;font-weight: bold;">else</span> <span style="color: #000000;">&#123;</span>       DBObject dbObj = cursor.<span style="color: #000000;">next</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;       <span style="color: #7F0055; font-weight: bold;">return</span> dbObjectConverter.<span style="color: #000000;">convert</span><span style="color: #000000;">&#40;</span>dbObj<span style="color: #000000;">&#41;</span>;     <span style="color: #000000;">&#125;</span>   <span style="color: #000000;">&#125;</span> &nbsp; <span style="color: #000000;">&#125;</span></pre> <p>OK, we're pretty much done, let's polish the reader by implementing restartability.</p> <h2>Restartability</h2> <p>Our reader is already restartable thanks to its parent class. In case of restart, the base class  knows where the previous execution left off and would scroll up to there by reading the already-read documents. This works but isn't efficient. We can tell the base class how to jump to a specific item more efficiently by implementing the <code>jumpToItem</code> method:</p> <pre class="java code java" style="font-family:inherit"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> MongoDbCursorItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">extends</span> AbstractItemCountingItemStreamItemReader<span style="color: #000000;">&lt;</span>T<span style="color: #000000;">&gt;</span> <span style="color: #7F0055; font-weight: bold;">implements</span> InitializingBean <span style="color: #000000;">&#123;</span>   <span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span>   @Override   <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> jumpToItem<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">int</span> itemIndex<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>     cursor = cursor.<span style="color: #000000;">skip</span><span style="color: #000000;">&#40;</span>itemIndex<span style="color: #000000;">&#41;</span>;   <span style="color: #000000;">&#125;</span> <span style="color: #000000;">&#125;</span></pre> <p>Chances are MongoDB scans sequentially the whole collection up to this point, but at least, the documents aren't sent on the network.</p> <h2>Configuring and launching the job</h2> <p>Our MongoDB item reader can be configured and used just like any other Spring Batch reader:</p> <pre class="xml code xml" style="font-family:inherit"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;batch:job</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;job&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;batch:step</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;step&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;batch:tasklet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>       <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;batch:chunk</span> <span style="color: #000066;">reader</span>=<span style="color: #ff0000;">&quot;reader&quot;</span> <span style="color: #000066;">writer</span>=<span style="color: #ff0000;">&quot;writer&quot;</span> <span style="color: #000066;">commit-interval</span>=<span style="color: #ff0000;">&quot;50&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/batch:tasklet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/batch:step<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/batch:job<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;reader&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;com.zenika.batch.item.database.mongo.MongoDbCursorItemReader&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;mongo&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;mongo&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;databaseName&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;spring-batch-mongodb&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;collectionName&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;dummy&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;dbObjectConverter&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;com.zenika.batch.item.database.mongo.PassthroughDbObjectConverter&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;refDbObject&quot;</span>
<span style="color: #000000; font-weight: bold;">&gt;</span></span>     <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;value<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>#{       T(com.mongodb.BasicDBObjectBuilder)         .start()         .push(&quot;number&quot;).add(&quot;$gt&quot;,12)         .pop()         .get()      }<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/value<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>   <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;fields&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;number&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span> &nbsp; (...) writer and infrastructure configuration omitted</pre> <p>Note the configuration of the criteria document (<code>refDbObject</code> property): it uses Spring Expression Language to create a <code>DBObject</code> that defines the query. Here is what the definition would look like in Java:</p> <pre class="java code java" style="font-family:inherit">DBObject refDbObject = BasicDBObjectBuilder.<span style="color: #000000;">start</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">push</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;number&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">add</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;$gt&quot;</span>,limit<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">pop</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">get</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</pre> <p>The job can be launched just like any other Spring Batch jobs:</p> <pre class="java code java" style="font-family:inherit">JobExecution exec = jobLauncher.<span style="color: #000000;">run</span><span style="color: #000000;">&#40;</span>job, jobParameters<span style="color: #000000;">&#41;</span>; assertThat<span style="color: #000000;">&#40;</span>exec.<span style="color: #000000;">getStatus</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>, is<span style="color: #000000;">&#40;</span>BatchStatus.<span style="color: #000000;">COMPLETED</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</pre> <h2>Conclusion</h2> <p>This post is a first attempt to integrate Spring Batch with MongoDB. Implementing the item reader is straightforward, even without a solid knowledge of Spring Batch internals. Such integration is definitely on the roadmap of the Spring Batch project, but it's not there yet, so this post should be a good start for anyone eager to integrate these two great technologies.</p> <p>Note a more advanced version of the cursor item reader could expose parameters like the cursor batch size, to have a better control over the memory footprint for very large datasets.</p> <p>Stay tuned, as subsequent posts about Spring Batch and MongoDB should come soon!</p> <p><a href="https://github.com/acogoluegnes/Spring-Batch-MongoDB">Source code</a></p>