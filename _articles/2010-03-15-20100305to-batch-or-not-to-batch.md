---
ID: 190
post_title: To batch or not to batch
author: Arnaud Cogolu√®gnes
post_date: 2010-03-15 07:57:00
post_excerpt: |
  <p>Batch applications are quite common in IT systems: perhaps you won't have to write a whole batch application in your developper career but there are many chances you'll have some batch parts in your Web or desktop applications. Batch is about handling high volumes of data and a lot of things can go wrong or be tricky when it comes to batch: bad performances, very high memory footprint, complex recovery scenarios to avoid stopping a whole batch because of one bad item, etc. This article covers through a simple use case different approaches to tackle with batch applications. By comparing the runtime behavior of the approaches, we'll see the benefits on relying a batch framework like <a href="http://static.springsource.org/spring-batch/" hreflang="en">Spring Batch</a>.</p>
layout: post
permalink: http://blog.zenika-offres.com/?p=190
published: true
---
<p>Batch applications are quite common in IT systems: perhaps you won't have to write a whole batch application in your developper career but there are many chances you'll have some batch parts in your Web or desktop applications. Batch is about handling high volumes of data and a lot of things can go wrong or be tricky when it comes to batch: bad performances, very high memory footprint, complex recovery scenarios to avoid stopping a whole batch because of one bad item, etc. This article covers through a simple use case different approaches to tackle with batch applications. By comparing the runtime behavior of the approaches, we'll see the benefits on relying a batch framework like <a href="http://static.springsource.org/spring-batch/" hreflang="en">Spring Batch</a>.</p>
<!--more-->
<h2>The use case: importing XML data into a database</h2> <p>The use case consists in importing data (contacts) from an XML file into a database. Here's a sample of the data to be imported:</p> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?xml</span> <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;1.0&quot;</span> <span style="color: #000066;">encoding</span>=<span style="color: #ff0000;">&quot;UTF-8&quot;</span><span style="color: #000000; font-weight: bold;">?&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;contacts<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;contact<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;firstname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>De-Anna<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/firstname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;lastname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Raghunath<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/lastname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;birthDate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>2010-03-04 12:06:45.99 CET<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/birthDate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/contact<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;contact<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;firstname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Susy<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/firstname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;lastname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Hauerstock<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/lastname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;birthDate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>2010-03-04 12:06:45.99 CET<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/birthDate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/contact<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;contact<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;firstname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Kiam<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/firstname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;lastname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Whitehurst<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/lastname<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;birthDate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>2010-03-04 12:06:45.99 CET<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/birthDate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/contact<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/contacts<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>This is quite a simple use case, but it could be the first step of a real batch application: you import data into a database to leverage the query fea
tures of the database engine (e.g. aggregates), to export the data under a "digested" version. We'll test the batch with XML files of different sizes: 100 contacts (14 Kb), 1000 contacts (123 Kb), 5000 contacts (614 Kb), 10000 contacts (1.2 Mb), 100000 contacts (12 Mb), 1000000 contacts (120 Mb).</p> <h2>The 3 approaches</h2> <p>What we really want to compare is a "simple" approach, without any support from a technical framework and a approach where we use the Spring Batch project for its importing features, but also for the infrastructure it provides for batch applications. We'll divide the "simple" approach into 2 sub-approaches: the first one will use one database transaction for the whole import (batch size = n) and the second one a database transaction for each row (batch size = 1). Why sticking to these simple strategies? Mainly to emphasize that these strategies are the most commonly used when we write batch applications from scratch, because they are the simplest to implement. We'll see then that we can easily choose the batch size with Spring Batch.</p> <h2>Approach #1: simple batch (batch size = n)</h2> <p>The first approach is made of the following steps:</p> <ul> <li>load the XML file into memory with DOM</li> <li>open a transaction</li> <li>iterate over the DOM tree to extract each contact and insert them into the database</li> </ul> <p>Here is an excerpt of this implementation:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> <span style="color: #a1a100;">importContacts {</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> run<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    DocumentBuilderFactory factory = DocumentBuilderFactory.<span style="color: #000000;">newInstance</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    DocumentBuilder builder = factory.<span style="color: #000000;">newDocumentBuilder</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">Document</span> document = builder.<span style="color: #000000;">parse</span><span style="color: #000000;">&#40;</span>input.<span style="color: #000000;">getInputStream</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">DateFormat</span> dateFormat = <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #000000;">SimpleDateFormat</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #7F0055; font-weight: bold;">final</span> NodeList contacts = document.<span style="color: #000000;">getElementsByTagName</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;contact&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    transactionTemplate.<span style="color: #000000;">execute</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> TransactionCallbackWithoutResult<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      @Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> doInTransactionWithoutResult<span style="color: #000000;">&#40;</span>TransactionStatus ts<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #7F0055;font-weight: bold;">for</span> <span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">int</span> i = 0, n = contacts.<span style="color: #000000;">getLength</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; i <span style="color: #000000;">&lt;</span> n; i++<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">Element</span> contact = <span style="color: #000000;">&#40;</span><span style="color: #000000;">Element</span><span style="color: #000000;">&#41;</span> contacts.<span style="color: #000000;">item</span><span style="color: #000000;">&#40;</span>i<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            jdbcTemplate.<span style="color: #000000;">update</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">              <span sty
le="color: #888888;">&quot;insert into contact (firstname,lastname,birthdate) values (?,?,?)&quot;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">              contact.<span style="color: #000000;">getElementsByTagName</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;firstname&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">item</span><span style="color: #000000;">&#40;</span>0<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getTextContent</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">              contact.<span style="color: #000000;">getElementsByTagName</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;lastname&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">item</span><span style="color: #000000;">&#40;</span>0<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getTextContent</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">              dateFormat.<span style="color: #000000;">parse</span><span style="color: #000000;">&#40;</span>contact.<span style="color: #000000;">getElementsByTagName</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;birthDate&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">item</span><span style="color: #000000;">&#40;</span>0<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getTextContent</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #000000;">&#40;</span><span style="color: #000000;">Exception</span> e<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            <span style="color: #7F0055; font-weight: bold;">throw</span> <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #000000;">RuntimeException</span><span style="color: #000000;">&#40;</span>e<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Perhaps this implementation is the most straightforward and would be the one used for a batch with low requirements in terms of robustness and scalability. Here are some of the drawbacks of this approach:</p> <ul> <li>the XML file is loaded into memory. This can become problematic if its size grows (100s of MB or even more). This will take a lot of memory and could prevent several instances of the batch to run simultaneously.</li> <li>poor exception handling. The explicit <code>catch</code> is due to the date parsing. Without it, perhaps we would have forgotten that the import <em>can</em> fail!</li> <li>fragility. If something goes wrong, the transaction is rolled back and the whole import will fail. This can be a business requirement actually. But what if the business people realize they don't want the whole import to fail and want to skip the bad rows? This logic will be hard-coded into the batch. This is where this simple implementation is weak: we don't have a clear boundary between the business logic (here, just the insertion of a contact) and the pure technical code (transaction management, but also skip policy and so on).</li> </ul> <h2>Approach #2: simple batch (batch size = 1)</h2> <p>The second approach differs from the first one in the transaction management:</p> <ul> <li>load the XML file into memory with DOM</li> <li>iterate over the DOM tree to extract each contact, <em>open a transaction for each contact</em> and insert it into the database</li> </ul> <p>Here is an excerpt of the implementation:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> <span style="color: #a1a100;">importContacts {</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> run<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    DocumentBuilderFactory factory = DocumentBuilderFactory.<span style="color: #000000;">newInstance</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    DocumentBuilder builder = factory.<span style="color: #000000;">newDocumentBuilder</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background
:inherit;">    <span style="color: #000000;">Document</span> document = builder.<span style="color: #000000;">parse</span><span style="color: #000000;">&#40;</span>input.<span style="color: #000000;">getInputStream</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">DateFormat</span> dateFormat = <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #000000;">SimpleDateFormat</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #7F0055; font-weight: bold;">final</span> NodeList contacts = document.<span style="color: #000000;">getElementsByTagName</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;contact&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #7F0055;font-weight: bold;">for</span> <span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">int</span> i = 0, n = contacts.<span style="color: #000000;">getLength</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>; i <span style="color: #000000;">&lt;</span> n; i++<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055; font-weight: bold;">final</span> <span style="color: #000000;">Element</span> contact = <span style="color: #000000;">&#40;</span><span style="color: #000000;">Element</span><span style="color: #000000;">&#41;</span> contacts.<span style="color: #000000;">item</span><span style="color: #000000;">&#40;</span>i<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      transactionTemplate.<span style="color: #000000;">execute</span><span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">new</span> TransactionCallbackWithoutResult<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        @Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #7F0055; font-weight: bold;">protected</span> <span style="color: #7F0055; font-weight: bold;">void</span> doInTransactionWithoutResult<span style="color: #000000;">&#40;</span>TransactionStatus ts<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #7F0055; font-weight: bold;">try</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            jdbcTemplate.<span style="color: #000000;">update</span><span style="color: #000000;">&#40;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">              <span style="color: #888888;">&quot;insert into contact (firstname,lastname,birthdate) values (?,?,?)&quot;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">              contact.<span style="color: #000000;">getElementsByTagName</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;firstname&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">item</span><span style="color: #000000;">&#40;</span>0<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getTextContent</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">              contact.<span style="color: #000000;">getElementsByTagName</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;lastname&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">item</span><span style="color: #000000;">&#40;</span>0<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getTextContent</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>,</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">              dateFormat.<span style="color: #000000;">parse</span><span style="color: #000000;">&#40;</span>contact.<span style="color: #000000;">getElementsByTagName</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;birthDate&quot;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">item</span><span style="color: #000000;">&#40;</span>0<span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getTextContent</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            <span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">          <span style="color: #000000;">&#125;</span> <span style="color: #7F0055; font-weight: bold;">catch</span> <span style="color: #000000;">&#40;</span><span style="color: #000000;">Exception</span> e<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">            <span style="color: #7F0055; font-weight: bold;">throw</span> <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #000000;">RuntimeException</span><span style="color: #000000;">&#40;</span>e<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; backgr
ound:inherit;">          <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">       <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>This approach is also straightforward and is actually only a variation of the first one. It could recover from any failure in the handling of a contact and skip it (we didn't implement this logic for brevity's sake). It suffers from the same drawbacks (DOM handling, no clear boundary between the business and batch logic). The batch size here is 1 (one row at a time) and we'll see later that this is not an efficient choice.</p> <h2>Approach #3: Spring Batch</h2> <p>The third and last approaches uses <a href="http://static.springsource.org/spring-batch/" hreflang="en">Spring Batch</a>. To make it short, Spring Batch leverages the Spring Framework for assembling your batch applications, but also provides some features for common import/export operations and a real technical infrastructure (transaction management, retry/skip policies and so on). By using the Inversion of Control pattern, your business code can be clearly separated from the technical code (handled by Spring Batch). That's where Spring Batch is very useful, because it helps you taking the good decisions for your batch applications.</p> <h3>Implementing the batch</h3> <p>Let's see how Spring Batch can help us to implement our import scenario. Spring Batch's sweet spot is <em>chunk</em> scenarios (it is by no means limited to this kind of scenarios). A chunk scenario is divided into 3 phases: read, transform and write. This is what we want to do: read data from the XML file and write them into the database. Fortunately, the transformation phase is optional. So here's the skeleton of our batch configuration:</p> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;batch:job</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;importer&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;batch:step</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;import&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;batch:tasklet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;batch:chunk</span> <span style="color: #000066;">reader</span>=<span style="color: #ff0000;">&quot;contactItemReader&quot;</span> <span style="color: #000066;">writer</span>=<span style="color: #ff0000;">&quot;contactItemWriter&quot;</span> <span style="color: #000066;">commit-interval</span>=<span style="color: #ff0000;">&quot;100&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/batch:tasklet<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/batch:step<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/batch:job<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>Our batch (called a job in Spring Batch's vocabulary) is made of only one step ("import"). We refer to Spring Beans that will be in charge of reading the data and writing them, respectively. The <code>contactItemReader</code> is here to read the contact from the XML file and Spring Batch comes with a built-in support for that, which is based on Spring OXM. Here is the configuration of the <code>contactItemReader</code> bean:</p> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;contactItemReader&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.batch.item.xml.StaxEventItemReader&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;fragmentRootElementName&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;contact&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;resource&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;file:./contacts_10000.xml&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;unmarshaller&quot;</s
pan> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;contactMarshaller&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;contactMarshaller&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.oxm.xstream.XStreamMarshaller&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;aliases&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;util:map</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;aliases&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;entry</span> <span style="color: #000066;">key</span>=<span style="color: #ff0000;">&quot;contact&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;com.zenika.domain.Contact&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/util:map<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/property<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>Notice Spring Batch uses StAX, which means that the whole XML file won't be loaded in memory. Spring Batch will "stream" it instead and send the <code>Contact</code> objects in chunks to the writer. The size of the chunk will the value in the <code>commit-interval</code> attribute defined previously. Spring Batch does not provide support for writing data in a database. This a good opportunity to take a look at the Spring Batch's API and implement our own <code>ItemWriter</code>:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> JdbcContactItemWriter <span style="color: #7F0055; font-weight: bold;">implements</span> ItemWriter<span style="color: #000000;">&lt;</span>Contact<span style="color: #000000;">&gt;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#40;</span>...<span style="color: #000000;">&#41;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  @Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> write<span style="color: #000000;">&#40;</span><span style="color: #7F0055; font-weight: bold;">final</span> List<span style="color: #000000;">&lt;?</span> <span style="color: #7F0055; font-weight: bold;">extends</span> Contact<span style="color: #000000;">&gt;</span> chunk<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">String</span> sql = <span style="color: #888888;">&quot;insert into contact (firstname,lastname,birthdate) values (?,?,?)&quot;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    jdbcTemplate.<span style="color: #000000;">batchUpdate</span><span style="color: #000000;">&#40;</span>sql, <span style="color: #7F0055; font-weight: bold;">new</span> BatchPreparedStatementSetter<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span>			</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      @Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">void</span> setValues<span style="color: #000000;">&#40;</span><span style="color: #000000;">PreparedStatement</span> ps, <span style="color: #7F0055; font-weight: bold;">int</span> i<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">SQLException</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        Contact contact = chunk.<span style="color: #000000;">get</span><span style="color: #000000;">&#40;</span>i<span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; m
argin:0; padding:0; background:inherit;">        ps.<span style="color: #000000;">setString</span><span style="color: #000000;">&#40;</span><span style="color: #cc66cc;">1</span>, contact.<span style="color: #000000;">getFirstname</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        ps.<span style="color: #000000;">setString</span><span style="color: #000000;">&#40;</span><span style="color: #cc66cc;">2</span>, contact.<span style="color: #000000;">getLastname</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        ps.<span style="color: #000000;">setDate</span><span style="color: #000000;">&#40;</span><span style="color: #cc66cc;">3</span>, <span style="color: #7F0055; font-weight: bold;">new</span> <span style="color: #000000;">Date</span><span style="color: #000000;">&#40;</span>contact.<span style="color: #000000;">getBirthDate</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>.<span style="color: #000000;">getTime</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      @Override</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">int</span> getBatchSize<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#123;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">        <span style="color: #7F0055; font-weight: bold;">return</span> chunk.<span style="color: #000000;">size</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">      <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    <span style="color: #000000;">&#125;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <p>Our business logic is now clearly in the <code>JdbcContactItemWriter</code>, which will be called <em>by</em> Spring Batch. This is where the Inversion of Control pattern takes place: our business code is surrounded by Spring Batch, which takes care of technical concerns (batch size, transaction management and so on). Note the <code>JdbcContactItemWriter</code> uses features of Spring's <code>JdbcTemplate</code>, to send batch updates, which is much more efficient. That's it for the configuration of the batch! This article is not a Spring Batch tutorial, but the following section shows how to configure the Spring Batch infrastructure.</p> <h3>Spring Batch infrastructure</h3> <p>We've just seen how to configure a batch, but Spring Batch needs some infrastructure beans to work properly. These beans are configured only once and any Spring Batch's job can use them then. If we use here a real database (PostgreSQL), and so real transaction management, we use an in-memory <code>JobRepository</code> (Spring Batch uses a <code>JobRepository</code> to store the state of jobs, which can be useful for monitoring but also to restart failed jobs at the exact same step they failed). Spring Batch comes also with a database implementation of <code>JobRepository</code>. Here is the configuration of our batch infrastructure:</p> <pre class="xml code xml" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;dataSource&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.jdbc.datasource.SingleConnectionDataSource&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;driverClassName&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;org.postgresql.Driver&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;url&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;jdbc:postgresql://localhost:5432/batchcontact&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;username&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;app&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;password&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;app&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; backgrou
nd:inherit;"> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;transactionManager&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;dataSource&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;dataSource&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;jobRepository&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.batch.core.repository.support.MapJobRepositoryFactoryBean&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;transactionManager&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;transactionManager&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;bean</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">&quot;jobLauncher&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.springframework.batch.core.launch.support.SimpleJobLauncher&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;jobRepository&quot;</span> <span style="color: #000066;">ref</span>=<span style="color: #ff0000;">&quot;jobRepository&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/bean<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></div></li></ol></pre> <p>Note we used some default name for the beans (<code>transactionManager</code>, <code>jobRepository</code>). Job beans will use them by default. It simplifies the configuration but also adds some magic.</p> <p>As a bonus, here is how to start the job in a main program:</p> <pre class="java code java" style="font-family:inherit"><ol><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">class</span> <span style="color: #a1a100;">importSpringBatch {</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #7F0055; font-weight: bold;">public</span> <span style="color: #7F0055; font-weight: bold;">static</span> <span style="color: #7F0055; font-weight: bold;">void</span> main<span style="color: #000000;">&#40;</span><span style="color: #000000;">String</span><span style="color: #000000;">&#91;</span><span style="color: #000000;">&#93;</span> args<span style="color: #000000;">&#41;</span> <span style="color: #7F0055; font-weight: bold;">throws</span> <span style="color: #000000;">Exception</span> <span style="color: #000000;">&#123;</span>		</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    ApplicationContext context = <span style="color: #7F0055; font-weight: bold;">new</span> ClassPathXmlApplicationContext<span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;/import-spring-batch.xml&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    JobLauncher launcher = <span style="color: #000000;">&#40;</span>JobLauncher<span style="color: #000000;">&#41;</span> context.<span style="color: #000000;">getBean</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;jobLauncher&quot;</span><span style="color: #000000;">&#41;</span>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    Job job = <span style="color: #000000;">&#40;</span>Job<span style="color: #000000;">&#41;</span> context.<span style="color: #000000;">getBean</span><span style="color: #000000;">&#40;</span><span style="color: #888888;">&quot;importer&quot;</span><span style="color: #000000;">&#41;</s
pan>;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">    launcher.<span style="color: #000000;">run</span><span style="color: #000000;">&#40;</span>job, <span style="color: #7F0055; font-weight: bold;">new</span> JobParameters<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;		</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">  <span style="color: #000000;">&#125;</span></div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;">&nbsp;</div></li><li style="font-weight: normal;"><div style="font-family: monospace; font-weight: normal; font-style: normal; margin:0; padding:0; background:inherit;"><span style="color: #000000;">&#125;</span></div></li></ol></pre> <h3>About the Spring Batch solution</h3> <p>So, what should we think of the Spring Batch solution?</p> <ul> <li>complex. Obviously, it looks more complicated than the simple approaches. This is typical of a framework: the learning curve is steeper.</li> <li>better separation of concerns. Spring Batch provides some support out-of-the-box (XML import) and lets us provide and plug our own implementation. There's less boilerplate code than in the simple approaches.</li> <li>flexibiliy. The batch size can be adjusted without changing the code and we can switch from XStream to JAXB2 or even provide our own marshaller.</li> <li>robustness. As Spring Batch uses StAX, the size of the XML file should not be a problem. We can also change the batch size easily. We didn't cover all the features that Spring Batch provides for robustness: retry and skip policies, restarting, reacting to the lifecycle of a step (success, failure), etc. All these features can be added declaratively.</li> </ul> <p>It's time to compare the solutions at runtime now!</p> <h2>Running the batch</h2> <p>I ran the three approaches on the same files, with PostgreSQL as the database. For Spring Batch, I used a simple rule for the batch size: the number of rows / 100. This is perhaps too simplistic, we just have to bear in mind that we can still adjust it easily, if we know about the number of contacts in the incoming file. I won't say that this benchmark is the most reliable in the world, but it helps to identify some trends. I monitored only the time execution, here are the results:</p> <table width="100%"> <tr> <th>Contact number</th><th>100</th><th>1 K</th><th>5 K</th><th>10 K</th><th>100 K</th><th>1 M</th> </tr> <tr> <th>Simple (batch size = n)</th><td>0.35 s</td><td>1.01 s</td><td>2.63 s</td><td>3.54 s</td><td>20.39 s</td><td>180.2 s</td> </tr> <tr> <th>Simple (batch size = 1)</th><td>0.77 s</td><td>3.28 s</td><td>11.2 s</td><td>21.16 s</td><td>179.06 s</td><td>1815.95 s</td> </tr> <tr> <th>Spring Batch</th><td>1.64 s</td><td>1.87 s</td><td>3.48 s</td><td>4.32 s</td><td>12.05 s</td><td>84.99 s</td> </tr> </table> <p>A quick analysis tells that the simple approaches are good for small datasets but do not scale, especially the one which creates a transaction for each row. Spring Batch becomes more efficient when the dataset gets bigger (100 K and more). Perhaps we could get even better results by tuning the batch size or by trying another marshaller. I didn't analyze the memory footprint, but we can guess that Spring Batch's should be smaller and smoother, as it does not load the whole dataset into memory.</p> <p>This leads us to think that parameters like the batch size can be relevant when tuning batch applications, which makes us realize that these policies should not be hard coded but rather externalized or even handled by a framework.</p> <h2>Summary</h2> <p>This article was about comparing different ways to tackle with batch applications. The use case is simple but rather representative. Simple, hand-written approaches work but they can require a lot of work and does not end up with good separation of concerns. Scaling can also becomes tricky and a framework like Spring Batch helps to take good decisions. It can also provide support classes for common use cases and helps implementing robust behaviors (retry, skip, batch transaction management) in a flexible way.</p> <p>The next question is: yet another framework to learn? If you have <em>really</em> simple batch, you can skip Spring Batch, but these cases are quite rare actually. You'll always end up with more complicated cases, where you need to take different paths if some steps in the batch fails, have to deal with complex skip policies and so on. And developping your own batch framework to handle these cases is perhaps the most common trap. So if you start a batch application, I would advise to take a quick look at Spring Batch!</p>